diff -Nurp busybox.old/archival/dpkg.c busybox/archival/dpkg.c
--- busybox.old/archival/dpkg.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/archival/dpkg.c	2015-05-29 07:00:58.099259145 +0800
@@ -1472,12 +1472,16 @@ static void init_archive_deb_control(arc
 	tar_handle->src_fd = ar_handle->src_fd;
 
 	/* We don't care about data.tar.* or debian-binary, just control.tar.* */
+	llist_add_to(&(ar_handle->accept), (char*)"control.tar");
 #if ENABLE_FEATURE_SEAMLESS_GZ
 	llist_add_to(&(ar_handle->accept), (char*)"control.tar.gz");
 #endif
 #if ENABLE_FEATURE_SEAMLESS_BZ2
 	llist_add_to(&(ar_handle->accept), (char*)"control.tar.bz2");
 #endif
+#if ENABLE_FEATURE_SEAMLESS_XZ
+	llist_add_to(&(ar_handle->accept), (char*)"control.tar.xz");
+#endif
 
 	/* Assign the tar handle as a subarchive of the ar handle */
 	ar_handle->dpkg__sub_archive = tar_handle;
@@ -1492,12 +1496,19 @@ static void init_archive_deb_data(archiv
 	tar_handle->src_fd = ar_handle->src_fd;
 
 	/* We don't care about control.tar.* or debian-binary, just data.tar.* */
+	llist_add_to(&(ar_handle->accept), (char*)"data.tar");
 #if ENABLE_FEATURE_SEAMLESS_GZ
 	llist_add_to(&(ar_handle->accept), (char*)"data.tar.gz");
 #endif
 #if ENABLE_FEATURE_SEAMLESS_BZ2
 	llist_add_to(&(ar_handle->accept), (char*)"data.tar.bz2");
 #endif
+#if ENABLE_FEATURE_SEAMLESS_LZMA
+	llist_add_to(&(ar_handle->accept), (char*)"data.tar.lzma");
+#endif
+#if ENABLE_FEATURE_SEAMLESS_XZ
+	llist_add_to(&(ar_handle->accept), (char*)"data.tar.xz");
+#endif
 
 	/* Assign the tar handle as a subarchive of the ar handle */
 	ar_handle->dpkg__sub_archive = tar_handle;
diff -Nurp busybox.old/archival/dpkg_deb.c busybox/archival/dpkg_deb.c
--- busybox.old/archival/dpkg_deb.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/archival/dpkg_deb.c	2015-05-29 07:00:58.099259145 +0800
@@ -70,6 +70,8 @@ int dpkg_deb_main(int argc, char **argv)
 	ar_archive->dpkg__sub_archive = tar_archive;
 	ar_archive->filter = filter_accept_list_reassign;
 
+	llist_add_to(&ar_archive->accept, (char*)"data.tar");
+	llist_add_to(&control_tar_llist, (char*)"control.tar");
 #if ENABLE_FEATURE_SEAMLESS_GZ
 	llist_add_to(&ar_archive->accept, (char*)"data.tar.gz");
 	llist_add_to(&control_tar_llist, (char*)"control.tar.gz");
@@ -82,6 +84,10 @@ int dpkg_deb_main(int argc, char **argv)
 	llist_add_to(&ar_archive->accept, (char*)"data.tar.lzma");
 	llist_add_to(&control_tar_llist, (char*)"control.tar.lzma");
 #endif
+#if ENABLE_FEATURE_SEAMLESS_XZ
+	llist_add_to(&ar_archive->accept, (char*)"data.tar.xz");
+	llist_add_to(&control_tar_llist, (char*)"control.tar.xz");
+#endif
 
 	opt_complementary = "c--efXx:e--cfXx:f--ceXx:X--cefx:x--cefX";
 	opt = getopt32(argv, "cefXx");
diff -Nurp busybox.old/archival/gzip.c busybox/archival/gzip.c
--- busybox.old/archival/gzip.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/archival/gzip.c	2015-05-29 07:00:58.099259145 +0800
@@ -62,14 +62,27 @@ aa:      85.1% -- replaced with aa.gz
 //config:	  1: larger buffers, larger hash-tables
 //config:	  2: larger buffers, largest hash-tables
 //config:	  Larger models may give slightly better compression
+//config:
+//config:config FEATURE_GZIP_LEVELS
+//config:	bool "Enable compression levels"
+//config:	default n
+//config:	depends on GZIP
+//config:	help
+//config:	  Enable support for compression levels 4-9. The default level
+//config:	  is 6. If levels 1-3 are specified, 4 is used.
+//config:	  If this option is not selected, -N options are ignored and -9
+//config:	  is used.
 
 //applet:IF_GZIP(APPLET(gzip, BB_DIR_BIN, BB_SUID_DROP))
 //kbuild:lib-$(CONFIG_GZIP) += gzip.o
 
 //usage:#define gzip_trivial_usage
-//usage:       "[-cfd] [FILE]..."
+//usage:       "[-cfd" IF_FEATURE_GZIP_LEVELS("123456789") "] [FILE]..."
 //usage:#define gzip_full_usage "\n\n"
 //usage:       "Compress FILEs (or stdin)\n"
+//usage:	IF_FEATURE_GZIP_LEVELS(
+//usage:     "\n	-1..9	Compression level"
+//usage:	)
 //usage:     "\n	-d	Decompress"
 //usage:     "\n	-c	Write to stdout"
 //usage:     "\n	-f	Force"
@@ -252,6 +265,8 @@ enum {
  * input file length plus MIN_LOOKAHEAD.
  */
 
+#ifndef ENABLE_FEATURE_GZIP_LEVELS
+
 	max_chain_length = 4096,
 /* To speed up deflation, hash chains are never searched beyond this length.
  * A higher limit improves compression ratio but degrades the speed.
@@ -283,11 +298,23 @@ enum {
  * For deflate_fast() (levels <= 3) good is ignored and lazy has a different
  * meaning.
  */
+#endif /* ENABLE_FEATURE_GZIP_LEVELS */
 };
 
 
 struct globals {
 
+#ifdef ENABLE_FEATURE_GZIP_LEVELS
+	unsigned max_chain_length;
+	unsigned max_lazy_match;
+	unsigned good_match;
+	unsigned nice_match;
+#define max_chain_length (G1.max_chain_length)
+#define max_lazy_match   (G1.max_lazy_match)
+#define good_match	 (G1.good_match)
+#define nice_match	 (G1.nice_match)
+#endif
+
 	lng block_start;
 
 /* window position at the beginning of the current output block. Gets
@@ -417,19 +444,46 @@ static void flush_outbuf(void)
 #define put_8bit(c) \
 do { \
 	G1.outbuf[G1.outcnt++] = (c); \
-	if (G1.outcnt == OUTBUFSIZ) flush_outbuf(); \
+	if (G1.outcnt == OUTBUFSIZ) \
+		flush_outbuf(); \
 } while (0)
 
 /* Output a 16 bit value, lsb first */
 static void put_16bit(ush w)
 {
-	if (G1.outcnt < OUTBUFSIZ - 2) {
-		G1.outbuf[G1.outcnt++] = w;
-		G1.outbuf[G1.outcnt++] = w >> 8;
-	} else {
-		put_8bit(w);
-		put_8bit(w >> 8);
+	/* GCC 4.2.1 won't optimize out redundant loads of G1.outcnt
+	 * (probably because of fear of aliasing with G1.outbuf[]
+	 * stores), do it explicitly:
+	 */
+	unsigned outcnt = G1.outcnt;
+	uch *dst = &G1.outbuf[outcnt];
+
+#if BB_UNALIGNED_MEMACCESS_OK && BB_LITTLE_ENDIAN
+	if (outcnt < OUTBUFSIZ-2) {
+		/* Common case */
+		ush *dst16 = (void*) dst;
+		*dst16 = w; /* unalinged LSB 16-bit store */
+		G1.outcnt = outcnt + 2;
+		return;
 	}
+	*dst = (uch)w;
+	w >>= 8;
+#else
+	*dst = (uch)w;
+	w >>= 8;
+	if (outcnt < OUTBUFSIZ-2) {
+		/* Common case */
+		dst[1] = w;
+		G1.outcnt = outcnt + 2;
+		return;
+	}
+#endif
+
+	/* Slowpath: we will need to do flush_outbuf() */
+	G1.outcnt = ++outcnt;
+	if (outcnt == OUTBUFSIZ)
+		flush_outbuf();
+	put_8bit(w);
 }
 
 static void put_32bit(ulg n)
@@ -2007,7 +2061,7 @@ static void ct_init(void)
  * IN assertions: the input and output buffers are cleared.
  */
 
-static void zip(ulg time_stamp)
+static void zip(void)
 {
 	ush deflate_flags = 0;  /* pkzip -es, -en or -ex equivalent */
 
@@ -2018,7 +2072,7 @@ static void zip(ulg time_stamp)
 	/* compression method: 8 (DEFLATED) */
 	/* general flags: 0 */
 	put_32bit(0x00088b1f);
-	put_32bit(time_stamp);
+	put_32bit(0);		/* Unix timestamp */
 
 	/* Write deflated file to zip file */
 	G1.crc = ~0;
@@ -2044,8 +2098,6 @@ static void zip(ulg time_stamp)
 static
 IF_DESKTOP(long long) int FAST_FUNC pack_gzip(transformer_state_t *xstate UNUSED_PARAM)
 {
-	struct stat s;
-
 	/* Clear input and output buffers */
 	G1.outcnt = 0;
 #ifdef DEBUG
@@ -2077,9 +2129,23 @@ IF_DESKTOP(long long) int FAST_FUNC pack
 	G2.bl_desc.max_length  = MAX_BL_BITS;
 	//G2.bl_desc.max_code    = 0;
 
+#if 0
+	/* Saving of timestamp is disabled. Why?
+	 * - it is not Y2038-safe.
+	 * - some people want deterministic results
+	 *   (normally they'd use -n, but our -n is a nop).
+	 * - it's bloat.
+	 * Per RFC 1952, gzfile.time=0 is "no timestamp".
+	 * If users will demand this to be reinstated,
+	 * implement -n "don't save timestamp".
+	 */
+	struct stat s;
 	s.st_ctime = 0;
 	fstat(STDIN_FILENO, &s);
 	zip(s.st_ctime);
+#else
+	zip();
+#endif
 	return 0;
 }
 
@@ -2122,24 +2188,48 @@ int gzip_main(int argc UNUSED_PARAM, cha
 #endif
 {
 	unsigned opt;
+#ifdef ENABLE_FEATURE_GZIP_LEVELS
+	static const struct {
+		uint8_t good;
+		uint8_t chain_shift;
+		uint8_t lazy2;
+		uint8_t nice2;
+	} gzip_level_config[6] = {
+		{4,   4,   4/2,  16/2}, /* Level 4 */
+		{8,   5,  16/2,  32/2}, /* Level 5 */
+		{8,   7,  16/2, 128/2}, /* Level 6 */
+		{8,   8,  32/2, 128/2}, /* Level 7 */
+		{32, 10, 128/2, 258/2}, /* Level 8 */
+		{32, 12, 258/2, 258/2}, /* Level 9 */
+	};
+#endif
+
+	SET_PTR_TO_GLOBALS((char *)xzalloc(sizeof(struct globals)+sizeof(struct globals2))
+			+ sizeof(struct globals));
 
 #if ENABLE_FEATURE_GZIP_LONG_OPTIONS
 	applet_long_options = gzip_longopts;
 #endif
 	/* Must match bbunzip's constants OPT_STDOUT, OPT_FORCE! */
-	opt = getopt32(argv, "cfv" IF_GUNZIP("dt") "q123456789n");
+	opt = getopt32(argv, "cfv" IF_GUNZIP("dt") "qn123456789");
 #if ENABLE_GUNZIP /* gunzip_main may not be visible... */
 	if (opt & 0x18) // -d and/or -t
 		return gunzip_main(argc, argv);
 #endif
-	option_mask32 &= 0x7; /* ignore -q, -0..9 */
-	//if (opt & 0x1) // -c
-	//if (opt & 0x2) // -f
-	//if (opt & 0x4) // -v
-	argv += optind;
-
-	SET_PTR_TO_GLOBALS((char *)xzalloc(sizeof(struct globals)+sizeof(struct globals2))
-			+ sizeof(struct globals));
+#ifdef ENABLE_FEATURE_GZIP_LEVELS
+	opt >>= ENABLE_GUNZIP ? 7 : 5; /* drop cfv[dt]qn bits */
+	if (opt == 0)
+		opt = 1 << 6; /* default: 6 */
+	/* Map 1..3 to 4 */
+	if (opt & 0x7)
+		opt |= 1 << 4;
+	opt = ffs(opt >> 3);
+	max_chain_length = 1 << gzip_level_config[opt].chain_shift;
+	good_match	 = gzip_level_config[opt].good;
+	max_lazy_match	 = gzip_level_config[opt].lazy2 * 2;
+	nice_match	 = gzip_level_config[opt].nice2 * 2;
+#endif
+	option_mask32 &= 0x7; /* retain only -cfv */
 
 	/* Allocate all global buffers (for DYN_ALLOC option) */
 	ALLOC(uch, G1.l_buf, INBUFSIZ);
@@ -2151,5 +2241,6 @@ int gzip_main(int argc UNUSED_PARAM, cha
 	/* Initialize the CRC32 table */
 	global_crc32_table = crc32_filltable(NULL, 0);
 
+	argv += optind;
 	return bbunpack(argv, pack_gzip, append_ext, "gz");
 }
diff -Nurp busybox.old/archival/libarchive/filter_accept_list_reassign.c busybox/archival/libarchive/filter_accept_list_reassign.c
--- busybox.old/archival/libarchive/filter_accept_list_reassign.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/archival/libarchive/filter_accept_list_reassign.c	2015-05-29 07:00:58.102592479 +0800
@@ -28,6 +28,10 @@ char FAST_FUNC filter_accept_list_reassi
 		name_ptr++;
 
 		/* Modify the subarchive handler based on the extension */
+		if (strcmp(name_ptr, "tar") == 0) {
+			archive_handle->dpkg__action_data_subarchive = get_header_tar;
+			return EXIT_SUCCESS;
+		}
 		if (ENABLE_FEATURE_SEAMLESS_GZ
 		 && strcmp(name_ptr, "gz") == 0
 		) {
@@ -46,6 +50,12 @@ char FAST_FUNC filter_accept_list_reassi
 			archive_handle->dpkg__action_data_subarchive = get_header_tar_lzma;
 			return EXIT_SUCCESS;
 		}
+		if (ENABLE_FEATURE_SEAMLESS_XZ
+		 && strcmp(name_ptr, "xz") == 0
+		) {
+			archive_handle->dpkg__action_data_subarchive = get_header_tar_xz;
+			return EXIT_SUCCESS;
+		}
 	}
 	return EXIT_FAILURE;
 }
diff -Nurp busybox.old/archival/libarchive/get_header_cpio.c busybox/archival/libarchive/get_header_cpio.c
--- busybox.old/archival/libarchive/get_header_cpio.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/archival/libarchive/get_header_cpio.c	2015-05-29 07:00:58.102592479 +0800
@@ -37,7 +37,7 @@ char FAST_FUNC get_header_cpio(archive_h
 	}
 	archive_handle->offset += 110;
 
-	if (strncmp(&cpio_header[0], "07070", 5) != 0
+	if (!is_prefixed_with(&cpio_header[0], "07070")
 	 || (cpio_header[5] != '1' && cpio_header[5] != '2')
 	) {
 		bb_error_msg_and_die("unsupported cpio format, use newc or crc");
diff -Nurp busybox.old/archival/libarchive/get_header_tar.c busybox/archival/libarchive/get_header_tar.c
--- busybox.old/archival/libarchive/get_header_tar.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/archival/libarchive/get_header_tar.c	2015-05-29 07:00:58.102592479 +0800
@@ -17,36 +17,6 @@
 typedef uint32_t aliased_uint32_t FIX_ALIASING;
 typedef off_t    aliased_off_t    FIX_ALIASING;
 
-
-const char* FAST_FUNC strip_unsafe_prefix(const char *str)
-{
-	const char *cp = str;
-	while (1) {
-		char *cp2;
-		if (*cp == '/') {
-			cp++;
-			continue;
-		}
-		if (strncmp(cp, "/../"+1, 3) == 0) {
-			cp += 3;
-			continue;
-		}
-		cp2 = strstr(cp, "/../");
-		if (!cp2)
-			break;
-		cp = cp2 + 4;
-	}
-	if (cp != str) {
-		static smallint warned = 0;
-		if (!warned) {
-			warned = 1;
-			bb_error_msg("removing leading '%.*s' from member names",
-				(int)(cp - str), str);
-		}
-	}
-	return cp;
-}
-
 /* NB: _DESTROYS_ str[len] character! */
 static unsigned long long getOctal(char *str, int len)
 {
@@ -135,7 +105,7 @@ static void process_pax_hdr(archive_hand
 		value = end + 1;
 
 #if ENABLE_FEATURE_TAR_GNU_EXTENSIONS
-		if (!global && strncmp(value, "path=", sizeof("path=") - 1) == 0) {
+		if (!global && is_prefixed_with(value, "path=")) {
 			value += sizeof("path=") - 1;
 			free(archive_handle->tar__longname);
 			archive_handle->tar__longname = xstrdup(value);
@@ -148,7 +118,7 @@ static void process_pax_hdr(archive_hand
 		 * This is what Red Hat's patched version of tar uses.
 		 */
 # define SELINUX_CONTEXT_KEYWORD "RHT.security.selinux"
-		if (strncmp(value, SELINUX_CONTEXT_KEYWORD"=", sizeof(SELINUX_CONTEXT_KEYWORD"=") - 1) == 0) {
+		if (is_prefixed_with(value, SELINUX_CONTEXT_KEYWORD"=")) {
 			value += sizeof(SELINUX_CONTEXT_KEYWORD"=") - 1;
 			free(archive_handle->tar__sctx[global]);
 			archive_handle->tar__sctx[global] = xstrdup(value);
@@ -232,7 +202,7 @@ char FAST_FUNC get_header_tar(archive_ha
 
 	/* Check header has valid magic, "ustar" is for the proper tar,
 	 * five NULs are for the old tar format  */
-	if (strncmp(tar.magic, "ustar", 5) != 0
+	if (!is_prefixed_with(tar.magic, "ustar")
 	 && (!ENABLE_FEATURE_TAR_OLDGNU_COMPATIBILITY
 	     || memcmp(tar.magic, "\0\0\0\0", 5) != 0)
 	) {
@@ -380,7 +350,14 @@ char FAST_FUNC get_header_tar(archive_ha
 	case '6':
 		file_header->mode |= S_IFIFO;
 		goto size0;
+	case 'g':	/* pax global header */
+	case 'x': {	/* pax extended header */
+		if ((uoff_t)file_header->size > 0xfffff) /* paranoia */
+			goto skip_ext_hdr;
+		process_pax_hdr(archive_handle, file_header->size, (tar.typeflag == 'g'));
+		goto again_after_align;
 #if ENABLE_FEATURE_TAR_GNU_EXTENSIONS
+/* See http://www.gnu.org/software/tar/manual/html_node/Extensions.html */
 	case 'L':
 		/* free: paranoia: tar with several consecutive longnames */
 		free(p_longname);
@@ -400,18 +377,17 @@ char FAST_FUNC get_header_tar(archive_ha
 		archive_handle->offset += file_header->size;
 		/* return get_header_tar(archive_handle); */
 		goto again;
-	case 'D':	/* GNU dump dir */
-	case 'M':	/* Continuation of multi volume archive */
-	case 'N':	/* Old GNU for names > 100 characters */
-	case 'S':	/* Sparse file */
-	case 'V':	/* Volume header */
+/*
+ *	case 'S':	// Sparse file
+ * Was seen in the wild. Not supported (yet?).
+ * See https://www.gnu.org/software/tar/manual/html_section/tar_92.html
+ * for the format. (An "Old GNU Format" was seen, not PAX formats).
+ */
+//	case 'D':	/* GNU dump dir */
+//	case 'M':	/* Continuation of multi volume archive */
+//	case 'N':	/* Old GNU for names > 100 characters */
+//	case 'V':	/* Volume header */
 #endif
-	case 'g':	/* pax global header */
-	case 'x': {	/* pax extended header */
-		if ((uoff_t)file_header->size > 0xfffff) /* paranoia */
-			goto skip_ext_hdr;
-		process_pax_hdr(archive_handle, file_header->size, (tar.typeflag == 'g'));
-		goto again_after_align;
 	}
  skip_ext_hdr:
 	{
diff -Nurp busybox.old/archival/libarchive/get_header_tar_xz.c busybox/archival/libarchive/get_header_tar_xz.c
--- busybox.old/archival/libarchive/get_header_tar_xz.c	1970-01-01 08:00:00.000000000 +0800
+++ busybox/archival/libarchive/get_header_tar_xz.c	2015-05-29 07:00:58.102592479 +0800
@@ -0,0 +1,21 @@
+/* vi: set sw=4 ts=4: */
+/*
+ * Licensed under GPLv2 or later, see file LICENSE in this source tree.
+ */
+
+#include "libbb.h"
+#include "bb_archive.h"
+
+char FAST_FUNC get_header_tar_xz(archive_handle_t *archive_handle)
+{
+	/* Can't lseek over pipes */
+	archive_handle->seek = seek_by_read;
+
+	fork_transformer_with_sig(archive_handle->src_fd, unpack_xz_stream, "unxz");
+	archive_handle->offset = 0;
+	while (get_header_tar(archive_handle) == EXIT_SUCCESS)
+		continue;
+
+	/* Can only do one file at a time */
+	return EXIT_FAILURE;
+}
diff -Nurp busybox.old/archival/libarchive/Kbuild.src busybox/archival/libarchive/Kbuild.src
--- busybox.old/archival/libarchive/Kbuild.src	2015-03-23 11:07:18.000000000 +0800
+++ busybox/archival/libarchive/Kbuild.src	2015-05-29 07:00:58.099259145 +0800
@@ -30,11 +30,13 @@ COMMON_FILES:= \
 DPKG_FILES:= \
 	unpack_ar_archive.o \
 	filter_accept_list_reassign.o \
+	unsafe_prefix.o \
 	get_header_ar.o \
 	get_header_tar.o \
 	get_header_tar_gz.o \
 	get_header_tar_bz2.o \
 	get_header_tar_lzma.o \
+	get_header_tar_xz.o \
 
 INSERT
 
@@ -43,7 +45,7 @@ lib-$(CONFIG_DPKG_DEB)
 
 lib-$(CONFIG_AR)                        += get_header_ar.o unpack_ar_archive.o
 lib-$(CONFIG_CPIO)                      += get_header_cpio.o
-lib-$(CONFIG_TAR)                       += get_header_tar.o
+lib-$(CONFIG_TAR)                       += get_header_tar.o unsafe_prefix.o
 lib-$(CONFIG_FEATURE_TAR_TO_COMMAND)    += data_extract_to_command.o
 lib-$(CONFIG_LZOP)                      += lzo1x_1.o lzo1x_1o.o lzo1x_d.o
 lib-$(CONFIG_LZOP_COMPR_HIGH)           += lzo1x_9x.o
@@ -52,7 +54,7 @@ lib-$(CONFIG_UNLZMA)
 lib-$(CONFIG_UNXZ)                      += open_transformer.o decompress_unxz.o
 lib-$(CONFIG_GUNZIP)                    += open_transformer.o decompress_gunzip.o
 lib-$(CONFIG_UNCOMPRESS)                += open_transformer.o decompress_uncompress.o
-lib-$(CONFIG_UNZIP)                     += open_transformer.o decompress_gunzip.o
+lib-$(CONFIG_UNZIP)                     += open_transformer.o decompress_gunzip.o unsafe_prefix.o
 lib-$(CONFIG_RPM2CPIO)                  += open_transformer.o decompress_gunzip.o get_header_cpio.o
 lib-$(CONFIG_RPM)                       += open_transformer.o decompress_gunzip.o get_header_cpio.o
 
diff -Nurp busybox.old/archival/libarchive/open_transformer.c busybox/archival/libarchive/open_transformer.c
--- busybox.old/archival/libarchive/open_transformer.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/archival/libarchive/open_transformer.c	2015-05-29 07:00:58.102592479 +0800
@@ -185,6 +185,13 @@ static transformer_state_t *setup_transf
 		USE_FOR_NOMMU(xstate->xformer_prog = "gunzip";)
 		goto found_magic;
 	}
+	if (ENABLE_FEATURE_SEAMLESS_Z
+	 && magic.b16[0] == COMPRESS_MAGIC
+	) {
+		xstate->xformer = unpack_Z_stream;
+		USE_FOR_NOMMU(xstate->xformer_prog = "uncompress";)
+		goto found_magic;
+	}
 	if (ENABLE_FEATURE_SEAMLESS_BZ2
 	 && magic.b16[0] == BZIP2_MAGIC
 	) {
diff -Nurp busybox.old/archival/libarchive/unpack_ar_archive.c busybox/archival/libarchive/unpack_ar_archive.c
--- busybox.old/archival/libarchive/unpack_ar_archive.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/archival/libarchive/unpack_ar_archive.c	2015-05-29 07:00:58.102592479 +0800
@@ -12,7 +12,7 @@ void FAST_FUNC unpack_ar_archive(archive
 	char magic[7];
 
 	xread(ar_archive->src_fd, magic, AR_MAGIC_LEN);
-	if (strncmp(magic, AR_MAGIC, AR_MAGIC_LEN) != 0) {
+	if (!is_prefixed_with(magic, AR_MAGIC)) {
 		bb_error_msg_and_die("invalid ar magic");
 	}
 	ar_archive->offset += AR_MAGIC_LEN;
diff -Nurp busybox.old/archival/libarchive/unsafe_prefix.c busybox/archival/libarchive/unsafe_prefix.c
--- busybox.old/archival/libarchive/unsafe_prefix.c	1970-01-01 08:00:00.000000000 +0800
+++ busybox/archival/libarchive/unsafe_prefix.c	2015-05-29 07:00:58.102592479 +0800
@@ -0,0 +1,36 @@
+/* vi: set sw=4 ts=4: */
+/*
+ * Licensed under GPLv2 or later, see file LICENSE in this source tree.
+ */
+
+#include "libbb.h"
+#include "bb_archive.h"
+
+const char* FAST_FUNC strip_unsafe_prefix(const char *str)
+{
+	const char *cp = str;
+	while (1) {
+		char *cp2;
+		if (*cp == '/') {
+			cp++;
+			continue;
+		}
+		if (is_prefixed_with(cp, "/../"+1)) {
+			cp += 3;
+			continue;
+		}
+		cp2 = strstr(cp, "/../");
+		if (!cp2)
+			break;
+		cp = cp2 + 4;
+	}
+	if (cp != str) {
+		static smallint warned = 0;
+		if (!warned) {
+			warned = 1;
+			bb_error_msg("removing leading '%.*s' from member names",
+				(int)(cp - str), str);
+		}
+	}
+	return cp;
+}
diff -Nurp busybox.old/archival/unzip.c busybox/archival/unzip.c
--- busybox.old/archival/unzip.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/archival/unzip.c	2015-05-29 07:00:58.105925812 +0800
@@ -596,14 +596,18 @@ int unzip_main(int argc, char **argv)
 		/* Skip extra header bytes */
 		unzip_skip(zip_header.formatted.extra_len);
 
+		/* Guard against "/abspath", "/../" and similar attacks */
+		overlapping_strcpy(dst_fn, strip_unsafe_prefix(dst_fn));
+
 		/* Filter zip entries */
 		if (find_list_entry(zreject, dst_fn)
 		 || (zaccept && !find_list_entry(zaccept, dst_fn))
 		) { /* Skip entry */
 			i = 'n';
 
-		} else { /* Extract entry */
-			if (listing) { /* List entry */
+		} else {
+			if (listing) {
+				/* List entry */
 				unsigned dostime = zip_header.formatted.modtime | (zip_header.formatted.moddate << 16);
 				if (!verbose) {
 					//      "  Length     Date   Time    Name\n"
@@ -639,9 +643,11 @@ int unzip_main(int argc, char **argv)
 					total_size += zip_header.formatted.cmpsize;
 				}
 				i = 'n';
-			} else if (dst_fd == STDOUT_FILENO) { /* Extracting to STDOUT */
+			} else if (dst_fd == STDOUT_FILENO) {
+				/* Extracting to STDOUT */
 				i = -1;
-			} else if (last_char_is(dst_fn, '/')) { /* Extract directory */
+			} else if (last_char_is(dst_fn, '/')) {
+				/* Extract directory */
 				if (stat(dst_fn, &stat_buf) == -1) {
 					if (errno != ENOENT) {
 						bb_perror_msg_and_die("can't stat '%s'", dst_fn);
@@ -655,22 +661,27 @@ int unzip_main(int argc, char **argv)
 					}
 				} else {
 					if (!S_ISDIR(stat_buf.st_mode)) {
-						bb_error_msg_and_die("'%s' exists but is not directory", dst_fn);
+						bb_error_msg_and_die("'%s' exists but is not a %s",
+							dst_fn, "directory");
 					}
 				}
 				i = 'n';
 
-			} else {  /* Extract file */
+			} else {
+				/* Extract file */
  check_file:
-				if (stat(dst_fn, &stat_buf) == -1) { /* File does not exist */
+				if (stat(dst_fn, &stat_buf) == -1) {
+					/* File does not exist */
 					if (errno != ENOENT) {
 						bb_perror_msg_and_die("can't stat '%s'", dst_fn);
 					}
 					i = 'y';
-				} else { /* File already exists */
+				} else {
+					/* File already exists */
 					if (overwrite == O_NEVER) {
 						i = 'n';
-					} else if (S_ISREG(stat_buf.st_mode)) { /* File is regular file */
+					} else if (S_ISREG(stat_buf.st_mode)) {
+						/* File is regular file */
 						if (overwrite == O_ALWAYS) {
 							i = 'y';
 						} else {
@@ -678,8 +689,10 @@ int unzip_main(int argc, char **argv)
 							my_fgets80(key_buf);
 							i = key_buf[0];
 						}
-					} else { /* File is not regular file */
-						bb_error_msg_and_die("'%s' exists but is not regular file", dst_fn);
+					} else {
+						/* File is not regular file */
+						bb_error_msg_and_die("'%s' exists but is not a %s",
+							dst_fn, "regular file");
 					}
 				}
 			}
diff -Nurp busybox.old/console-tools/loadkmap.c busybox/console-tools/loadkmap.c
--- busybox.old/console-tools/loadkmap.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/console-tools/loadkmap.c	2015-05-29 07:00:58.109259146 +0800
@@ -10,8 +10,9 @@
 //usage:#define loadkmap_trivial_usage
 //usage:       "< keymap"
 //usage:#define loadkmap_full_usage "\n\n"
-//usage:       "Load a binary keyboard translation table from stdin\n"
-/* //usage:     "\n	-C TTY	Affect TTY instead of /dev/tty" */
+//usage:       "Load a binary keyboard translation table from stdin"
+////usage:       "\n"
+////usage:       "\n	-C TTY	Affect TTY instead of /dev/tty"
 //usage:
 //usage:#define loadkmap_example_usage
 //usage:       "$ loadkmap < /etc/i18n/lang-keymap\n"
@@ -56,7 +57,7 @@ int loadkmap_main(int argc UNUSED_PARAM,
 */
 
 	xread(STDIN_FILENO, flags, 7);
-	if (strncmp(flags, BINARY_KEYMAP_MAGIC, 7))
+	if (!is_prefixed_with(flags, BINARY_KEYMAP_MAGIC))
 		bb_error_msg_and_die("not a valid binary keymap");
 
 	xread(STDIN_FILENO, flags, MAX_NR_KEYMAPS);
diff -Nurp busybox.old/coreutils/basename.c busybox/coreutils/basename.c
--- busybox.old/coreutils/basename.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/coreutils/basename.c	2015-05-29 07:00:58.109259146 +0800
@@ -31,7 +31,7 @@
 //usage:#define basename_trivial_usage
 //usage:       "FILE [SUFFIX]"
 //usage:#define basename_full_usage "\n\n"
-//usage:       "Strip directory path and .SUFFIX from FILE\n"
+//usage:       "Strip directory path and .SUFFIX from FILE"
 //usage:
 //usage:#define basename_example_usage
 //usage:       "$ basename /usr/local/bin/foo\n"
diff -Nurp busybox.old/coreutils/Config.src busybox/coreutils/Config.src
--- busybox.old/coreutils/Config.src	2015-03-23 11:07:18.000000000 +0800
+++ busybox/coreutils/Config.src	2015-05-29 07:00:58.109259146 +0800
@@ -11,7 +11,7 @@ config CAL
 	bool "cal"
 	default y
 	help
-	  cal is used to display a monthly calender.
+	  cal is used to display a monthly calendar.
 
 config CATV
 	bool "catv"
@@ -87,44 +87,6 @@ config CUT
 	  cut is used to print selected parts of lines from
 	  each file to stdout.
 
-config DD
-	bool "dd"
-	default y
-	help
-	  dd copies a file (from standard input to standard output,
-	  by default) using specific input and output blocksizes,
-	  while optionally performing conversions on it.
-
-config FEATURE_DD_SIGNAL_HANDLING
-	bool "Enable DD signal handling for status reporting"
-	default y
-	depends on DD
-	help
-	  Sending a SIGUSR1 signal to a running `dd' process makes it
-	  print to standard error the number of records read and written
-	  so far, then to resume copying.
-
-	  $ dd if=/dev/zero of=/dev/null&
-	  $ pid=$! kill -USR1 $pid; sleep 1; kill $pid
-	  10899206+0 records in
-	  10899206+0 records out
-
-config FEATURE_DD_THIRD_STATUS_LINE
-	bool "Enable the third status line upon signal"
-	default y
-	depends on DD && FEATURE_DD_SIGNAL_HANDLING
-	help
-	  Displays a coreutils-like third status line with transferred bytes,
-	  elapsed time and speed.
-
-config FEATURE_DD_IBS_OBS
-	bool "Enable ibs, obs and conv options"
-	default y
-	depends on DD
-	help
-	  Enables support for writing a certain number of bytes in and out,
-	  at a time, and performing conversions on the data stream.
-
 config DF
 	bool "df"
 	default y
diff -Nurp busybox.old/coreutils/date.c busybox/coreutils/date.c
--- busybox.old/coreutils/date.c	2015-05-29 06:54:59.000000000 +0800
+++ busybox/coreutils/date.c	2015-05-29 07:00:58.109259146 +0800
@@ -123,7 +123,6 @@
 //usage:	IF_FEATURE_DATE_ISOFMT(
 //usage:     "\n	-D FMT		Use FMT for -d TIME conversion"
 //usage:	)
-//usage:     "\n	-k		Set Kernel timezone from localtime and exit"
 //usage:     "\n"
 //usage:     "\nRecognized TIME formats:"
 //usage:     "\n	hh:mm[:ss]"
@@ -139,7 +138,6 @@
 //usage:       "Wed Apr 12 18:52:41 MDT 2000\n"
 
 #include "libbb.h"
-#include <sys/time.h>
 #if ENABLE_FEATURE_DATE_NANO
 # include <sys/syscall.h>
 #endif
@@ -150,9 +148,8 @@ enum {
 	OPT_UTC       = (1 << 2), /* u */
 	OPT_DATE      = (1 << 3), /* d */
 	OPT_REFERENCE = (1 << 4), /* r */
-	OPT_KERNELTZ  = (1 << 5), /* k */
-	OPT_TIMESPEC  = (1 << 6) * ENABLE_FEATURE_DATE_ISOFMT, /* I */
-	OPT_HINT      = (1 << 7) * ENABLE_FEATURE_DATE_ISOFMT, /* D */
+	OPT_TIMESPEC  = (1 << 5) * ENABLE_FEATURE_DATE_ISOFMT, /* I */
+	OPT_HINT      = (1 << 6) * ENABLE_FEATURE_DATE_ISOFMT, /* D */
 };
 
 static void maybe_set_utc(int opt)
@@ -170,15 +167,12 @@ static const char date_longopts[] ALIGN1
 	/*	"universal\0" No_argument       "u" */
 		"date\0"      Required_argument "d"
 		"reference\0" Required_argument "r"
-		"set-kernel-tz\0" No_argument   "k"
 		;
 #endif
 
 int date_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
 int date_main(int argc UNUSED_PARAM, char **argv)
 {
-	time_t tt;
-	struct timezone tz;
 	struct timespec ts;
 	struct tm tm_time;
 	char buf_fmt_dt2str[64];
@@ -193,7 +187,7 @@ int date_main(int argc UNUSED_PARAM, cha
 	opt_complementary = "d--s:s--d"
 		IF_FEATURE_DATE_ISOFMT(":R--I:I--R");
 	IF_LONG_OPTS(applet_long_options = date_longopts;)
-	opt = getopt32(argv, "Rs:ud:r:k"
+	opt = getopt32(argv, "Rs:ud:r:"
 			IF_FEATURE_DATE_ISOFMT("I::D:"),
 			&date_str, &date_str, &filename
 			IF_FEATURE_DATE_ISOFMT(, &isofmt_arg, &fmt_str2dt));
@@ -250,31 +244,6 @@ int date_main(int argc UNUSED_PARAM, cha
 	if (*argv)
 		bb_show_usage();
 
-	/* Setting of kernel timezone was requested */
-	if (opt & OPT_KERNELTZ) {
-		tt = time(NULL);
-		localtime_r(&tt, &tm_time);
-
-		/* workaround warp_clock() on first invocation */
-		memset(&tz, 0, sizeof(tz));
-		settimeofday(NULL, &tz);
-
-		memset(&tz, 0, sizeof(tz));
-#ifdef __USE_MISC
-		tz.tz_minuteswest = -(tm_time.tm_gmtoff / 60);
-#else
-		tz.tz_minuteswest = -(tm_time.__tm_gmtoff / 60);
-#endif
-
-		if (settimeofday(NULL, &tz))
-		{
-			bb_perror_msg("can't set kernel time zone");
-			return EXIT_FAILURE;
-		}
-
-		return EXIT_SUCCESS;
-	}
-
 	/* Now we have parsed all the information except the date format
 	 * which depends on whether the clock is being set or read */
 
@@ -404,7 +373,7 @@ int date_main(int argc UNUSED_PARAM, cha
 		date_buf[0] = '\0';
 	} else {
 		/* Handle special conversions */
-		if (strncmp(fmt_dt2str, "%f", 2) == 0) {
+		if (is_prefixed_with(fmt_dt2str, "%f")) {
 			fmt_dt2str = (char*)"%Y.%m.%d-%H:%M:%S";
 		}
 		/* Generate output string */
diff -Nurp busybox.old/coreutils/dd.c busybox/coreutils/dd.c
--- busybox.old/coreutils/dd.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/coreutils/dd.c	2015-05-29 07:00:58.109259146 +0800
@@ -8,6 +8,51 @@
  * Licensed under GPLv2 or later, see file LICENSE in this source tree.
  */
 
+//config:config DD
+//config:	bool "dd"
+//config:	default y
+//config:	help
+//config:	  dd copies a file (from standard input to standard output,
+//config:	  by default) using specific input and output blocksizes,
+//config:	  while optionally performing conversions on it.
+//config:
+//config:config FEATURE_DD_SIGNAL_HANDLING
+//config:	bool "Enable signal handling for status reporting"
+//config:	default y
+//config:	depends on DD
+//config:	help
+//config:	  Sending a SIGUSR1 signal to a running `dd' process makes it
+//config:	  print to standard error the number of records read and written
+//config:	  so far, then to resume copying.
+//config:
+//config:	  $ dd if=/dev/zero of=/dev/null &
+//config:	  $ pid=$!; kill -USR1 $pid; sleep 1; kill $pid
+//config:	  10899206+0 records in
+//config:	  10899206+0 records out
+//config:
+//config:config FEATURE_DD_THIRD_STATUS_LINE
+//config:	bool "Enable the third status line upon signal"
+//config:	default y
+//config:	depends on DD && FEATURE_DD_SIGNAL_HANDLING
+//config:	help
+//config:	  Displays a coreutils-like third status line with transferred bytes,
+//config:	  elapsed time and speed.
+//config:
+//config:config FEATURE_DD_IBS_OBS
+//config:	bool "Enable ibs, obs and conv options"
+//config:	default y
+//config:	depends on DD
+//config:	help
+//config:	  Enables support for writing a certain number of bytes in and out,
+//config:	  at a time, and performing conversions on the data stream.
+//config:
+//config:config FEATURE_DD_STATUS
+//config:	bool "Enable status display options"
+//config:	default y
+//config:	depends on DD
+//config:	help
+//config:	  Enables support for status=noxfer/none option.
+
 //usage:#define dd_trivial_usage
 //usage:       "[if=FILE] [of=FILE] " IF_FEATURE_DD_IBS_OBS("[ibs=N] [obs=N] ") "[bs=N] [count=N] [skip=N]\n"
 //usage:       "	[seek=N]" IF_FEATURE_DD_IBS_OBS(" [conv=notrunc|noerror|sync|fsync]")
@@ -32,8 +77,12 @@
 //usage:     "\n	conv=fsync	Physically write data out before finishing"
 //usage:     "\n	conv=swab	Swap every pair of bytes"
 //usage:	)
+//usage:	IF_FEATURE_DD_STATUS(
+//usage:     "\n	status=noxfer	Suppress rate output"
+//usage:     "\n	status=none	Suppress all output"
+//usage:	)
 //usage:     "\n"
-//usage:     "\nN may be suffixed by c (1), w (2), b (512), kD (1000), k (1024), MD, M, GD, G"
+//usage:     "\nN may be suffixed by c (1), w (2), b (512), kB (1000), k (1024), MB, M, GB, G"
 //usage:
 //usage:#define dd_example_usage
 //usage:       "$ dd if=/dev/zero of=/dev/ram1 bs=1M count=4\n"
@@ -50,26 +99,13 @@ enum {
 	ofd = STDOUT_FILENO,
 };
 
-static const struct suffix_mult dd_suffixes[] = {
-	{ "c", 1 },
-	{ "w", 2 },
-	{ "b", 512 },
-	{ "kD", 1000 },
-	{ "k", 1024 },
-	{ "K", 1024 },  /* compat with coreutils dd */
-	{ "MD", 1000000 },
-	{ "M", 1048576 },
-	{ "GD", 1000000000 },
-	{ "G", 1073741824 },
-	{ "", 0 }
-};
-
 struct globals {
 	off_t out_full, out_part, in_full, in_part;
 #if ENABLE_FEATURE_DD_THIRD_STATUS_LINE
 	unsigned long long total_bytes;
 	unsigned long long begin_time_us;
 #endif
+	int flags;
 } FIX_ALIASING;
 #define G (*(struct globals*)&bb_common_bufsiz1)
 #define INIT_G() do { \
@@ -77,6 +113,21 @@ struct globals {
 	memset(&G, 0, sizeof(G)); \
 } while (0)
 
+enum {
+	/* Must be in the same order as OP_conv_XXX! */
+	/* (see "flags |= (1 << what)" below) */
+	FLAG_NOTRUNC = (1 << 0) * ENABLE_FEATURE_DD_IBS_OBS,
+	FLAG_SYNC    = (1 << 1) * ENABLE_FEATURE_DD_IBS_OBS,
+	FLAG_NOERROR = (1 << 2) * ENABLE_FEATURE_DD_IBS_OBS,
+	FLAG_FSYNC   = (1 << 3) * ENABLE_FEATURE_DD_IBS_OBS,
+	FLAG_SWAB    = (1 << 4) * ENABLE_FEATURE_DD_IBS_OBS,
+	/* end of conv flags */
+	FLAG_TWOBUFS = (1 << 5) * ENABLE_FEATURE_DD_IBS_OBS,
+	FLAG_COUNT   = 1 << 6,
+	FLAG_STATUS  = 1 << 7,
+	FLAG_STATUS_NONE = 1 << 7,
+	FLAG_STATUS_NOXFER = 1 << 8,
+};
 
 static void dd_output_status(int UNUSED_PARAM cur_signal)
 {
@@ -93,6 +144,13 @@ static void dd_output_status(int UNUSED_
 			G.out_full, G.out_part);
 
 #if ENABLE_FEATURE_DD_THIRD_STATUS_LINE
+# if ENABLE_FEATURE_DD_STATUS
+	if (G.flags & FLAG_STATUS_NOXFER) /* status=noxfer active? */
+		return;
+	//TODO: should status=none make dd stop reacting to USR1 entirely?
+	//So far we react to it (we print the stats),
+	//status=none only suppresses final, non-USR1 generated status message.
+# endif
 	fprintf(stderr, "%llu bytes (%sB) copied, ",
 			G.total_bytes,
 			/* show fractional digit, use suffixes */
@@ -148,20 +206,8 @@ static bool write_and_stats(const void *
 int dd_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
 int dd_main(int argc UNUSED_PARAM, char **argv)
 {
-	enum {
-		/* Must be in the same order as OP_conv_XXX! */
-		/* (see "flags |= (1 << what)" below) */
-		FLAG_NOTRUNC = (1 << 0) * ENABLE_FEATURE_DD_IBS_OBS,
-		FLAG_SYNC    = (1 << 1) * ENABLE_FEATURE_DD_IBS_OBS,
-		FLAG_NOERROR = (1 << 2) * ENABLE_FEATURE_DD_IBS_OBS,
-		FLAG_FSYNC   = (1 << 3) * ENABLE_FEATURE_DD_IBS_OBS,
-		FLAG_SWAB    = (1 << 4) * ENABLE_FEATURE_DD_IBS_OBS,
-		/* end of conv flags */
-		FLAG_TWOBUFS = (1 << 5) * ENABLE_FEATURE_DD_IBS_OBS,
-		FLAG_COUNT   = 1 << 6,
-	};
 	static const char keywords[] ALIGN1 =
-		"bs\0""count\0""seek\0""skip\0""if\0""of\0"
+		"bs\0""count\0""seek\0""skip\0""if\0""of\0"IF_FEATURE_DD_STATUS("status\0")
 #if ENABLE_FEATURE_DD_IBS_OBS
 		"ibs\0""obs\0""conv\0"
 #endif
@@ -170,6 +216,10 @@ int dd_main(int argc UNUSED_PARAM, char
 	static const char conv_words[] ALIGN1 =
 		"notrunc\0""sync\0""noerror\0""fsync\0""swab\0";
 #endif
+#if ENABLE_FEATURE_DD_STATUS
+	static const char status_words[] ALIGN1 =
+		"none\0""noxfer\0";
+#endif
 	enum {
 		OP_bs = 0,
 		OP_count,
@@ -177,6 +227,7 @@ int dd_main(int argc UNUSED_PARAM, char
 		OP_skip,
 		OP_if,
 		OP_of,
+		IF_FEATURE_DD_STATUS(OP_status,)
 #if ENABLE_FEATURE_DD_IBS_OBS
 		OP_ibs,
 		OP_obs,
@@ -215,14 +266,12 @@ int dd_main(int argc UNUSED_PARAM, char
 #endif
 	/* These are all zeroed at once! */
 	struct {
-		int flags;
 		size_t oc;
 		ssize_t prev_read_size; /* for detecting swab failure */
 		off_t count;
 		off_t seek, skip;
 		const char *infile, *outfile;
 	} Z;
-#define flags   (Z.flags  )
 #define oc      (Z.oc     )
 #define prev_read_size (Z.prev_read_size)
 #define count   (Z.count  )
@@ -258,11 +307,11 @@ int dd_main(int argc UNUSED_PARAM, char
 #if ENABLE_FEATURE_DD_IBS_OBS
 		if (what == OP_ibs) {
 			/* Must fit into positive ssize_t */
-			ibs = xatoul_range_sfx(val, 1, ((size_t)-1L)/2, dd_suffixes);
+			ibs = xatoul_range_sfx(val, 1, ((size_t)-1L)/2, cwbkMG_suffixes);
 			/*continue;*/
 		}
 		if (what == OP_obs) {
-			obs = xatoul_range_sfx(val, 1, ((size_t)-1L)/2, dd_suffixes);
+			obs = xatoul_range_sfx(val, 1, ((size_t)-1L)/2, cwbkMG_suffixes);
 			/*continue;*/
 		}
 		if (what == OP_conv) {
@@ -278,7 +327,7 @@ int dd_main(int argc UNUSED_PARAM, char
 				n = index_in_strings(conv_words, val);
 				if (n < 0)
 					bb_error_msg_and_die(bb_msg_invalid_arg, val, "conv");
-				flags |= (1 << n);
+				G.flags |= (1 << n);
 				if (!arg) /* no ',' left, so this was the last specifier */
 					break;
 				/* *arg = ','; - to preserve ps listing? */
@@ -288,22 +337,22 @@ int dd_main(int argc UNUSED_PARAM, char
 		}
 #endif
 		if (what == OP_bs) {
-			ibs = xatoul_range_sfx(val, 1, ((size_t)-1L)/2, dd_suffixes);
+			ibs = xatoul_range_sfx(val, 1, ((size_t)-1L)/2, cwbkMG_suffixes);
 			obs = ibs;
 			/*continue;*/
 		}
 		/* These can be large: */
 		if (what == OP_count) {
-			flags |= FLAG_COUNT;
-			count = XATOU_SFX(val, dd_suffixes);
+			G.flags |= FLAG_COUNT;
+			count = XATOU_SFX(val, cwbkMG_suffixes);
 			/*continue;*/
 		}
 		if (what == OP_seek) {
-			seek = XATOU_SFX(val, dd_suffixes);
+			seek = XATOU_SFX(val, cwbkMG_suffixes);
 			/*continue;*/
 		}
 		if (what == OP_skip) {
-			skip = XATOU_SFX(val, dd_suffixes);
+			skip = XATOU_SFX(val, cwbkMG_suffixes);
 			/*continue;*/
 		}
 		if (what == OP_if) {
@@ -314,6 +363,16 @@ int dd_main(int argc UNUSED_PARAM, char
 			outfile = val;
 			/*continue;*/
 		}
+#if ENABLE_FEATURE_DD_STATUS
+		if (what == OP_status) {
+			int n;
+			n = index_in_strings(status_words, val);
+			if (n < 0)
+				bb_error_msg_and_die(bb_msg_invalid_arg, val, "status");
+			G.flags |= FLAG_STATUS << n;
+			/*continue;*/
+		}
+#endif
 	} /* end of "for (argv[i])" */
 
 //XXX:FIXME for huge ibs or obs, malloc'ing them isn't the brightest idea ever
@@ -321,7 +380,7 @@ int dd_main(int argc UNUSED_PARAM, char
 	obuf = ibuf;
 #if ENABLE_FEATURE_DD_IBS_OBS
 	if (ibs != obs) {
-		flags |= FLAG_TWOBUFS;
+		G.flags |= FLAG_TWOBUFS;
 		obuf = xmalloc(obs);
 	}
 #endif
@@ -341,12 +400,12 @@ int dd_main(int argc UNUSED_PARAM, char
 	if (outfile) {
 		int oflag = O_WRONLY | O_CREAT;
 
-		if (!seek && !(flags & FLAG_NOTRUNC))
+		if (!seek && !(G.flags & FLAG_NOTRUNC))
 			oflag |= O_TRUNC;
 
 		xmove_fd(xopen(outfile, oflag), ofd);
 
-		if (seek && !(flags & FLAG_NOTRUNC)) {
+		if (seek && !(G.flags & FLAG_NOTRUNC)) {
 			if (ftruncate(ofd, seek * obs) < 0) {
 				struct stat st;
 
@@ -377,7 +436,7 @@ int dd_main(int argc UNUSED_PARAM, char
 			goto die_outfile;
 	}
 
-	while (!(flags & FLAG_COUNT) || (G.in_full + G.in_part != count)) {
+	while (!(G.flags & FLAG_COUNT) || (G.in_full + G.in_part != count)) {
 		ssize_t n;
 
 		n = safe_read(ifd, ibuf, ibs);
@@ -385,7 +444,7 @@ int dd_main(int argc UNUSED_PARAM, char
 			break;
 		if (n < 0) {
 			/* "Bad block" */
-			if (!(flags & FLAG_NOERROR))
+			if (!(G.flags & FLAG_NOERROR))
 				goto die_infile;
 			bb_simple_perror_msg(infile);
 			/* GNU dd with conv=noerror skips over bad blocks */
@@ -394,7 +453,7 @@ int dd_main(int argc UNUSED_PARAM, char
 			 * conv=noerror just ignores input bad blocks */
 			n = 0;
 		}
-		if (flags & FLAG_SWAB) {
+		if (G.flags & FLAG_SWAB) {
 			uint16_t *p16;
 			ssize_t n2;
 
@@ -419,12 +478,12 @@ int dd_main(int argc UNUSED_PARAM, char
 			G.in_full++;
 		else {
 			G.in_part++;
-			if (flags & FLAG_SYNC) {
+			if (G.flags & FLAG_SYNC) {
 				memset(ibuf + n, 0, ibs - n);
 				n = ibs;
 			}
 		}
-		if (flags & FLAG_TWOBUFS) {
+		if (G.flags & FLAG_TWOBUFS) {
 			char *tmp = ibuf;
 			while (n) {
 				size_t d = obs - oc;
@@ -446,7 +505,7 @@ int dd_main(int argc UNUSED_PARAM, char
 				goto out_status;
 		}
 
-		if (flags & FLAG_FSYNC) {
+		if (G.flags & FLAG_FSYNC) {
 			if (fsync(ofd) < 0)
 				goto die_outfile;
 		}
@@ -468,11 +527,12 @@ int dd_main(int argc UNUSED_PARAM, char
 
 	exitcode = EXIT_SUCCESS;
  out_status:
-	dd_output_status(0);
+	if (!ENABLE_FEATURE_DD_STATUS || !(G.flags & FLAG_STATUS_NONE))
+		dd_output_status(0);
 
 	if (ENABLE_FEATURE_CLEAN_UP) {
 		free(obuf);
-		if (flags & FLAG_TWOBUFS)
+		if (G.flags & FLAG_TWOBUFS)
 			free(ibuf);
 	}
 
diff -Nurp busybox.old/coreutils/false.c busybox/coreutils/false.c
--- busybox.old/coreutils/false.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/coreutils/false.c	2015-05-29 07:00:58.112592480 +0800
@@ -10,11 +10,9 @@
 /* BB_AUDIT SUSv3 compliant */
 /* http://www.opengroup.org/onlinepubs/000095399/utilities/false.html */
 
-//usage:#define false_trivial_usage
-//usage:       ""
-//usage:#define false_full_usage "\n\n"
-//usage:       "Return an exit code of FALSE (1)"
-//usage:
+/* "false --help" is special-cased to ignore --help */
+//usage:#define false_trivial_usage NOUSAGE_STR
+//usage:#define false_full_usage ""
 //usage:#define false_example_usage
 //usage:       "$ false\n"
 //usage:       "$ echo $?\n"
diff -Nurp busybox.old/coreutils/ls.c busybox/coreutils/ls.c
--- busybox.old/coreutils/ls.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/coreutils/ls.c	2015-05-29 07:00:58.112592480 +0800
@@ -566,12 +566,12 @@ static NOINLINE unsigned display_single(
 #if ENABLE_FEATURE_LS_TIMESTAMPS
 	if (G.all_fmt & (LIST_FULLTIME|LIST_DATE_TIME)) {
 		char *filetime;
-		time_t ttime = dn->dn_mtime;
+		const time_t *ttime = &dn->dn_mtime;
 		if (G.all_fmt & TIME_ACCESS)
-			ttime = dn->dn_atime;
+			ttime = &dn->dn_atime;
 		if (G.all_fmt & TIME_CHANGE)
-			ttime = dn->dn_ctime;
-		filetime = ctime(&ttime);
+			ttime = &dn->dn_ctime;
+		filetime = ctime(ttime);
 		/* filetime's format: "Wed Jun 30 21:49:08 1993\n" */
 		if (G.all_fmt & LIST_FULLTIME) { /* -e */
 			/* Note: coreutils 8.4 ls --full-time prints:
@@ -580,13 +580,16 @@ static NOINLINE unsigned display_single(
 			column += printf("%.24s ", filetime);
 		} else { /* LIST_DATE_TIME */
 			/* G.current_time_t ~== time(NULL) */
-			time_t age = G.current_time_t - ttime;
-			printf("%.6s ", filetime + 4); /* "Jun 30" */
+			time_t age = G.current_time_t - *ttime;
 			if (age < 3600L * 24 * 365 / 2 && age > -15 * 60) {
-				/* hh:mm if less than 6 months old */
-				printf("%.5s ", filetime + 11);
-			} else { /* year. buggy if year > 9999 ;) */
-				printf(" %.4s ", filetime + 20);
+				/* less than 6 months old */
+				/* "mmm dd hh:mm " */
+				printf("%.12s ", filetime + 4);
+			} else {
+				/* "mmm dd  yyyy " */
+				/* "mmm dd yyyyy " after year 9999 :) */
+				strchr(filetime + 20, '\n')[0] = ' ';
+				printf("%.7s%6s", filetime + 4, filetime + 20);
 			}
 			column += 13;
 		}
diff -Nurp busybox.old/coreutils/od_bloaty.c busybox/coreutils/od_bloaty.c
--- busybox.old/coreutils/od_bloaty.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/coreutils/od_bloaty.c	2015-05-29 07:00:58.112592480 +0800
@@ -387,11 +387,11 @@ print_named_ascii(size_t n_bytes, const
 		" sp"
 	};
 	// buf[N] pos:  01234 56789
-	char buf[12] = "   x\0 0xx\0";
-	// actually "   x\0 xxx\0", but want to share string with print_ascii.
+	char buf[12] = "   x\0 xxx\0";
 	// [12] because we take three 32bit stack slots anyway, and
 	// gcc is too dumb to initialize with constant stores,
 	// it copies initializer from rodata. Oh well.
+	// https://gcc.gnu.org/bugzilla/show_bug.cgi?id=65410
 
 	while (n_bytes--) {
 		unsigned masked_c = *(unsigned char *) block++;
@@ -419,7 +419,7 @@ print_ascii(size_t n_bytes, const char *
 		const char *unused_fmt_string UNUSED_PARAM)
 {
 	// buf[N] pos:  01234 56789
-	char buf[12] = "   x\0 0xx\0";
+	char buf[12] = "   x\0 xxx\0";
 
 	while (n_bytes--) {
 		const char *s;
@@ -455,11 +455,9 @@ print_ascii(size_t n_bytes, const char *
 		case '\v':
 			s = "  \\v";
 			break;
-		case '\x7f':
-			s = " 177";
-			break;
-		default: /* c is never larger than 040 */
-			buf[7] = (c >> 3) + '0';
+		default:
+			buf[6] = (c >> 6 & 3) + '0';
+			buf[7] = (c >> 3 & 7) + '0';
 			buf[8] = (c & 7) + '0';
 			s = buf + 5;
 		}
diff -Nurp busybox.old/coreutils/stat.c busybox/coreutils/stat.c
--- busybox.old/coreutils/stat.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/coreutils/stat.c	2015-05-29 07:00:58.115925813 +0800
@@ -374,7 +374,7 @@ static void print_it(const char *masterf
 {
 	/* Create a working copy of the format string */
 	char *format = xstrdup(masterformat);
-	/* Add 2 to accomodate our conversion of the stat '%s' format string
+	/* Add 2 to accommodate our conversion of the stat '%s' format string
 	 * to the printf '%llu' one.  */
 	char *dest = xmalloc(strlen(format) + 2 + 1);
 	char *b;
diff -Nurp busybox.old/coreutils/test.c busybox/coreutils/test.c
--- busybox.old/coreutils/test.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/coreutils/test.c	2015-05-29 07:00:58.115925813 +0800
@@ -39,14 +39,9 @@
 //config:	help
 //config:	  Enable 64-bit support in test.
 
-/* "test --help" does not print help (POSIX compat), only "[ --help" does.
- * We display "<applet> EXPRESSION ]" here (not "<applet> EXPRESSION")
- * Unfortunately, it screws up generated BusyBox.html. TODO. */
-//usage:#define test_trivial_usage
-//usage:       "EXPRESSION ]"
-//usage:#define test_full_usage "\n\n"
-//usage:       "Check file types, compare values etc. Return a 0/1 exit code\n"
-//usage:       "depending on logical value of EXPRESSION"
+/* "test --help" is special-cased to ignore --help */
+//usage:#define test_trivial_usage NOUSAGE_STR
+//usage:#define test_full_usage ""
 //usage:
 //usage:#define test_example_usage
 //usage:       "$ test 1 -eq 2\n"
diff -Nurp busybox.old/coreutils/true.c busybox/coreutils/true.c
--- busybox.old/coreutils/true.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/coreutils/true.c	2015-05-29 07:00:58.115925813 +0800
@@ -10,11 +10,9 @@
 /* BB_AUDIT SUSv3 compliant */
 /* http://www.opengroup.org/onlinepubs/007904975/utilities/true.html */
 
-//usage:#define true_trivial_usage
-//usage:       ""
-//usage:#define true_full_usage "\n\n"
-//usage:       "Return an exit code of TRUE (0)"
-//usage:
+/* "true --help" is special-cased to ignore --help */
+//usage:#define true_trivial_usage NOUSAGE_STR
+//usage:#define true_full_usage ""
 //usage:#define true_example_usage
 //usage:       "$ true\n"
 //usage:       "$ echo $?\n"
diff -Nurp busybox.old/coreutils/truncate.c busybox/coreutils/truncate.c
--- busybox.old/coreutils/truncate.c	1970-01-01 08:00:00.000000000 +0800
+++ busybox/coreutils/truncate.c	2015-05-29 07:00:58.115925813 +0800
@@ -0,0 +1,87 @@
+/*
+ * Mini truncate implementation for busybox
+ *
+ * Copyright (C) 2015 by Ari Sundholm <ari@tuxera.com>
+ *
+ * Licensed under GPLv2 or later, see file LICENSE in this source tree.
+ */
+
+//config:config TRUNCATE
+//config:	bool "truncate"
+//config:	default y
+//config:	help
+//config:	  truncate truncates files to a given size. If a file does
+//config:	  not exist, it is created unless told otherwise.
+
+//kbuild:lib-$(CONFIG_TRUNCATE) += truncate.o
+//applet:IF_TRUNCATE(APPLET_NOFORK(truncate, truncate, BB_DIR_USR_BIN, BB_SUID_DROP, truncate))
+
+//usage:#define truncate_trivial_usage
+//usage:       "[-c] -s SIZE FILE..."
+//usage:#define truncate_full_usage "\n\n"
+//usage:	"Truncate FILEs to the given size\n"
+//usage:	"\n	-c	Do not create files"
+//usage:	"\n	-s SIZE	Truncate to SIZE"
+//usage:
+//usage:#define truncate_example_usage
+//usage:	"$ truncate -s 1G foo"
+
+#include "libbb.h"
+
+#if ENABLE_LFS
+# define XATOU_SFX xatoull_sfx
+#else
+# define XATOU_SFX xatoul_sfx
+#endif
+
+/* This is a NOFORK applet. Be very careful! */
+
+int truncate_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
+int truncate_main(int argc UNUSED_PARAM, char **argv)
+{
+	unsigned opts;
+	int flags = O_RDWR;
+	int ret = EXIT_SUCCESS;
+	char *size_str;
+	off_t size;
+
+	enum {
+		OPT_NOCREATE  = (1 << 0),
+		OPT_SIZE = (1 << 1),
+	};
+
+	opt_complementary = "s:-1";
+	opts = getopt32(argv, "cs:", &size_str);
+
+	if (!(opts & OPT_NOCREATE))
+		flags |= O_CREAT;
+
+	// TODO: coreutils 8.17 also support "m" (lowercase) suffix
+	// with truncate, but not with dd!
+	// We share kMG_suffixes[], so we can't make both tools
+	// compatible at once...
+	size = XATOU_SFX(size_str, kMG_suffixes);
+
+	argv += optind;
+	while (*argv) {
+		int fd = open(*argv, flags);
+		if (fd < 0) {
+			if (errno != ENOENT || !(opts & OPT_NOCREATE)) {
+				bb_perror_msg("%s: open", *argv);
+				ret = EXIT_FAILURE;
+			}
+			/* else: ENOENT && OPT_NOCREATE:
+			 * do not report error, exitcode is also 0.
+			 */
+		} else {
+			if (ftruncate(fd, size) == -1) {
+				bb_perror_msg("%s: truncate", *argv);
+				ret = EXIT_FAILURE;
+			}
+			xclose(fd);
+		}
+		++argv;
+	}
+
+	return ret;
+}
diff -Nurp busybox.old/coreutils/uudecode.c busybox/coreutils/uudecode.c
--- busybox.old/coreutils/uudecode.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/coreutils/uudecode.c	2015-05-29 07:00:58.115925813 +0800
@@ -46,7 +46,7 @@ static void FAST_FUNC read_stduu(FILE *s
 
 		encoded_len = line[0] * 4 / 3;
 		/* Check that line is not too short. (we tolerate
-		 * overly _long_ line to accomodate possible extra '`').
+		 * overly _long_ line to accommodate possible extra '`').
 		 * Empty line case is also caught here. */
 		if (str_len <= encoded_len) {
 			break; /* go to bb_error_msg_and_die("short file"); */
@@ -110,10 +110,10 @@ int uudecode_main(int argc UNUSED_PARAM,
 		FILE *dst_stream;
 		int mode;
 
-		if (strncmp(line, "begin-base64 ", 13) == 0) {
+		if (is_prefixed_with(line, "begin-base64 ")) {
 			line_ptr = line + 13;
 			decode_fn_ptr = read_base64;
-		} else if (strncmp(line, "begin ", 6) == 0) {
+		} else if (is_prefixed_with(line, "begin ")) {
 			line_ptr = line + 6;
 			decode_fn_ptr = read_stduu;
 		} else {
diff -Nurp busybox.old/coreutils/who.c busybox/coreutils/who.c
--- busybox.old/coreutils/who.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/coreutils/who.c	2015-05-29 07:00:58.115925813 +0800
@@ -73,7 +73,7 @@ static void idle_string(char *str6, time
 int who_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
 int who_main(int argc UNUSED_PARAM, char **argv)
 {
-	struct utmp *ut;
+	struct utmpx *ut;
 	unsigned opt;
 	int do_users = (ENABLE_USERS && (!ENABLE_WHO || applet_name[0] == 'u'));
 	const char *fmt = "%s";
@@ -83,8 +83,8 @@ int who_main(int argc UNUSED_PARAM, char
 	if (opt & 2) // -H
 		printf("USER\t\tTTY\t\tIDLE\tTIME\t\t HOST\n");
 
-	setutent();
-	while ((ut = getutent()) != NULL) {
+	setutxent();
+	while ((ut = getutxent()) != NULL) {
 		if (ut->ut_user[0]
 		 && ((opt & 1) || ut->ut_type == USER_PROCESS)
 		) {
@@ -126,6 +126,6 @@ int who_main(int argc UNUSED_PARAM, char
 	if (do_users)
 		bb_putchar('\n');
 	if (ENABLE_FEATURE_CLEAN_UP)
-		endutent();
+		endutxent();
 	return EXIT_SUCCESS;
 }
diff -Nurp busybox.old/docs/cgi/env.html busybox/docs/cgi/env.html
--- busybox.old/docs/cgi/env.html	2015-03-23 11:06:55.000000000 +0800
+++ busybox/docs/cgi/env.html	2015-05-29 07:00:58.119259147 +0800
@@ -38,7 +38,7 @@ fulfilled by the gateway program: <p>
 
 </p><ul>
 <li> <a name="protocol"><code>SERVER_PROTOCOL</code></a> <p>
-    The name and revision of the information protcol this request came
+    The name and revision of the information protocol this request came
     in with. Format: protocol/revision </p><p>
 
 </p></li><li> <code>SERVER_PORT</code>  <p>
diff -Nurp busybox.old/e2fsprogs/fsck.c busybox/e2fsprogs/fsck.c
--- busybox.old/e2fsprogs/fsck.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/e2fsprogs/fsck.c	2015-05-29 07:00:58.122592481 +0800
@@ -199,7 +199,7 @@ static char *base_device(const char *dev
 	}
 
 	/* Handle DAC 960 devices */
-	if (strncmp(cp, "rd/", 3) == 0) {
+	if (is_prefixed_with(cp, "rd/")) {
 		cp += 3;
 		if (cp[0] != 'c' || !isdigit(cp[1])
 		 || cp[2] != 'd' || !isdigit(cp[3]))
@@ -224,9 +224,9 @@ static char *base_device(const char *dev
 #if ENABLE_FEATURE_DEVFS
 	/* Now let's handle devfs (ugh) names */
 	len = 0;
-	if (strncmp(cp, "ide/", 4) == 0)
+	if (is_prefixed_with(cp, "ide/"))
 		len = 4;
-	if (strncmp(cp, "scsi/", 5) == 0)
+	if (is_prefixed_with(cp, "scsi/"))
 		len = 5;
 	if (len) {
 		cp += len;
@@ -237,38 +237,38 @@ static char *base_device(const char *dev
 		 * some number of digits at each level, abort.
 		 */
 		for (hier = devfs_hier; *hier; hier++) {
-			len = strlen(*hier);
-			if (strncmp(cp, *hier, len) != 0)
+			cp = is_prefixed_with(cp, *hier);
+			if (!cp)
 				goto errout;
-			cp += len;
-			while (*cp != '/' && *cp != 0) {
+			while (*cp != '/' && *cp != '\0') {
 				if (!isdigit(*cp))
 					goto errout;
 				cp++;
 			}
+//FIXME: what if *cp = '\0' now? cp++ moves past it!!!
 			cp++;
 		}
-		cp[-1] = 0;
+		cp[-1] = '\0';
 		return str;
 	}
 
 	/* Now handle devfs /dev/disc or /dev/disk names */
-	disk = 0;
-	if (strncmp(cp, "discs/", 6) == 0)
+	disk = NULL;
+	if (is_prefixed_with(cp, "discs/"))
 		disk = "disc";
-	else if (strncmp(cp, "disks/", 6) == 0)
+	else if (is_prefixed_with(cp, "disks/"))
 		disk = "disk";
 	if (disk) {
 		cp += 6;
-		if (strncmp(cp, disk, 4) != 0)
+		cp = is_prefixed_with(cp, disk);
+		if (!cp)
 			goto errout;
-		cp += 4;
-		while (*cp != '/' && *cp != 0) {
+		while (*cp != '/' && *cp != '\0') {
 			if (!isdigit(*cp))
 				goto errout;
 			cp++;
 		}
-		*cp = 0;
+		*cp = '\0';
 		return str;
 	}
 #endif
@@ -593,8 +593,8 @@ static void fsck_device(struct fs_info *
 					type, "from fstab");
 	} else if (fstype
 	 && (fstype[0] != 'n' || fstype[1] != 'o') /* != "no" */
-	 && strncmp(fstype, "opts=", 5) != 0
-	 && strncmp(fstype, "loop", 4) != 0
+	 && !is_prefixed_with(fstype, "opts=")
+	 && !is_prefixed_with(fstype, "loop")
 	 && !strchr(fstype, ',')
 	) {
 		type = fstype;
@@ -627,8 +627,8 @@ static int device_already_active(char *d
 #ifdef BASE_MD
 	/* Don't check a soft raid disk with any other disk */
 	if (instance_list
-	 && (!strncmp(instance_list->device, BASE_MD, sizeof(BASE_MD)-1)
-	     || !strncmp(device, BASE_MD, sizeof(BASE_MD)-1))
+	 && (is_prefixed_with(instance_list->device, BASE_MD)
+	     || is_prefixed_with(device, BASE_MD))
 	) {
 		return 1;
 	}
@@ -895,7 +895,7 @@ static void compile_fs_type(char *fs_typ
 		if (strcmp(s, "loop") == 0)
 			/* loop is really short-hand for opts=loop */
 			goto loop_special_case;
-		if (strncmp(s, "opts=", 5) == 0) {
+		if (is_prefixed_with(s, "opts=")) {
 			s += 5;
  loop_special_case:
 			fs_type_flag[num] = negate ? FS_TYPE_FLAG_NEGOPT : FS_TYPE_FLAG_OPT;
diff -Nurp busybox.old/e2fsprogs/old_e2fsprogs/blkid/dev.c busybox/e2fsprogs/old_e2fsprogs/blkid/dev.c
--- busybox.old/e2fsprogs/old_e2fsprogs/blkid/dev.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/e2fsprogs/old_e2fsprogs/blkid/dev.c	2015-05-29 07:00:58.122592481 +0800
@@ -90,7 +90,7 @@ void blkid_debug_dump_dev(blkid_dev dev)
  *
  * These routines do not expose the list.h implementation, which are a
  * contamination of the namespace, and which force us to reveal far, far
- * too much of our internal implemenation.  I'm not convinced I want
+ * too much of our internal implementation.  I'm not convinced I want
  * to keep list.h in the long term, anyway.  It's fine for kernel
  * programming, but performance is not the #1 priority for this
  * library, and I really don't like the tradeoff of type-safety for
diff -Nurp busybox.old/e2fsprogs/old_e2fsprogs/blkid/tag.c busybox/e2fsprogs/old_e2fsprogs/blkid/tag.c
--- busybox.old/e2fsprogs/old_e2fsprogs/blkid/tag.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/e2fsprogs/old_e2fsprogs/blkid/tag.c	2015-05-29 07:00:58.125925814 +0800
@@ -230,7 +230,7 @@ errout:
  *
  * These routines do not expose the list.h implementation, which are a
  * contamination of the namespace, and which force us to reveal far, far
- * too much of our internal implemenation.  I'm not convinced I want
+ * too much of our internal implementation.  I'm not convinced I want
  * to keep list.h in the long term, anyway.  It's fine for kernel
  * programming, but performance is not the #1 priority for this
  * library, and I really don't like the tradeoff of type-safety for
diff -Nurp busybox.old/e2fsprogs/old_e2fsprogs/e2fsck.c busybox/e2fsprogs/old_e2fsprogs/e2fsck.c
--- busybox.old/e2fsprogs/old_e2fsprogs/e2fsck.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/e2fsprogs/old_e2fsprogs/e2fsck.c	2015-05-29 07:00:58.129259147 +0800
@@ -6381,7 +6381,7 @@ static int deallocate_inode_block(ext2_f
 }
 
 /*
- * This fuction deallocates an inode
+ * This function deallocates an inode
  */
 static void deallocate_inode(e2fsck_t ctx, ext2_ino_t ino, char* block_buf)
 {
@@ -6447,7 +6447,7 @@ static void deallocate_inode(e2fsck_t ct
 }
 
 /*
- * This fuction clears the htree flag on an inode
+ * This function clears the htree flag on an inode
  */
 static void clear_htree(e2fsck_t ctx, ext2_ino_t ino)
 {
@@ -11462,7 +11462,7 @@ static int release_inode_blocks(e2fsck_t
 			count = 1;
 		}
 		if (retval) {
-			bb_error_msg(_("while calling ext2fs_adjust_ea_refocunt for inode %d"),
+			bb_error_msg(_("while calling ext2fs_adjust_ea_refcount for inode %d"),
 				ino);
 			return 1;
 		}
diff -Nurp busybox.old/editors/diff.c busybox/editors/diff.c
--- busybox.old/editors/diff.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/editors/diff.c	2015-05-29 07:00:58.155925814 +0800
@@ -363,7 +363,7 @@ static void stone(const int *a, int n, c
 }
 
 struct line {
-	/* 'serial' is not used in the begining, so we reuse it
+	/* 'serial' is not used in the beginning, so we reuse it
 	 * to store line offsets, thus reducing memory pressure
 	 */
 	union {
@@ -740,9 +740,10 @@ static int diffreg(char *file[2])
 			unlink(name);
 			if (bb_copyfd_eof(fd, fd_tmp) < 0)
 				xfunc_die();
-			if (fd) /* Prevents closing of stdin */
+			if (fd != STDIN_FILENO)
 				close(fd);
 			fd = fd_tmp;
+			xlseek(fd, 0, SEEK_SET);
 		}
 		fp[i] = fdopen(fd, "r");
 	}
diff -Nurp busybox.old/editors/patch.c busybox/editors/patch.c
--- busybox.old/editors/patch.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/editors/patch.c	2015-05-29 07:00:58.155925814 +0800
@@ -345,6 +345,8 @@ done:
 // state 1: Found +++ file indicator, look for @@
 // state 2: In hunk: counting initial context lines
 // state 3: In hunk: getting body
+// Like GNU patch, we don't require a --- line before the +++, and
+// also allow the --- after the +++ line.
 
 int patch_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
 int patch_main(int argc UNUSED_PARAM, char **argv)
@@ -412,7 +414,7 @@ int patch_main(int argc UNUSED_PARAM, ch
 		}
 
 		// Open a new file?
-		if (!strncmp("--- ", patchline, 4) || !strncmp("+++ ", patchline, 4)) {
+		if (is_prefixed_with(patchline, "--- ") || is_prefixed_with(patchline, "+++ ")) {
 			char *s, **name = reverse ? &newname : &oldname;
 			int i;
 
@@ -444,7 +446,7 @@ int patch_main(int argc UNUSED_PARAM, ch
 
 		// Start a new hunk?  Usually @@ -oldline,oldlen +newline,newlen @@
 		// but a missing ,value means the value is 1.
-		} else if (state == 1 && !strncmp("@@ -", patchline, 4)) {
+		} else if (state == 1 && is_prefixed_with(patchline, "@@ -")) {
 			int i;
 			char *s = patchline+4;
 
@@ -462,6 +464,14 @@ int patch_main(int argc UNUSED_PARAM, ch
 			TT.context = 0;
 			state = 2;
 
+			// If the --- line is missing or malformed, either oldname
+			// or (for -R) newname could be NULL -- but not both.  Like
+			// GNU patch, proceed based on the +++ line, and avoid SEGVs.
+			if (!oldname)
+				oldname = xstrdup("MISSING_FILENAME");
+			if (!newname)
+				newname = xstrdup("MISSING_FILENAME");
+
 			// If this is the first hunk, open the file.
 			if (TT.filein == -1) {
 				int oldsum, newsum, empty = 0;
diff -Nurp busybox.old/editors/sed.c busybox/editors/sed.c
--- busybox.old/editors/sed.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/editors/sed.c	2015-05-29 07:00:58.155925814 +0800
@@ -53,6 +53,7 @@
  * Reference
  * http://www.opengroup.org/onlinepubs/007904975/utilities/sed.html
  * http://pubs.opengroup.org/onlinepubs/9699919799/utilities/sed.html
+ * http://sed.sourceforge.net/sedfaq3.html
  */
 
 //config:config SED
@@ -109,7 +110,8 @@ typedef struct sed_cmd_s {
 	regex_t *sub_match;     /* For 's/sub_match/string/' */
 	int beg_line;           /* 'sed 1p'   0 == apply commands to all lines */
 	int beg_line_orig;      /* copy of the above, needed for -i */
-	int end_line;           /* 'sed 1,3p' 0 == one line only. -1 = last line ($) */
+	int end_line;           /* 'sed 1,3p' 0 == one line only. -1 = last line ($). -2-N = +N */
+	int end_line_orig;
 
 	FILE *sw_file;          /* File (sw) command writes to, -1 for none. */
 	char *string;           /* Data string for (saicytb) commands. */
@@ -640,10 +642,29 @@ static void add_cmd(const char *cmdstr)
 			int idx;
 
 			cmdstr++;
-			idx = get_address(cmdstr, &sed_cmd->end_line, &sed_cmd->end_match);
-			if (!idx)
+			if (*cmdstr == '+' && isdigit(cmdstr[1])) {
+				/* http://sed.sourceforge.net/sedfaq3.html#s3.3
+				 * Under GNU sed 3.02+, ssed, and sed15+, <address2>
+				 * may also be a notation of the form +num,
+				 * indicating the next num lines after <address1> is
+				 * matched.
+				 * GNU sed 4.2.1 accepts even "+" (meaning "+0").
+				 * We don't (we check for isdigit, see above), think
+				 * about the "+-3" case.
+				 */
+				char *end;
+				/* code is smaller compared to using &cmdstr here: */
+				idx = strtol(cmdstr+1, &end, 10);
+				sed_cmd->end_line = -2 - idx;
+				cmdstr = end;
+			} else {
+				idx = get_address(cmdstr, &sed_cmd->end_line, &sed_cmd->end_match);
+				cmdstr += idx;
+				idx--; /* if 0, trigger error check below */
+			}
+			if (idx < 0)
 				bb_error_msg_and_die("no address after comma");
-			cmdstr += idx;
+			sed_cmd->end_line_orig = sed_cmd->end_line;
 		}
 
 		/* skip whitespace before the command */
@@ -1089,10 +1110,19 @@ static void process_files(void)
 		/* Is this line the end of the current match? */
 
 		if (matched) {
+			if (sed_cmd->end_line <= -2) {
+				/* address2 is +N, i.e. N lines from beg_line */
+				sed_cmd->end_line = linenum + (-sed_cmd->end_line - 2);
+			}
 			/* once matched, "n,xxx" range is dead, disabling it */
 			if (sed_cmd->beg_line > 0) {
 				sed_cmd->beg_line = -2;
 			}
+			dbg("end1:%d", sed_cmd->end_line ? sed_cmd->end_line == -1
+						? !next_line : (sed_cmd->end_line <= linenum)
+					: !sed_cmd->end_match);
+			dbg("end2:%d", sed_cmd->end_match && old_matched
+					&& !regexec(sed_cmd->end_match,pattern_space, 0, NULL, 0));
 			sed_cmd->in_match = !(
 				/* has the ending line come, or is this a single address command? */
 				(sed_cmd->end_line
@@ -1551,9 +1581,10 @@ int sed_main(int argc UNUSED_PARAM, char
 			free(G.outname);
 			G.outname = NULL;
 
-			/* Re-enable disabled range matches */
+			/* Fix disabled range matches and mangled ",+N" ranges */
 			for (sed_cmd = G.sed_cmd_head; sed_cmd; sed_cmd = sed_cmd->next) {
 				sed_cmd->beg_line = sed_cmd->beg_line_orig;
+				sed_cmd->end_line = sed_cmd->end_line_orig;
 			}
 		}
 		/* Here, to handle "sed 'cmds' nonexistent_file" case we did:
diff -Nurp busybox.old/editors/vi.c busybox/editors/vi.c
--- busybox.old/editors/vi.c	2015-03-23 11:07:18.000000000 +0800
+++ busybox/editors/vi.c	2015-05-29 07:00:58.159259147 +0800
@@ -501,7 +501,7 @@ static char *prev_line(char *);	// retur
 static char *next_line(char *);	// return pointer to next line B-o-l
 static char *end_screen(void);	// get pointer to last char on screen
 static int count_lines(char *, char *);	// count line from start to stop
-static char *find_line(int);	// find begining of line #li
+static char *find_line(int);	// find beginning of line #li
 static char *move_to_col(char *, int);	// move "p" to column l
 static void dot_left(void);	// move dot left- dont leave line
 static void dot_right(void);	// move dot right- dont leave line
@@ -1318,8 +1318,12 @@ static void colon(char *buf)
 			q = begin_line(dot);	// assume "dot"
 		}
 		// read after current line- unless user said ":0r foo"
-		if (b != 0)
+		if (b != 0) {
 			q = next_line(q);
+			// read after last line
+			if (q == end-1)
+				++q;
+		}
 		{ // dance around potentially-reallocated text[]
 			uintptr_t ofs = q - text;
 			size = file_insert(fn, q, 0);
@@ -1680,10 +1684,10 @@ static char *dollar_line(char *p) // ret
 
 static char *prev_line(char *p) // return pointer first char prev line
 {
-	p = begin_line(p);	// goto begining of cur line
+	p = begin_line(p);	// goto beginning of cur line
 	if (p > text && p[-1] == '\n')
 		p--;			// step to prev line
-	p = begin_line(p);	// goto begining of prev line
+	p = begin_line(p);	// goto beginning of prev line
 	return p;
 }
 
@@ -1731,7 +1735,7 @@ static int count_lines(char *start, char
 	return cnt;
 }
 
-static char *find_line(int li)	// find begining of line #li
+static char *find_line(int li)	// find beginning of line #li
 {
 	char *q;
 
@@ -2013,8 +2017,7 @@ static char *char_insert(char *p, char c
 			p--;
 		}
 	} else if (c == erase_char || c == 8 || c == 127) { // Is this a BS
-		//     123456789
-		if ((p[-1] != '\n') && (dot>text)) {
+		if (p > text) {
 			p--;
 			p = text_hole_delete(p, p, ALLOW_UNDO_QUEUED);	// shrink buffer 1 char
 		}
@@ -3354,7 +3357,7 @@ static void refresh(int full_screen)
 			tp = t + 1;
 		}
 
-		// see if there are any changes between vitual screen and out_buf
+		// see if there are any changes between virtual screen and out_buf
 		changed = FALSE;	// assume no change
 		cs = 0;
 		ce = columns - 1;
@@ -3391,7 +3394,7 @@ static void refresh(int full_screen)
 		if (cs < 0) cs = 0;
 		if (ce > columns - 1) ce = columns - 1;
 		if (cs > ce) { cs = 0; ce = columns - 1; }
-		// is there a change between vitual screen and out_buf
+		// is there a change between virtual screen and out_buf
 		if (changed) {
 			// copy changed part of buffer to virtual screen
 			memcpy(sp+cs, out_buf+cs, ce-cs+1);
@@ -3673,11 +3676,6 @@ static void do_cmd(int c)
 		string_insert(dot, p, ALLOW_UNDO);	// insert the string
 		end_cmd_q();	// stop adding to q
 		break;
-#if ENABLE_FEATURE_VI_UNDO
-	case 'u':	// u- undo last operation
-		undo_pop();
-		break;
-#endif
 	case 'U':			// U- Undo; replace current line with original version
 		if (reg[Ureg] != NULL) {
 			p = begin_line(dot);
@@ -3689,6 +3687,11 @@ static void do_cmd(int c)
 		}
 		break;
 #endif /* FEATURE_VI_YANKMARK */
+#if ENABLE_FEATURE_VI_UNDO
+	case 'u':	// u- undo last operation
+		undo_pop();
+		break;
+#endif
 	case '$':			// $- goto end of line
 	case KEYCODE_END:		// Cursor Key End
 		for (;;) {
@@ -3841,7 +3844,7 @@ static void do_cmd(int c)
 		}
 		break;
 #endif /* FEATURE_VI_SEARCH */
-	case '0':			// 0- goto begining of line
+	case '0':			// 0- goto beginning of line
 	case '1':			// 1-
 	case '2':			// 2-
 	case '3':			// 3-
@@ -4022,8 +4025,9 @@ static void do_cmd(int c)
 		undo_queue_commit();
 		break;
 	case KEYCODE_DELETE:
-		c = 'x';
-		// fall through
+		if (dot < end - 1)
+			dot = yank_delete(dot, dot, 1, YANKDEL, ALLOW_UNDO);
+		break;
 	case 'X':			// X- delete char before dot
 	case 'x':			// x- delete the current char
 	case 's':			// s- substitute the current char
diff -Nurp busybox.old/examples/android-build busybox/examples/android-build
--- busybox.old/examples/android-build	2015-03-23 11:06:55.000000000 +0800
+++ busybox/examples/android-build	2015-05-29 07:00:58.159259147 +0800
@@ -29,4 +29,6 @@ else
 	LDLIBS="dl m c gcc"
 fi
 
+# It's possible with newer version
+# you need to use CFLAGS_busybox instead of EXTRA_LDFLAGS below:
 make EXTRA_LDFLAGS="$LDFLAGS" LDLIBS="$LDLIBS" "$@"
diff -Nurp busybox.old/examples/mdev_fat.conf busybox/examples/mdev_fat.conf
--- busybox.old/examples/mdev_fat.conf	2015-03-23 11:07:18.000000000 +0800
+++ busybox/examples/mdev_fat.conf	2015-05-29 07:00:58.159259147 +0800
@@ -19,7 +19,7 @@
 # support module loading on hotplug
 $MODALIAS=.*	root:root 660 @modprobe "$MODALIAS"
 
-# null may already exist; therefore ownership has to be changed with command
+# null may already exist; therefore mode has to be changed with command
 null		root:root 666 @chmod 666 $MDEV
 zero		root:root 666
 full		root:root 666
@@ -31,7 +31,7 @@ grsec		root:root 660
 kmem		root:root 640
 mem		root:root 640
 port		root:root 640
-# console may already exist; therefore ownership has to be changed with command
+# console may already exist; therefore mode has to be changed with command
 console		root:tty 600 @chmod 600 $MDEV
 ptmx		root:tty 666
 pty.*		root:tty 660
@@ -63,6 +63,12 @@ control.*	root:audio 660 =snd/
 midi.*		root:audio 660 =snd/
 seq		root:audio 660 =snd/
 timer		root:audio 660 =snd/
+# for kernels/mdevs which expose full path of alsa devices:
+snd/pcm.*	root:audio 660
+snd/control.*	root:audio 660
+snd/midi.*	root:audio 660
+snd/seq		root:audio 660
+snd/timer	root:audio 660
 
 adsp		root:audio 660 >sound/
 audio		root:audio 660 >sound/
@@ -139,6 +145,6 @@ dahdi!(.*)	root:dialout 660 =dahdi/%1
 # We are hooking to the last events. To avoid having two scripts running,
 # we check for DISK_MEDIA_CHANGE=1 (prev to last event has it,
 # and it's the _only_ difference in env for these two events as of kernel 3.7.7)
-# Unfortunately, there is no event for "user pressed [Turn USB storage] btn"!
+# Unfortunately, there is no event for "user pressed [Turn USB storage on] btn"!
 # Script merely backgrounds and tries to rescan partition table for 1 minute:
 ACTION=change;SUBSYSTEM=block;DISK_MEDIA_CHANGE=1;.*    0:0 660 */etc/mdev.conf.change_blockdev.sh
diff -Nurp busybox.old/examples/var_service/ntpd/ntp.script busybox/examples/var_service/ntpd/ntp.script
--- busybox.old/examples/var_service/ntpd/ntp.script	2015-03-23 11:06:55.000000000 +0800
+++ busybox/examples/var_service/ntpd/ntp.script	2015-05-29 07:00:58.162592480 +0800
@@ -10,12 +10,30 @@
 
 dt=`date '+%Y-%m-%d %H:%M:%S'`
 
+echo "`tail -n 199 -- "$0.log" 2>/dev/null`" >"$0.log.$$"
+
+if test x"$1" = x"unsync" \
+; then
+	# No replies for our NTP requests were seen for some time.
+	#
+	# Among more mundate cases like network outages, this happens
+	# if we ran for a LONG time (days) and ntp server's IP has changed.
+	# ntpd has no code to re-resolve peers' addresses to IPs,
+	# we need to help it:
+	#
+	echo "$dt: $1"\
+		"syncronization lost, restarting ntpd"\
+		>>"$0.log.$$"
+	mv -- "$0.log.$$" "$0.log"
+	kill $PPID
+	exit
+fi
+
 if test x"$stratum" != x"" \
 && test x"$poll_interval" != x"" \
 && test 4 -ge "$stratum" \
 && test 128 -le "$poll_interval" \
 ; then
-	echo "`tail -n 199 -- "$0.log" 2>/dev/null`" >"$0.log.$$"
 	echo "$dt: $1"\
 		"freq_drift_ppm=$freq_drift_ppm"\
 		"offset=$offset"\
@@ -27,7 +45,6 @@ if test x"$stratum" != x"" \
 	exec hwclock --systohc
 fi
 
-echo "`tail -n 199 -- "$0.log" 2>/dev/null`" >"$0.log.$$"
 echo "$dt: $1"\
 	"freq_drift_ppm=$freq_drift_ppm"\
 	"offset=$offset"\
diff -Nurp busybox.old/findutils/xargs.c busybox/findutils/xargs.c
--- busybox.old/findutils/xargs.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/findutils/xargs.c	2015-05-29 07:00:58.165925813 +0800
@@ -151,7 +151,7 @@ static void store_param(char *s)
  * is seen, store the address of a new parameter to args[].
  * If reading discovers that last chars do not form the complete
  * parameter, the pointer to the first such "tail character" is returned.
- * (buf has extra byte at the end to accomodate terminating NUL
+ * (buf has extra byte at the end to accommodate terminating NUL
  * of "tail characters" string).
  * Otherwise, the returned pointer points to NUL byte.
  * On entry, buf[] may contain some "seed chars" which are to become
diff -Nurp busybox.old/include/applets.src.h busybox/include/applets.src.h
--- busybox.old/include/applets.src.h	2015-05-29 06:54:59.000000000 +0800
+++ busybox/include/applets.src.h	2015-05-29 07:00:58.165925813 +0800
@@ -211,7 +211,6 @@ IF_LN(APPLET_NOEXEC(ln, ln, BB_DIR_BIN,
 IF_LOAD_POLICY(APPLET(load_policy, BB_DIR_USR_SBIN, BB_SUID_DROP))
 IF_LOADFONT(APPLET(loadfont, BB_DIR_USR_SBIN, BB_SUID_DROP))
 IF_LOADKMAP(APPLET(loadkmap, BB_DIR_SBIN, BB_SUID_DROP))
-IF_LOCK(APPLET(lock, BB_DIR_BIN, BB_SUID_DROP))
 IF_LOGGER(APPLET(logger, BB_DIR_USR_BIN, BB_SUID_DROP))
 /* Needs to be run by root or be suid root - needs to change uid and gid: */
 IF_LOGIN(APPLET(login, BB_DIR_BIN, BB_SUID_REQUIRE))
@@ -255,7 +254,6 @@ IF_MT(APPLET(mt, BB_DIR_BIN, BB_SUID_DRO
 IF_MV(APPLET(mv, BB_DIR_BIN, BB_SUID_DROP))
 IF_NAMEIF(APPLET(nameif, BB_DIR_SBIN, BB_SUID_DROP))
 IF_NC(APPLET(nc, BB_DIR_USR_BIN, BB_SUID_DROP))
-IF_NETMSG(APPLET(netmsg, BB_DIR_BIN, BB_SUID_REQUIRE))
 IF_NETSTAT(APPLET(netstat, BB_DIR_BIN, BB_SUID_DROP))
 IF_NICE(APPLET(nice, BB_DIR_BIN, BB_SUID_DROP))
 IF_NOHUP(APPLET(nohup, BB_DIR_USR_BIN, BB_SUID_DROP))
diff -Nurp busybox.old/include/bb_archive.h busybox/include/bb_archive.h
--- busybox.old/include/bb_archive.h	2015-03-23 11:07:18.000000000 +0800
+++ busybox/include/bb_archive.h	2015-05-29 07:00:58.165925813 +0800
@@ -184,6 +184,7 @@ char get_header_tar(archive_handle_t *ar
 char get_header_tar_gz(archive_handle_t *archive_handle) FAST_FUNC;
 char get_header_tar_bz2(archive_handle_t *archive_handle) FAST_FUNC;
 char get_header_tar_lzma(archive_handle_t *archive_handle) FAST_FUNC;
+char get_header_tar_xz(archive_handle_t *archive_handle) FAST_FUNC;
 
 void seek_by_jump(int fd, off_t amount) FAST_FUNC;
 void seek_by_read(int fd, off_t amount) FAST_FUNC;
diff -Nurp busybox.old/include/grp_.h busybox/include/grp_.h
--- busybox.old/include/grp_.h	2015-03-23 11:07:19.000000000 +0800
+++ busybox/include/grp_.h	2015-05-29 07:00:58.165925813 +0800
@@ -30,89 +30,36 @@ PUSH_AND_SET_FUNCTION_VISIBILITY_TO_HIDD
  * so that function calls are directed to bb_internal_XXX replacements
  */
 #undef endgrent
-#define setgrent     bb_internal_setgrent
 #define endgrent     bb_internal_endgrent
-#define getgrent     bb_internal_getgrent
-#define fgetgrent    bb_internal_fgetgrent
-#define putgrent     bb_internal_putgrent
 #define getgrgid     bb_internal_getgrgid
 #define getgrnam     bb_internal_getgrnam
-#define getgrent_r   bb_internal_getgrent_r
-#define getgrgid_r   bb_internal_getgrgid_r
-#define getgrnam_r   bb_internal_getgrnam_r
-#define fgetgrent_r  bb_internal_fgetgrent_r
 #define getgrouplist bb_internal_getgrouplist
 #define initgroups   bb_internal_initgroups
 
-
 /* All function names below should be remapped by #defines above
  * in order to not collide with libc names. */
 
-
-/* Rewind the group-file stream.  */
-extern void setgrent(void);
-
 /* Close the group-file stream.  */
-extern void endgrent(void);
-
-#ifdef UNUSED_SINCE_WE_AVOID_STATIC_BUFS
-/* Read an entry from the group-file stream, opening it if necessary.  */
-extern struct group *getgrent(void);
-
-/* Read a group entry from STREAM.  */
-extern struct group *fgetgrent(FILE *__stream);
-
-/* Write the given entry onto the given stream.  */
-extern int putgrent(const struct group *__restrict __p,
-		FILE *__restrict __f);
-#endif
+void FAST_FUNC endgrent(void);
 
 /* Search for an entry with a matching group ID.  */
-extern struct group *getgrgid(gid_t __gid);
+struct group* FAST_FUNC getgrgid(gid_t __gid);
 
 /* Search for an entry with a matching group name.  */
-extern struct group *getgrnam(const char *__name);
-
-/* Reentrant versions of some of the functions above.
+struct group* FAST_FUNC getgrnam(const char *__name);
 
-   PLEASE NOTE: the `getgrent_r' function is not (yet) standardized.
-   The interface may change in later versions of this library.  But
-   the interface is designed following the principals used for the
-   other reentrant functions so the chances are good this is what the
-   POSIX people would choose.  */
-
-extern int getgrent_r(struct group *__restrict __resultbuf,
-		char *__restrict __buffer, size_t __buflen,
-		struct group **__restrict __result);
-
-/* Search for an entry with a matching group ID.  */
-extern int getgrgid_r(gid_t __gid, struct group *__restrict __resultbuf,
-		char *__restrict __buffer, size_t __buflen,
-		struct group **__restrict __result);
-
-/* Search for an entry with a matching group name.  */
-extern int getgrnam_r(const char *__restrict __name,
-		struct group *__restrict __resultbuf,
-		char *__restrict __buffer, size_t __buflen,
-		struct group **__restrict __result);
-
-/* Read a group entry from STREAM.  This function is not standardized
-   an probably never will.  */
-extern int fgetgrent_r(FILE *__restrict __stream,
-		struct group *__restrict __resultbuf,
-		char *__restrict __buffer, size_t __buflen,
-		struct group **__restrict __result);
+/* Reentrant versions of some of the functions above. */
 
 /* Store at most *NGROUPS members of the group set for USER into
    *GROUPS.  Also include GROUP.  The actual number of groups found is
    returned in *NGROUPS.  Return -1 if the if *NGROUPS is too small.  */
-extern int getgrouplist(const char *__user, gid_t __group,
+int FAST_FUNC getgrouplist(const char *__user, gid_t __group,
 		gid_t *__groups, int *__ngroups);
 
 /* Initialize the group set for the current user
    by reading the group database and using all groups
    of which USER is a member.  Also include GROUP.  */
-extern int initgroups(const char *__user, gid_t __group);
+int FAST_FUNC initgroups(const char *__user, gid_t __group);
 
 POP_SAVED_FUNCTION_VISIBILITY
 
diff -Nurp busybox.old/include/libbb.h busybox/include/libbb.h
--- busybox.old/include/libbb.h	2015-05-29 06:54:59.000000000 +0800
+++ busybox/include/libbb.h	2015-05-29 07:00:58.165925813 +0800
@@ -40,7 +40,6 @@
 #include <poll.h>
 #include <sys/ioctl.h>
 #include <sys/mman.h>
-#include <sys/resource.h>
 #include <sys/socket.h>
 #include <sys/stat.h>
 #include <sys/time.h>
@@ -85,7 +84,30 @@
 # include <selinux/av_permissions.h>
 #endif
 #if ENABLE_FEATURE_UTMP
-# include <utmp.h>
+# if defined __UCLIBC__ && ( \
+    (UCLIBC_VERSION >= KERNEL_VERSION(0, 9, 32) \
+     && UCLIBC_VERSION < KERNEL_VERSION(0, 9, 34) \
+     && defined __UCLIBC_HAS_UTMPX__ \
+    ) || ( \
+	 UCLIBC_VERSION >= KERNEL_VERSION(0, 9, 34) \
+	) \
+  )
+#  include <utmpx.h>
+# elif defined __UCLIBC__
+#  include <utmp.h>
+#  define utmpx utmp
+#  define setutxent setutent
+#  define endutxent endutent
+#  define getutxent getutent
+#  define getutxid getutid
+#  define getutxline getutline
+#  define pututxline pututline
+#  define utmpxname utmpname
+#  define updwtmpx updwtmp
+#  define _PATH_UTMPX _PATH_UTMP
+# else
+#  include <utmpx.h>
+# endif
 #endif
 #if ENABLE_LOCALE_SUPPORT
 # include <locale.h>
@@ -390,6 +412,7 @@ const char *bb_basename(const char *name
 /* NB: can violate const-ness (similarly to strchr) */
 char *last_char_is(const char *s, int c) FAST_FUNC;
 const char* endofname(const char *name) FAST_FUNC;
+char *is_prefixed_with(const char *string, const char *key) FAST_FUNC;
 
 int ndelay_on(int fd) FAST_FUNC;
 int ndelay_off(int fd) FAST_FUNC;
@@ -713,7 +736,7 @@ void* xrealloc_vector_helper(void *vecto
 
 
 extern ssize_t safe_read(int fd, void *buf, size_t count) FAST_FUNC;
-extern ssize_t nonblock_immune_read(int fd, void *buf, size_t count, int loop_on_EINTR) FAST_FUNC;
+extern ssize_t nonblock_immune_read(int fd, void *buf, size_t count) FAST_FUNC;
 // NB: will return short read on error, not -1,
 // if some data was read before error occurred
 extern ssize_t full_read(int fd, void *buf, size_t count) FAST_FUNC;
@@ -862,6 +885,8 @@ struct suffix_mult {
 };
 extern const struct suffix_mult bkm_suffixes[];
 #define km_suffixes (bkm_suffixes + 1)
+extern const struct suffix_mult cwbkMG_suffixes[];
+#define kMG_suffixes (cwbkMG_suffixes + 3)
 
 #include "xatonum.h"
 /* Specialized: */
@@ -922,9 +947,11 @@ void die_if_bad_username(const char* nam
 #if ENABLE_FEATURE_UTMP
 void FAST_FUNC write_new_utmp(pid_t pid, int new_type, const char *tty_name, const char *username, const char *hostname);
 void FAST_FUNC update_utmp(pid_t pid, int new_type, const char *tty_name, const char *username, const char *hostname);
+void FAST_FUNC update_utmp_DEAD_PROCESS(pid_t pid);
 #else
 # define write_new_utmp(pid, new_type, tty_name, username, hostname) ((void)0)
 # define update_utmp(pid, new_type, tty_name, username, hostname) ((void)0)
+# define update_utmp_DEAD_PROCESS(pid) ((void)0)
 #endif
 
 
diff -Nurp busybox.old/include/platform.h busybox/include/platform.h
--- busybox.old/include/platform.h	2015-03-23 11:07:19.000000000 +0800
+++ busybox/include/platform.h	2015-05-29 07:00:58.165925813 +0800
@@ -217,6 +217,7 @@ typedef uint64_t bb__aliased_uint64_t FI
  * a lvalue. This makes it more likely to not swap them by mistake
  */
 #if defined(i386) || defined(__x86_64__) || defined(__powerpc__)
+# define BB_UNALIGNED_MEMACCESS_OK 1
 # define move_from_unaligned_int(v, intp)  ((v) = *(bb__aliased_int*)(intp))
 # define move_from_unaligned_long(v, longp) ((v) = *(bb__aliased_long*)(longp))
 # define move_from_unaligned16(v, u16p) ((v) = *(bb__aliased_uint16_t*)(u16p))
@@ -225,6 +226,7 @@ typedef uint64_t bb__aliased_uint64_t FI
 # define move_to_unaligned32(u32p, v)   (*(bb__aliased_uint32_t*)(u32p) = (v))
 /* #elif ... - add your favorite arch today! */
 #else
+# define BB_UNALIGNED_MEMACCESS_OK 0
 /* performs reasonably well (gcc usually inlines memcpy here) */
 # define move_from_unaligned_int(v, intp) (memcpy(&(v), (intp), sizeof(int)))
 # define move_from_unaligned_long(v, longp) (memcpy(&(v), (longp), sizeof(long)))
@@ -366,10 +368,12 @@ typedef unsigned smalluint;
 #define HAVE_DPRINTF 1
 #define HAVE_MEMRCHR 1
 #define HAVE_MKDTEMP 1
+#define HAVE_TTYNAME_R 1
 #define HAVE_PTSNAME_R 1
 #define HAVE_SETBIT 1
 #define HAVE_SIGHANDLER_T 1
 #define HAVE_STPCPY 1
+#define HAVE_MEMPCPY 1
 #define HAVE_STRCASESTR 1
 #define HAVE_STRCHRNUL 1
 #define HAVE_STRSEP 1
@@ -450,6 +454,8 @@ typedef unsigned smalluint;
 #endif
 
 #if defined(__FreeBSD__)
+/* users say mempcpy is not present in FreeBSD 9.x */
+# undef HAVE_MEMPCPY
 # undef HAVE_CLEARENV
 # undef HAVE_FDATASYNC
 # undef HAVE_MNTENT_H
@@ -474,9 +480,17 @@ typedef unsigned smalluint;
 #endif
 
 #if defined(ANDROID) || defined(__ANDROID__)
-# undef HAVE_DPRINTF
-# undef HAVE_GETLINE
-# undef HAVE_STPCPY
+# if __ANDROID_API__ < 8
+#  undef HAVE_DPRINTF
+# else
+#  define dprintf fdprintf
+# endif
+# if __ANDROID_API__ < 21
+#  undef HAVE_TTYNAME_R
+#  undef HAVE_GETLINE
+#  undef HAVE_STPCPY
+# endif
+# undef HAVE_MEMPCPY
 # undef HAVE_STRCHRNUL
 # undef HAVE_STRVERSCMP
 # undef HAVE_UNLOCKED_LINE_OPS
@@ -500,6 +514,11 @@ extern void *memrchr(const void *s, int
 extern char *mkdtemp(char *template) FAST_FUNC;
 #endif
 
+#ifndef HAVE_TTYNAME_R
+#define ttyname_r bb_ttyname_r
+extern int ttyname_r(int fd, char *buf, size_t buflen);
+#endif
+
 #ifndef HAVE_SETBIT
 # define setbit(a, b)  ((a)[(b) >> 3] |= 1 << ((b) & 7))
 # define clrbit(a, b)  ((a)[(b) >> 3] &= ~(1 << ((b) & 7)))
@@ -513,6 +532,18 @@ typedef void (*sighandler_t)(int);
 extern char *stpcpy(char *p, const char *to_add) FAST_FUNC;
 #endif
 
+#ifndef HAVE_MEMPCPY
+#include <string.h>
+/* In case we are wrong about !HAVE_MEMPCPY, and toolchain _does_ have
+ * mempcpy(), avoid colliding with it:
+ */
+#define mempcpy bb__mempcpy
+static ALWAYS_INLINE void *mempcpy(void *dest, const void *src, size_t len)
+{
+	return memcpy(dest, src, len) + len;
+}
+#endif
+
 #ifndef HAVE_STRCASESTR
 extern char *strcasestr(const char *s, const char *pattern) FAST_FUNC;
 #endif
diff -Nurp busybox.old/include/pwd_.h busybox/include/pwd_.h
--- busybox.old/include/pwd_.h	2015-03-23 11:07:19.000000000 +0800
+++ busybox/include/pwd_.h	2015-05-29 07:00:58.165925813 +0800
@@ -34,69 +34,30 @@ PUSH_AND_SET_FUNCTION_VISIBILITY_TO_HIDD
 #define setpwent    bb_internal_setpwent
 #define endpwent    bb_internal_endpwent
 #define getpwent    bb_internal_getpwent
-#define fgetpwent   bb_internal_fgetpwent
-#define putpwent    bb_internal_putpwent
 #define getpwuid    bb_internal_getpwuid
 #define getpwnam    bb_internal_getpwnam
-#define getpwent_r  bb_internal_getpwent_r
-#define getpwuid_r  bb_internal_getpwuid_r
 #define getpwnam_r  bb_internal_getpwnam_r
-#define fgetpwent_r bb_internal_fgetpwent_r
-
 
 /* All function names below should be remapped by #defines above
  * in order to not collide with libc names. */
 
-
 /* Rewind the password-file stream.  */
-extern void setpwent(void);
+void FAST_FUNC setpwent(void);
 
 /* Close the password-file stream.  */
-extern void endpwent(void);
+void FAST_FUNC endpwent(void);
 
-#ifdef UNUSED_SINCE_WE_AVOID_STATIC_BUFS
 /* Read an entry from the password-file stream, opening it if necessary.  */
-extern struct passwd *getpwent(void);
-
-/* Read an entry from STREAM.  */
-extern struct passwd *fgetpwent(FILE *__stream);
-
-/* Write the given entry onto the given stream.  */
-extern int putpwent(const struct passwd *__restrict __p,
-		FILE *__restrict __f);
-#endif
+struct passwd* FAST_FUNC getpwent(void);
 
 /* Search for an entry with a matching user ID.  */
-extern struct passwd *getpwuid(uid_t __uid);
+struct passwd* FAST_FUNC getpwuid(uid_t __uid);
 
 /* Search for an entry with a matching username.  */
-extern struct passwd *getpwnam(const char *__name);
-
-/* Reentrant versions of some of the functions above.
-
-   PLEASE NOTE: the `getpwent_r' function is not (yet) standardized.
-   The interface may change in later versions of this library.  But
-   the interface is designed following the principals used for the
-   other reentrant functions so the chances are good this is what the
-   POSIX people would choose.  */
-
-extern int getpwent_r(struct passwd *__restrict __resultbuf,
-		char *__restrict __buffer, size_t __buflen,
-		struct passwd **__restrict __result);
-
-extern int getpwuid_r(uid_t __uid,
-		struct passwd *__restrict __resultbuf,
-		char *__restrict __buffer, size_t __buflen,
-		struct passwd **__restrict __result);
-
-extern int getpwnam_r(const char *__restrict __name,
-		struct passwd *__restrict __resultbuf,
-		char *__restrict __buffer, size_t __buflen,
-		struct passwd **__restrict __result);
+struct passwd* FAST_FUNC getpwnam(const char *__name);
 
-/* Read an entry from STREAM.  This function is not standardized and
-   probably never will.  */
-extern int fgetpwent_r(FILE *__restrict __stream,
+/* Reentrant versions of some of the functions above. */
+int FAST_FUNC getpwnam_r(const char *__restrict __name,
 		struct passwd *__restrict __resultbuf,
 		char *__restrict __buffer, size_t __buflen,
 		struct passwd **__restrict __result);
diff -Nurp busybox.old/include/shadow_.h busybox/include/shadow_.h
--- busybox.old/include/shadow_.h	2015-03-23 11:07:19.000000000 +0800
+++ busybox/include/shadow_.h	2015-05-29 07:00:58.165925813 +0800
@@ -57,48 +57,48 @@ struct spwd {
 
 #ifdef UNUSED_FOR_NOW
 /* Open database for reading */
-extern void setspent(void);
+void FAST_FUNC setspent(void);
 
 /* Close database */
-extern void endspent(void);
+void FAST_FUNC endspent(void);
 
 /* Get next entry from database, perhaps after opening the file */
-extern struct spwd *getspent(void);
+struct spwd* FAST_FUNC getspent(void);
 
 /* Get shadow entry matching NAME */
-extern struct spwd *getspnam(const char *__name);
+struct spwd* FAST_FUNC getspnam(const char *__name);
 
 /* Read shadow entry from STRING */
-extern struct spwd *sgetspent(const char *__string);
+struct spwd* FAST_FUNC sgetspent(const char *__string);
 
 /* Read next shadow entry from STREAM */
-extern struct spwd *fgetspent(FILE *__stream);
+struct spwd* FAST_FUNC fgetspent(FILE *__stream);
 
 /* Write line containing shadow password entry to stream */
-extern int putspent(const struct spwd *__p, FILE *__stream);
+int FAST_FUNC putspent(const struct spwd *__p, FILE *__stream);
 
 /* Reentrant versions of some of the functions above */
-extern int getspent_r(struct spwd *__result_buf, char *__buffer,
+int FAST_FUNC getspent_r(struct spwd *__result_buf, char *__buffer,
 		size_t __buflen, struct spwd **__result);
 #endif
 
-extern int getspnam_r(const char *__name, struct spwd *__result_buf,
+int FAST_FUNC getspnam_r(const char *__name, struct spwd *__result_buf,
 		char *__buffer, size_t __buflen,
 		struct spwd **__result);
 
 #ifdef UNUSED_FOR_NOW
-extern int sgetspent_r(const char *__string, struct spwd *__result_buf,
+int FAST_FUNC sgetspent_r(const char *__string, struct spwd *__result_buf,
 		char *__buffer, size_t __buflen,
 		struct spwd **__result);
 
-extern int fgetspent_r(FILE *__stream, struct spwd *__result_buf,
+int FAST_FUNC fgetspent_r(FILE *__stream, struct spwd *__result_buf,
 		char *__buffer, size_t __buflen,
 		struct spwd **__result);
 /* Protect password file against multi writers */
-extern int lckpwdf(void);
+int FAST_FUNC lckpwdf(void);
 
 /* Unlock password file */
-extern int ulckpwdf(void);
+int FAST_FUNC ulckpwdf(void);
 #endif
 
 POP_SAVED_FUNCTION_VISIBILITY
diff -Nurp busybox.old/init/halt.c busybox/init/halt.c
--- busybox.old/init/halt.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/init/halt.c	2015-05-29 07:00:58.169259147 +0800
@@ -74,7 +74,7 @@
 
 static void write_wtmp(void)
 {
-	struct utmp utmp;
+	struct utmpx utmp;
 	struct utsname uts;
 	/* "man utmp" says wtmp file should *not* be created automagically */
 	/*if (access(bb_path_wtmp_file, R_OK|W_OK) == -1) {
@@ -88,7 +88,7 @@ static void write_wtmp(void)
 	utmp.ut_line[0] = '~'; utmp.ut_line[1] = '~'; /* = strcpy(utmp.ut_line, "~~"); */
 	uname(&uts);
 	safe_strncpy(utmp.ut_host, uts.release, sizeof(utmp.ut_host));
-	updwtmp(bb_path_wtmp_file, &utmp);
+	updwtmpx(bb_path_wtmp_file, &utmp);
 }
 #else
 #define write_wtmp() ((void)0)
diff -Nurp busybox.old/init/init.c busybox/init/init.c
--- busybox.old/init/init.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/init/init.c	2015-05-29 07:00:58.169259147 +0800
@@ -538,11 +538,7 @@ static struct init_action *mark_terminat
 	struct init_action *a;
 
 	if (pid > 0) {
-		update_utmp(pid, DEAD_PROCESS,
-				/*tty_name:*/ NULL,
-				/*username:*/ NULL,
-				/*hostname:*/ NULL
-		);
+		update_utmp_DEAD_PROCESS(pid);
 		for (a = init_action_list; a; a = a->next) {
 			if (a->pid == pid) {
 				a->pid = 0;
diff -Nurp busybox.old/libbb/appletlib.c busybox/libbb/appletlib.c
--- busybox.old/libbb/appletlib.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/appletlib.c	2015-05-29 07:00:58.169259147 +0800
@@ -130,7 +130,7 @@ void FAST_FUNC bb_show_usage(void)
 			full_write2_str(applet_name);
 			full_write2_str(" ");
 			full_write2_str(p);
-			full_write2_str("\n\n");
+			full_write2_str("\n");
 		}
 		if (ENABLE_FEATURE_CLEAN_UP)
 			dealloc_usage_messages((char*)usage_string);
@@ -193,7 +193,7 @@ void lbb_prepare(const char *applet
 	if (argv[1]
 	 && !argv[2]
 	 && strcmp(argv[1], "--help") == 0
-	 && strncmp(applet, "busybox", 7) != 0
+	 && !is_prefixed_with(applet, "busybox")
 	) {
 		/* Special case. POSIX says "test --help"
 		 * should be no different from e.g. "test --foo".  */
@@ -631,7 +631,7 @@ static int busybox_main(char **argv)
 		full_write2_str(bb_banner); /* reuse const string */
 		full_write2_str(" multi-call binary.\n"); /* reuse */
 		full_write2_str(
-			"BusyBox is copyrighted by many authors between 1998-2012.\n"
+			"BusyBox is copyrighted by many authors between 1998-2015.\n"
 			"Licensed under GPLv2. See source distribution for detailed\n"
 			"copyright notices.\n"
 			"\n"
@@ -673,7 +673,7 @@ static int busybox_main(char **argv)
 		return 0;
 	}
 
-	if (strncmp(argv[1], "--list", 6) == 0) {
+	if (is_prefixed_with(argv[1], "--list")) {
 		unsigned i = 0;
 		const char *a = applet_names;
 		dup2(1, 2);
@@ -748,23 +748,25 @@ void FAST_FUNC run_applet_no_and_exit(in
 	xfunc_error_retval = EXIT_FAILURE;
 	applet_name = APPLET_NAME(applet_no);
 
-#if defined APPLET_NO_test
 	/* Special case. POSIX says "test --help"
 	 * should be no different from e.g. "test --foo".
 	 * Thus for "test", we skip --help check.
+	 * "true" and "false" are also special.
 	 */
-	if (applet_no != APPLET_NO_test)
+	if (1
+#if defined APPLET_NO_test
+	 && applet_no != APPLET_NO_test
+#endif
+#if defined APPLET_NO_true
+	 && applet_no != APPLET_NO_true
 #endif
-	{
-		if (argc == 2 && strcmp(argv[1], "--help") == 0) {
 #if defined APPLET_NO_false
-			/* Someone insisted that "false --help" must exit 1. Sigh */
-			if (applet_no != APPLET_NO_false)
+	 && applet_no != APPLET_NO_false
 #endif
-			{
-				/* Make "foo --help" exit with 0: */
-				xfunc_error_retval = 0;
-			}
+	) {
+		if (argc == 2 && strcmp(argv[1], "--help") == 0) {
+			/* Make "foo --help" exit with 0: */
+			xfunc_error_retval = 0;
 			bb_show_usage();
 		}
 	}
@@ -778,7 +780,7 @@ void FAST_FUNC run_applet_and_exit(const
 	int applet = find_applet_by_name(name);
 	if (applet >= 0)
 		run_applet_no_and_exit(applet, argv);
-	if (strncmp(name, "busybox", 7) == 0)
+	if (is_prefixed_with(name, "busybox"))
 		exit(busybox_main(argv));
 }
 
@@ -817,7 +819,7 @@ int main(int argc UNUSED_PARAM, char **a
 
 #if defined(SINGLE_APPLET_MAIN)
 	/* Only one applet is selected in .config */
-	if (argv[1] && strncmp(argv[0], "busybox", 7) == 0) {
+	if (argv[1] && is_prefixed_with(argv[0], "busybox")) {
 		/* "busybox <applet> <params>" should still work as expected */
 		argv++;
 	}
diff -Nurp busybox.old/libbb/bb_pwd.c busybox/libbb/bb_pwd.c
--- busybox.old/libbb/bb_pwd.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/bb_pwd.c	2015-05-29 07:00:58.169259147 +0800
@@ -110,51 +110,3 @@ unsigned long FAST_FUNC get_ug_id(const
 		return xname2id(s);
 	return r;
 }
-
-/* Experimental "mallocing" API.
- * The goal is nice: "we want to support a case when "guests" group is very large"
- * but the code is butt-ugly.
- */
-#if 0
-static char *find_latest(char last, char *cp)
-{
-	if (!cp)
-		return last;
-	cp += strlen(cp) + 1;
-	if (last < cp)
-		last = cp;
-	return last;
-}
-
-struct group* FAST_FUNC xmalloc_getgrnam(const char *name)
-{
-	struct {
-		struct group gr;
-		// May still be not enough!
-		char buf[64*1024 - sizeof(struct group) - 16];
-	} *s;
-	struct group *grp;
-	int r;
-	char *last;
-	char **gr_mem;
-
-	s = xmalloc(sizeof(*s));
-	r = getgrnam_r(name, &s->gr, s->buf, sizeof(s->buf), &grp);
-	if (!grp) {
-		free(s);
-		return grp;
-	}
-	last = find_latest(s->buf, grp->gr_name);
-	last = find_latest(last, grp->gr_passwd);
-	gr_mem = grp->gr_mem;
-	while (*gr_mem)
-		last = find_latest(last, *gr_mem++);
-	gr_mem++; /* points past NULL */
-	if (last < (char*)gr_mem)
-		last = (char*)gr_mem;
-//FIXME: what if we get not only truncated, but also moved here?
-// grp->gr_name pointer and friends are invalid now!!!
-	s = xrealloc(s, last - (char*)s);
-	return grp;
-}
-#endif
diff -Nurp busybox.old/libbb/change_identity.c busybox/libbb/change_identity.c
--- busybox.old/libbb/change_identity.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/libbb/change_identity.c	2015-05-29 07:00:58.169259147 +0800
@@ -33,9 +33,28 @@
 /* Become the user and group(s) specified by PW.  */
 void FAST_FUNC change_identity(const struct passwd *pw)
 {
-	if (initgroups(pw->pw_name, pw->pw_gid) == -1)
-		bb_perror_msg_and_die("can't set groups");
+	int res;
+
+	res = initgroups(pw->pw_name, pw->pw_gid);
 	endgrent(); /* helps to close a fd used internally by libc */
+
+	if (res != 0) {
+		/*
+		 * If initgroups() fails because a system call is unimplemented
+		 * then we are running on a Linux kernel compiled without multiuser
+		 * support (CONFIG_MULTIUSER is not defined).
+		 *
+		 * If we are running without multiuser support *and* the target uid
+		 * already matches the current uid then we can skip the change of
+		 * identity.
+		 */
+		if (errno == ENOSYS && pw->pw_uid == getuid()) {
+			return;
+		}
+
+		bb_perror_msg_and_die("can't set groups");
+	}
+
 	xsetgid(pw->pw_gid);
 	xsetuid(pw->pw_uid);
 }
diff -Nurp busybox.old/libbb/compare_string_array.c busybox/libbb/compare_string_array.c
--- busybox.old/libbb/compare_string_array.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/compare_string_array.c	2015-05-29 07:00:58.169259147 +0800
@@ -5,6 +5,24 @@
 
 #include "libbb.h"
 
+char* FAST_FUNC is_prefixed_with(const char *string, const char *key)
+{
+#if 0	/* Two passes over key - probably slower */
+	int len = strlen(key);
+	if (strncmp(string, key, len) == 0)
+		return string + len;
+	return NULL;
+#else	/* Open-coded */
+	while (*key != '\0') {
+		if (*key != *string)
+			return NULL;
+		key++;
+		string++;
+	}
+	return (char*)string;
+#endif
+}
+
 /* returns the array index of the string */
 /* (index of first match is returned, or -1) */
 int FAST_FUNC index_in_str_array(const char *const string_array[], const char *key)
@@ -39,10 +57,9 @@ int FAST_FUNC index_in_strings(const cha
 int FAST_FUNC index_in_substr_array(const char *const string_array[], const char *key)
 {
 	int i;
-	int len = strlen(key);
-	if (len) {
+	if (key[0]) {
 		for (i = 0; string_array[i] != 0; i++) {
-			if (strncmp(string_array[i], key, len) == 0) {
+			if (is_prefixed_with(string_array[i], key)) {
 				return i;
 			}
 		}
diff -Nurp busybox.old/libbb/inet_common.c busybox/libbb/inet_common.c
--- busybox.old/libbb/inet_common.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/inet_common.c	2015-05-29 07:00:58.172592480 +0800
@@ -32,14 +32,12 @@ int FAST_FUNC INET_resolve(const char *n
 		return 0;
 	}
 	/* If we expect this to be a hostname, try hostname database first */
-#ifdef DEBUG
 	if (hostfirst) {
+#ifdef DEBUG
 		bb_error_msg("gethostbyname(%s)", name);
-	}
 #endif
-	if (hostfirst) {
 		hp = gethostbyname(name);
-		if (hp != NULL) {
+		if (hp) {
 			memcpy(&s_in->sin_addr, hp->h_addr_list[0],
 				sizeof(struct in_addr));
 			return 0;
@@ -51,7 +49,7 @@ int FAST_FUNC INET_resolve(const char *n
 	bb_error_msg("getnetbyname(%s)", name);
 #endif
 	np = getnetbyname(name);
-	if (np != NULL) {
+	if (np) {
 		s_in->sin_addr.s_addr = htonl(np->n_net);
 		return 1;
 	}
@@ -66,7 +64,7 @@ int FAST_FUNC INET_resolve(const char *n
 	bb_error_msg("gethostbyname(%s)", name);
 #endif
 	hp = gethostbyname(name);
-	if (hp == NULL) {
+	if (!hp) {
 		return -1;
 	}
 	memcpy(&s_in->sin_addr, hp->h_addr_list[0], sizeof(struct in_addr));
@@ -74,7 +72,7 @@ int FAST_FUNC INET_resolve(const char *n
 }
 
 
-/* numeric: & 0x8000: default instead of *,
+/* numeric: & 0x8000: "default" instead of "*",
  *          & 0x4000: host instead of net,
  *          & 0x0fff: don't resolve
  */
@@ -83,16 +81,16 @@ char* FAST_FUNC INET_rresolve(struct soc
 	/* addr-to-name cache */
 	struct addr {
 		struct addr *next;
-		struct sockaddr_in addr;
-		int host;
+		uint32_t nip;
+		smallint is_host;
 		char name[1];
 	};
 	static struct addr *cache = NULL;
 
 	struct addr *pn;
 	char *name;
-	uint32_t ad, host_ad;
-	int host = 0;
+	uint32_t nip;
+	smallint is_host;
 
 	if (s_in->sin_family != AF_INET) {
 #ifdef DEBUG
@@ -102,61 +100,57 @@ char* FAST_FUNC INET_rresolve(struct soc
 		errno = EAFNOSUPPORT;
 		return NULL;
 	}
-	ad = s_in->sin_addr.s_addr;
+	nip = s_in->sin_addr.s_addr;
 #ifdef DEBUG
-	bb_error_msg("rresolve: %08x, mask %08x, num %08x", (unsigned)ad, netmask, numeric);
+	bb_error_msg("rresolve: %08x mask:%08x num:%08x", (unsigned)nip, netmask, numeric);
 #endif
-	if (ad == INADDR_ANY) {
-		if ((numeric & 0x0FFF) == 0) {
-			if (numeric & 0x8000)
-				return xstrdup("default");
-			return xstrdup("*");
-		}
-	}
 	if (numeric & 0x0FFF)
-		return xstrdup(inet_ntoa(s_in->sin_addr));
+		return xmalloc_sockaddr2dotted_noport((void*)s_in);
+	if (nip == INADDR_ANY) {
+		if (numeric & 0x8000)
+			return xstrdup("default");
+		return xstrdup("*");
+	}
+
+	is_host = ((nip & (~netmask)) != 0 || (numeric & 0x4000));
 
-	if ((ad & (~netmask)) != 0 || (numeric & 0x4000))
-		host = 1;
 	pn = cache;
 	while (pn) {
-		if (pn->addr.sin_addr.s_addr == ad && pn->host == host) {
+		if (pn->nip == nip && pn->is_host == is_host) {
 #ifdef DEBUG
 			bb_error_msg("rresolve: found %s %08x in cache",
-					  (host ? "host" : "net"), (unsigned)ad);
+				(is_host ? "host" : "net"), (unsigned)nip);
 #endif
 			return xstrdup(pn->name);
 		}
 		pn = pn->next;
 	}
 
-	host_ad = ntohl(ad);
 	name = NULL;
-	if (host) {
-		struct hostent *ent;
+	if (is_host) {
 #ifdef DEBUG
-		bb_error_msg("gethostbyaddr (%08x)", (unsigned)ad);
+		bb_error_msg("sockaddr2host_noport(%08x)", (unsigned)nip);
 #endif
-		ent = gethostbyaddr((char *) &ad, 4, AF_INET);
-		if (ent)
-			name = xstrdup(ent->h_name);
+		name = xmalloc_sockaddr2host_noport((void*)s_in);
 	} else if (ENABLE_FEATURE_ETC_NETWORKS) {
 		struct netent *np;
 #ifdef DEBUG
-		bb_error_msg("getnetbyaddr (%08x)", (unsigned)host_ad);
+		bb_error_msg("getnetbyaddr(%08x)", (unsigned)ntohl(nip));
 #endif
-		np = getnetbyaddr(host_ad, AF_INET);
+		np = getnetbyaddr(ntohl(nip), AF_INET);
 		if (np)
 			name = xstrdup(np->n_name);
 	}
 	if (!name)
-		name = xstrdup(inet_ntoa(s_in->sin_addr));
+		name = xmalloc_sockaddr2dotted_noport((void*)s_in);
+
 	pn = xmalloc(sizeof(*pn) + strlen(name)); /* no '+ 1', it's already accounted for */
 	pn->next = cache;
-	pn->addr = *s_in;
-	pn->host = host;
+	pn->nip = nip;
+	pn->is_host = is_host;
 	strcpy(pn->name, name);
 	cache = pn;
+
 	return name;
 }
 
@@ -188,9 +182,6 @@ int FAST_FUNC INET6_resolve(const char *
 
 char* FAST_FUNC INET6_rresolve(struct sockaddr_in6 *sin6, int numeric)
 {
-	char name[128];
-	int s;
-
 	if (sin6->sin6_family != AF_INET6) {
 #ifdef DEBUG
 		bb_error_msg("rresolve: unsupported address family %d!",
@@ -200,8 +191,7 @@ char* FAST_FUNC INET6_rresolve(struct so
 		return NULL;
 	}
 	if (numeric & 0x7FFF) {
-		inet_ntop(AF_INET6, &sin6->sin6_addr, name, sizeof(name));
-		return xstrdup(name);
+		return xmalloc_sockaddr2dotted_noport((void*)sin6);
 	}
 	if (IN6_IS_ADDR_UNSPECIFIED(&sin6->sin6_addr)) {
 		if (numeric & 0x8000)
@@ -209,15 +199,7 @@ char* FAST_FUNC INET6_rresolve(struct so
 		return xstrdup("*");
 	}
 
-	s = getnameinfo((struct sockaddr *) sin6, sizeof(*sin6),
-				name, sizeof(name),
-				/*serv,servlen:*/ NULL, 0,
-				0);
-	if (s != 0) {
-		bb_error_msg("getnameinfo failed");
-		return NULL;
-	}
-	return xstrdup(name);
+	return xmalloc_sockaddr2host_noport((void*)sin6);
 }
 
 #endif  /* CONFIG_FEATURE_IPV6 */
diff -Nurp busybox.old/libbb/lineedit.c busybox/libbb/lineedit.c
--- busybox.old/libbb/lineedit.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/lineedit.c	2015-05-29 07:00:58.172592480 +0800
@@ -672,23 +672,20 @@ static char *username_path_completion(ch
  */
 static NOINLINE unsigned complete_username(const char *ud)
 {
-	/* Using _r function to avoid pulling in static buffers */
-	char line_buff[256];
-	struct passwd pwd;
-	struct passwd *result;
+	struct passwd *pw;
 	unsigned userlen;
 
 	ud++; /* skip ~ */
 	userlen = strlen(ud);
 
 	setpwent();
-	while (!getpwent_r(&pwd, line_buff, sizeof(line_buff), &result)) {
+	while ((pw = getpwent()) != NULL) {
 		/* Null usernames should result in all users as possible completions. */
-		if (/*!userlen || */ strncmp(ud, pwd.pw_name, userlen) == 0) {
-			add_match(xasprintf("~%s/", pwd.pw_name));
+		if (/* !ud[0] || */ is_prefixed_with(pw->pw_name, ud)) {
+			add_match(xasprintf("~%s/", pw->pw_name));
 		}
 	}
-	endpwent();
+	endpwent(); /* don't keep password file open */
 
 	return 1 + userlen;
 }
@@ -795,7 +792,7 @@ static NOINLINE unsigned complete_cmd_di
 			if (!pfind[0] && DOT_OR_DOTDOT(name_found))
 				continue;
 			/* match? */
-			if (strncmp(name_found, pfind, pf_len) != 0)
+			if (!is_prefixed_with(name_found, pfind))
 				continue; /* no */
 
 			found = concat_path_file(paths[i], name_found);
@@ -1882,15 +1879,16 @@ static void parse_and_put_prompt(const c
 						cwd_buf = xrealloc_getcwd_or_warn(NULL);
 						if (!cwd_buf)
 							cwd_buf = (char *)bb_msg_unknown;
-						else {
+						else if (home_pwd_buf[0]) {
+							char *after_home_user;
+
 							/* /home/user[/something] -> ~[/something] */
-							l = strlen(home_pwd_buf);
-							if (l != 0
-							 && strncmp(home_pwd_buf, cwd_buf, l) == 0
-							 && (cwd_buf[l] == '/' || cwd_buf[l] == '\0')
+							after_home_user = is_prefixed_with(cwd_buf, home_pwd_buf);
+							if (after_home_user
+							 && (*after_home_user == '/' || *after_home_user == '\0')
 							) {
 								cwd_buf[0] = '~';
-								overlapping_strcpy(cwd_buf + 1, cwd_buf + l);
+								overlapping_strcpy(cwd_buf + 1, after_home_user);
 							}
 						}
 					}
diff -Nurp busybox.old/libbb/loop.c busybox/libbb/loop.c
--- busybox.old/libbb/loop.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/loop.c	2015-05-29 07:00:58.172592480 +0800
@@ -154,16 +154,7 @@ int FAST_FUNC set_loop(char **device, co
 				else
 					ioctl(dfd, LOOP_CLR_FD, 0);
 			}
-
-		/* If this block device already set up right, re-use it.
-		 * (Yes this is racy, but associating two loop devices with the same
-		 * file isn't pretty either.  In general, mounting the same file twice
-		 * without using losetup manually is problematic.)
-		 */
-		} else
-		if (strcmp(file, (char *)loopinfo.lo_file_name) != 0
-		 || offset != loopinfo.lo_offset
-		) {
+		} else {
 			rc = -1;
 		}
 		close(dfd);
diff -Nurp busybox.old/libbb/match_fstype.c busybox/libbb/match_fstype.c
--- busybox.old/libbb/match_fstype.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/match_fstype.c	2015-05-29 07:00:58.172592480 +0800
@@ -17,7 +17,6 @@
 int FAST_FUNC match_fstype(const struct mntent *mt, const char *t_fstype)
 {
 	int match = 1;
-	int len;
 
 	if (!t_fstype)
 		return match;
@@ -27,10 +26,10 @@ int FAST_FUNC match_fstype(const struct
 		t_fstype += 2;
 	}
 
-	len = strlen(mt->mnt_type);
 	while (1) {
-		if (strncmp(mt->mnt_type, t_fstype, len) == 0
-		 && (t_fstype[len] == '\0' || t_fstype[len] == ',')
+		char *after_mnt_type = is_prefixed_with(t_fstype, mt->mnt_type);
+		if (after_mnt_type
+		 && (*after_mnt_type == '\0' || *after_mnt_type == ',')
 		) {
 			return match;
 		}
diff -Nurp busybox.old/libbb/missing_syscalls.c busybox/libbb/missing_syscalls.c
--- busybox.old/libbb/missing_syscalls.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/libbb/missing_syscalls.c	2015-05-29 07:00:58.172592480 +0800
@@ -39,4 +39,9 @@ int pivot_root(const char *new_root, con
 {
 	return syscall(__NR_pivot_root, new_root, put_old);
 }
+
+int tcdrain(int fd)
+{
+	return ioctl(fd, TCSBRK, 1);
+}
 #endif
diff -Nurp busybox.old/libbb/platform.c busybox/libbb/platform.c
--- busybox.old/libbb/platform.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/libbb/platform.c	2015-05-29 07:00:58.175925814 +0800
@@ -194,3 +194,22 @@ ssize_t FAST_FUNC getline(char **lineptr
 	return len;
 }
 #endif
+
+#ifndef HAVE_TTYNAME_R
+int ttyname_r(int fd, char *buf, size_t buflen)
+{
+	int r;
+	char path[sizeof("/proc/self/fd/%d") + sizeof(int)*3];
+
+	if (!isatty(fd))
+		return errno == EINVAL ? ENOTTY : errno;
+	sprintf(path, "/proc/self/fd/%d", fd);
+	r = readlink(path, buf, buflen);
+	if (r < 0)
+		return errno;
+	if (r >= buflen)
+		return ERANGE;
+	buf[r] = '\0';
+	return 0;
+}
+#endif
diff -Nurp busybox.old/libbb/printable_string.c busybox/libbb/printable_string.c
--- busybox.old/libbb/printable_string.c	2015-05-29 06:54:59.000000000 +0800
+++ busybox/libbb/printable_string.c	2015-05-29 07:00:58.175925814 +0800
@@ -31,6 +31,8 @@ const char* FAST_FUNC printable_string(u
 		}
 		if (c < ' ')
 			break;
+		if (c >= 0x7f)
+			break;
 		s++;
 	}
 
@@ -43,7 +45,7 @@ const char* FAST_FUNC printable_string(u
 			unsigned char c = *d;
 			if (c == '\0')
 				break;
-			if (c < ' ')
+			if (c < ' ' || c >= 0x7f)
 				*d = '?';
 			d++;
 		}
diff -Nurp busybox.old/libbb/procps.c busybox/libbb/procps.c
--- busybox.old/libbb/procps.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/procps.c	2015-05-29 07:00:58.175925814 +0800
@@ -205,11 +205,11 @@ int FAST_FUNC procps_read_smaps(pid_t pi
 		// Rss:                 nnn kB
 		// .....
 
-		char *tp = buf, *p;
+		char *tp, *p;
 
 #define SCAN(S, X) \
-		if (strncmp(tp, S, sizeof(S)-1) == 0) {              \
-			tp = skip_whitespace(tp + sizeof(S)-1);      \
+		if ((tp = is_prefixed_with(buf, S)) != NULL) {       \
+			tp = skip_whitespace(tp);                    \
 			total->X += currec.X = fast_strtoul_10(&tp); \
 			continue;                                    \
 		}
@@ -247,7 +247,7 @@ int FAST_FUNC procps_read_smaps(pid_t pi
 			// skipping "rw-s FILEOFS M:m INODE "
 			tp = skip_whitespace(skip_fields(tp, 4));
 			// filter out /dev/something (something != zero)
-			if (strncmp(tp, "/dev/", 5) != 0 || strcmp(tp, "/dev/zero\n") == 0) {
+			if (!is_prefixed_with(tp, "/dev/") || strcmp(tp, "/dev/zero\n") == 0) {
 				if (currec.smap_mode[1] == 'w') {
 					currec.mapped_rw = currec.smap_size;
 					total->mapped_rw += currec.smap_size;
@@ -497,8 +497,8 @@ procps_status_t* FAST_FUNC procps_scan(p
 				while (fgets(buf, sizeof(buf), file)) {
 					char *tp;
 #define SCAN_TWO(str, name, statement) \
-	if (strncmp(buf, str, sizeof(str)-1) == 0) { \
-		tp = skip_whitespace(buf + sizeof(str)-1); \
+	if ((tp = is_prefixed_with(buf, str)) != NULL) { \
+		tp = skip_whitespace(tp); \
 		sscanf(tp, "%u", &sp->name); \
 		statement; \
 	}
diff -Nurp busybox.old/libbb/read_printf.c busybox/libbb/read_printf.c
--- busybox.old/libbb/read_printf.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/libbb/read_printf.c	2015-05-29 07:00:58.175925814 +0800
@@ -45,20 +45,20 @@
  * which detects EAGAIN and uses poll() to wait on the fd.
  * Thankfully, poll() doesn't care about O_NONBLOCK flag.
  */
-ssize_t FAST_FUNC nonblock_immune_read(int fd, void *buf, size_t count, int loop_on_EINTR)
+ssize_t FAST_FUNC nonblock_immune_read(int fd, void *buf, size_t count)
 {
 	struct pollfd pfd[1];
 	ssize_t n;
 
 	while (1) {
-		n = loop_on_EINTR ? safe_read(fd, buf, count) : read(fd, buf, count);
+		n = safe_read(fd, buf, count);
 		if (n >= 0 || errno != EAGAIN)
 			return n;
 		/* fd is in O_NONBLOCK mode. Wait using poll and repeat */
 		pfd[0].fd = fd;
 		pfd[0].events = POLLIN;
 		/* note: safe_poll pulls in printf */
-		loop_on_EINTR ? safe_poll(pfd, 1, -1) : poll(pfd, 1, -1);
+		safe_poll(pfd, 1, -1);
 	}
 }
 
@@ -81,7 +81,7 @@ char* FAST_FUNC xmalloc_reads(int fd, si
 			p = buf + sz;
 			sz += 128;
 		}
-		if (nonblock_immune_read(fd, p, 1, /*loop_on_EINTR:*/ 1) != 1) {
+		if (nonblock_immune_read(fd, p, 1) != 1) {
 			/* EOF/error */
 			if (p == buf) { /* we read nothing */
 				free(buf);
diff -Nurp busybox.old/libbb/rtc.c busybox/libbb/rtc.c
--- busybox.old/libbb/rtc.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/rtc.c	2015-05-29 07:00:58.175925814 +0800
@@ -22,7 +22,7 @@ int FAST_FUNC rtc_adjtime_is_utc(void)
 		char buffer[128];
 
 		while (fgets(buffer, sizeof(buffer), f)) {
-			if (strncmp(buffer, "UTC", 3) == 0) {
+			if (is_prefixed_with(buffer, "UTC")) {
 				utc = 1;
 				break;
 			}
diff -Nurp busybox.old/libbb/skip_whitespace.c busybox/libbb/skip_whitespace.c
--- busybox.old/libbb/skip_whitespace.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/skip_whitespace.c	2015-05-29 07:00:58.175925814 +0800
@@ -33,7 +33,7 @@ char* FAST_FUNC skip_non_whitespace(cons
 
 char* FAST_FUNC skip_dev_pfx(const char *tty_name)
 {
-	if (strncmp(tty_name, "/dev/", 5) == 0)
+	if (is_prefixed_with(tty_name, "/dev/"))
 		tty_name += 5;
 	return (char*)tty_name;
 }
diff -Nurp busybox.old/libbb/update_passwd.c busybox/libbb/update_passwd.c
--- busybox.old/libbb/update_passwd.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/update_passwd.c	2015-05-29 07:00:58.179259146 +0800
@@ -62,6 +62,8 @@ static void check_selinux_update_passwd(
     only if CONFIG_PASSWD=y and applet_name[0] == 'p' like in passwd
     or if CONFIG_CHPASSWD=y and applet_name[0] == 'c' like in chpasswd
 
+ 8) delete a user from all groups: update_passwd(FILE, NULL, NULL, MEMBER)
+
  This function does not validate the arguments fed to it
  so the calling program should take care of that.
 
@@ -82,7 +84,6 @@ int FAST_FUNC update_passwd(const char *
 	char *fnamesfx;
 	char *sfx_char;
 	char *name_colon;
-	unsigned user_len;
 	int old_fd;
 	int new_fd;
 	int i;
@@ -99,13 +100,13 @@ int FAST_FUNC update_passwd(const char *
 	if (filename == NULL)
 		return ret;
 
-	check_selinux_update_passwd(name);
+	if (name)
+		check_selinux_update_passwd(name);
 
 	/* New passwd file, "/etc/passwd+" for now */
 	fnamesfx = xasprintf("%s+", filename);
 	sfx_char = &fnamesfx[strlen(fnamesfx)-1];
-	name_colon = xasprintf("%s:", name);
-	user_len = strlen(name_colon);
+	name_colon = xasprintf("%s:", name ? name : "");
 
 	if (shadow)
 		old_fp = fopen(filename, "r+");
@@ -167,13 +168,45 @@ int FAST_FUNC update_passwd(const char *
 		line = xmalloc_fgetline(old_fp);
 		if (!line) /* EOF/error */
 			break;
-		if (strncmp(name_colon, line, user_len) != 0) {
+
+		if (!name && member) {
+			/* Delete member from all groups */
+			/* line is "GROUP:PASSWD:[member1[,member2]...]" */
+			unsigned member_len = strlen(member);
+			char *list = strrchr(line, ':');
+			while (list) {
+				list++;
+ next_list_element:
+				if (is_prefixed_with(list, member)) {
+					char c;
+					changed_lines++;
+					c = list[member_len];
+					if (c == '\0') {
+						if (list[-1] == ',')
+							list--;
+						*list = '\0';
+						break;
+					}
+					if (c == ',') {
+						overlapping_strcpy(list, list + member_len + 1);
+						goto next_list_element;
+					}
+					changed_lines--;
+				}
+				list = strchr(list, ',');
+			}
+			fprintf(new_fp, "%s\n", line);
+			goto next;
+		}
+
+		cp = is_prefixed_with(line, name_colon);
+		if (!cp) {
 			fprintf(new_fp, "%s\n", line);
 			goto next;
 		}
 
 		/* We have a match with "name:"... */
-		cp = line + user_len; /* move past name: */
+		/* cp points past "name:" */
 
 #if ENABLE_FEATURE_ADDUSER_TO_GROUP || ENABLE_FEATURE_DEL_USER_FROM_GROUP
 		if (member) {
diff -Nurp busybox.old/libbb/utmp.c busybox/libbb/utmp.c
--- busybox.old/libbb/utmp.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/utmp.c	2015-05-29 07:00:58.179259146 +0800
@@ -16,7 +16,7 @@ static void touch(const char *filename)
 
 void FAST_FUNC write_new_utmp(pid_t pid, int new_type, const char *tty_name, const char *username, const char *hostname)
 {
-	struct utmp utent;
+	struct utmpx utent;
 	char *id;
 	unsigned width;
 
@@ -45,17 +45,17 @@ void FAST_FUNC write_new_utmp(pid_t pid,
 		tty_name += 3;
 	strncpy(id, tty_name, width);
 
-	touch(_PATH_UTMP);
-	//utmpname(_PATH_UTMP);
-	setutent();
+	touch(_PATH_UTMPX);
+	//utmpxname(_PATH_UTMPX);
+	setutxent();
 	/* Append new one (hopefully, unless we collide on ut_id) */
-	pututline(&utent);
-	endutent();
+	pututxline(&utent);
+	endutxent();
 
 #if ENABLE_FEATURE_WTMP
 	/* "man utmp" says wtmp file should *not* be created automagically */
 	/*touch(bb_path_wtmp_file);*/
-	updwtmp(bb_path_wtmp_file, &utent);
+	updwtmpx(bb_path_wtmp_file, &utent);
 #endif
 }
 
@@ -64,17 +64,17 @@ void FAST_FUNC write_new_utmp(pid_t pid,
  */
 void FAST_FUNC update_utmp(pid_t pid, int new_type, const char *tty_name, const char *username, const char *hostname)
 {
-	struct utmp utent;
-	struct utmp *utp;
+	struct utmpx utent;
+	struct utmpx *utp;
 
-	touch(_PATH_UTMP);
-	//utmpname(_PATH_UTMP);
-	setutent();
+	touch(_PATH_UTMPX);
+	//utmpxname(_PATH_UTMPX);
+	setutxent();
 
 	/* Did init/getty/telnetd/sshd/... create an entry for us?
 	 * It should be (new_type-1), but we'd also reuse
 	 * any other potentially stale xxx_PROCESS entry */
-	while ((utp = getutent()) != NULL) {
+	while ((utp = getutxent()) != NULL) {
 		if (utp->ut_pid == pid
 		// && ut->ut_line[0]
 		 && utp->ut_id[0] /* must have nonzero id */
@@ -88,25 +88,25 @@ void FAST_FUNC update_utmp(pid_t pid, in
 				/* Stale record. Nuke hostname */
 				memset(utp->ut_host, 0, sizeof(utp->ut_host));
 			}
-			/* NB: pututline (see later) searches for matching utent
-			 * using getutid(utent) - we must not change ut_id
+			/* NB: pututxline (see later) searches for matching utxent
+			 * using getutxid(utent) - we must not change ut_id
 			 * if we want *exactly this* record to be overwritten!
 			 */
 			break;
 		}
 	}
-	//endutent(); - no need, pututline can deal with (and actually likes)
+	//endutxent(); - no need, pututxline can deal with (and actually likes)
 	//the situation when utmp file is positioned on found record
 
 	if (!utp) {
 		if (new_type != DEAD_PROCESS)
 			write_new_utmp(pid, new_type, tty_name, username, hostname);
 		else
-			endutent();
+			endutxent();
 		return;
 	}
 
-	/* Make a copy. We can't use *utp, pututline's internal getutid
+	/* Make a copy. We can't use *utp, pututxline's internal getutxid
 	 * will overwrite it before it is used! */
 	utent = *utp;
 
@@ -120,13 +120,27 @@ void FAST_FUNC update_utmp(pid_t pid, in
 	utent.ut_tv.tv_sec = time(NULL);
 
 	/* Update, or append new one */
-	//setutent();
-	pututline(&utent);
-	endutent();
+	//setutxent();
+	pututxline(&utent);
+	endutxent();
 
 #if ENABLE_FEATURE_WTMP
 	/* "man utmp" says wtmp file should *not* be created automagically */
 	/*touch(bb_path_wtmp_file);*/
-	updwtmp(bb_path_wtmp_file, &utent);
+	updwtmpx(bb_path_wtmp_file, &utent);
 #endif
 }
+
+/* man utmp:
+ * When init(8) finds that a process has exited, it locates its utmp entry
+ * by ut_pid, sets ut_type to DEAD_PROCESS, and clears ut_user, ut_host
+ * and ut_time with null bytes.
+ * [same applies to other processes which maintain utmp entries, like telnetd]
+ *
+ * We do not bother actually clearing fields:
+ * it might be interesting to know who was logged in and from where
+ */
+void FAST_FUNC update_utmp_DEAD_PROCESS(pid_t pid)
+{
+	update_utmp(pid, DEAD_PROCESS, NULL, NULL, NULL);
+}
diff -Nurp busybox.old/libbb/xatonum.c busybox/libbb/xatonum.c
--- busybox.old/libbb/xatonum.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/xatonum.c	2015-05-29 07:00:58.179259146 +0800
@@ -75,3 +75,24 @@ const struct suffix_mult bkm_suffixes[]
 	{ "m", 1024*1024 },
 	{ "", 0 }
 };
+
+const struct suffix_mult cwbkMG_suffixes[] = {
+	{ "c", 1 },
+	{ "w", 2 },
+	{ "b", 512 },
+	{ "kB", 1000 },
+	{ "kD", 1000 },
+	{ "k", 1024 },
+	{ "KB", 1000 }, /* compat with coreutils dd */
+	{ "KD", 1000 }, /* compat with coreutils dd */
+	{ "K", 1024 },  /* compat with coreutils dd */
+	{ "MB", 1000000 },
+	{ "MD", 1000000 },
+	{ "M", 1024*1024 },
+	{ "GB", 1000000000 },
+	{ "GD", 1000000000 },
+	{ "G", 1024*1024*1024 },
+	/* "D" suffix for decimal is not in coreutils manpage, looks like it's deprecated */
+	/* coreutils also understands TPEZY suffixes for tera- and so on, with B suffix for decimal */
+	{ "", 0 }
+};
diff -Nurp busybox.old/libbb/xconnect.c busybox/libbb/xconnect.c
--- busybox.old/libbb/xconnect.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libbb/xconnect.c	2015-05-29 07:00:58.179259146 +0800
@@ -171,7 +171,7 @@ IF_NOT_FEATURE_IPV6(sa_family_t af = AF_
 	const char *cp;
 	struct addrinfo hint;
 
-	if (ENABLE_FEATURE_UNIX_LOCAL && strncmp(host, "local:", 6) == 0) {
+	if (ENABLE_FEATURE_UNIX_LOCAL && is_prefixed_with(host, "local:")) {
 		struct sockaddr_un *sun;
 
 		r = xzalloc(LSA_LEN_SIZE + sizeof(struct sockaddr_un));
diff -Nurp busybox.old/libpwdgrp/pwd_grp.c busybox/libpwdgrp/pwd_grp.c
--- busybox.old/libpwdgrp/pwd_grp.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/libpwdgrp/pwd_grp.c	2015-05-29 07:00:58.179259146 +0800
@@ -1,613 +1,541 @@
 /* vi: set sw=4 ts=4: */
-/* Copyright (C) 2003     Manuel Novoa III
+/* Copyright (C) 2014 Tito Ragusa <farmatito@tiscali.it>
  *
  * Licensed under GPLv2 or later, see file LICENSE in this source tree.
  */
-
-/* Nov 6, 2003  Initial version.
+/* This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY!!
  *
- * NOTE: This implementation is quite strict about requiring all
- *    field seperators.  It also does not allow leading whitespace
- *    except when processing the numeric fields.  glibc is more
- *    lenient.  See the various glibc difference comments below.
+ * Rewrite of some parts. Main differences are:
  *
- * TODO:
- *    Move to dynamic allocation of (currently statically allocated)
- *      buffers; especially for the group-related functions since
- *      large group member lists will cause error returns.
+ * 1) the buffer for getpwuid, getgrgid, getpwnam, getgrnam is dynamically
+ *    allocated.
+ *    If ENABLE_FEATURE_CLEAN_UP is set the buffers are freed at program
+ *    exit using the atexit function to make valgrind happy.
+ * 2) the passwd/group files:
+ *      a) must contain the expected number of fields (as per count of field
+ *         delimeters ":") or we will complain with a error message.
+ *      b) leading and trailing whitespace in fields is stripped.
+ *      c) some fields are not allowed to be empty (e.g. username, uid/gid,
+ *         homedir, shell) and in this case NULL is returned and errno is
+ *         set to EINVAL. This behaviour could be easily changed by
+ *         modifying PW_DEF, GR_DEF, SP_DEF strings (uppercase
+ *         makes a field mandatory).
+ *      d) the string representing uid/gid must be convertible by strtoXX
+ *         functions, or errno is set to EINVAL.
+ *      e) leading and trailing whitespace in group member names is stripped.
+ * 3) the internal function for getgrouplist uses dynamically allocated buffer.
+ * 4) at the moment only the functions really used by busybox code are
+ *    implemented, if you need a particular missing function it should be
+ *    easy to write it by using the internal common code.
  */
 
 #include "libbb.h"
-#include <assert.h>
-
-/**********************************************************************/
-/* Sizes for statically allocated buffers. */
-
-#define PWD_BUFFER_SIZE 256
-#define GRP_BUFFER_SIZE 256
 
-/**********************************************************************/
-/* Prototypes for internal functions. */
-
-static int bb__pgsreader(
-		int FAST_FUNC (*parserfunc)(void *d, char *line),
-		void *data,
-		char *__restrict line_buff,
-		size_t buflen,
-		FILE *f);
+struct const_passdb {
+	const char *filename;
+	char def[7 + 2*ENABLE_USE_BB_SHADOW];
+	uint8_t off[7 + 2*ENABLE_USE_BB_SHADOW];
+	uint8_t numfields;
+	uint8_t size_of;
+};
+struct passdb {
+	const char *filename;
+	char def[7 + 2*ENABLE_USE_BB_SHADOW];
+	uint8_t off[7 + 2*ENABLE_USE_BB_SHADOW];
+	uint8_t numfields;
+	uint8_t size_of;
+	FILE *fp;
+	char *malloced;
+};
+/* Note: for shadow db, def[] will not contain terminating NUL,
+ * but convert_to_struct() logic detects def[] end by "less than SP?",
+ * not by "is it NUL?" condition; and off[0] happens to be zero
+ * for every db anyway, so there _is_ in fact a terminating NUL there.
+ */
 
-static int FAST_FUNC bb__parsepwent(void *pw, char *line);
-static int FAST_FUNC bb__parsegrent(void *gr, char *line);
+/* S = string not empty, s = string maybe empty,
+ * I = uid,gid, l = long maybe empty, m = members,
+ * r = reserved
+ */
+#define PW_DEF "SsIIsSS"
+#define GR_DEF "SsIm"
+#define SP_DEF "Ssllllllr"
+
+static const struct const_passdb const_pw_db = {
+	_PATH_PASSWD, PW_DEF,
+	{
+		offsetof(struct passwd, pw_name),       /* 0 S */
+		offsetof(struct passwd, pw_passwd),     /* 1 s */
+		offsetof(struct passwd, pw_uid),        /* 2 I */
+		offsetof(struct passwd, pw_gid),        /* 3 I */
+		offsetof(struct passwd, pw_gecos),      /* 4 s */
+		offsetof(struct passwd, pw_dir),        /* 5 S */
+		offsetof(struct passwd, pw_shell)       /* 6 S */
+	},
+	sizeof(PW_DEF)-1, sizeof(struct passwd)
+};
+static const struct const_passdb const_gr_db = {
+	_PATH_GROUP, GR_DEF,
+	{
+		offsetof(struct group, gr_name),        /* 0 S */
+		offsetof(struct group, gr_passwd),      /* 1 s */
+		offsetof(struct group, gr_gid),         /* 2 I */
+		offsetof(struct group, gr_mem)          /* 3 m (char **) */
+	},
+	sizeof(GR_DEF)-1, sizeof(struct group)
+};
 #if ENABLE_USE_BB_SHADOW
-static int FAST_FUNC bb__parsespent(void *sp, char *line);
+static const struct const_passdb const_sp_db = {
+	_PATH_SHADOW, SP_DEF,
+	{
+		offsetof(struct spwd, sp_namp),         /* 0 S Login name */
+		offsetof(struct spwd, sp_pwdp),         /* 1 s Encrypted password */
+		offsetof(struct spwd, sp_lstchg),       /* 2 l */
+		offsetof(struct spwd, sp_min),          /* 3 l */
+		offsetof(struct spwd, sp_max),          /* 4 l */
+		offsetof(struct spwd, sp_warn),         /* 5 l */
+		offsetof(struct spwd, sp_inact),        /* 6 l */
+		offsetof(struct spwd, sp_expire),       /* 7 l */
+		offsetof(struct spwd, sp_flag)          /* 8 r Reserved */
+	},
+	sizeof(SP_DEF)-1, sizeof(struct spwd)
+};
 #endif
 
-/**********************************************************************/
 /* We avoid having big global data. */
-
 struct statics {
-	/* Smaller things first */
-	/* It's ok to use one buffer for getpwuid and getpwnam. Manpage says:
+	/* We use same buffer (db[0].malloced) for getpwuid and getpwnam.
+	 * Manpage says:
 	 * "The return value may point to a static area, and may be overwritten
 	 * by subsequent calls to getpwent(), getpwnam(), or getpwuid()."
 	 */
-	struct passwd getpw_resultbuf;
-	struct group getgr_resultbuf;
-
-	char getpw_buffer[PWD_BUFFER_SIZE];
-	char getgr_buffer[GRP_BUFFER_SIZE];
-#if 0 //ENABLE_USE_BB_SHADOW
-	struct spwd getsp_resultbuf;
-	char getsp_buffer[PWD_BUFFER_SIZE];
-#endif
-// Not converted - too small to bother
-//pthread_mutex_t mylock = PTHREAD_MUTEX_INITIALIZER;
-//FILE *pwf /*= NULL*/;
-//FILE *grf /*= NULL*/;
-//FILE *spf /*= NULL*/;
+	struct passdb db[2 + ENABLE_USE_BB_SHADOW];
+	char *tokenize_end;
+	unsigned string_size;
 };
 
 static struct statics *ptr_to_statics;
+#define S     (*ptr_to_statics)
+#define has_S (ptr_to_statics)
+
+#if ENABLE_FEATURE_CLEAN_UP
+static void free_static(void)
+{
+    	free(S.db[0].malloced);
+	free(S.db[1].malloced);
+# if ENABLE_USE_BB_SHADOW
+	free(S.db[2].malloced);
+# endif
+	free(ptr_to_statics);
+}
+#endif
 
 static struct statics *get_S(void)
 {
-	if (!ptr_to_statics)
-		ptr_to_statics = xzalloc(sizeof(*ptr_to_statics));
+	if (!ptr_to_statics) {
+		ptr_to_statics = xzalloc(sizeof(S));
+		memcpy(&S.db[0], &const_pw_db, sizeof(const_pw_db));
+		memcpy(&S.db[1], &const_gr_db, sizeof(const_gr_db));
+#if ENABLE_USE_BB_SHADOW
+		memcpy(&S.db[2], &const_sp_db, sizeof(const_sp_db));
+#endif
+#if ENABLE_FEATURE_CLEAN_UP
+		atexit(free_static);
+#endif
+	}
 	return ptr_to_statics;
 }
 
-/* Always use in this order, get_S() must be called first */
-#define RESULTBUF(name) &((S = get_S())->name##_resultbuf)
-#define BUFFER(name)    (S->name##_buffer)
+/* Internal functions */
 
-/**********************************************************************/
-/* For the various fget??ent_r funcs, return
- *
- *  0: success
- *  ENOENT: end-of-file encountered
- *  ERANGE: buflen too small
- *  other error values possible. See bb__pgsreader.
- *
- * Also, *result == resultbuf on success and NULL on failure.
- *
- * NOTE: glibc difference - For the ENOENT case, glibc also sets errno.
- *   We do not, as it really isn't an error if we reach the end-of-file.
- *   Doing so is analogous to having fgetc() set errno on EOF.
+/* Divide the passwd/group/shadow record in fields
+ * by substituting the given delimeter
+ * e.g. ':' or ',' with '\0'.
+ * Returns the number of fields found.
+ * Strips leading and trailing whitespace in fields.
  */
-/**********************************************************************/
-
-int fgetpwent_r(FILE *__restrict stream, struct passwd *__restrict resultbuf,
-				char *__restrict buffer, size_t buflen,
-				struct passwd **__restrict result)
+static int tokenize(char *buffer, int ch)
 {
-	int rv;
+	char *p = buffer;
+	char *s = p;
+	int num_fields = 0;
 
-	*result = NULL;
-
-	rv = bb__pgsreader(bb__parsepwent, resultbuf, buffer, buflen, stream);
-	if (!rv) {
-		*result = resultbuf;
+	for (;;) {
+		if (isblank(*s)) {
+			overlapping_strcpy(s, skip_whitespace(s));
+		}
+		if (*p == ch || *p == '\0') {
+			char *end = p;
+			while (p != s && isblank(p[-1]))
+				p--;
+			if (p != end)
+				overlapping_strcpy(p, end);
+			num_fields++;
+			if (*end == '\0') {
+				S.tokenize_end = p + 1;
+				return num_fields;
+			}
+			*p = '\0';
+			s = p + 1;
+		}
+		p++;
 	}
-
-	return rv;
 }
 
-int fgetgrent_r(FILE *__restrict stream, struct group *__restrict resultbuf,
-				char *__restrict buffer, size_t buflen,
-				struct group **__restrict result)
+/* Returns !NULL on success and matching line broken up in fields by '\0' in buf.
+ * We require the expected number of fields to be found.
+ */
+static char *parse_common(FILE *fp, struct passdb *db,
+		const char *key, int field_pos)
 {
-	int rv;
+	char *buf;
 
-	*result = NULL;
+	while ((buf = xmalloc_fgetline(fp)) != NULL) {
+		/* Skip empty lines, comment lines */
+		if (buf[0] == '\0' || buf[0] == '#')
+			goto free_and_next;
+		if (tokenize(buf, ':') != db->numfields) {
+			/* number of fields is wrong */
+			bb_error_msg("%s: bad record", db->filename);
+			goto free_and_next;
+		}
 
-	rv = bb__pgsreader(bb__parsegrent, resultbuf, buffer, buflen, stream);
-	if (!rv) {
-		*result = resultbuf;
+		if (field_pos == -1) {
+			/* no key specified: sequential read, return a record */
+			break;
+		}
+		if (strcmp(key, nth_string(buf, field_pos)) == 0) {
+			/* record found */
+			break;
+		}
+ free_and_next:
+		free(buf);
 	}
 
-	return rv;
-}
-
-#if ENABLE_USE_BB_SHADOW
-#ifdef UNUSED_FOR_NOW
-int fgetspent_r(FILE *__restrict stream, struct spwd *__restrict resultbuf,
-				char *__restrict buffer, size_t buflen,
-				struct spwd **__restrict result)
-{
-	int rv;
-
-	*result = NULL;
-
-	rv = bb__pgsreader(bb__parsespent, resultbuf, buffer, buflen, stream);
-	if (!rv) {
-		*result = resultbuf;
+	S.string_size = S.tokenize_end - buf;
+/*
+ * Ugly hack: group db requires additional buffer space
+ * for members[] array. If there is only one group, we need space
+ * for 3 pointers: alignment padding, group name, NULL.
+ * +1 for every additional group.
+ */
+	if (buf && db->numfields == sizeof(GR_DEF)-1) { /* if we read group file... */
+		int cnt = 3;
+		char *p = buf;
+		while (p < S.tokenize_end)
+			if (*p++ == ',')
+				cnt++;
+		S.string_size += cnt * sizeof(char*);
+//bb_error_msg("+%d words = %u key:%s buf:'%s'", cnt, S.string_size, key, buf);
+		buf = xrealloc(buf, S.string_size);
 	}
 
-	return rv;
-}
-#endif
-#endif
-
-/**********************************************************************/
-/* For the various fget??ent funcs, return NULL on failure and a
- * pointer to the appropriate struct (statically allocated) on success.
- * TODO: audit & stop using these in bbox, they pull in static buffers */
-/**********************************************************************/
-
-#ifdef UNUSED_SINCE_WE_AVOID_STATIC_BUFS
-struct passwd *fgetpwent(FILE *stream)
-{
-	struct statics *S;
-	struct passwd *resultbuf = RESULTBUF(getpw);
-	char *buffer = BUFFER(getpw);
-	struct passwd *result;
-
-	fgetpwent_r(stream, resultbuf, buffer, sizeof(BUFFER(getpw)), &result);
-	return result;
+	return buf;
 }
 
-struct group *fgetgrent(FILE *stream)
+static char *parse_file(struct passdb *db,
+		const char *key, int field_pos)
 {
-	struct statics *S;
-	struct group *resultbuf = RESULTBUF(getgr);
-	char *buffer = BUFFER(getgr);
-	struct group *result;
-
-	fgetgrent_r(stream, resultbuf, buffer, sizeof(BUFFER(getgr)), &result);
-	return result;
-}
-#endif
+	char *buf = NULL;
+	FILE *fp = fopen_for_read(db->filename);
 
-#if ENABLE_USE_BB_SHADOW
-#ifdef UNUSED_SINCE_WE_AVOID_STATIC_BUFS
-struct spwd *fgetspent(FILE *stream)
-{
-	struct statics *S;
-	struct spwd *resultbuf = RESULTBUF(getsp);
-	char *buffer = BUFFER(getsp);
-	struct spwd *result;
-
-	fgetspent_r(stream, resultbuf, buffer, sizeof(BUFFER(getsp)), &result);
-	return result;
+	if (fp) {
+		buf = parse_common(fp, db, key, field_pos);
+		fclose(fp);
+	}
+	return buf;
 }
-#endif
 
-#ifdef UNUSED_FOR_NOW
-int sgetspent_r(const char *string, struct spwd *result_buf,
-				char *buffer, size_t buflen, struct spwd **result)
+/* Convert passwd/group/shadow file record in buffer to a struct */
+static void *convert_to_struct(struct passdb *db,
+		char *buffer, void *result)
 {
-	int rv = ERANGE;
+	const char *def = db->def;
+	const uint8_t *off = db->off;
 
-	*result = NULL;
+	/* For consistency, zero out all fields */
+	memset(result, 0, db->size_of);
 
-	if (buflen < PWD_BUFFER_SIZE) {
- DO_ERANGE:
-		errno = rv;
-		goto DONE;
-	}
+	for (;;) {
+		void *member = (char*)result + (*off++);
 
-	if (string != buffer) {
-		if (strlen(string) >= buflen) {
-			goto DO_ERANGE;
+		if ((*def | 0x20) == 's') { /* s or S */
+			*(char **)member = (char*)buffer;
+			if (!buffer[0] && (*def == 'S')) {
+				errno = EINVAL;
+			}
+		}
+		if (*def == 'I') {
+			*(int *)member = bb_strtou(buffer, NULL, 10);
 		}
-		strcpy(buffer, string);
-	}
-
-	rv = bb__parsespent(result_buf, buffer);
-	if (!rv) {
-		*result = result_buf;
-	}
-
- DONE:
-	return rv;
-}
-#endif
-#endif /* ENABLE_USE_BB_SHADOW */
-
-/**********************************************************************/
-
-#define GETXXKEY_R_FUNC         getpwnam_r
-#define GETXXKEY_R_PARSER       bb__parsepwent
-#define GETXXKEY_R_ENTTYPE      struct passwd
-#define GETXXKEY_R_TEST(ENT)    (!strcmp((ENT)->pw_name, key))
-#define GETXXKEY_R_KEYTYPE      const char *__restrict
-#define GETXXKEY_R_PATHNAME     _PATH_PASSWD
-#include "pwd_grp_internal.c"
-
-#define GETXXKEY_R_FUNC         getgrnam_r
-#define GETXXKEY_R_PARSER       bb__parsegrent
-#define GETXXKEY_R_ENTTYPE      struct group
-#define GETXXKEY_R_TEST(ENT)    (!strcmp((ENT)->gr_name, key))
-#define GETXXKEY_R_KEYTYPE      const char *__restrict
-#define GETXXKEY_R_PATHNAME     _PATH_GROUP
-#include "pwd_grp_internal.c"
-
 #if ENABLE_USE_BB_SHADOW
-#define GETXXKEY_R_FUNC         getspnam_r
-#define GETXXKEY_R_PARSER       bb__parsespent
-#define GETXXKEY_R_ENTTYPE      struct spwd
-#define GETXXKEY_R_TEST(ENT)    (!strcmp((ENT)->sp_namp, key))
-#define GETXXKEY_R_KEYTYPE      const char *__restrict
-#define GETXXKEY_R_PATHNAME     _PATH_SHADOW
-#include "pwd_grp_internal.c"
-#endif
+		if (*def == 'l') {
+			long n = -1;
+			if (buffer[0])
+				n = bb_strtol(buffer, NULL, 10);
+			*(long *)member = n;
+		}
+#endif
+		if (*def == 'm') {
+			char **members;
+			int i = tokenize(buffer, ',');
+
+			/* Store members[] after buffer's end.
+			 * This is safe ONLY because there is a hack
+			 * in parse_common() which allocates additional space
+			 * at the end of malloced buffer!
+			 */
+			members = (char **)
+				( ((intptr_t)S.tokenize_end + sizeof(members[0]))
+				& -(intptr_t)sizeof(members[0])
+				);
+			((struct group *)result)->gr_mem = members;
+			while (--i >= 0) {
+				if (buffer[0]) {
+					*members++ = buffer;
+					// bb_error_msg("member[]='%s'", buffer);
+				}
+				buffer += strlen(buffer) + 1;
+			}
+			*members = NULL;
+		}
+		/* def "r" does nothing */
 
-#define GETXXKEY_R_FUNC         getpwuid_r
-#define GETXXKEY_R_PARSER       bb__parsepwent
-#define GETXXKEY_R_ENTTYPE      struct passwd
-#define GETXXKEY_R_TEST(ENT)    ((ENT)->pw_uid == key)
-#define GETXXKEY_R_KEYTYPE      uid_t
-#define GETXXKEY_R_PATHNAME     _PATH_PASSWD
-#include "pwd_grp_internal.c"
-
-#define GETXXKEY_R_FUNC         getgrgid_r
-#define GETXXKEY_R_PARSER       bb__parsegrent
-#define GETXXKEY_R_ENTTYPE      struct group
-#define GETXXKEY_R_TEST(ENT)    ((ENT)->gr_gid == key)
-#define GETXXKEY_R_KEYTYPE      gid_t
-#define GETXXKEY_R_PATHNAME     _PATH_GROUP
-#include "pwd_grp_internal.c"
-
-/**********************************************************************/
-/* TODO: audit & stop using these in bbox, they pull in static buffers */
-
-/* This one has many users */
-struct passwd *getpwuid(uid_t uid)
-{
-	struct statics *S;
-	struct passwd *resultbuf = RESULTBUF(getpw);
-	char *buffer = BUFFER(getpw);
-	struct passwd *result;
+		def++;
+		if ((unsigned char)*def <= (unsigned char)' ')
+			break;
+		buffer += strlen(buffer) + 1;
+	}
 
-	getpwuid_r(uid, resultbuf, buffer, sizeof(BUFFER(getpw)), &result);
+	if (errno)
+		result = NULL;
 	return result;
 }
 
-/* This one has many users */
-struct group *getgrgid(gid_t gid)
+static int massage_data_for_r_func(struct passdb *db,
+		char *buffer, size_t buflen,
+		void **result,
+		char *buf)
 {
-	struct statics *S;
-	struct group *resultbuf = RESULTBUF(getgr);
-	char *buffer = BUFFER(getgr);
-	struct group *result;
-
-	getgrgid_r(gid, resultbuf, buffer, sizeof(BUFFER(getgr)), &result);
-	return result;
-}
-
-#if 0 //ENABLE_USE_BB_SHADOW
-/* This function is non-standard and is currently not built.  It seems
- * to have been created as a reentrant version of the non-standard
- * functions getspuid.  Why getspuid was added, I do not know. */
-int getspuid_r(uid_t uid, struct spwd *__restrict resultbuf,
-			char *__restrict buffer, size_t buflen,
-			struct spwd **__restrict result)
-{
-	int rv;
-	struct passwd *pp;
-	struct passwd password;
-	char pwd_buff[PWD_BUFFER_SIZE];
-
+	void *result_buf = *result;
 	*result = NULL;
-	rv = getpwuid_r(uid, &password, pwd_buff, sizeof(pwd_buff), &pp);
-	if (!rv) {
-		rv = getspnam_r(password.pw_name, resultbuf, buffer, buflen, result);
+	if (buf) {
+		if (S.string_size > buflen) {
+			errno = ERANGE;
+		} else {
+			memcpy(buffer, buf, S.string_size);
+			*result = convert_to_struct(db, buffer, result_buf);
+		}
+		free(buf);
 	}
-
-	return rv;
+	/* "The reentrant functions return zero on success.
+	 * In case of error, an error number is returned."
+	 * NB: not finding the record is also a "success" here:
+	 */
+	return errno;
 }
 
-/* This function is non-standard and is currently not built.
- * Why it was added, I do not know. */
-struct spwd *getspuid(uid_t uid)
+static void* massage_data_for_non_r_func(struct passdb *db, char *buf)
 {
-	struct statics *S;
-	struct spwd *resultbuf = RESULTBUF(getsp);
-	char *buffer = BUFFER(getsp);
-	struct spwd *result;
+	if (!buf)
+		return NULL;
 
-	getspuid_r(uid, resultbuf, buffer, sizeof(BUFFER(getsp)), &result);
-	return result;
+	free(db->malloced);
+	/* We enlarge buf and move string data up, freeing space
+	 * for struct passwd/group/spwd at the beginning. This way,
+	 * entire result of getXXnam is in a single malloced block.
+	 * This enables easy creation of xmalloc_getpwnam() API.
+	 */
+	db->malloced = buf = xrealloc(buf, db->size_of + S.string_size);
+	memmove(buf + db->size_of, buf, S.string_size);
+	return convert_to_struct(db, buf + db->size_of, buf);
 }
-#endif
 
-/* This one has many users */
-struct passwd *getpwnam(const char *name)
+/****** getXXnam/id_r */
+
+static int FAST_FUNC getXXnam_r(const char *name, uintptr_t db_and_field_pos,
+		char *buffer, size_t buflen,
+		void *result)
 {
-	struct statics *S;
-	struct passwd *resultbuf = RESULTBUF(getpw);
-	char *buffer = BUFFER(getpw);
-	struct passwd *result;
+	char *buf;
+	struct passdb *db = &get_S()->db[db_and_field_pos >> 2];
 
-	getpwnam_r(name, resultbuf, buffer, sizeof(BUFFER(getpw)), &result);
-	return result;
+	buf = parse_file(db, name, 0 /*db_and_field_pos & 3*/);
+	/* "db_and_field_pos & 3" is commented out since so far we don't implement
+	 * getXXXid_r() functions which would use that to pass 2 here */
+
+	return massage_data_for_r_func(db, buffer, buflen, result, buf);
 }
 
-/* This one has many users */
-struct group *getgrnam(const char *name)
+int FAST_FUNC getpwnam_r(const char *name, struct passwd *struct_buf,
+		char *buffer, size_t buflen,
+		struct passwd **result)
 {
-	struct statics *S;
-	struct group *resultbuf = RESULTBUF(getgr);
-	char *buffer = BUFFER(getgr);
-	struct group *result;
-
-	getgrnam_r(name, resultbuf, buffer, sizeof(BUFFER(getgr)), &result);
-	return result;
+	/* Why the "store buffer address in result" trick?
+	 * This way, getXXnam_r has the same ABI signature as getpwnam_r,
+	 * hopefully compiler can optimize tail call better in this case.
+	 */
+	*result = struct_buf;
+	return getXXnam_r(name, (0 << 2) + 0, buffer, buflen, result);
 }
-
-#if 0 //ENABLE_USE_BB_SHADOW
-struct spwd *getspnam(const char *name)
+#if ENABLE_USE_BB_SHADOW
+int FAST_FUNC getspnam_r(const char *name, struct spwd *struct_buf, char *buffer, size_t buflen,
+		struct spwd **result)
 {
-	struct statics *S;
-	struct spwd *resultbuf = RESULTBUF(getsp);
-	char *buffer = BUFFER(getsp);
-	struct spwd *result;
-
-	getspnam_r(name, resultbuf, buffer, sizeof(BUFFER(getsp)), &result);
-	return result;
+	*result = struct_buf;
+	return getXXnam_r(name, (2 << 2) + 0, buffer, buflen, result);
 }
 #endif
 
-/**********************************************************************/
-
-/* FIXME: we don't have such CONFIG_xx - ?! */
-
-#if defined CONFIG_USE_BB_THREADSAFE_SHADOW && defined PTHREAD_MUTEX_INITIALIZER
-static pthread_mutex_t mylock = PTHREAD_MUTEX_INITIALIZER;
-# define LOCK		pthread_mutex_lock(&mylock)
-# define UNLOCK		pthread_mutex_unlock(&mylock);
-#else
-# define LOCK		((void) 0)
-# define UNLOCK		((void) 0)
-#endif
+#ifdef UNUSED
+/****** getXXent_r */
 
-static FILE *pwf /*= NULL*/;
-void setpwent(void)
+static int FAST_FUNC getXXent_r(uintptr_t db_idx, char *buffer, size_t buflen,
+		void *result)
 {
-	LOCK;
-	if (pwf) {
-		rewind(pwf);
+	char *buf;
+	struct passdb *db = &get_S()->db[db_idx];
+
+	if (!db->fp) {
+		db->fp = fopen_for_read(db->filename);
+		if (!db->fp) {
+			return errno;
+		}
+		close_on_exec_on(fileno(db->fp));
 	}
-	UNLOCK;
+
+	buf = parse_common(db->fp, db, /*no search key:*/ NULL, -1);
+	if (!buf && !errno)
+		errno = ENOENT;
+	return massage_data_for_r_func(db, buffer, buflen, result, buf);
 }
 
-void endpwent(void)
+int FAST_FUNC getpwent_r(struct passwd *struct_buf, char *buffer, size_t buflen,
+		struct passwd **result)
 {
-	LOCK;
-	if (pwf) {
-		fclose(pwf);
-		pwf = NULL;
-	}
-	UNLOCK;
+	*result = struct_buf;
+	return getXXent_r(0, buffer, buflen, result);
 }
+#endif
 
+/****** getXXent */
 
-int getpwent_r(struct passwd *__restrict resultbuf,
-			char *__restrict buffer, size_t buflen,
-			struct passwd **__restrict result)
+static void* FAST_FUNC getXXent(uintptr_t db_idx)
 {
-	int rv;
-
-	LOCK;
-	*result = NULL;				/* In case of error... */
+	char *buf;
+	struct passdb *db = &get_S()->db[db_idx];
 
-	if (!pwf) {
-		pwf = fopen_for_read(_PATH_PASSWD);
-		if (!pwf) {
-			rv = errno;
-			goto ERR;
+	if (!db->fp) {
+		db->fp = fopen_for_read(db->filename);
+		if (!db->fp) {
+			return NULL;
 		}
-		close_on_exec_on(fileno(pwf));
-	}
-
-	rv = bb__pgsreader(bb__parsepwent, resultbuf, buffer, buflen, pwf);
-	if (!rv) {
-		*result = resultbuf;
+		close_on_exec_on(fileno(db->fp));
 	}
 
- ERR:
-	UNLOCK;
-	return rv;
+	buf = parse_common(db->fp, db, /*no search key:*/ NULL, -1);
+	return massage_data_for_non_r_func(db, buf);
 }
 
-static FILE *grf /*= NULL*/;
-void setgrent(void)
+struct passwd* FAST_FUNC getpwent(void)
 {
-	LOCK;
-	if (grf) {
-		rewind(grf);
-	}
-	UNLOCK;
+	return getXXent(0);
 }
 
-void endgrent(void)
-{
-	LOCK;
-	if (grf) {
-		fclose(grf);
-		grf = NULL;
-	}
-	UNLOCK;
-}
+/****** getXXnam/id */
 
-int getgrent_r(struct group *__restrict resultbuf,
-			char *__restrict buffer, size_t buflen,
-			struct group **__restrict result)
+static void* FAST_FUNC getXXnam(const char *name, unsigned db_and_field_pos)
 {
-	int rv;
+	char *buf;
+	struct passdb *db = &get_S()->db[db_and_field_pos >> 2];
 
-	LOCK;
-	*result = NULL;				/* In case of error... */
-
-	if (!grf) {
-		grf = fopen_for_read(_PATH_GROUP);
-		if (!grf) {
-			rv = errno;
-			goto ERR;
-		}
-		close_on_exec_on(fileno(grf));
-	}
-
-	rv = bb__pgsreader(bb__parsegrent, resultbuf, buffer, buflen, grf);
-	if (!rv) {
-		*result = resultbuf;
-	}
-
- ERR:
-	UNLOCK;
-	return rv;
+	buf = parse_file(db, name, db_and_field_pos & 3);
+	return massage_data_for_non_r_func(db, buf);
 }
 
-#ifdef UNUSED_FOR_NOW
-#if ENABLE_USE_BB_SHADOW
-static FILE *spf /*= NULL*/;
-void setspent(void)
+struct passwd* FAST_FUNC getpwnam(const char *name)
 {
-	LOCK;
-	if (spf) {
-		rewind(spf);
-	}
-	UNLOCK;
+	return getXXnam(name, (0 << 2) + 0);
 }
-
-void endspent(void)
+struct group* FAST_FUNC getgrnam(const char *name)
 {
-	LOCK;
-	if (spf) {
-		fclose(spf);
-		spf = NULL;
-	}
-	UNLOCK;
+	return getXXnam(name, (1 << 2) + 0);
 }
-
-int getspent_r(struct spwd *resultbuf, char *buffer,
-			size_t buflen, struct spwd **result)
+struct passwd* FAST_FUNC getpwuid(uid_t id)
 {
-	int rv;
-
-	LOCK;
-	*result = NULL;				/* In case of error... */
-
-	if (!spf) {
-		spf = fopen_for_read(_PATH_SHADOW);
-		if (!spf) {
-			rv = errno;
-			goto ERR;
-		}
-		close_on_exec_on(fileno(spf));
-	}
-
-	rv = bb__pgsreader(bb__parsespent, resultbuf, buffer, buflen, spf);
-	if (!rv) {
-		*result = resultbuf;
-	}
-
- ERR:
-	UNLOCK;
-	return rv;
+	return getXXnam(utoa(id), (0 << 2) + 2);
 }
-#endif
-#endif /* UNUSED_FOR_NOW */
-
-#ifdef UNUSED_SINCE_WE_AVOID_STATIC_BUFS
-struct passwd *getpwent(void)
+struct group* FAST_FUNC getgrgid(gid_t id)
 {
-	static char line_buff[PWD_BUFFER_SIZE];
-	static struct passwd pwd;
-	struct passwd *result;
-
-	getpwent_r(&pwd, line_buff, sizeof(line_buff), &result);
-	return result;
+	return getXXnam(utoa(id), (1 << 2) + 2);
 }
 
-struct group *getgrent(void)
-{
-	static char line_buff[GRP_BUFFER_SIZE];
-	static struct group gr;
-	struct group *result;
+/****** end/setXXend */
 
-	getgrent_r(&gr, line_buff, sizeof(line_buff), &result);
-	return result;
+void FAST_FUNC endpwent(void)
+{
+	if (has_S && S.db[0].fp) {
+		fclose(S.db[0].fp);
+		S.db[0].fp = NULL;
+	}
 }
-
-#if ENABLE_USE_BB_SHADOW
-struct spwd *getspent(void)
+void FAST_FUNC setpwent(void)
 {
-	static char line_buff[PWD_BUFFER_SIZE];
-	static struct spwd spwd;
-	struct spwd *result;
-
-	getspent_r(&spwd, line_buff, sizeof(line_buff), &result);
-	return result;
+	if (has_S && S.db[0].fp) {
+		rewind(S.db[0].fp);
+	}
 }
-
-struct spwd *sgetspent(const char *string)
+void FAST_FUNC endgrent(void)
 {
-	static char line_buff[PWD_BUFFER_SIZE];
-	static struct spwd spwd;
-	struct spwd *result;
-
-	sgetspent_r(string, &spwd, line_buff, sizeof(line_buff), &result);
-	return result;
+	if (has_S && S.db[1].fp) {
+		fclose(S.db[1].fp);
+		S.db[1].fp = NULL;
+	}
 }
-#endif
-#endif /* UNUSED_SINCE_WE_AVOID_STATIC_BUFS */
 
-static gid_t *getgrouplist_internal(int *ngroups_ptr, const char *user, gid_t gid)
+/****** initgroups and getgrouplist */
+
+static gid_t* FAST_FUNC getgrouplist_internal(int *ngroups_ptr,
+		const char *user, gid_t gid)
 {
-	FILE *grfile;
+	FILE *fp;
 	gid_t *group_list;
 	int ngroups;
-	struct group group;
-	char buff[PWD_BUFFER_SIZE];
 
 	/* We alloc space for 8 gids at a time. */
-	group_list = xmalloc(8 * sizeof(group_list[0]));
+	group_list = xzalloc(8 * sizeof(group_list[0]));
 	group_list[0] = gid;
 	ngroups = 1;
 
-	grfile = fopen_for_read(_PATH_GROUP);
-	if (grfile) {
-		while (!bb__pgsreader(bb__parsegrent, &group, buff, sizeof(buff), grfile)) {
+	fp = fopen_for_read(_PATH_GROUP);
+	if (fp) {
+		struct passdb *db = &get_S()->db[1];
+		char *buf;
+		while ((buf = parse_common(fp, db, NULL, -1)) != NULL) {
 			char **m;
-			assert(group.gr_mem); /* Must have at least a NULL terminator. */
+			struct group group;
+			if (!convert_to_struct(db, buf, &group))
+				goto next;
 			if (group.gr_gid == gid)
-				continue;
+				goto next;
 			for (m = group.gr_mem; *m; m++) {
 				if (strcmp(*m, user) != 0)
 					continue;
 				group_list = xrealloc_vector(group_list, /*8=2^3:*/ 3, ngroups);
 				group_list[ngroups++] = group.gr_gid;
-				break;
+				goto next;
 			}
+ next:
+			free(buf);
 		}
-		fclose(grfile);
+		fclose(fp);
 	}
 	*ngroups_ptr = ngroups;
 	return group_list;
 }
 
-int initgroups(const char *user, gid_t gid)
+int FAST_FUNC initgroups(const char *user, gid_t gid)
 {
 	int ngroups;
 	gid_t *group_list = getgrouplist_internal(&ngroups, user, gid);
@@ -617,7 +545,7 @@ int initgroups(const char *user, gid_t g
 	return ngroups;
 }
 
-int getgrouplist(const char *user, gid_t gid, gid_t *groups, int *ngroups)
+int FAST_FUNC getgrouplist(const char *user, gid_t gid, gid_t *groups, int *ngroups)
 {
 	int ngroups_old = *ngroups;
 	gid_t *group_list = getgrouplist_internal(ngroups, user, gid);
@@ -631,409 +559,3 @@ int getgrouplist(const char *user, gid_t
 	free(group_list);
 	return ngroups_old;
 }
-
-#ifdef UNUSED_SINCE_WE_AVOID_STATIC_BUFS
-int putpwent(const struct passwd *__restrict p, FILE *__restrict f)
-{
-	int rv = -1;
-
-#if 0
-	/* glibc does this check */
-	if (!p || !f) {
-		errno = EINVAL;
-		return rv;
-	}
-#endif
-
-	/* No extra thread locking is needed above what fprintf does. */
-	if (fprintf(f, "%s:%s:%lu:%lu:%s:%s:%s\n",
-				p->pw_name, p->pw_passwd,
-				(unsigned long)(p->pw_uid),
-				(unsigned long)(p->pw_gid),
-				p->pw_gecos, p->pw_dir, p->pw_shell) >= 0
-		) {
-		rv = 0;
-	}
-
-	return rv;
-}
-
-int putgrent(const struct group *__restrict p, FILE *__restrict f)
-{
-	int rv = -1;
-
-#if 0
-	/* glibc does this check */
-	if (!p || !f) {
-		errno = EINVAL;
-		return rv;
-	}
-#endif
-
-	if (fprintf(f, "%s:%s:%lu:",
-				p->gr_name, p->gr_passwd,
-				(unsigned long)(p->gr_gid)) >= 0
-	) {
-		static const char format[] ALIGN1 = ",%s";
-
-		char **m;
-		const char *fmt;
-
-		fmt = format + 1;
-
-		assert(p->gr_mem);
-		m = p->gr_mem;
-
-		while (1) {
-			if (!*m) {
-				if (fputc('\n', f) >= 0) {
-					rv = 0;
-				}
-				break;
-			}
-			if (fprintf(f, fmt, *m) < 0) {
-				break;
-			}
-			m++;
-			fmt = format;
-		}
-	}
-
-	return rv;
-}
-#endif
-
-#if ENABLE_USE_BB_SHADOW
-#ifdef UNUSED_FOR_NOW
-static const unsigned char put_sp_off[] ALIGN1 = {
-	offsetof(struct spwd, sp_lstchg),       /* 2 - not a char ptr */
-	offsetof(struct spwd, sp_min),          /* 3 - not a char ptr */
-	offsetof(struct spwd, sp_max),          /* 4 - not a char ptr */
-	offsetof(struct spwd, sp_warn),         /* 5 - not a char ptr */
-	offsetof(struct spwd, sp_inact),        /* 6 - not a char ptr */
-	offsetof(struct spwd, sp_expire)        /* 7 - not a char ptr */
-};
-
-int putspent(const struct spwd *p, FILE *stream)
-{
-	const char *fmt;
-	long x;
-	int i;
-	int rv = -1;
-
-	/* Unlike putpwent and putgrent, glibc does not check the args. */
-	if (fprintf(stream, "%s:%s:", p->sp_namp,
-				(p->sp_pwdp ? p->sp_pwdp : "")) < 0
-	) {
-		goto DO_UNLOCK;
-	}
-
-	for (i = 0; i < sizeof(put_sp_off); i++) {
-		fmt = "%ld:";
-		x = *(long *)((char *)p + put_sp_off[i]);
-		if (x == -1) {
-			fmt += 3;
-		}
-		if (fprintf(stream, fmt, x) < 0) {
-			goto DO_UNLOCK;
-		}
-	}
-
-	if ((p->sp_flag != ~0UL) && (fprintf(stream, "%lu", p->sp_flag) < 0)) {
-		goto DO_UNLOCK;
-	}
-
-	if (fputc('\n', stream) > 0) {
-		rv = 0;
-	}
-
- DO_UNLOCK:
-	return rv;
-}
-#endif
-#endif /* USE_BB_SHADOW */
-
-/**********************************************************************/
-/* Internal functions                                                 */
-/**********************************************************************/
-
-static const unsigned char pw_off[] ALIGN1 = {
-	offsetof(struct passwd, pw_name),       /* 0 */
-	offsetof(struct passwd, pw_passwd),     /* 1 */
-	offsetof(struct passwd, pw_uid),        /* 2 - not a char ptr */
-	offsetof(struct passwd, pw_gid),        /* 3 - not a char ptr */
-	offsetof(struct passwd, pw_gecos),      /* 4 */
-	offsetof(struct passwd, pw_dir),        /* 5 */
-	offsetof(struct passwd, pw_shell)       /* 6 */
-};
-
-static int FAST_FUNC bb__parsepwent(void *data, char *line)
-{
-	char *endptr;
-	char *p;
-	int i;
-
-	i = 0;
-	while (1) {
-		p = (char *) data + pw_off[i];
-
-		if (i < 2 || i > 3) {
-			*((char **) p) = line;
-			if (i == 6) {
-				return 0;
-			}
-			/* NOTE: glibc difference - glibc allows omission of
-			 * ':' seperators after the gid field if all remaining
-			 * entries are empty.  We require all separators. */
-			line = strchr(line, ':');
-			if (!line) {
-				break;
-			}
-		} else {
-			unsigned long t = strtoul(line, &endptr, 10);
-			/* Make sure we had at least one digit, and that the
-			 * failing char is the next field seperator ':'.  See
-			 * glibc difference note above. */
-			/* TODO: Also check for leading whitespace? */
-			if ((endptr == line) || (*endptr != ':')) {
-				break;
-			}
-			line = endptr;
-			if (i & 1) {		/* i == 3 -- gid */
-				*((gid_t *) p) = t;
-			} else {			/* i == 2 -- uid */
-				*((uid_t *) p) = t;
-			}
-		}
-
-		*line++ = '\0';
-		i++;
-	} /* while (1) */
-
-	return -1;
-}
-
-/**********************************************************************/
-
-static const unsigned char gr_off[] ALIGN1 = {
-	offsetof(struct group, gr_name),        /* 0 */
-	offsetof(struct group, gr_passwd),      /* 1 */
-	offsetof(struct group, gr_gid)          /* 2 - not a char ptr */
-};
-
-static int FAST_FUNC bb__parsegrent(void *data, char *line)
-{
-	char *endptr;
-	char *p;
-	int i;
-	char **members;
-	char *end_of_buf;
-
-	end_of_buf = ((struct group *) data)->gr_name; /* Evil hack! */
-	i = 0;
-	while (1) {
-		p = (char *) data + gr_off[i];
-
-		if (i < 2) {
-			*((char **) p) = line;
-			line = strchr(line, ':');
-			if (!line) {
-				break;
-			}
-			*line++ = '\0';
-			i++;
-		} else {
-			*((gid_t *) p) = strtoul(line, &endptr, 10);
-
-			/* NOTE: glibc difference - glibc allows omission of the
-			 * trailing colon when there is no member list.  We treat
-			 * this as an error. */
-
-			/* Make sure we had at least one digit, and that the
-			 * failing char is the next field seperator ':'.  See
-			 * glibc difference note above. */
-			if ((endptr == line) || (*endptr != ':')) {
-				break;
-			}
-
-			i = 1;				/* Count terminating NULL ptr. */
-			p = endptr;
-
-			if (p[1]) { /* We have a member list to process. */
-				/* Overwrite the last ':' with a ',' before counting.
-				 * This allows us to (1) test for initial ','
-				 * and (2) adds one ',' so that the number of commas
-				 * equals the member count. */
-				*p = ',';
-				do {
-					/* NOTE: glibc difference - glibc allows and trims leading
-					 * (but not trailing) space.  We treat this as an error. */
-					/* NOTE: glibc difference - glibc allows consecutive and
-					 * trailing commas, and ignores "empty string" users.  We
-					 * treat this as an error. */
-					if (*p == ',') {
-						++i;
-						*p = 0;	/* nul-terminate each member string. */
-						if (!*++p || (*p == ',') || isspace(*p)) {
-							goto ERR;
-						}
-					}
-				} while (*++p);
-			}
-
-			/* Now align (p+1), rounding up. */
-			/* Assumes sizeof(char **) is a power of 2. */
-			members = (char **)( (((intptr_t) p) + sizeof(char **))
-								 & ~((intptr_t)(sizeof(char **) - 1)) );
-
-			if (((char *)(members + i)) > end_of_buf) {	/* No space. */
-				break;
-			}
-
-			((struct group *) data)->gr_mem = members;
-
-			if (--i) {
-				p = endptr;	/* Pointing to char prior to first member. */
-				while (1) {
-					*members++ = ++p;
-					if (!--i)
-						break;
-					while (*++p)
-						continue;
-				}
-			}
-			*members = NULL;
-
-			return 0;
-		}
-	} /* while (1) */
-
- ERR:
-	return -1;
-}
-
-/**********************************************************************/
-
-#if ENABLE_USE_BB_SHADOW
-static const unsigned char sp_off[] ALIGN1 = {
-	offsetof(struct spwd, sp_namp),         /* 0: char* */
-	offsetof(struct spwd, sp_pwdp),         /* 1: char* */
-	offsetof(struct spwd, sp_lstchg),       /* 2: long */
-	offsetof(struct spwd, sp_min),          /* 3: long */
-	offsetof(struct spwd, sp_max),          /* 4: long */
-	offsetof(struct spwd, sp_warn),         /* 5: long */
-	offsetof(struct spwd, sp_inact),        /* 6: long */
-	offsetof(struct spwd, sp_expire),       /* 7: long */
-	offsetof(struct spwd, sp_flag)          /* 8: unsigned long */
-};
-
-static int FAST_FUNC bb__parsespent(void *data, char *line)
-{
-	char *endptr;
-	char *p;
-	int i;
-
-	i = 0;
-	while (1) {
-		p = (char *) data + sp_off[i];
-		if (i < 2) {
-			*((char **) p) = line;
-			line = strchr(line, ':');
-			if (!line) {
-				break; /* error */
-			}
-		} else {
-			*((long *) p) = strtoul(line, &endptr, 10);
-			if (endptr == line) {
-				*((long *) p) = -1L;
-			}
-			line = endptr;
-			if (i == 8) {
-				if (*line != '\0') {
-					break; /* error */
-				}
-				return 0; /* all ok */
-			}
-			if (*line != ':') {
-				break; /* error */
-			}
-		}
-		*line++ = '\0';
-		i++;
-	}
-
-	return EINVAL;
-}
-#endif
-
-/**********************************************************************/
-
-/* Reads until EOF, or until it finds a line which fits in the buffer
- * and for which the parser function succeeds.
- *
- * Returns 0 on success and ENOENT for end-of-file (glibc convention).
- */
-static int bb__pgsreader(
-		int FAST_FUNC (*parserfunc)(void *d, char *line),
-		void *data,
-		char *__restrict line_buff,
-		size_t buflen,
-		FILE *f)
-{
-	int skip;
-	int rv = ERANGE;
-
-	if (buflen < PWD_BUFFER_SIZE) {
-		errno = rv;
-		return rv;
-	}
-
-	skip = 0;
-	while (1) {
-		if (!fgets(line_buff, buflen, f)) {
-			if (feof(f)) {
-				rv = ENOENT;
-			}
-			break;
-		}
-
-		{
-			int line_len = strlen(line_buff) - 1;
-			if (line_len >= 0 && line_buff[line_len] == '\n') {
-				line_buff[line_len] = '\0';
-			} else
-			if (line_len + 2 == buflen) {
-				/* A start (or continuation) of overlong line */
-				skip = 1;
-				continue;
-			} /* else: a last line in the file, and it has no '\n' */
-		}
-
-		if (skip) {
-			/* This "line" is a remainder of overlong line, ignore */
-			skip = 0;
-			continue;
-		}
-
-		/* NOTE: glibc difference - glibc strips leading whitespace from
-		 * records.  We do not allow leading whitespace. */
-
-		/* Skip empty lines, comment lines, and lines with leading
-		 * whitespace. */
-		if (line_buff[0] != '\0' && line_buff[0] != '#' && !isspace(line_buff[0])) {
-			if (parserfunc == bb__parsegrent) {
-				/* Do evil group hack:
-				 * The group entry parsing function needs to know where
-				 * the end of the buffer is so that it can construct the
-				 * group member ptr table. */
-				((struct group *) data)->gr_name = line_buff + buflen;
-			}
-			if (parserfunc(data, line_buff) == 0) {
-				rv = 0;
-				break;
-			}
-		}
-	} /* while (1) */
-
-	return rv;
-}
diff -Nurp busybox.old/loginutils/deluser.c busybox/loginutils/deluser.c
--- busybox.old/loginutils/deluser.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/loginutils/deluser.c	2015-05-29 07:00:58.182592480 +0800
@@ -11,9 +11,10 @@
  */
 
 //usage:#define deluser_trivial_usage
-//usage:       "USER"
+//usage:       IF_LONG_OPTS("[--remove-home] ") "USER"
 //usage:#define deluser_full_usage "\n\n"
 //usage:       "Delete USER from the system"
+//	--remove-home is self-explanatory enough to put it in --help
 
 //usage:#define delgroup_trivial_usage
 //usage:	IF_FEATURE_DEL_USER_FROM_GROUP("[USER] ")"GROUP"
@@ -37,6 +38,19 @@ int deluser_main(int argc, char **argv)
 	/* Are we deluser or delgroup? */
 	int do_deluser = (ENABLE_DELUSER && (!ENABLE_DELGROUP || applet_name[3] == 'u'));
 
+#if !ENABLE_LONG_OPTS
+	const int opt_delhome = 0;
+#else
+	int opt_delhome = 0;
+	if (do_deluser) {
+		applet_long_options =
+			"remove-home\0" No_argument "\xff";
+		opt_delhome = getopt32(argv, "");
+		argv += opt_delhome;
+		argc -= opt_delhome;
+	}
+#endif
+
 	if (geteuid() != 0)
 		bb_error_msg_and_die(bb_msg_perm_denied_are_you_root);
 
@@ -55,10 +69,14 @@ int deluser_main(int argc, char **argv)
 	case 2:
 		if (do_deluser) {
 			/* "deluser USER" */
-			xgetpwnam(name); /* bail out if USER is wrong */
+			struct passwd *pw;
+
+			pw = xgetpwnam(name); /* bail out if USER is wrong */
 			pfile = bb_path_passwd_file;
 			if (ENABLE_FEATURE_SHADOWPASSWDS)
 				sfile = bb_path_shadow_file;
+			if (opt_delhome)
+				remove_file(pw->pw_dir, FILEUTILS_RECUR);
 		} else {
 			struct group *gr;
  do_delgroup:
@@ -73,12 +91,11 @@ int deluser_main(int argc, char **argv)
 			if (!member) {
 				/* "delgroup GROUP" */
 				struct passwd *pw;
-				struct passwd pwent;
 				/* Check if the group is in use */
-#define passwd_buf bb_common_bufsiz1
-				while (!getpwent_r(&pwent, passwd_buf, sizeof(passwd_buf), &pw)) {
-					if (pwent.pw_gid == gr->gr_gid)
-						bb_error_msg_and_die("'%s' still has '%s' as their primary group!", pwent.pw_name, name);
+				while ((pw = getpwent()) != NULL) {
+					if (pw->pw_gid == gr->gr_gid)
+						bb_error_msg_and_die("'%s' still has '%s' as their primary group!",
+							pw->pw_name, name);
 				}
 				//endpwent();
 			}
@@ -97,16 +114,22 @@ int deluser_main(int argc, char **argv)
 			}
 		} while (ENABLE_FEATURE_SHADOWPASSWDS && pfile);
 
-		if (ENABLE_DELGROUP && do_deluser > 0) {
-			/* "deluser USER" also should try to delete
-			 * same-named group. IOW: do "delgroup USER"
-			 */
+		if (do_deluser > 0) {
+			/* Delete user from all groups */
+			if (update_passwd(bb_path_group_file, NULL, NULL, name) == -1)
+				return EXIT_FAILURE;
+
+			if (ENABLE_DELGROUP) {
+				/* "deluser USER" also should try to delete
+				 * same-named group. IOW: do "delgroup USER"
+				 */
 // On debian deluser is a perl script that calls userdel.
 // From man userdel:
 //  If USERGROUPS_ENAB is defined to yes in /etc/login.defs, userdel will
 //  delete the group with the same name as the user.
-			do_deluser = -1;
-			goto do_delgroup;
+				do_deluser = -1;
+				goto do_delgroup;
+			}
 		}
 		return EXIT_SUCCESS;
 	}
diff -Nurp busybox.old/loginutils/login.c busybox/loginutils/login.c
--- busybox.old/loginutils/login.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/loginutils/login.c	2015-05-29 07:00:58.182592480 +0800
@@ -454,7 +454,7 @@ int login_main(int argc UNUSED_PARAM, ch
 		else {
 			if (safe_waitpid(child_pid, NULL, 0) == -1)
 				bb_perror_msg("waitpid");
-			update_utmp(child_pid, DEAD_PROCESS, NULL, NULL, NULL);
+			update_utmp_DEAD_PROCESS(child_pid);
 		}
 		IF_PAM(login_pam_end(pamh);)
 		return 0;
diff -Nurp busybox.old/Makefile busybox/Makefile
--- busybox.old/Makefile	2015-03-23 11:07:18.000000000 +0800
+++ busybox/Makefile	2015-05-29 07:00:58.095925812 +0800
@@ -1,7 +1,7 @@
 VERSION = 1
-PATCHLEVEL = 23
-SUBLEVEL = 2
-EXTRAVERSION =
+PATCHLEVEL = 24
+SUBLEVEL = 0
+EXTRAVERSION = .git
 NAME = Unnamed
 
 # *DOCUMENTATION*
@@ -552,7 +552,7 @@ export	INSTALL_PATH ?= /boot
 #
 # INSTALL_MOD_PATH specifies a prefix to MODLIB for module directory
 # relocations required by build roots.  This is not defined in the
-# makefile but the arguement can be passed to make if needed.
+# makefile but the argument can be passed to make if needed.
 #
 
 MODLIB	= $(INSTALL_MOD_PATH)/lib/modules/$(KERNELRELEASE)
@@ -1165,24 +1165,7 @@ endif
 ALLSOURCE_ARCHS := $(ARCH)
 
 define all-sources
-	( find $(__srctree) $(RCS_FIND_IGNORE) \
-	       \( -name include -o -name arch \) -prune -o \
-	       -name '*.[chS]' -print; \
-	  for ARCH in $(ALLSOURCE_ARCHS) ; do \
-	       find $(__srctree)arch/$${ARCH} $(RCS_FIND_IGNORE) \
-	            -name '*.[chS]' -print; \
-	  done ; \
-	  find $(__srctree)security/selinux/include $(RCS_FIND_IGNORE) \
-	       -name '*.[chS]' -print; \
-	  find $(__srctree)include $(RCS_FIND_IGNORE) \
-	       \( -name config -o -name 'asm-*' \) -prune \
-	       -o -name '*.[chS]' -print; \
-	  for ARCH in $(ALLINCLUDE_ARCHS) ; do \
-	       find $(__srctree)include/asm-$${ARCH} $(RCS_FIND_IGNORE) \
-	            -name '*.[chS]' -print; \
-	  done ; \
-	  find $(__srctree)include/asm-generic $(RCS_FIND_IGNORE) \
-	       -name '*.[chS]' -print )
+	( find -regex '.*\.[ch]$$' )
 endef
 
 quiet_cmd_cscope-file = FILELST cscope.files
diff -Nurp busybox.old/Makefile.flags busybox/Makefile.flags
--- busybox.old/Makefile.flags	2015-05-29 06:54:59.000000000 +0800
+++ busybox/Makefile.flags	2015-05-29 07:00:58.095925812 +0800
@@ -51,7 +51,7 @@ CFLAGS += $(call cc-option,-fno-builtin-
 # -fno-guess-branch-probability: prohibit pseudo-random guessing
 # of branch probabilities (hopefully makes bloatcheck more stable):
 CFLAGS += $(call cc-option,-fno-guess-branch-probability,)
-CFLAGS += $(call cc-option,-funsigned-char,)
+CFLAGS += $(call cc-option,-funsigned-char -static-libgcc,)
 CFLAGS += $(call cc-option,-falign-functions=1 -falign-jumps=1 -falign-labels=1 -falign-loops=1,)
 # Defeat .eh_frame bloat (gcc 4.6.3 x86-32 defconfig: 20% smaller busybox binary):
 CFLAGS += $(call cc-option,-fno-unwind-tables,)
@@ -163,7 +163,7 @@ SKIP_STRIP = y
 endif
 
 ifneq ($(CONFIG_EXTRA_LDFLAGS),)
-EXTRA_LDFLAGS += $(strip $(subst ",,$(CONFIG_EXTRA_LDFLAGS)))
+LDFLAGS += $(strip $(subst ",,$(CONFIG_EXTRA_LDFLAGS)))
 #"))
 endif
 
diff -Nurp busybox.old/miscutils/Config.src busybox/miscutils/Config.src
--- busybox.old/miscutils/Config.src	2015-05-29 06:54:59.000000000 +0800
+++ busybox/miscutils/Config.src	2015-05-29 07:00:58.182592480 +0800
@@ -385,12 +385,6 @@ config FEATURE_HDPARM_HDIO_GETSET_DMA
 	help
 	  Enables the 'hdparm -d' option to get/set using_dma flag.
 
-config LOCK
-	bool "lock"
-	default n
-	help
-	  Small utility for using locks in scripts
-
 config MAKEDEVS
 	bool "makedevs"
 	default y
diff -Nurp busybox.old/miscutils/crond.c busybox/miscutils/crond.c
--- busybox.old/miscutils/crond.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/miscutils/crond.c	2015-05-29 07:00:58.182592480 +0800
@@ -438,14 +438,14 @@ static void load_crontab(const char *fil
 			log5("user:%s entry:%s", fileName, parser->data);
 
 			/* check if line is setting MAILTO= */
-			if (0 == strncmp(tokens[0], "MAILTO=", 7)) {
+			if (is_prefixed_with(tokens[0], "MAILTO=")) {
 #if ENABLE_FEATURE_CROND_CALL_SENDMAIL
 				free(mailTo);
 				mailTo = (tokens[0][7]) ? xstrdup(&tokens[0][7]) : NULL;
 #endif /* otherwise just ignore such lines */
 				continue;
 			}
-			if (0 == strncmp(tokens[0], "SHELL=", 6)) {
+			if (is_prefixed_with(tokens[0], "SHELL=")) {
 				free(shell);
 				shell = xstrdup(&tokens[0][6]);
 				continue;
diff -Nurp busybox.old/miscutils/dc.c busybox/miscutils/dc.c
--- busybox.old/miscutils/dc.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/miscutils/dc.c	2015-05-29 07:00:58.182592480 +0800
@@ -56,6 +56,12 @@ enum { STACK_SIZE = (COMMON_BUFSIZE - of
 } while (0)
 
 
+static void check_under(void)
+{
+	if (pointer == 0)
+		bb_error_msg_and_die("stack underflow");
+}
+
 static void push(double a)
 {
 	if (pointer >= STACK_SIZE)
@@ -65,8 +71,7 @@ static void push(double a)
 
 static double pop(void)
 {
-	if (pointer == 0)
-		bb_error_msg_and_die("stack underflow");
+	check_under();
 	return stack[--pointer];
 }
 
@@ -187,6 +192,7 @@ static void print_stack_no_pop(void)
 
 static void print_no_pop(void)
 {
+	check_under();
 	print_base(stack[pointer-1]);
 }
 
@@ -244,9 +250,9 @@ static void stack_machine(const char *ar
 
 	o = operators;
 	do {
-		const size_t name_len = strlen(o->name);
-		if (strncmp(o->name, argument, name_len) == 0) {
-			argument += name_len;
+		char *after_name = is_prefixed_with(argument, o->name);
+		if (after_name) {
+			argument = after_name;
 			o->function();
 			goto next;
 		}
diff -Nurp busybox.old/miscutils/devfsd.c busybox/miscutils/devfsd.c
--- busybox.old/miscutils/devfsd.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/miscutils/devfsd.c	2015-05-29 07:00:58.185925813 +0800
@@ -1405,7 +1405,6 @@ const char *get_old_name(const char *dev
 	int indexx;
 	const char *pty1;
 	const char *pty2;
-	size_t len;
 	/* 1 to 5  "scsi/" , 6 to 9 "ide/host", 10 sbp/, 11 vcc/, 12 pty/ */
 	static const char *const fmt[] = {
 		NULL ,
@@ -1425,12 +1424,11 @@ const char *get_old_name(const char *dev
 	};
 
 	for (trans = translate_table; trans->match != NULL; ++trans) {
-		len = strlen(trans->match);
-
-		if (strncmp(devname, trans->match, len) == 0) {
+		char *after_match = is_prefixed_with(devname, trans->match);
+		if (after_match) {
 			if (trans->format == NULL)
-				return devname + len;
-			sprintf(buffer, trans->format, devname + len);
+				return after_match;
+			sprintf(buffer, trans->format, after_match);
 			return buffer;
 		}
 	}
diff -Nurp busybox.old/miscutils/fbsplash.c busybox/miscutils/fbsplash.c
--- busybox.old/miscutils/fbsplash.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/miscutils/fbsplash.c	2015-05-29 07:00:58.185925813 +0800
@@ -516,7 +516,7 @@ int fbsplash_main(int argc UNUSED_PARAM,
 	// handle a case when we have many buffered lines
 	// already in the pipe
 	while ((num_buf = xmalloc_fgetline(fp)) != NULL) {
-		if (strncmp(num_buf, "exit", 4) == 0) {
+		if (is_prefixed_with(num_buf, "exit")) {
 			DEBUG_MESSAGE("exit");
 			break;
 		}
diff -Nurp busybox.old/miscutils/i2c_tools.c busybox/miscutils/i2c_tools.c
--- busybox.old/miscutils/i2c_tools.c	1970-01-01 08:00:00.000000000 +0800
+++ busybox/miscutils/i2c_tools.c	2015-05-29 07:00:58.185925813 +0800
@@ -0,0 +1,1403 @@
+/* vi: set sw=4 ts=4: */
+/*
+ * Minimal i2c-tools implementation for busybox.
+ * Parts of code ported from i2c-tools:
+ * 		http://www.lm-sensors.org/wiki/I2CTools.
+ *
+ * Copyright (C) 2014 by Bartosz Golaszewski <bartekgola@gmail.com>
+ *
+ * Licensed under GPLv2 or later, see file LICENSE in this source tree.
+ */
+
+//config:config I2CGET
+//config:	bool "i2cget"
+//config:	default y
+//config:	select PLATFORM_LINUX
+//config:	help
+//config:	  Read from I2C/SMBus chip registers.
+//config:
+//config:config I2CSET
+//config:	bool "i2cset"
+//config:	default y
+//config:	select PLATFORM_LINUX
+//config:	help
+//config:	  Set I2C registers.
+//config:
+//config:config I2CDUMP
+//config:	bool "i2cdump"
+//config:	default y
+//config:	select PLATFORM_LINUX
+//config:	help
+//config:	  Examine I2C registers.
+//config:
+//config:config I2CDETECT
+//config:	bool "i2cdetect"
+//config:	default y
+//config:	select PLATFORM_LINUX
+//config:	help
+//config:	  Detect I2C chips.
+//config:
+
+//applet:IF_I2CGET(APPLET(i2cget, BB_DIR_USR_SBIN, BB_SUID_DROP))
+//applet:IF_I2CSET(APPLET(i2cset, BB_DIR_USR_SBIN, BB_SUID_DROP))
+//applet:IF_I2CDUMP(APPLET(i2cdump, BB_DIR_USR_SBIN, BB_SUID_DROP))
+//applet:IF_I2CDETECT(APPLET(i2cdetect, BB_DIR_USR_SBIN, BB_SUID_DROP))
+
+//kbuild:lib-$(CONFIG_I2CGET) += i2c_tools.o
+//kbuild:lib-$(CONFIG_I2CSET) += i2c_tools.o
+//kbuild:lib-$(CONFIG_I2CDUMP) += i2c_tools.o
+//kbuild:lib-$(CONFIG_I2CDETECT) += i2c_tools.o
+
+/*
+ * Unsupported stuff:
+ *
+ * - upstream i2c-tools can also look-up i2c busses by name, we only accept
+ *   numbers,
+ * - bank and bankreg parameters for i2cdump are not supported because of
+ *   their limited usefulness (see i2cdump manual entry for more info),
+ * - i2cdetect doesn't look for bus info in /proc as it does in upstream, but
+ *   it shouldn't be a problem in modern kernels.
+ */
+
+#include "libbb.h"
+
+/*
+ * /dev/i2c-X ioctl commands. The ioctl's parameter is always an unsigned long,
+ * except for:
+ *    - I2C_FUNCS, takes pointer to an unsigned long
+ *    - I2C_RDWR, takes pointer to struct i2c_rdwr_ioctl_data
+ *    - I2C_SMBUS, takes pointer to struct i2c_smbus_ioctl_data
+ */
+
+/*
+ * NOTE: Slave address is 7 or 10 bits, but 10-bit addresses
+ * are not supported due to code brokenness.
+ */
+
+/* Use this slave address. */
+#define I2C_SLAVE	0x0703
+/* Use this slave address, even if it is already in use by a driver. */
+#define I2C_SLAVE_FORCE	0x0706
+/* 0 for 7 bit addrs, != 0 for 10 bit. */
+#define I2C_TENBIT	0x0704
+/* Get the adapter functionality mask. */
+#define I2C_FUNCS	0x0705
+/* Combined R/W transfer (one STOP only). */
+#define I2C_RDWR	0x0707
+/* != 0 to use PEC with SMBus. */
+#define I2C_PEC		0x0708
+/* SMBus transfer. */
+#define I2C_SMBUS	0x0720
+
+/* Structure used in the I2C_SMBUS ioctl call. */
+struct i2c_smbus_ioctl_data {
+	uint8_t read_write;
+	uint8_t command;
+	uint32_t size;
+	union i2c_smbus_data *data;
+};
+
+/* Structure used in the I2C_RDWR ioctl call. */
+struct i2c_rdwr_ioctl_data {
+	struct i2c_msg *msgs;	/* Pointers to i2c_msgs. */
+	uint32_t nmsgs;		/* Number of i2c_msgs. */
+};
+
+/* As specified in SMBus standard. */
+#define I2C_SMBUS_BLOCK_MAX		32
+/* Not specified but we use same structure. */
+#define I2C_SMBUS_I2C_BLOCK_MAX		32
+
+/* Data for SMBus Messages. */
+union i2c_smbus_data {
+	uint8_t byte;
+	uint16_t word;
+	/* block[0] is used for length and one more for PEC */
+	uint8_t block[I2C_SMBUS_BLOCK_MAX + 2];
+};
+
+#define I2C_RDRW_IOCTL_MAX_MSGS		42
+#define I2C_MAX_REGS			256
+
+/* Smbus_access read or write markers. */
+#define I2C_SMBUS_READ			1
+#define I2C_SMBUS_WRITE			0
+
+/* SMBus transaction types (size parameter in the below functions). */
+#define I2C_SMBUS_QUICK			0
+#define I2C_SMBUS_BYTE			1
+#define I2C_SMBUS_BYTE_DATA		2
+#define I2C_SMBUS_WORD_DATA		3
+#define I2C_SMBUS_PROC_CALL		4
+#define I2C_SMBUS_BLOCK_DATA		5
+#define I2C_SMBUS_I2C_BLOCK_BROKEN	6
+#define I2C_SMBUS_BLOCK_PROC_CALL	7
+#define I2C_SMBUS_I2C_BLOCK_DATA	8
+
+#define DETECT_MODE_AUTO		0
+#define DETECT_MODE_QUICK		1
+#define DETECT_MODE_READ		2
+
+/* Defines to determine what functionality is present. */
+#define I2C_FUNC_I2C				0x00000001
+#define I2C_FUNC_10BIT_ADDR			0x00000002
+#define I2C_FUNC_PROTOCOL_MANGLING		0x00000004
+#define I2C_FUNC_SMBUS_PEC			0x00000008
+#define I2C_FUNC_SMBUS_BLOCK_PROC_CALL		0x00008000
+#define I2C_FUNC_SMBUS_QUICK			0x00010000
+#define I2C_FUNC_SMBUS_READ_BYTE		0x00020000
+#define I2C_FUNC_SMBUS_WRITE_BYTE		0x00040000
+#define I2C_FUNC_SMBUS_READ_BYTE_DATA		0x00080000
+#define I2C_FUNC_SMBUS_WRITE_BYTE_DATA		0x00100000
+#define I2C_FUNC_SMBUS_READ_WORD_DATA		0x00200000
+#define I2C_FUNC_SMBUS_WRITE_WORD_DATA		0x00400000
+#define I2C_FUNC_SMBUS_PROC_CALL		0x00800000
+#define I2C_FUNC_SMBUS_READ_BLOCK_DATA		0x01000000
+#define I2C_FUNC_SMBUS_WRITE_BLOCK_DATA 	0x02000000
+#define I2C_FUNC_SMBUS_READ_I2C_BLOCK		0x04000000
+#define I2C_FUNC_SMBUS_WRITE_I2C_BLOCK		0x08000000
+
+#define I2C_FUNC_SMBUS_BYTE		(I2C_FUNC_SMBUS_READ_BYTE | \
+					 I2C_FUNC_SMBUS_WRITE_BYTE)
+#define I2C_FUNC_SMBUS_BYTE_DATA	(I2C_FUNC_SMBUS_READ_BYTE_DATA | \
+					 I2C_FUNC_SMBUS_WRITE_BYTE_DATA)
+#define I2C_FUNC_SMBUS_WORD_DATA	(I2C_FUNC_SMBUS_READ_WORD_DATA | \
+					 I2C_FUNC_SMBUS_WRITE_WORD_DATA)
+#define I2C_FUNC_SMBUS_BLOCK_DATA	(I2C_FUNC_SMBUS_READ_BLOCK_DATA | \
+					 I2C_FUNC_SMBUS_WRITE_BLOCK_DATA)
+#define I2C_FUNC_SMBUS_I2C_BLOCK	(I2C_FUNC_SMBUS_READ_I2C_BLOCK | \
+					 I2C_FUNC_SMBUS_WRITE_I2C_BLOCK)
+
+/*
+ * This is needed for ioctl_or_perror_and_die() since it only accepts pointers.
+ */
+static ALWAYS_INLINE void *itoptr(int i)
+{
+	return (void*)(intptr_t)i;
+}
+
+static int32_t i2c_smbus_access(int fd, char read_write, uint8_t cmd,
+				int size, union i2c_smbus_data *data)
+{
+	struct i2c_smbus_ioctl_data args;
+
+	args.read_write = read_write;
+	args.command = cmd;
+	args.size = size;
+	args.data = data;
+
+	return ioctl(fd, I2C_SMBUS, &args);
+}
+
+static int32_t i2c_smbus_read_byte(int fd)
+{
+	union i2c_smbus_data data;
+	int err;
+
+	err = i2c_smbus_access(fd, I2C_SMBUS_READ, 0, I2C_SMBUS_BYTE, &data);
+	if (err < 0)
+		return err;
+
+	return data.byte;
+}
+
+#if ENABLE_I2CGET || ENABLE_I2CSET || ENABLE_I2CDUMP
+static int32_t i2c_smbus_write_byte(int fd, uint8_t val)
+{
+	return i2c_smbus_access(fd, I2C_SMBUS_WRITE,
+				val, I2C_SMBUS_BYTE, NULL);
+}
+
+static int32_t i2c_smbus_read_byte_data(int fd, uint8_t cmd)
+{
+	union i2c_smbus_data data;
+	int err;
+
+	err = i2c_smbus_access(fd, I2C_SMBUS_READ, cmd,
+			       I2C_SMBUS_BYTE_DATA, &data);
+	if (err < 0)
+		return err;
+
+	return data.byte;
+}
+
+static int32_t i2c_smbus_read_word_data(int fd, uint8_t cmd)
+{
+	union i2c_smbus_data data;
+	int err;
+
+	err = i2c_smbus_access(fd, I2C_SMBUS_READ, cmd,
+			       I2C_SMBUS_WORD_DATA, &data);
+	if (err < 0)
+		return err;
+
+	return data.word;
+}
+#endif /* ENABLE_I2CGET || ENABLE_I2CSET || ENABLE_I2CDUMP */
+
+#if ENABLE_I2CSET
+static int32_t i2c_smbus_write_byte_data(int file,
+					 uint8_t cmd, uint8_t value)
+{
+	union i2c_smbus_data data;
+
+	data.byte = value;
+
+	return i2c_smbus_access(file, I2C_SMBUS_WRITE, cmd,
+				I2C_SMBUS_BYTE_DATA, &data);
+}
+
+static int32_t i2c_smbus_write_word_data(int file, uint8_t cmd, uint16_t value)
+{
+	union i2c_smbus_data data;
+
+	data.word = value;
+
+	return i2c_smbus_access(file, I2C_SMBUS_WRITE, cmd,
+				I2C_SMBUS_WORD_DATA, &data);
+}
+
+static int32_t i2c_smbus_write_block_data(int file, uint8_t cmd,
+				   uint8_t length, const uint8_t *values)
+{
+	union i2c_smbus_data data;
+
+	if (length > I2C_SMBUS_BLOCK_MAX)
+		length = I2C_SMBUS_BLOCK_MAX;
+
+	memcpy(data.block+1, values, length);
+	data.block[0] = length;
+
+	return i2c_smbus_access(file, I2C_SMBUS_WRITE, cmd,
+				I2C_SMBUS_BLOCK_DATA, &data);
+}
+
+static int32_t i2c_smbus_write_i2c_block_data(int file, uint8_t cmd,
+				       uint8_t length, const uint8_t *values)
+{
+	union i2c_smbus_data data;
+
+	if (length > I2C_SMBUS_BLOCK_MAX)
+		length = I2C_SMBUS_BLOCK_MAX;
+
+	memcpy(data.block+1, values, length);
+	data.block[0] = length;
+
+	return i2c_smbus_access(file, I2C_SMBUS_WRITE, cmd,
+				I2C_SMBUS_I2C_BLOCK_BROKEN, &data);
+}
+#endif /* ENABLE_I2CSET */
+
+#if ENABLE_I2CDUMP
+/*
+ * Returns the number of bytes read, vals must hold at
+ * least I2C_SMBUS_BLOCK_MAX bytes.
+ */
+static int32_t i2c_smbus_read_block_data(int fd, uint8_t cmd, uint8_t *vals)
+{
+	union i2c_smbus_data data;
+	int i, err;
+
+	err = i2c_smbus_access(fd, I2C_SMBUS_READ, cmd,
+			       I2C_SMBUS_BLOCK_DATA, &data);
+	if (err < 0)
+		return err;
+
+	for (i = 1; i <= data.block[0]; i++)
+		*vals++ = data.block[i];
+	return data.block[0];
+}
+
+static int32_t i2c_smbus_read_i2c_block_data(int fd, uint8_t cmd,
+					     uint8_t len, uint8_t *vals)
+{
+	union i2c_smbus_data data;
+	int i, err;
+
+	if (len > I2C_SMBUS_BLOCK_MAX)
+		len = I2C_SMBUS_BLOCK_MAX;
+	data.block[0] = len;
+
+	err = i2c_smbus_access(fd, I2C_SMBUS_READ, cmd,
+			       len == 32 ? I2C_SMBUS_I2C_BLOCK_BROKEN :
+					   I2C_SMBUS_I2C_BLOCK_DATA, &data);
+	if (err < 0)
+		return err;
+
+	for (i = 1; i <= data.block[0]; i++)
+		*vals++ = data.block[i];
+	return data.block[0];
+}
+#endif /* ENABLE_I2CDUMP */
+
+#if ENABLE_I2CDETECT
+static int32_t i2c_smbus_write_quick(int fd, uint8_t val)
+{
+	return i2c_smbus_access(fd, val, 0, I2C_SMBUS_QUICK, NULL);
+}
+#endif /* ENABLE_I2CDETECT */
+
+static int i2c_bus_lookup(const char *bus_str)
+{
+	return xstrtou_range(bus_str, 10, 0, 0xfffff);
+}
+
+#if ENABLE_I2CGET || ENABLE_I2CSET || ENABLE_I2CDUMP
+static int i2c_parse_bus_addr(const char *addr_str)
+{
+	/* Slave address must be in range 0x03 - 0x77. */
+	return xstrtou_range(addr_str, 16, 0x03, 0x77);
+}
+
+static void i2c_set_pec(int fd, int pec)
+{
+	ioctl_or_perror_and_die(fd, I2C_PEC,
+				itoptr(pec ? 1 : 0),
+				"can't set PEC");
+}
+#endif /* ENABLE_I2CGET || ENABLE_I2CSET || ENABLE_I2CDUMP */
+
+#if ENABLE_I2CGET || ENABLE_I2CSET
+static int i2c_parse_data_addr(const char *data_addr)
+{
+	/* Data address must be an 8 bit integer. */
+	return xstrtou_range(data_addr, 16, 0, 0xff);
+}
+#endif /* ENABLE_I2CGET || ENABLE_I2CSET */
+
+/*
+ * Opens the device file associated with given i2c bus.
+ *
+ * Upstream i2c-tools also support opening devices by i2c bus name
+ * but we drop it here for size reduction.
+ */
+static int i2c_dev_open(int i2cbus)
+{
+	char filename[sizeof("/dev/i2c-%d") + sizeof(int)*3];
+	int fd;
+
+	sprintf(filename, "/dev/i2c-%d", i2cbus);
+	fd = open(filename, O_RDWR);
+	if (fd < 0) {
+		if (errno == ENOENT) {
+			filename[8] = '/'; /* change to "/dev/i2c/%d" */
+			fd = xopen(filename, O_RDWR);
+		} else {
+			bb_perror_msg_and_die("can't open '%s'", filename);
+		}
+	}
+
+	return fd;
+}
+
+static void i2c_set_slave_addr(int fd, int addr, int force)
+{
+	ioctl_or_perror_and_die(fd, force ? I2C_SLAVE_FORCE : I2C_SLAVE,
+				itoptr(addr),
+				"can't set address to 0x%02x", addr);
+}
+
+/* Size reducing helpers for xxx_check_funcs(). */
+static void get_funcs_matrix(int fd, unsigned long *funcs)
+{
+	ioctl_or_perror_and_die(fd, I2C_FUNCS, funcs,
+			"can't get adapter functionality matrix");
+}
+
+#if ENABLE_I2CGET || ENABLE_I2CSET || ENABLE_I2CDUMP
+static void check_funcs_test_end(int funcs, int pec, const char *err)
+{
+	if (pec && !(funcs & (I2C_FUNC_SMBUS_PEC | I2C_FUNC_I2C)))
+		bb_error_msg("warning: adapter does not support PEC");
+
+	if (err)
+		bb_error_msg_and_die(
+			"adapter has no %s capability", err);
+}
+#endif /* ENABLE_I2CGET || ENABLE_I2CSET || ENABLE_I2CDUMP */
+
+/*
+ * The below functions emit an error message and exit if the adapter doesn't
+ * support desired functionalities.
+ */
+#if ENABLE_I2CGET || ENABLE_I2CDUMP
+static void check_read_funcs(int fd, int mode, int data_addr, int pec)
+{
+	unsigned long funcs;
+	const char *err = NULL;
+
+	get_funcs_matrix(fd, &funcs);
+	switch (mode) {
+	case I2C_SMBUS_BYTE:
+		if (!(funcs & I2C_FUNC_SMBUS_READ_BYTE)) {
+			err = "SMBus receive byte";
+			break;
+		}
+		if (data_addr >= 0 && !(funcs & I2C_FUNC_SMBUS_WRITE_BYTE))
+			err = "SMBus send byte";
+		break;
+	case I2C_SMBUS_BYTE_DATA:
+		if (!(funcs & I2C_FUNC_SMBUS_READ_BYTE_DATA))
+			err = "SMBus read byte";
+		break;
+	case I2C_SMBUS_WORD_DATA:
+		if (!(funcs & I2C_FUNC_SMBUS_READ_WORD_DATA))
+			err = "SMBus read word";
+		break;
+#if ENABLE_I2CDUMP
+	case I2C_SMBUS_BLOCK_DATA:
+		if (!(funcs & I2C_FUNC_SMBUS_READ_BLOCK_DATA))
+			err = "SMBus block read";
+		break;
+
+	case I2C_SMBUS_I2C_BLOCK_DATA:
+		if (!(funcs & I2C_FUNC_SMBUS_READ_I2C_BLOCK))
+			err = "I2C block read";
+		break;
+#endif /* ENABLE_I2CDUMP */
+	default:
+		bb_error_msg_and_die("Programmer goofed!");
+	}
+	check_funcs_test_end(funcs, pec, err);
+}
+#endif /* ENABLE_I2CGET || ENABLE_I2CDUMP */
+
+#if ENABLE_I2CSET
+static void check_write_funcs(int fd, int mode, int pec)
+{
+	unsigned long funcs;
+	const char *err = NULL;
+
+	get_funcs_matrix(fd, &funcs);
+	switch (mode) {
+	case I2C_SMBUS_BYTE:
+		if (!(funcs & I2C_FUNC_SMBUS_WRITE_BYTE))
+			err = "SMBus send byte";
+		break;
+
+	case I2C_SMBUS_BYTE_DATA:
+		if (!(funcs & I2C_FUNC_SMBUS_WRITE_BYTE_DATA))
+			err = "SMBus write byte";
+		break;
+
+	case I2C_SMBUS_WORD_DATA:
+		if (!(funcs & I2C_FUNC_SMBUS_WRITE_WORD_DATA))
+			err = "SMBus write word";
+		break;
+
+	case I2C_SMBUS_BLOCK_DATA:
+		if (!(funcs & I2C_FUNC_SMBUS_WRITE_BLOCK_DATA))
+			err = "SMBus block write";
+		break;
+	case I2C_SMBUS_I2C_BLOCK_DATA:
+		if (!(funcs & I2C_FUNC_SMBUS_WRITE_I2C_BLOCK))
+			err = "I2C block write";
+		break;
+	}
+	check_funcs_test_end(funcs, pec, err);
+}
+#endif /* ENABLE_I2CSET */
+
+static void confirm_or_abort(void)
+{
+	fprintf(stderr, "Continue? [y/N] ");
+	fflush_all();
+	if (!bb_ask_confirmation())
+		bb_error_msg_and_die("aborting");
+}
+
+/*
+ * Return only if user confirms the action, abort otherwise.
+ *
+ * The messages displayed here are much less elaborate than their i2c-tools
+ * counterparts - this is done for size reduction.
+ */
+static void confirm_action(int bus_addr, int mode, int data_addr, int pec)
+{
+	bb_error_msg("WARNING! This program can confuse your I2C bus");
+
+	/* Don't let the user break his/her EEPROMs */
+	if (bus_addr >= 0x50 && bus_addr <= 0x57 && pec) {
+		bb_error_msg_and_die("this is I2C not smbus - using PEC on I2C "
+			"devices may result in data loss, aborting");
+	}
+
+	if (mode == I2C_SMBUS_BYTE && data_addr >= 0 && pec)
+		bb_error_msg("WARNING! May interpret a write byte command "
+			"with PEC as a write byte data command");
+
+	if (pec)
+		bb_error_msg("PEC checking enabled");
+
+	confirm_or_abort();
+}
+
+#if ENABLE_I2CGET
+//usage:#define i2cget_trivial_usage
+//usage:       "[-f] [-y] BUS CHIP-ADDRESS [DATA-ADDRESS [MODE]]"
+//usage:#define i2cget_full_usage "\n\n"
+//usage:       "Read from I2C/SMBus chip registers\n"
+//usage:     "\n	I2CBUS	i2c bus number"
+//usage:     "\n	ADDRESS	0x03 - 0x77"
+//usage:     "\nMODE is:"
+//usage:     "\n	b	read byte data (default)"
+//usage:     "\n	w	read word data"
+//usage:     "\n	c	write byte/read byte"
+//usage:     "\n	Append p for SMBus PEC"
+//usage:     "\n"
+//usage:     "\n	-f	force access"
+//usage:     "\n	-y	disable interactive mode"
+int i2cget_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
+int i2cget_main(int argc UNUSED_PARAM, char **argv)
+{
+	const unsigned opt_f = (1 << 0), opt_y = (1 << 1);
+	const char *const optstr = "fy";
+
+	int bus_num, bus_addr, data_addr = -1, status;
+	int mode = I2C_SMBUS_BYTE, pec = 0, fd;
+	unsigned opts;
+
+        opt_complementary = "-2:?4"; /* from 2 to 4 args */
+	opts = getopt32(argv, optstr);
+	argv += optind;
+
+	bus_num = i2c_bus_lookup(argv[0]);
+	bus_addr = i2c_parse_bus_addr(argv[1]);
+
+	if (argv[2]) {
+		data_addr = i2c_parse_data_addr(argv[2]);
+		mode = I2C_SMBUS_BYTE_DATA;
+		if (argv[3]) {
+			switch (argv[3][0]) {
+			case 'b':	/* Already set */		break;
+			case 'w':	mode = I2C_SMBUS_WORD_DATA;	break;
+			case 'c':	mode = I2C_SMBUS_BYTE;		break;
+			default:
+				bb_error_msg("invalid mode");
+				bb_show_usage();
+			}
+			pec = argv[3][1] == 'p';
+		}
+	}
+
+	fd = i2c_dev_open(bus_num);
+	check_read_funcs(fd, mode, data_addr, pec);
+	i2c_set_slave_addr(fd, bus_addr, opts & opt_f);
+
+	if (!(opts & opt_y))
+		confirm_action(bus_addr, mode, data_addr, pec);
+
+	if (pec)
+		i2c_set_pec(fd, 1);
+
+	switch (mode) {
+	case I2C_SMBUS_BYTE:
+		if (data_addr >= 0) {
+			status = i2c_smbus_write_byte(fd, data_addr);
+			if (status < 0)
+				bb_error_msg("warning - write failed");
+		}
+		status = i2c_smbus_read_byte(fd);
+		break;
+	case I2C_SMBUS_WORD_DATA:
+		status = i2c_smbus_read_word_data(fd, data_addr);
+		break;
+	default: /* I2C_SMBUS_BYTE_DATA */
+		status = i2c_smbus_read_byte_data(fd, data_addr);
+	}
+	close(fd);
+
+	if (status < 0)
+		bb_perror_msg_and_die("read failed");
+
+	printf("0x%0*x\n", mode == I2C_SMBUS_WORD_DATA ? 4 : 2, status);
+
+	return 0;
+}
+#endif /* ENABLE_I2CGET */
+
+#if ENABLE_I2CSET
+//usage:#define i2cset_trivial_usage
+//usage:       "[-f] [-y] [-m MASK] BUS CHIP-ADDR DATA-ADDR [VALUE] ... [MODE]"
+//usage:#define i2cset_full_usage "\n\n"
+//usage:       "Set I2C registers\n"
+//usage:     "\n	I2CBUS	i2c bus number"
+//usage:     "\n	ADDRESS	0x03 - 0x77"
+//usage:     "\nMODE is:"
+//usage:     "\n	c	byte, no value"
+//usage:     "\n	b	byte data (default)"
+//usage:     "\n	w	word data"
+//usage:     "\n	i	I2C block data"
+//usage:     "\n	s	SMBus block data"
+//usage:     "\n	Append p for SMBus PEC"
+//usage:     "\n"
+//usage:     "\n	-f	force access"
+//usage:     "\n	-y	disable interactive mode"
+//usage:     "\n	-r	read back and compare the result"
+//usage:     "\n	-m MASK	mask specifying which bits to write"
+int i2cset_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
+int i2cset_main(int argc, char **argv)
+{
+	const unsigned opt_f = (1 << 0), opt_y = (1 << 1),
+			      opt_m = (1 << 2), opt_r = (1 << 3);
+	const char *const optstr = "fym:r";
+
+	int bus_num, bus_addr, data_addr, mode = I2C_SMBUS_BYTE, pec = 0;
+	int val, blen = 0, mask = 0, fd, status;
+	unsigned char block[I2C_SMBUS_BLOCK_MAX];
+	char *opt_m_arg = NULL;
+	unsigned opts;
+
+        opt_complementary = "-3"; /* from 3 to ? args */
+	opts = getopt32(argv, optstr, &opt_m_arg);
+	argv += optind;
+	argc -= optind;
+
+	bus_num = i2c_bus_lookup(argv[0]);
+	bus_addr = i2c_parse_bus_addr(argv[1]);
+	data_addr = i2c_parse_data_addr(argv[2]);
+
+	if (argv[3]) {
+		if (!argv[4] && argv[3][0] != 'c') {
+			mode = I2C_SMBUS_BYTE_DATA; /* Implicit b */
+		} else {
+			switch (argv[argc-1][0]) {
+			case 'c': /* Already set */			break;
+			case 'b': mode = I2C_SMBUS_BYTE_DATA;		break;
+			case 'w': mode = I2C_SMBUS_WORD_DATA;		break;
+			case 's': mode = I2C_SMBUS_BLOCK_DATA;		break;
+			case 'i': mode = I2C_SMBUS_I2C_BLOCK_DATA;	break;
+			default:
+				bb_error_msg("invalid mode");
+				bb_show_usage();
+			}
+
+			pec = argv[argc-1][1] == 'p';
+			if (mode == I2C_SMBUS_BLOCK_DATA ||
+					mode == I2C_SMBUS_I2C_BLOCK_DATA) {
+				if (pec && mode == I2C_SMBUS_I2C_BLOCK_DATA)
+					bb_error_msg_and_die(
+						"PEC not supported for I2C "
+						"block writes");
+				if (opts & opt_m)
+					bb_error_msg_and_die(
+						"mask not supported for block "
+						"writes");
+			}
+		}
+	}
+
+	/* Prepare the value(s) to be written according to current mode. */
+	switch (mode) {
+	case I2C_SMBUS_BYTE_DATA:
+		val = xstrtou_range(argv[3], 0, 0, 0xff);
+		break;
+	case I2C_SMBUS_WORD_DATA:
+		val = xstrtou_range(argv[3], 0, 0, 0xffff);
+		break;
+	case I2C_SMBUS_BLOCK_DATA:
+	case I2C_SMBUS_I2C_BLOCK_DATA:
+		for (blen = 3; blen < (argc - 1); blen++)
+			block[blen] = xstrtou_range(argv[blen], 0, 0, 0xff);
+		val = -1;
+		break;
+	default:
+		val = -1;
+		break;
+	}
+
+	if (opts & opt_m) {
+		mask = xstrtou_range(opt_m_arg, 0, 0,
+				(mode == I2C_SMBUS_BYTE ||
+				 mode == I2C_SMBUS_BYTE_DATA) ? 0xff : 0xffff);
+	}
+
+	fd = i2c_dev_open(bus_num);
+	check_write_funcs(fd, mode, pec);
+	i2c_set_slave_addr(fd, bus_addr, opts & opt_f);
+
+	if (!(opts & opt_y))
+		confirm_action(bus_addr, mode, data_addr, pec);
+
+	/*
+	 * If we're using mask - read the current value here and adjust the
+	 * value to be written.
+	 */
+	if (opts & opt_m) {
+		int tmpval;
+
+		switch (mode) {
+		case I2C_SMBUS_BYTE:
+			tmpval = i2c_smbus_read_byte(fd);
+			break;
+		case I2C_SMBUS_WORD_DATA:
+			tmpval = i2c_smbus_read_word_data(fd, data_addr);
+			break;
+		default:
+			tmpval = i2c_smbus_read_byte_data(fd, data_addr);
+		}
+
+		if (tmpval < 0)
+			bb_perror_msg_and_die("can't read old value");
+
+		val = (val & mask) | (tmpval & ~mask);
+
+		if (!(opts & opt_y)) {
+			bb_error_msg("old value 0x%0*x, write mask "
+				"0x%0*x, will write 0x%0*x to register "
+				"0x%02x",
+				mode == I2C_SMBUS_WORD_DATA ? 4 : 2, tmpval,
+				mode == I2C_SMBUS_WORD_DATA ? 4 : 2, mask,
+				mode == I2C_SMBUS_WORD_DATA ? 4 : 2, val,
+				data_addr);
+			confirm_or_abort();
+		}
+	}
+
+	if (pec)
+		i2c_set_pec(fd, 1);
+
+	switch (mode) {
+	case I2C_SMBUS_BYTE:
+		status = i2c_smbus_write_byte(fd, data_addr);
+		break;
+	case I2C_SMBUS_WORD_DATA:
+		status = i2c_smbus_write_word_data(fd, data_addr, val);
+		break;
+	case I2C_SMBUS_BLOCK_DATA:
+		status = i2c_smbus_write_block_data(fd, data_addr,
+						    blen, block);
+		break;
+	case I2C_SMBUS_I2C_BLOCK_DATA:
+		status = i2c_smbus_write_i2c_block_data(fd, data_addr,
+							blen, block);
+		break;
+	default: /* I2C_SMBUS_BYTE_DATA */
+		status = i2c_smbus_write_byte_data(fd, data_addr, val);
+		break;
+	}
+	if (status < 0)
+		bb_perror_msg_and_die("write failed");
+
+	if (pec)
+		i2c_set_pec(fd, 0); /* Clear PEC. */
+
+	/* No readback required - we're done. */
+	if (!(opts & opt_r))
+		return 0;
+
+	switch (mode) {
+	case I2C_SMBUS_BYTE:
+		status = i2c_smbus_read_byte(fd);
+		val = data_addr;
+		break;
+	case I2C_SMBUS_WORD_DATA:
+		status = i2c_smbus_read_word_data(fd, data_addr);
+		break;
+	default: /* I2C_SMBUS_BYTE_DATA */
+		status = i2c_smbus_read_byte_data(fd, data_addr);
+	}
+
+	if (status < 0) {
+		printf("Warning - readback failed\n");
+	} else
+	if (status != val) {
+		printf("Warning - data mismatch - wrote "
+		       "0x%0*x, read back 0x%0*x\n",
+		       mode == I2C_SMBUS_WORD_DATA ? 4 : 2, val,
+		       mode == I2C_SMBUS_WORD_DATA ? 4 : 2, status);
+	} else {
+		printf("Value 0x%0*x written, readback matched\n",
+		       mode == I2C_SMBUS_WORD_DATA ? 4 : 2, val);
+	}
+
+	return 0;
+}
+#endif /* ENABLE_I2CSET */
+
+#if ENABLE_I2CDUMP
+//usage:#define i2cdump_trivial_usage
+//usage:       "[-f] [-r FIRST-LAST] [-y] BUS ADDR [MODE]"
+//usage:#define i2cdump_full_usage "\n\n"
+//usage:       "Examine I2C registers\n"
+//usage:     "\n	I2CBUS	i2c bus number"
+//usage:     "\n	ADDRESS	0x03 - 0x77"
+//usage:     "\nMODE is:"
+//usage:     "\n	b	byte (default)"
+//usage:     "\n	w	word"
+//usage:     "\n	W	word on even register addresses"
+//usage:     "\n	i	I2C block"
+//usage:     "\n	s	SMBus block"
+//usage:     "\n	c	consecutive byte"
+//usage:     "\n	Append p for SMBus PEC"
+//usage:     "\n"
+//usage:     "\n	-f	force access"
+//usage:     "\n	-y	disable interactive mode"
+//usage:     "\n	-r	limit the number of registers being accessed"
+int i2cdump_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
+int i2cdump_main(int argc UNUSED_PARAM, char **argv)
+{
+	const unsigned opt_f = (1 << 0), opt_y = (1 << 1),
+			      opt_r = (1 << 2);
+	const char *const optstr = "fyr:";
+
+	int bus_num, bus_addr, mode = I2C_SMBUS_BYTE_DATA, even = 0, pec = 0;
+	unsigned first = 0x00, last = 0xff;
+	int fd, i, j, res, blen = 0, tmp;
+	unsigned char cblock[I2C_SMBUS_BLOCK_MAX + I2C_MAX_REGS];
+	unsigned char block[I2C_SMBUS_BLOCK_MAX];
+	char *opt_r_str, *dash;
+	unsigned opts;
+
+        opt_complementary = "-2:?3"; /* from 2 to 3 args */
+	opts = getopt32(argv, optstr, &opt_r_str);
+	argv += optind;
+
+	bus_num = i2c_bus_lookup(argv[0]);
+	bus_addr = i2c_parse_bus_addr(argv[1]);
+
+	if (argv[2]) {
+		switch (argv[2][0]) {
+		case 'b': /* Already set */			break;
+		case 'c': mode = I2C_SMBUS_BYTE;		break;
+		case 'w': mode = I2C_SMBUS_WORD_DATA;		break;
+		case 'W':
+			mode = I2C_SMBUS_WORD_DATA;
+			even = 1;
+			break;
+		case 's': mode = I2C_SMBUS_BLOCK_DATA;		break;
+		case 'i': mode = I2C_SMBUS_I2C_BLOCK_DATA;	break;
+		default:
+			bb_error_msg_and_die("invalid mode");
+		}
+
+		if (argv[2][1] == 'p') {
+			if (argv[2][0] == 'W' || argv[2][0] == 'i') {
+				bb_error_msg_and_die(
+					"pec not supported for -W and -i");
+			} else {
+				pec = 1;
+			}
+		}
+	}
+
+	if (opts & opt_r) {
+		first = strtol(opt_r_str, &dash, 0);
+		if (dash == opt_r_str || *dash != '-' || first > 0xff)
+			bb_error_msg_and_die("invalid range");
+		last = xstrtou_range(++dash, 0, first, 0xff);
+
+		/* Range is not available for every mode */
+		switch (mode) {
+		case I2C_SMBUS_BYTE:
+		case I2C_SMBUS_BYTE_DATA:
+			break;
+		case I2C_SMBUS_WORD_DATA:
+			if (!even || (!(first % 2) && last % 2))
+				break;
+			/* Fall through */
+		default:
+			bb_error_msg_and_die(
+				"range not compatible with selected mode");
+		}
+	}
+
+	fd = i2c_dev_open(bus_num);
+	check_read_funcs(fd, mode, -1 /* data_addr */, pec);
+	i2c_set_slave_addr(fd, bus_addr, opts & opt_f);
+
+	if (pec)
+		i2c_set_pec(fd, 1);
+
+	if (!(opts & opt_y))
+		confirm_action(bus_addr, mode, -1 /* data_addr */, pec);
+
+	/* All but word data */
+	if (mode != I2C_SMBUS_WORD_DATA || even) {
+		/*
+		 * FIXME This section has been ported from upstream i2cdump.
+		 * It has been reworked a bit but is still pretty spaghetti
+		 * and needs splitting into several functions.
+		 */
+		if (mode == I2C_SMBUS_BLOCK_DATA ||
+		    mode == I2C_SMBUS_I2C_BLOCK_DATA) {
+			res = i2c_smbus_read_block_data(fd, 0, cblock);
+			blen = res;
+		} else {
+			for (res = 0; res < I2C_MAX_REGS; res += tmp) {
+				tmp = i2c_smbus_read_i2c_block_data(
+					fd, res, I2C_SMBUS_BLOCK_MAX,
+					cblock + res);
+				if (tmp < 0) {
+					bb_error_msg_and_die(
+						"block read failed");
+				}
+			}
+			if (res >= I2C_MAX_REGS)
+				res = I2C_MAX_REGS;
+			for (i = 0; i < res; i++)
+				block[i] = cblock[i];
+			if (mode != I2C_SMBUS_BLOCK_DATA)
+				for (i = res; i < I2C_MAX_REGS; i++)
+					cblock[i] = -1;
+		}
+
+		if (mode == I2C_SMBUS_BYTE) {
+			res = i2c_smbus_write_byte(fd, first);
+			if (res < 0)
+				bb_perror_msg_and_die(
+					"write start address failed");
+		}
+
+		printf("     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f"
+		       "    0123456789abcdef\n");
+
+		for (i = 0; i < I2C_MAX_REGS; i += 0x10) {
+			if (mode == I2C_SMBUS_BLOCK_DATA && i >= blen)
+				break;
+			if (i/16 < first/16)
+				continue;
+			if (i/16 > last/16)
+				break;
+
+			printf("%02x: ", i);
+			for (j = 0; j < 16; j++) {
+				fflush_all();
+				/* Skip unwanted registers */
+				if (i+j < first || i+j > last) {
+					printf("   ");
+					if (mode == I2C_SMBUS_WORD_DATA) {
+						printf("   ");
+						j++;
+					}
+					continue;
+				}
+
+				switch (mode) {
+				case I2C_SMBUS_BYTE_DATA:
+					res = i2c_smbus_read_byte_data(fd, i+j);
+					block[i+j] = res;
+					break;
+				case I2C_SMBUS_WORD_DATA:
+					res = i2c_smbus_read_word_data(fd, i+j);
+					if (res < 0) {
+						block[i+j] = res;
+						block[i+j+1] = res;
+					} else {
+						block[i+j] = res & 0xff;
+						block[i+j+1] = res >> 8;
+					}
+					break;
+				case I2C_SMBUS_BYTE:
+					res = i2c_smbus_read_byte(fd);
+					block[i+j] = res;
+					break;
+				default:
+					res = block[i+j];
+				}
+
+				if (mode == I2C_SMBUS_BLOCK_DATA &&
+				    i+j >= blen) {
+					printf("   ");
+				} else if (res < 0) {
+					printf("XX ");
+					if (mode == I2C_SMBUS_WORD_DATA)
+						printf("XX ");
+				} else {
+					printf("%02x ", block[i+j]);
+					if (mode == I2C_SMBUS_WORD_DATA)
+						printf("%02x ", block[i+j+1]);
+				}
+
+				if (mode == I2C_SMBUS_WORD_DATA)
+					j++;
+			}
+			printf("   ");
+
+			for (j = 0; j < 16; j++) {
+				if (mode == I2C_SMBUS_BLOCK_DATA && i+j >= blen)
+					break;
+				/* Skip unwanted registers */
+				if (i+j < first || i+j > last) {
+					printf(" ");
+					continue;
+				}
+
+				res = block[i+j];
+				if (res < 0) {
+//FIXME: impossible, block[] is uchar[]
+					printf("X");
+				} else if (res == 0x00 || res == 0xff) {
+					printf(".");
+				} else if (res < 32 || res >= 127) {
+					printf("?");
+				} else {
+					printf("%c", res);
+				}
+			}
+			printf("\n");
+		}
+	} else {
+		/* Word data. */
+		printf("     0,8  1,9  2,a  3,b  4,c  5,d  6,e  7,f\n");
+		for (i = 0; i < 256; i += 8) {
+			if (i/8 < first/8)
+				continue;
+			if (i/8 > last/8)
+				break;
+
+			printf("%02x: ", i);
+			for (j = 0; j < 8; j++) {
+				/* Skip unwanted registers. */
+				if (i+j < first || i+j > last) {
+					printf("     ");
+					continue;
+				}
+
+				res = i2c_smbus_read_word_data(fd, i+j);
+				if (res < 0)
+					printf("XXXX ");
+				else
+					printf("%04x ", res & 0xffff);
+			}
+			printf("\n");
+		}
+	}
+
+	return 0;
+}
+#endif /* ENABLE_I2CDUMP */
+
+#if ENABLE_I2CDETECT
+enum adapter_type {
+	ADT_DUMMY = 0,
+	ADT_ISA,
+	ADT_I2C,
+	ADT_SMBUS,
+};
+
+struct adap_desc {
+	const char *funcs;
+	const char *algo;
+};
+
+static const struct adap_desc adap_descs[] = {
+	{ .funcs	= "dummy",
+	  .algo		= "Dummy bus", },
+	{ .funcs	= "isa",
+	  .algo		= "ISA bus", },
+	{ .funcs	= "i2c",
+	  .algo		= "I2C adapter", },
+	{ .funcs	= "smbus",
+	  .algo		= "SMBus adapter", },
+};
+
+struct i2c_func
+{
+	long value;
+	const char* name;
+};
+
+static const struct i2c_func i2c_funcs_tab[] = {
+	{ .value = I2C_FUNC_I2C,
+	  .name = "I2C" },
+	{ .value = I2C_FUNC_SMBUS_QUICK,
+	  .name = "SMBus Quick Command" },
+	{ .value = I2C_FUNC_SMBUS_WRITE_BYTE,
+	  .name = "SMBus Send Byte" },
+	{ .value = I2C_FUNC_SMBUS_READ_BYTE,
+	  .name = "SMBus Receive Byte" },
+	{ .value = I2C_FUNC_SMBUS_WRITE_BYTE_DATA,
+	  .name = "SMBus Write Byte" },
+	{ .value = I2C_FUNC_SMBUS_READ_BYTE_DATA,
+	  .name = "SMBus Read Byte" },
+	{ .value = I2C_FUNC_SMBUS_WRITE_WORD_DATA,
+	  .name = "SMBus Write Word" },
+	{ .value = I2C_FUNC_SMBUS_READ_WORD_DATA,
+	  .name = "SMBus Read Word" },
+	{ .value = I2C_FUNC_SMBUS_PROC_CALL,
+	  .name = "SMBus Process Call" },
+	{ .value = I2C_FUNC_SMBUS_WRITE_BLOCK_DATA,
+	  .name = "SMBus Block Write" },
+	{ .value = I2C_FUNC_SMBUS_READ_BLOCK_DATA,
+	  .name = "SMBus Block Read" },
+	{ .value = I2C_FUNC_SMBUS_BLOCK_PROC_CALL,
+	  .name = "SMBus Block Process Call" },
+	{ .value = I2C_FUNC_SMBUS_PEC,
+	  .name = "SMBus PEC" },
+	{ .value = I2C_FUNC_SMBUS_WRITE_I2C_BLOCK,
+	  .name = "I2C Block Write" },
+	{ .value = I2C_FUNC_SMBUS_READ_I2C_BLOCK,
+	  .name = "I2C Block Read" },
+	{ .value = 0, .name = NULL }
+};
+
+static enum adapter_type i2cdetect_get_funcs(int bus)
+{
+	enum adapter_type ret;
+	unsigned long funcs;
+	int fd;
+
+	fd = i2c_dev_open(bus);
+
+	get_funcs_matrix(fd, &funcs);
+	if (funcs & I2C_FUNC_I2C)
+		ret = ADT_I2C;
+	else if (funcs & (I2C_FUNC_SMBUS_BYTE |
+			  I2C_FUNC_SMBUS_BYTE_DATA |
+			  I2C_FUNC_SMBUS_WORD_DATA))
+		ret = ADT_SMBUS;
+	else
+		ret = ADT_DUMMY;
+
+	close(fd);
+
+	return ret;
+}
+
+static void NORETURN list_i2c_busses_and_exit(void)
+{
+	const char *const i2cdev_path = "/sys/class/i2c-dev";
+
+	char path[NAME_MAX], name[128];
+	struct dirent *de, *subde;
+	enum adapter_type adt;
+	DIR *dir, *subdir;
+	int rv, bus;
+	char *pos;
+	FILE *fp;
+
+	/*
+	 * XXX Upstream i2cdetect also looks for i2c bus info in /proc/bus/i2c,
+	 * but we won't bother since it's only useful on older kernels (before
+	 * 2.6.5). We expect sysfs to be present and mounted at /sys/.
+	 */
+
+	dir = xopendir(i2cdev_path);
+	while ((de = readdir(dir))) {
+		if (de->d_name[0] == '.')
+			continue;
+
+		/* Simple version for ISA chips. */
+		snprintf(path, NAME_MAX, "%s/%s/name",
+			 i2cdev_path, de->d_name);
+		fp = fopen(path, "r");
+		if (fp == NULL) {
+			snprintf(path, NAME_MAX,
+				 "%s/%s/device/name",
+				 i2cdev_path, de->d_name);
+			fp = fopen(path, "r");
+		}
+
+		/* Non-ISA chips require the hard-way. */
+		if (fp == NULL) {
+			snprintf(path, NAME_MAX,
+				 "%s/%s/device/name",
+				 i2cdev_path, de->d_name);
+			subdir = opendir(path);
+			if (subdir == NULL)
+				continue;
+
+			while ((subde = readdir(subdir))) {
+				if (subde->d_name[0] == '.')
+					continue;
+
+				if (is_prefixed_with(subde->d_name, "i2c-")) {
+					snprintf(path, NAME_MAX,
+						 "%s/%s/device/%s/name",
+						 i2cdev_path, de->d_name,
+						 subde->d_name);
+					fp = fopen(path, "r");
+					goto found;
+				}
+			}
+		}
+
+found:
+		if (fp != NULL) {
+			/*
+			 * Get the rest of the info and display a line
+			 * for a single bus.
+			 */
+			memset(name, 0, sizeof(name));
+			pos = fgets(name, sizeof(name), fp);
+			fclose(fp);
+			if (pos == NULL)
+				continue;
+
+			pos = strchr(name, '\n');
+			if (pos != NULL)
+				*pos = '\0';
+
+			rv = sscanf(de->d_name, "i2c-%d", &bus);
+			if (rv != 1)
+				continue;
+
+			if (is_prefixed_with(name, "ISA"))
+				adt = ADT_ISA;
+			else
+				adt = i2cdetect_get_funcs(bus);
+
+			printf(
+				"i2c-%d\t%-10s\t%-32s\t%s\n",
+				bus, adap_descs[adt].funcs,
+				name, adap_descs[adt].algo);
+		}
+	}
+
+	exit(EXIT_SUCCESS);
+}
+
+static void NORETURN no_support(const char *cmd)
+{
+	bb_error_msg_and_die("bus doesn't support %s", cmd);
+}
+
+static void will_skip(const char *cmd)
+{
+	bb_error_msg(
+		"warning: can't use %s command, "
+		"will skip some addresses", cmd);
+}
+
+//usage:#define i2cdetect_trivial_usage
+//usage:       "[-F I2CBUS] [-l] [-y] [-a] [-q|-r] I2CBUS [FIRST LAST]"
+//usage:#define i2cdetect_full_usage "\n\n"
+//usage:       "Detect I2C chips.\n"
+//usage:     "\n	I2CBUS	i2c bus number"
+//usage:     "\n	FIRST and LAST limit the probing range"
+//usage:     "\n"
+//usage:     "\n	-l	output list of installed busses"
+//usage:     "\n	-y	disable interactive mode"
+//usage:     "\n	-a	force scanning of non-regular addresses"
+//usage:     "\n	-q	use smbus quick write commands for probing (default)"
+//usage:     "\n	-r	use smbus read byte commands for probing"
+//usage:     "\n	-F	display list of functionalities"
+int i2cdetect_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
+int i2cdetect_main(int argc UNUSED_PARAM, char **argv)
+{
+	const unsigned opt_y = (1 << 0), opt_a = (1 << 1),
+			      opt_q = (1 << 2), opt_r = (1 << 3),
+			      opt_F = (1 << 4), opt_l = (1 << 5);
+	const char *const optstr = "yaqrFl";
+
+	int fd, bus_num, i, j, mode = DETECT_MODE_AUTO;
+	int status;
+	unsigned first = 0x00, last = 0x77;
+	unsigned long funcs;
+	unsigned opts;
+
+	opt_complementary = "q--r:r--q:" /* mutually exclusive */
+			"?3"; /* up to 3 args */
+	opts = getopt32(argv, optstr);
+	argv += optind;
+
+	if (opts & opt_l)
+		list_i2c_busses_and_exit();
+
+	if (!argv[0])
+		bb_show_usage();
+
+	bus_num = i2c_bus_lookup(argv[0]);
+	fd = i2c_dev_open(bus_num);
+	get_funcs_matrix(fd, &funcs);
+
+	if (opts & opt_F) {
+		/* Only list the functionalities. */
+		printf("Functionalities implemented by bus #%d\n", bus_num);
+		for (i = 0; i2c_funcs_tab[i].value; i++) {
+			printf("%-32s %s\n", i2c_funcs_tab[i].name,
+			       funcs & i2c_funcs_tab[i].value ? "yes" : "no");
+		}
+
+		return EXIT_SUCCESS;
+	}
+
+	if (opts & opt_r)
+		mode = DETECT_MODE_READ;
+	else if (opts & opt_q)
+		mode = DETECT_MODE_QUICK;
+
+	if (opts & opt_a)
+		last = 0x7f;
+
+	/* Read address range. */
+	if (argv[1]) {
+		first = xstrtou_range(argv[1], 16, first, last);
+		if (argv[2])
+			last = xstrtou_range(argv[2], 16, first, last);
+	}
+
+	if (!(funcs & (I2C_FUNC_SMBUS_QUICK | I2C_FUNC_SMBUS_READ_BYTE))) {
+		no_support("detection commands");
+	} else
+	if (mode == DETECT_MODE_QUICK && !(funcs & I2C_FUNC_SMBUS_QUICK)) {
+		no_support("SMBus Quick Write command");
+	} else
+	if (mode == DETECT_MODE_READ && !(funcs & I2C_FUNC_SMBUS_READ_BYTE)) {
+		no_support("SMBus Receive Byte command");
+	} else {
+		if (!(funcs & I2C_FUNC_SMBUS_QUICK))
+			will_skip("SMBus Quick Write");
+		if (!(funcs & I2C_FUNC_SMBUS_READ_BYTE))
+			will_skip("SMBus Receive Byte");
+	}
+
+	if (!(opts & opt_y))
+		confirm_action(-1, -1, -1, 0);
+
+	printf("     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f\n");
+	for (i = 0; i < 128; i += 16) {
+		printf("%02x: ", i);
+		for(j = 0; j < 16; j++) {
+			fflush_all();
+
+			if (mode == DETECT_MODE_AUTO) {
+				if ((i+j >= 0x30 && i+j <= 0x37) ||
+				    (i+j >= 0x50 && i+j <= 0x5F))
+					mode = DETECT_MODE_READ;
+				else
+					mode = DETECT_MODE_QUICK;
+			}
+
+			/* Skip unwanted addresses. */
+			if (i+j < first
+			 || i+j > last
+			 || (mode == DETECT_MODE_READ && !(funcs & I2C_FUNC_SMBUS_READ_BYTE))
+			 || (mode == DETECT_MODE_QUICK && !(funcs & I2C_FUNC_SMBUS_QUICK)))
+			{
+				printf("   ");
+				continue;
+			}
+
+			i2c_set_slave_addr(fd, i + j, 0);
+
+			switch (mode) {
+			case DETECT_MODE_READ:
+				/*
+				 * This is known to lock SMBus on various
+				 * write-only chips (mainly clock chips).
+				 */
+				status = i2c_smbus_read_byte(fd);
+				break;
+			default: /* DETECT_MODE_QUICK: */
+				/*
+				 * This is known to corrupt the Atmel
+				 * AT24RF08 EEPROM.
+				 */
+				status = i2c_smbus_write_quick(fd,
+							       I2C_SMBUS_WRITE);
+				break;
+			}
+
+			if (status < 0)
+				printf("-- ");
+			else
+				printf("%02x ", i+j);
+		}
+		printf("\n");
+	}
+
+	return 0;
+}
+#endif /* ENABLE_I2CDETECT */
diff -Nurp busybox.old/miscutils/Kbuild.src busybox/miscutils/Kbuild.src
--- busybox.old/miscutils/Kbuild.src	2015-05-29 06:54:59.000000000 +0800
+++ busybox/miscutils/Kbuild.src	2015-05-29 07:00:58.182592480 +0800
@@ -28,7 +28,6 @@ lib-$(CONFIG_INOTIFYD)    += inotifyd.o
 lib-$(CONFIG_FEATURE_LAST_SMALL)+= last.o
 lib-$(CONFIG_FEATURE_LAST_FANCY)+= last_fancy.o
 lib-$(CONFIG_LESS)        += less.o
-lib-$(CONFIG_LOCK)        += lock.o
 lib-$(CONFIG_MAKEDEVS)    += makedevs.o
 lib-$(CONFIG_MAN)         += man.o
 lib-$(CONFIG_MICROCOM)    += microcom.o
diff -Nurp busybox.old/miscutils/last.c busybox/miscutils/last.c
--- busybox.old/miscutils/last.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/miscutils/last.c	2015-05-29 07:00:58.185925813 +0800
@@ -32,21 +32,21 @@
 
 #if defined UT_LINESIZE \
 	&& ((UT_LINESIZE != 32) || (UT_NAMESIZE != 32) || (UT_HOSTSIZE != 256))
-#error struct utmp member char[] size(s) have changed!
+#error struct utmpx member char[] size(s) have changed!
 #elif defined __UT_LINESIZE \
 	&& ((__UT_LINESIZE != 32) || (__UT_NAMESIZE != 64) || (__UT_HOSTSIZE != 256))
-#error struct utmp member char[] size(s) have changed!
+#error struct utmpx member char[] size(s) have changed!
 #endif
 
 #if EMPTY != 0 || RUN_LVL != 1 || BOOT_TIME != 2 || NEW_TIME != 3 || \
 	OLD_TIME != 4
-#error Values for the ut_type field of struct utmp changed
+#error Values for the ut_type field of struct utmpx changed
 #endif
 
 int last_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
 int last_main(int argc UNUSED_PARAM, char **argv UNUSED_PARAM)
 {
-	struct utmp ut;
+	struct utmpx ut;
 	int n, file = STDIN_FILENO;
 	time_t t_tmp;
 	off_t pos;
@@ -87,11 +87,11 @@ int last_main(int argc UNUSED_PARAM, cha
 			if (++n > 0)
 				ut.ut_type = n != 3 ? n : SHUTDOWN_TIME;
 #else
-			if (strncmp(ut.ut_user, "shutdown", 8) == 0)
+			if (is_prefixed_with(ut.ut_user, "shutdown"))
 				ut.ut_type = SHUTDOWN_TIME;
-			else if (strncmp(ut.ut_user, "reboot", 6) == 0)
+			else if (is_prefixed_with(ut.ut_user, "reboot"))
 				ut.ut_type = BOOT_TIME;
-			else if (strncmp(ut.ut_user, "runlevel", 8) == 0)
+			else if (is_prefixed_with(ut.ut_user, "runlevel"))
 				ut.ut_type = RUN_LVL;
 #endif
 		} else {
diff -Nurp busybox.old/miscutils/last_fancy.c busybox/miscutils/last_fancy.c
--- busybox.old/miscutils/last_fancy.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/miscutils/last_fancy.c	2015-05-29 07:00:58.185925813 +0800
@@ -22,6 +22,10 @@
 #define HEADER_LINE_WIDE  "USER", "TTY", \
 	INET6_ADDRSTRLEN, INET6_ADDRSTRLEN, "HOST", "LOGIN", "  TIME", ""
 
+#if !defined __UT_LINESIZE && defined UT_LINESIZE
+# define __UT_LINESIZE UT_LINESIZE
+#endif
+
 enum {
 	NORMAL,
 	LOGGED,
@@ -39,10 +43,10 @@ enum {
 
 #define show_wide (option_mask32 & LAST_OPT_W)
 
-static void show_entry(struct utmp *ut, int state, time_t dur_secs)
+static void show_entry(struct utmpx *ut, int state, time_t dur_secs)
 {
 	unsigned days, hours, mins;
-	char duration[32];
+	char duration[sizeof("(%u+02:02)") + sizeof(int)*3];
 	char login_time[17];
 	char logout_time[8];
 	const char *logout_str;
@@ -53,7 +57,8 @@ static void show_entry(struct utmp *ut,
 	 * but some systems have it wrong */
 	tmp = ut->ut_tv.tv_sec;
 	safe_strncpy(login_time, ctime(&tmp), 17);
-	snprintf(logout_time, 8, "- %s", ctime(&dur_secs) + 11);
+	tmp = dur_secs;
+	snprintf(logout_time, 8, "- %s", ctime(&tmp) + 11);
 
 	dur_secs = MAX(dur_secs - (time_t)ut->ut_tv.tv_sec, (time_t)0);
 	/* unsigned int is easier to divide than time_t (which may be signed long) */
@@ -103,7 +108,7 @@ static void show_entry(struct utmp *ut,
 		duration_str);
 }
 
-static int get_ut_type(struct utmp *ut)
+static int get_ut_type(struct utmpx *ut)
 {
 	if (ut->ut_line[0] == '~') {
 		if (strcmp(ut->ut_user, "shutdown") == 0) {
@@ -141,7 +146,7 @@ static int get_ut_type(struct utmp *ut)
 	return ut->ut_type;
 }
 
-static int is_runlevel_shutdown(struct utmp *ut)
+static int is_runlevel_shutdown(struct utmpx *ut)
 {
 	if (((ut->ut_pid & 255) == '0') || ((ut->ut_pid & 255) == '6')) {
 		return 1;
@@ -153,7 +158,7 @@ static int is_runlevel_shutdown(struct u
 int last_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
 int last_main(int argc UNUSED_PARAM, char **argv)
 {
-	struct utmp ut;
+	struct utmpx ut;
 	const char *filename = _PATH_WTMP;
 	llist_t *zlist;
 	off_t pos;
@@ -241,9 +246,9 @@ int last_main(int argc UNUSED_PARAM, cha
 			{
 				llist_t *el, *next;
 				for (el = zlist; el; el = next) {
-					struct utmp *up = (struct utmp *)el->data;
+					struct utmpx *up = (struct utmpx *)el->data;
 					next = el->link;
-					if (strncmp(up->ut_line, ut.ut_line, UT_LINESIZE) == 0) {
+					if (strncmp(up->ut_line, ut.ut_line, __UT_LINESIZE) == 0) {
 						if (show) {
 							show_entry(&ut, NORMAL, up->ut_tv.tv_sec);
 							show = 0;
diff -Nurp busybox.old/miscutils/less.c busybox/miscutils/less.c
--- busybox.old/miscutils/less.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/miscutils/less.c	2015-05-29 07:00:58.185925813 +0800
@@ -1848,7 +1848,7 @@ key and/or command line switch compatibi
         Most options may be changed either on the command line,
         or from within less by using the - or -- command.
         Options may be given in one of two forms: either a single
-        character preceded by a -, or a name preceeded by --.
+        character preceded by a -, or a name preceded by --.
   -?  ........  --help
                   Display help (from command line).
   -a  ........  --search-skip-screen
diff -Nurp busybox.old/miscutils/man.c busybox/miscutils/man.c
--- busybox.old/miscutils/man.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/miscutils/man.c	2015-05-29 07:00:58.185925813 +0800
@@ -66,7 +66,7 @@ static int run_pipe(const char *pager, c
 			goto ordinary_manpage;
 
 		line = xmalloc_open_zipped_read_close(man_filename, NULL);
-		if (!line || strncmp(line, ".so ", 4) != 0) {
+		if (!line || !is_prefixed_with(line, ".so ")) {
 			free(line);
 			goto ordinary_manpage;
 		}
@@ -228,7 +228,7 @@ int man_main(int argc UNUSED_PARAM, char
 		if (!token[1])
 			continue;
 		if (strcmp("DEFINE", token[0]) == 0) {
-			if (strncmp("pager", token[1], 5) == 0) {
+			if (is_prefixed_with("pager", token[1])) {
 				pager = xstrdup(skip_whitespace(token[1]) + 5);
 			}
 		} else
diff -Nurp busybox.old/miscutils/runlevel.c busybox/miscutils/runlevel.c
--- busybox.old/miscutils/runlevel.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/miscutils/runlevel.c	2015-05-29 07:00:58.189259147 +0800
@@ -29,19 +29,19 @@
 int runlevel_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
 int runlevel_main(int argc UNUSED_PARAM, char **argv)
 {
-	struct utmp *ut;
+	struct utmpx *ut;
 	char prev;
 
-	if (argv[1]) utmpname(argv[1]);
+	if (argv[1]) utmpxname(argv[1]);
 
-	setutent();
-	while ((ut = getutent()) != NULL) {
+	setutxent();
+	while ((ut = getutxent()) != NULL) {
 		if (ut->ut_type == RUN_LVL) {
 			prev = ut->ut_pid / 256;
 			if (prev == 0) prev = 'N';
 			printf("%c %c\n", prev, ut->ut_pid % 256);
 			if (ENABLE_FEATURE_CLEAN_UP)
-				endutent();
+				endutxent();
 			return 0;
 		}
 	}
@@ -49,6 +49,6 @@ int runlevel_main(int argc UNUSED_PARAM,
 	puts("unknown");
 
 	if (ENABLE_FEATURE_CLEAN_UP)
-		endutent();
+		endutxent();
 	return 1;
 }
diff -Nurp busybox.old/miscutils/ubi_tools.c busybox/miscutils/ubi_tools.c
--- busybox.old/miscutils/ubi_tools.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/miscutils/ubi_tools.c	2015-05-29 07:00:58.189259147 +0800
@@ -105,6 +105,7 @@ int ubi_tools_main(int argc UNUSED_PARAM
 	int mtd_num;
 	int dev_num = UBI_DEV_NUM_AUTO;
 	int vol_id = UBI_VOL_NUM_AUTO;
+	int vid_hdr_offset = 0;
 	char *vol_name;
 	unsigned long long size_bytes = size_bytes; /* for compiler */
 	char *size_bytes_str;
@@ -133,10 +134,11 @@ int ubi_tools_main(int argc UNUSED_PARAM
 #define OPTION_a  (1 << 5)
 #define OPTION_t  (1 << 6)
 	if (do_mkvol) {
-		opt_complementary = "-1:d+:n+:a+";
-		opts = getopt32(argv, "md:n:N:s:a:t:",
+		opt_complementary = "-1:d+:n+:a+:O+";
+		opts = getopt32(argv, "md:n:N:s:a:t:O:",
 				&dev_num, &vol_id,
-				&vol_name, &size_bytes_str, &alignment, &type
+				&vol_name, &size_bytes_str, &alignment, &type,
+				&vid_hdr_offset
 			);
 	} else
 	if (do_update) {
@@ -162,17 +164,19 @@ int ubi_tools_main(int argc UNUSED_PARAM
 	//	bb_error_msg_and_die("%s: not a char device", ubi_ctrl);
 
 //usage:#define ubiattach_trivial_usage
-//usage:       "-m MTD_NUM [-d UBI_NUM] UBI_CTRL_DEV"
+//usage:       "-m MTD_NUM [-d UBI_NUM] [-O VID_HDR_OFF] UBI_CTRL_DEV"
 //usage:#define ubiattach_full_usage "\n\n"
 //usage:       "Attach MTD device to UBI\n"
 //usage:     "\n	-m MTD_NUM	MTD device number to attach"
 //usage:     "\n	-d UBI_NUM	UBI device number to assign"
+//usage:     "\n	-O VID_HDR_OFF	VID header offset"
 	if (do_attach) {
 		if (!(opts & OPTION_m))
 			bb_error_msg_and_die("%s device not specified", "MTD");
 
 		attach_req.mtd_num = mtd_num;
 		attach_req.ubi_num = dev_num;
+		attach_req.vid_hdr_offset = vid_hdr_offset;
 
 		xioctl(fd, UBI_IOCATT, &attach_req);
 	} else
diff -Nurp busybox.old/miscutils/wall.c busybox/miscutils/wall.c
--- busybox.old/miscutils/wall.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/miscutils/wall.c	2015-05-29 07:00:58.189259147 +0800
@@ -32,7 +32,7 @@
 int wall_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
 int wall_main(int argc UNUSED_PARAM, char **argv)
 {
-	struct utmp *ut;
+	struct utmpx *ut;
 	char *msg;
 	int fd;
 
@@ -46,8 +46,8 @@ int wall_main(int argc UNUSED_PARAM, cha
 	msg = xmalloc_read(fd, NULL);
 	if (ENABLE_FEATURE_CLEAN_UP && argv[1])
 		close(fd);
-	setutent();
-	while ((ut = getutent()) != NULL) {
+	setutxent();
+	while ((ut = getutxent()) != NULL) {
 		char *line;
 		if (ut->ut_type != USER_PROCESS)
 			continue;
@@ -56,7 +56,7 @@ int wall_main(int argc UNUSED_PARAM, cha
 		free(line);
 	}
 	if (ENABLE_FEATURE_CLEAN_UP) {
-		endutent();
+		endutxent();
 		free(msg);
 	}
 	return EXIT_SUCCESS;
diff -Nurp busybox.old/modutils/depmod.c busybox/modutils/depmod.c
--- busybox.old/modutils/depmod.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/modutils/depmod.c	2015-05-29 07:00:58.189259147 +0800
@@ -33,7 +33,6 @@ typedef struct module_info {
 static int FAST_FUNC parse_module(const char *fname, struct stat *sb UNUSED_PARAM,
 				void *data, int depth UNUSED_PARAM)
 {
-	char modname[MODULE_NAME_LEN];
 	module_info **first = (module_info **) data;
 	char *image, *ptr;
 	module_info *info;
@@ -51,13 +50,12 @@ static int FAST_FUNC parse_module(const
 
 	info->dnext = info->dprev = info;
 	info->name = xstrdup(fname + 2); /* skip "./" */
-	info->modname = xstrdup(
-		filename2modname(
+	info->modname = filename2modname(
 			bb_get_last_path_component_nostrip(fname),
-			modname
-	));
+			NULL
+	);
 	for (ptr = image; ptr < image + len - 10; ptr++) {
-		if (strncmp(ptr, "depends=", 8) == 0) {
+		if (is_prefixed_with(ptr, "depends=")) {
 			char *u;
 
 			ptr += 8;
@@ -66,15 +64,15 @@ static int FAST_FUNC parse_module(const
 					*u = '_';
 			ptr += string_to_llist(ptr, &info->dependencies, ",");
 		} else if (ENABLE_FEATURE_MODUTILS_ALIAS
-		 && strncmp(ptr, "alias=", 6) == 0
+		 && is_prefixed_with(ptr, "alias=")
 		) {
 			llist_add_to(&info->aliases, xstrdup(ptr + 6));
 			ptr += strlen(ptr);
 		} else if (ENABLE_FEATURE_MODUTILS_SYMBOLS
-		 && strncmp(ptr, "__ksymtab_", 10) == 0
+		 && is_prefixed_with(ptr, "__ksymtab_")
 		) {
 			ptr += 10;
-			if (strncmp(ptr, "gpl", 3) == 0
+			if (is_prefixed_with(ptr, "gpl")
 			 || strcmp(ptr, "strings") == 0
 			) {
 				continue;
@@ -250,11 +248,12 @@ int depmod_main(int argc UNUSED_PARAM, c
 		const char *fname = bb_basename(m->name);
 		filename2modname(fname, modname);
 		while (m->aliases) {
-			/* Last word can well be m->modname instead,
-			 * but depmod from module-init-tools 3.4
-			 * uses module basename, i.e., no s/-/_/g.
-			 * (pathname and .ko.* are still stripped)
-			 * Mimicking that... */
+			/*
+			 * Last word used to be a basename
+			 * (filename with path and .ko.* stripped)
+			 * at the time of module-init-tools 3.4.
+			 * kmod v.12 uses module name, i.e., s/-/_/g.
+			 */
 			printf("alias %s %s\n",
 				(char*)llist_pop(&m->aliases),
 				modname);
diff -Nurp busybox.old/modutils/modinfo.c busybox/modutils/modinfo.c
--- busybox.old/modutils/modinfo.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/modutils/modinfo.c	2015-05-29 07:00:58.189259147 +0800
@@ -62,7 +62,7 @@ static void modinfo(const char *path, co
 		"firmware",
 	};
 	size_t len;
-	int j, length;
+	int j;
 	char *ptr, *the_module;
 	const char *field = env->field;
 	int tags = env->tags;
@@ -94,16 +94,18 @@ static void modinfo(const char *path, co
 		pattern = field;
 		if ((1<<j) & OPT_TAGS)
 			pattern = shortcuts[j];
-		length = strlen(pattern);
 		ptr = the_module;
 		while (1) {
+			char *after_pattern;
+
 			ptr = memchr(ptr, *pattern, len - (ptr - (char*)the_module));
 			if (ptr == NULL) /* no occurance left, done */
 				break;
-			if (strncmp(ptr, pattern, length) == 0 && ptr[length] == '=') {
+			after_pattern = is_prefixed_with(ptr, pattern);
+			if (after_pattern && *after_pattern == '=') {
 				/* field prefixes are 0x80 or 0x00 */
-				if ((ptr[-1] & 0x7F) == '\0') {
-					ptr += length + 1;
+				if ((ptr[-1] & 0x7F) == 0x00) {
+					ptr = after_pattern + 1;
 					display(ptr, pattern, (1<<j) != tags);
 					ptr += strlen(ptr);
 				}
diff -Nurp busybox.old/modutils/modprobe.c busybox/modutils/modprobe.c
--- busybox.old/modutils/modprobe.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/modutils/modprobe.c	2015-05-29 07:00:58.189259147 +0800
@@ -15,8 +15,11 @@
 #include <sys/utsname.h>
 #include <fnmatch.h>
 
-//#define DBG(fmt, ...) bb_error_msg("%s: " fmt, __func__, ## __VA_ARGS__)
+#if 1
 #define DBG(...) ((void)0)
+#else
+#define DBG(fmt, ...) bb_error_msg("%s: " fmt, __func__, ## __VA_ARGS__)
+#endif
 
 /* Note that unlike older versions of modules.dep/depmod (busybox and m-i-t),
  * we expect the full dependency list to be specified in modules.dep.
@@ -257,7 +260,7 @@ static void add_probe(const char *name)
 	llist_add_to_end(&G.probes, m);
 	G.num_unresolved_deps++;
 	if (ENABLE_FEATURE_MODUTILS_SYMBOLS
-	 && strncmp(m->modname, "symbol:", 7) == 0
+	 && is_prefixed_with(m->modname, "symbol:")
 	) {
 		G.need_symbols = 1;
 	}
@@ -350,22 +353,18 @@ static char *parse_and_add_kcmdline_modu
 	char *kcmdline_buf;
 	char *kcmdline;
 	char *kptr;
-	int len;
 
 	kcmdline_buf = xmalloc_open_read_close("/proc/cmdline", NULL);
 	if (!kcmdline_buf)
 		return options;
 
 	kcmdline = kcmdline_buf;
-	len = strlen(modulename);
 	while ((kptr = strsep(&kcmdline, "\n\t ")) != NULL) {
-		if (strncmp(modulename, kptr, len) != 0)
-			continue;
-		kptr += len;
-		if (*kptr != '.')
+		char *after_modulename = is_prefixed_with(kptr, modulename);
+		if (!after_modulename || *after_modulename != '.')
 			continue;
 		/* It is "modulename.xxxx" */
-		kptr++;
+		kptr = after_modulename + 1;
 		if (strchr(kptr, '=') != NULL) {
 			/* It is "modulename.opt=[val]" */
 			options = gather_options_str(options, kptr);
diff -Nurp busybox.old/modutils/modprobe-small.c busybox/modutils/modprobe-small.c
--- busybox.old/modutils/modprobe-small.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/modutils/modprobe-small.c	2015-05-29 07:00:58.189259147 +0800
@@ -116,21 +116,21 @@ static char* copy_stringbuf(void)
 
 static char* find_keyword(char *ptr, size_t len, const char *word)
 {
-	int wlen;
-
 	if (!ptr) /* happens if xmalloc_open_zipped_read_close cannot read it */
 		return NULL;
 
-	wlen = strlen(word);
-	len -= wlen - 1;
+	len -= strlen(word) - 1;
 	while ((ssize_t)len > 0) {
 		char *old = ptr;
+		char *after_word;
+
 		/* search for the first char in word */
-		ptr = memchr(ptr, *word, len);
+		ptr = memchr(ptr, word[0], len);
 		if (ptr == NULL) /* no occurance left, done */
 			break;
-		if (strncmp(ptr, word, wlen) == 0)
-			return ptr + wlen; /* found, return ptr past it */
+		after_word = is_prefixed_with(ptr, word);
+		if (after_word)
+			return after_word; /* found, return ptr past it */
 		++ptr;
 		len -= (ptr - old);
 	}
@@ -163,6 +163,15 @@ static char *filename2modname(const char
 	return modname;
 }
 
+static int pathname_matches_modname(const char *pathname, const char *modname)
+{
+	int r;
+	char name[MODULE_NAME_LEN];
+	filename2modname(bb_get_last_path_component_nostrip(pathname), name);
+	r = (strcmp(name, modname) == 0);
+	return r;
+}
+
 /* Take "word word", return malloced "word",NUL,"word",NUL,NUL */
 static char* str_2_list(const char *str)
 {
@@ -295,18 +304,6 @@ static void parse_module(module_info *in
 	free(module_image);
 }
 
-static int pathname_matches_modname(const char *pathname, const char *modname)
-{
-	int r;
-	char name[MODULE_NAME_LEN];
-	const char *fname = bb_get_last_path_component_nostrip(pathname);
-	const char *suffix = strrstr(fname, ".ko");
-	safe_strncpy(name, fname, suffix - fname + 1);
-	replace(name, '-', '_');
-	r = (strcmp(name, modname) == 0);
-	return r;
-}
-
 static FAST_FUNC int fileAction(const char *pathname,
 		struct stat *sb UNUSED_PARAM,
 		void *modname_to_match,
@@ -539,17 +536,50 @@ static module_info** find_alias(const ch
 // TODO: open only once, invent config_rewind()
 static int already_loaded(const char *name)
 {
-	int ret = 0;
-	char *s;
-	parser_t *parser = config_open2("/proc/modules", xfopen_for_read);
-	while (config_read(parser, &s, 1, 1, "# \t", PARSE_NORMAL & ~PARSE_GREEDY)) {
-		if (strcmp(s, name) == 0) {
-			ret = 1;
-			break;
+	int ret;
+	char *line;
+	FILE *fp;
+
+	ret = 5 * 2;
+ again:
+	fp = fopen_for_read("/proc/modules");
+	if (!fp)
+		return 0;
+	while ((line = xmalloc_fgetline(fp)) != NULL) {
+		char *live;
+		char *after_name;
+
+		// Examples from kernel 3.14.6:
+		//pcspkr 12718 0 - Live 0xffffffffa017e000
+		//snd_timer 28690 2 snd_seq,snd_pcm, Live 0xffffffffa025e000
+		//i915 801405 2 - Live 0xffffffffa0096000
+		after_name = is_prefixed_with(line, name);
+		if (!after_name || *after_name != ' ') {
+			free(line);
+			continue;
 		}
+		live = strstr(line, " Live");
+		free(line);
+		if (!live) {
+			/* State can be Unloading, Loading, or Live.
+			 * modprobe must not return prematurely if we see "Loading":
+			 * it can cause further programs to assume load completed,
+			 * but it did not (yet)!
+			 * Wait up to 5*20 ms for it to resolve.
+			 */
+			ret -= 2;
+			if (ret == 0)
+				break;  /* huh? report as "not loaded" */
+			fclose(fp);
+			usleep(20*1000);
+			goto again;
+		}
+		ret = 1;
+		break;
 	}
-	config_close(parser);
-	return ret;
+	fclose(fp);
+
+	return ret & 1;
 }
 #else
 #define already_loaded(name) 0
diff -Nurp busybox.old/modutils/modutils-24.c busybox/modutils/modutils-24.c
--- busybox.old/modutils/modutils-24.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/modutils/modutils-24.c	2015-05-29 07:00:58.189259147 +0800
@@ -2255,7 +2255,7 @@ static int add_symbols_from(struct obj_f
 		 * symbols so they cannot fudge it by adding the prefix on
 		 * their references.
 		 */
-		if (strncmp((char *)s->name, "GPLONLY_", 8) == 0) {
+		if (is_prefixed_with((char *)s->name, "GPLONLY_")) {
 #if ENABLE_FEATURE_CHECK_TAINTED_MODULE
 			if (gpl)
 				s->name += 8;
diff -Nurp busybox.old/modutils/modutils.c busybox/modutils/modutils.c
--- busybox.old/modutils/modutils.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/modutils/modutils.c	2015-05-29 07:00:58.189259147 +0800
@@ -47,13 +47,14 @@ int FAST_FUNC string_to_llist(char *stri
 
 char* FAST_FUNC filename2modname(const char *filename, char *modname)
 {
+	char local_modname[MODULE_NAME_LEN];
 	int i;
 	const char *from;
 
 	if (filename == NULL)
 		return NULL;
 	if (modname == NULL)
-		modname = xmalloc(MODULE_NAME_LEN);
+		modname = local_modname;
 	// Disabled since otherwise "modprobe dir/name" would work
 	// as if it is "modprobe name". It is unclear why
 	// 'basenamization' was here in the first place.
@@ -63,6 +64,9 @@ char* FAST_FUNC filename2modname(const c
 		modname[i] = (from[i] == '-') ? '_' : from[i];
 	modname[i] = '\0';
 
+	if (modname == local_modname)
+		return xstrdup(modname);
+
 	return modname;
 }
 
diff -Nurp busybox.old/networking/arping.c busybox/networking/arping.c
--- busybox.old/networking/arping.c	2015-05-29 06:54:59.000000000 +0800
+++ busybox/networking/arping.c	2015-05-29 07:00:58.192592480 +0800
@@ -24,8 +24,6 @@
 
 #include <arpa/inet.h>
 #include <net/if.h>
-#include <net/if_arp.h>
-#include <netinet/if_ether.h>
 #include <netinet/ether.h>
 #include <netpacket/packet.h>
 
@@ -286,7 +284,6 @@ int arping_main(int argc UNUSED_PARAM, c
 	// Need to remove SUID_NEVER from applets.h for this to work
 	//xsetuid(getuid());
 
-	err_str = xasprintf("interface %s %%s", device);
 	{
 		unsigned opt;
 		char *str_timeout;
@@ -304,7 +301,7 @@ int arping_main(int argc UNUSED_PARAM, c
 	}
 
 	target = argv[optind];
-
+	err_str = xasprintf("interface %s %%s", device);
 	xfunc_error_retval = 2;
 
 	{
diff -Nurp busybox.old/networking/Config.src busybox/networking/Config.src
--- busybox.old/networking/Config.src	2015-05-29 06:54:59.000000000 +0800
+++ busybox/networking/Config.src	2015-05-29 07:00:58.192592480 +0800
@@ -619,12 +619,6 @@ config FEATURE_IPCALC_LONG_OPTIONS
 	help
 	  Support long options for the ipcalc applet.
 
-config NETMSG
-	bool "netmsg"
-	default n
-	help
-	  simple program for sending udp broadcast messages
-
 config NETSTAT
 	bool "netstat"
 	default y
@@ -756,8 +750,7 @@ config TELNETD
 
 	  Note that for busybox telnetd to work you need several things:
 	  First of all, your kernel needs:
-		  UNIX98_PTYS=y
-		  DEVPTS_FS=y
+		  CONFIG_UNIX98_PTYS=y
 
 	  Next, you need a /dev/pts directory on your root filesystem:
 
diff -Nurp busybox.old/networking/dnsd.c busybox/networking/dnsd.c
--- busybox.old/networking/dnsd.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/networking/dnsd.c	2015-05-29 07:00:58.192592480 +0800
@@ -194,7 +194,7 @@ static char *table_lookup(struct dns_ent
 		if ((len != 1 || d->name[1] != '*')
 		/* we assume (do not check) that query_string
 		 * ends in ".in-addr.arpa" */
-		 && strncmp(d->rip, query_string, strlen(d->rip)) == 0
+		 && is_prefixed_with(query_string, d->rip)
 		) {
 #if DEBUG
 			fprintf(stderr, "Found name:%s\n", d->name);
diff -Nurp busybox.old/networking/ftpd.c busybox/networking/ftpd.c
--- busybox.old/networking/ftpd.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/networking/ftpd.c	2015-05-29 07:00:58.192592480 +0800
@@ -1116,6 +1116,9 @@ int ftpd_main(int argc, char **argv)
 int ftpd_main(int argc UNUSED_PARAM, char **argv)
 #endif
 {
+#if ENABLE_FEATURE_FTP_AUTHENTICATION
+	struct passwd *pw = NULL;
+#endif
 	unsigned abs_timeout;
 	unsigned verbose_S;
 	smallint opts;
@@ -1193,29 +1196,23 @@ int ftpd_main(int argc UNUSED_PARAM, cha
 	signal(SIGALRM, timeout_handler);
 
 #if ENABLE_FEATURE_FTP_AUTHENTICATION
-	{
-		struct passwd *pw = NULL;
-
-		while (1) {
-			uint32_t cmdval = cmdio_get_cmd_and_arg();
-
+	while (1) {
+		uint32_t cmdval = cmdio_get_cmd_and_arg();
 			if (cmdval == const_USER) {
-				pw = getpwnam(G.ftp_arg);
-				cmdio_write_raw(STR(FTP_GIVEPWORD)" Please specify password\r\n");
-			} else if (cmdval == const_PASS) {
-				if (check_password(pw, G.ftp_arg) > 0) {
-					break;	/* login success */
-				}
-				cmdio_write_raw(STR(FTP_LOGINERR)" Login failed\r\n");
-				pw = NULL;
-			} else if (cmdval == const_QUIT) {
-				WRITE_OK(FTP_GOODBYE);
-				return 0;
-			} else {
-				cmdio_write_raw(STR(FTP_LOGINERR)" Login with USER and PASS\r\n");
+			pw = getpwnam(G.ftp_arg);
+			cmdio_write_raw(STR(FTP_GIVEPWORD)" Please specify password\r\n");
+		} else if (cmdval == const_PASS) {
+			if (check_password(pw, G.ftp_arg) > 0) {
+				break;	/* login success */
 			}
+			cmdio_write_raw(STR(FTP_LOGINERR)" Login failed\r\n");
+			pw = NULL;
+		} else if (cmdval == const_QUIT) {
+			WRITE_OK(FTP_GOODBYE);
+			return 0;
+		} else {
+			cmdio_write_raw(STR(FTP_LOGINERR)" Login with USER and PASS\r\n");
 		}
-		change_identity(pw);
 	}
 	WRITE_OK(FTP_LOGINOK);
 #endif
@@ -1233,6 +1230,10 @@ int ftpd_main(int argc UNUSED_PARAM, cha
 		xchroot(argv[0]);
 	}
 
+#if ENABLE_FEATURE_FTP_AUTHENTICATION
+	change_identity(pw);
+#endif
+
 	/* RFC-959 Section 5.1
 	 * The following commands and options MUST be supported by every
 	 * server-FTP and user-FTP, except in cases where the underlying
diff -Nurp busybox.old/networking/httpd.c busybox/networking/httpd.c
--- busybox.old/networking/httpd.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/networking/httpd.c	2015-05-29 07:00:58.192592480 +0800
@@ -697,7 +697,7 @@ static void parse_conf(const char *path,
 				goto config_error;
 			}
 			*host_port++ = '\0';
-			if (strncmp(host_port, "http://", 7) == 0)
+			if (is_prefixed_with(host_port, "http://"))
 				host_port += 7;
 			if (*host_port == '\0') {
 				goto config_error;
@@ -1894,7 +1894,7 @@ static Htaccess_Proxy *find_proxy_entry(
 {
 	Htaccess_Proxy *p;
 	for (p = proxy; p; p = p->next) {
-		if (strncmp(url, p->url_from, strlen(p->url_from)) == 0)
+		if (is_prefixed_with(url, p->url_from))
 			return p;
 	}
 	return NULL;
@@ -2183,7 +2183,7 @@ static void handle_incoming_and_exit(con
 			if (STRNCASECMP(iobuf, "Range:") == 0) {
 				/* We know only bytes=NNN-[MMM] */
 				char *s = skip_whitespace(iobuf + sizeof("Range:")-1);
-				if (strncmp(s, "bytes=", 6) == 0) {
+				if (is_prefixed_with(s, "bytes=") == 0) {
 					s += sizeof("bytes=")-1;
 					range_start = BB_STRTOOFF(s, &s, 10);
 					if (s[0] != '-' || range_start < 0) {
@@ -2269,7 +2269,7 @@ static void handle_incoming_and_exit(con
 	tptr = urlcopy + 1;      /* skip first '/' */
 
 #if ENABLE_FEATURE_HTTPD_CGI
-	if (strncmp(tptr, "cgi-bin/", 8) == 0) {
+	if (is_prefixed_with(tptr, "cgi-bin/")) {
 		if (tptr[8] == '\0') {
 			/* protect listing "cgi-bin/" */
 			send_headers_and_exit(HTTP_FORBIDDEN);
diff -Nurp busybox.old/networking/ifupdown.c busybox/networking/ifupdown.c
--- busybox.old/networking/ifupdown.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/networking/ifupdown.c	2015-05-29 07:00:58.192592480 +0800
@@ -289,7 +289,7 @@ static char *parse(const char *command,
 					/* "hwaddress <class> <address>":
 					 * unlike ifconfig, ip doesnt want <class>
 					 * (usually "ether" keyword). Skip it. */
-					if (strncmp(command, "hwaddress", 9) == 0) {
+					if (is_prefixed_with(command, "hwaddress")) {
 						varvalue = skip_whitespace(skip_non_whitespace(varvalue));
 					}
 # endif
@@ -298,7 +298,7 @@ static char *parse(const char *command,
 # if ENABLE_FEATURE_IFUPDOWN_IP
 					/* Sigh...  Add a special case for 'ip' to convert from
 					 * dotted quad to bit count style netmasks.  */
-					if (strncmp(command, "bnmask", 6) == 0) {
+					if (is_prefixed_with(command, "bnmask")) {
 						unsigned res;
 						varvalue = get_var("netmask", 7, ifd);
 						if (varvalue) {
@@ -1159,12 +1159,12 @@ static char *run_mapping(char *physical,
 
 static llist_t *find_iface_state(llist_t *state_list, const char *iface)
 {
-	unsigned iface_len = strlen(iface);
 	llist_t *search = state_list;
 
 	while (search) {
-		if ((strncmp(search->data, iface, iface_len) == 0)
-		 && (search->data[iface_len] == '=')
+		char *after_iface = is_prefixed_with(search->data, iface);
+		if (after_iface
+		 && *after_iface == '='
 		) {
 			return search;
 		}
@@ -1239,6 +1239,7 @@ int ifupdown_main(int argc UNUSED_PARAM,
 		char *pch;
 		bool okay = 0;
 		int cmds_ret;
+		bool curr_failure = 0;
 
 		iface = xstrdup(target_list->data);
 		target_list = target_list->link;
@@ -1304,11 +1305,11 @@ int ifupdown_main(int argc UNUSED_PARAM,
 				/* Call the cmds function pointer, does either iface_up() or iface_down() */
 				cmds_ret = cmds(currif);
 				if (cmds_ret == -1) {
-					bb_error_msg("don't seem to have all the variables for %s/%s",
+					bb_error_msg("don't have all variables for %s/%s",
 							liface, currif->address_family->name);
-					any_failures = 1;
+					any_failures = curr_failure = 1;
 				} else if (cmds_ret == 0) {
-					any_failures = 1;
+					any_failures = curr_failure = 1;
 				}
 
 				currif->iface = oldiface;
@@ -1329,7 +1330,7 @@ int ifupdown_main(int argc UNUSED_PARAM,
 			llist_t *state_list = read_iface_state();
 			llist_t *iface_state = find_iface_state(state_list, iface);
 
-			if (cmds == iface_up && !any_failures) {
+			if (cmds == iface_up && !curr_failure) {
 				char *newiface = xasprintf("%s=%s", iface, liface);
 				if (!iface_state) {
 					llist_add_to_end(&state_list, newiface);
diff -Nurp busybox.old/networking/inetd.c busybox/networking/inetd.c
--- busybox.old/networking/inetd.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/networking/inetd.c	2015-05-29 07:00:58.195925813 +0800
@@ -645,7 +645,7 @@ static servtab_t *dup_servtab(servtab_t
 }
 
 /* gcc generates much more code if this is inlined */
-static servtab_t *parse_one_line(void)
+static NOINLINE servtab_t *parse_one_line(void)
 {
 	int argc;
 	char *token[6+MAXARGV];
@@ -675,6 +675,8 @@ static servtab_t *parse_one_line(void)
 			 * default host for the following lines. */
 			free(default_local_hostname);
 			default_local_hostname = sep->se_local_hostname;
+			/*sep->se_local_hostname = NULL; - redundant */
+			/* (we'll overwrite this field anyway) */
 			goto more;
 		}
 	} else
@@ -688,10 +690,10 @@ static servtab_t *parse_one_line(void)
  parse_err:
 		bb_error_msg("parse error on line %u, line is ignored",
 				parser->lineno);
-		free_servtab_strings(sep);
 		/* Just "goto more" can make sep to carry over e.g.
 		 * "rpc"-ness (by having se_rpcver_lo != 0).
 		 * We will be more paranoid: */
+		free_servtab_strings(sep);
 		free(sep);
 		goto new;
 	}
@@ -725,7 +727,7 @@ static servtab_t *parse_one_line(void)
 			goto parse_err;
 #endif
 		}
-		if (strncmp(arg, "rpc/", 4) == 0) {
+		if (is_prefixed_with(arg, "rpc/")) {
 #if ENABLE_FEATURE_INETD_RPC
 			unsigned n;
 			arg += 4;
@@ -815,7 +817,7 @@ static servtab_t *parse_one_line(void)
 	}
 #endif
 	argc = 0;
-	while ((arg = token[6+argc]) != NULL && argc < MAXARGV)
+	while (argc < MAXARGV && (arg = token[6+argc]) != NULL)
 		sep->se_argv[argc++] = xstrdup(arg);
 	/* Some inetd.conf files have no argv's, not even argv[0].
 	 * Fix them up.
@@ -1654,7 +1656,7 @@ static void FAST_FUNC daytime_stream(int
 {
 	time_t t;
 
-	t = time(NULL);
+	time(&t);
 	fdprintf(s, "%.24s\r\n", ctime(&t));
 }
 static void FAST_FUNC daytime_dg(int s, servtab_t *sep)
diff -Nurp busybox.old/networking/interface.c busybox/networking/interface.c
--- busybox.old/networking/interface.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/networking/interface.c	2015-05-29 07:00:58.195925813 +0800
@@ -91,9 +91,9 @@ static const char* FAST_FUNC INET_sprint
 {
 	static char *buff; /* defaults to NULL */
 
-	free(buff);
 	if (sap->sa_family == 0xFFFF || sap->sa_family == 0)
 		return "[NONE SET]";
+	free(buff);
 	buff = INET_rresolve((struct sockaddr_in *) sap, numeric, 0xffffff00);
 	return buff;
 }
@@ -173,9 +173,9 @@ static const char* FAST_FUNC INET6_sprin
 {
 	static char *buff;
 
-	free(buff);
 	if (sap->sa_family == 0xFFFF || sap->sa_family == 0)
 		return "[NONE SET]";
+	free(buff);
 	buff = INET6_rresolve((struct sockaddr_in6 *) sap, numeric);
 	return buff;
 }
diff -Nurp busybox.old/networking/Kbuild.src busybox/networking/Kbuild.src
--- busybox.old/networking/Kbuild.src	2015-05-29 06:54:59.000000000 +0800
+++ busybox/networking/Kbuild.src	2015-05-29 07:00:58.192592480 +0800
@@ -27,7 +27,6 @@ lib-$(CONFIG_IP)           += ip.o
 lib-$(CONFIG_IPCALC)       += ipcalc.o
 lib-$(CONFIG_NAMEIF)       += nameif.o
 lib-$(CONFIG_NC)           += nc.o
-lib-$(CONFIG_NETMSG)       += netmsg.o
 lib-$(CONFIG_NETSTAT)      += netstat.o
 lib-$(CONFIG_NSLOOKUP)     += nslookup.o
 lib-$(CONFIG_NTPD)         += ntpd.o
diff -Nurp busybox.old/networking/libiproute/ipaddress.c busybox/networking/libiproute/ipaddress.c
--- busybox.old/networking/libiproute/ipaddress.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/networking/libiproute/ipaddress.c	2015-05-29 07:00:58.195925813 +0800
@@ -701,7 +701,7 @@ static int ipaddr_modify(int cmd, char *
 		/* There was no "dev IFACE", but we need that */
 		bb_error_msg_and_die("need \"dev IFACE\"");
 	}
-	if (l && strncmp(d, l, strlen(d)) != 0) {
+	if (l && !is_prefixed_with(l, d)) {
 		bb_error_msg_and_die("\"dev\" (%s) must match \"label\" (%s)", d, l);
 	}
 
diff -Nurp busybox.old/networking/nameif.c busybox/networking/nameif.c
--- busybox.old/networking/nameif.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/networking/nameif.c	2015-05-29 07:00:58.195925813 +0800
@@ -161,19 +161,19 @@ static void nameif_parse_selector(ethtab
 		if (*next)
 			*next++ = '\0';
 		/* Check for selectors, mac= is assumed */
-		if (strncmp(selector, "bus=", 4) == 0) {
+		if (is_prefixed_with(selector, "bus=")) {
 			ch->bus_info = xstrdup(selector + 4);
 			found_selector++;
-		} else if (strncmp(selector, "driver=", 7) == 0) {
+		} else if (is_prefixed_with(selector, "driver=")) {
 			ch->driver = xstrdup(selector + 7);
 			found_selector++;
-		} else if (strncmp(selector, "phyaddr=", 8) == 0) {
+		} else if (is_prefixed_with(selector, "phyaddr=")) {
 			ch->phy_address = xatoi_positive(selector + 8);
 			found_selector++;
 		} else {
 #endif
 			lmac = xmalloc(ETH_ALEN);
-			ch->mac = ether_aton_r(selector + (strncmp(selector, "mac=", 4) != 0 ? 0 : 4), lmac);
+			ch->mac = ether_aton_r(selector + (is_prefixed_with(selector, "mac=") ? 4 : 0), lmac);
 			if (ch->mac == NULL)
 				bb_error_msg_and_die("can't parse %s", selector);
 #if  ENABLE_FEATURE_NAMEIF_EXTENDED
diff -Nurp busybox.old/networking/netstat.c busybox/networking/netstat.c
--- busybox.old/networking/netstat.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/networking/netstat.c	2015-05-29 07:00:58.199259146 +0800
@@ -119,7 +119,7 @@ typedef enum {
 #define ADDR_NORMAL_WIDTH        23
 /* When there are IPv6 connections the IPv6 addresses will be
  * truncated to none-recognition. The '-W' option makes the
- * address columns wide enough to accomodate for longest possible
+ * address columns wide enough to accommodate for longest possible
  * IPv6 addresses, i.e. addresses of the form
  * xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:ddd.ddd.ddd.ddd
  */
@@ -228,12 +228,12 @@ static long extract_socket_inode(const c
 {
 	long inode = -1;
 
-	if (strncmp(lname, "socket:[", sizeof("socket:[")-1) == 0) {
+	if (is_prefixed_with(lname, "socket:[")) {
 		/* "socket:[12345]", extract the "12345" as inode */
 		inode = bb_strtoul(lname + sizeof("socket:[")-1, (char**)&lname, 0);
 		if (*lname != ']')
 			inode = -1;
-	} else if (strncmp(lname, "[0000]:", sizeof("[0000]:")-1) == 0) {
+	} else if (is_prefixed_with(lname, "[0000]:")) {
 		/* "[0000]:12345", extract the "12345" as inode */
 		inode = bb_strtoul(lname + sizeof("[0000]:")-1, NULL, 0);
 		if (errno) /* not NUL terminated? */
@@ -622,7 +622,7 @@ static int FAST_FUNC unix_do_one(char *l
 
 	/* TODO: currently we stop at first NUL byte. Is it a problem? */
 	line += path_ofs;
-	*strchrnul(line, '\n') = '\0';
+	chomp(line);
 	while (*line)
 		fputc_printable(*line++, stdout);
 	bb_putchar('\n');
diff -Nurp busybox.old/networking/ntpd.c busybox/networking/ntpd.c
--- busybox.old/networking/ntpd.c	2015-05-29 06:54:59.000000000 +0800
+++ busybox/networking/ntpd.c	2015-05-29 07:00:58.199259146 +0800
@@ -1,30 +1,43 @@
 /*
  * NTP client/server, based on OpenNTPD 3.9p1
  *
- * Author: Adam Tkac <vonsch@gmail.com>
+ * Busybox port author: Adam Tkac (C) 2009 <vonsch@gmail.com>
  *
- * Licensed under GPLv2, see file LICENSE in this source tree.
+ * OpenNTPd 3.9p1 copyright holders:
+ *   Copyright (c) 2003, 2004 Henning Brauer <henning@openbsd.org>
+ *   Copyright (c) 2004 Alexander Guy <alexander.guy@andern.org>
+ *
+ * OpenNTPd code is licensed under ISC-style licence:
+ *
+ * Permission to use, copy, modify, and distribute this software for any
+ * purpose with or without fee is hereby granted, provided that the above
+ * copyright notice and this permission notice appear in all copies.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
+ * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
+ * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
+ * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+ * WHATSOEVER RESULTING FROM LOSS OF MIND, USE, DATA OR PROFITS, WHETHER
+ * IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING
+ * OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
+ ***********************************************************************
  *
  * Parts of OpenNTPD clock syncronization code is replaced by
- * code which is based on ntp-4.2.6, whuch carries the following
+ * code which is based on ntp-4.2.6, which carries the following
  * copyright notice:
  *
- ***********************************************************************
- *                                                                     *
- * Copyright (c) University of Delaware 1992-2009                      *
- *                                                                     *
- * Permission to use, copy, modify, and distribute this software and   *
- * its documentation for any purpose with or without fee is hereby     *
- * granted, provided that the above copyright notice appears in all    *
- * copies and that both the copyright notice and this permission       *
- * notice appear in supporting documentation, and that the name        *
- * University of Delaware not be used in advertising or publicity      *
- * pertaining to distribution of the software without specific,        *
- * written prior permission. The University of Delaware makes no       *
- * representations about the suitability this software for any         *
- * purpose. It is provided "as is" without express or implied          *
- * warranty.                                                           *
- *                                                                     *
+ * Copyright (c) University of Delaware 1992-2009
+ *
+ * Permission to use, copy, modify, and distribute this software and
+ * its documentation for any purpose with or without fee is hereby
+ * granted, provided that the above copyright notice appears in all
+ * copies and that both the copyright notice and this permission
+ * notice appear in supporting documentation, and that the name
+ * University of Delaware not be used in advertising or publicity
+ * pertaining to distribution of the software without specific,
+ * written prior permission. The University of Delaware makes no
+ * representations about the suitability this software for any
+ * purpose. It is provided "as is" without express or implied warranty.
  ***********************************************************************
  */
 
@@ -37,14 +50,15 @@
 //usage:     "\n	-q	Quit after clock is set"
 //usage:     "\n	-N	Run at high priority"
 //usage:     "\n	-w	Do not set time (only query peers), implies -n"
-//usage:	IF_FEATURE_NTPD_SERVER(
-//usage:     "\n	-l	Run as server on port 123"
-//usage:     "\n	-I IFACE Bind server to IFACE, implies -l"
-//usage:	)
 //usage:     "\n	-S PROG	Run PROG after stepping time, stratum change, and every 11 mins"
 //usage:     "\n	-p PEER	Obtain time from PEER (may be repeated)"
 //usage:	IF_FEATURE_NTPD_CONF(
-//usage:     "\n		If -p is not given, read /etc/ntp.conf"
+//usage:     "\n		If -p is not given, 'server HOST' lines"
+//usage:     "\n		from /etc/ntp.conf are used"
+//usage:	)
+//usage:	IF_FEATURE_NTPD_SERVER(
+//usage:     "\n	-l	Also run as server on port 123"
+//usage:     "\n	-I IFACE Bind server to IFACE, implies -l"
 //usage:	)
 
 // -l and -p options are not compatible with "standard" ntpd:
@@ -251,7 +265,6 @@ typedef struct {
 typedef struct {
 	len_and_sockaddr *p_lsa;
 	char             *p_dotted;
-	char             *p_hostname;
 	int              p_fd;
 	int              datapoint_idx;
 	uint32_t         lastpkt_refid;
@@ -364,8 +377,6 @@ struct globals {
 	 */
 #define G_precision_sec  0.002
 	uint8_t  stratum;
-	/* Bool. After set to 1, never goes back to 0: */
-	smallint initial_poll_complete;
 
 #define STATE_NSET      0       /* initial state, "nothing is set" */
 //#define STATE_FSET    1       /* frequency set from file */
@@ -757,9 +768,8 @@ add_peers(const char *s)
 	peer_t *p;
 
 	p = xzalloc(sizeof(*p));
-	p->p_hostname = s;
-	p->p_lsa = NULL;
-	p->p_dotted = NULL;
+	p->p_lsa = xhost2sockaddr(s, 123);
+	p->p_dotted = xmalloc_sockaddr2dotted_noport(&p->p_lsa->u.sa);
 	p->p_fd = -1;
 	p->p_xmt_msg.m_status = MODE_CLIENT | (NTP_VERSION << 3);
 	p->next_action_time = G.cur_time; /* = set_next(p, 0); */
@@ -808,25 +818,6 @@ send_query_to_peer(peer_t *p)
 	 *
 	 * Uncomment this and use strace to see it in action:
 	 */
-
-	/* See if the peer hostname already resolved yet, if not, retry to resolv and return on failure */
-	if (!p->p_lsa)
-	{
-		p->p_lsa = host2sockaddr(p->p_hostname, 123);
-
-		if (p->p_lsa)
-		{
-			p->p_dotted = xmalloc_sockaddr2dotted_noport(&p->p_lsa->u.sa);
-			VERB1 bb_error_msg("resolved peer %s to %s", p->p_hostname, p->p_dotted);
-		}
-		else
-		{
-			set_next(p, RETRY_INTERVAL);
-			VERB1 bb_error_msg("could not resolve peer %s, skipping", p->p_hostname);
-			return;
-		}
-	}
-
 #define PROBE_LOCAL_ADDR /* { len_and_sockaddr lsa; lsa.len = LSA_SIZEOF_SA; getsockname(p->query.fd, &lsa.u.sa, &lsa.len); } */
 
 	if (p->p_fd == -1) {
@@ -1092,7 +1083,7 @@ select_and_cluster(void)
 
 	num_points = 0;
 	item = G.ntp_peers;
-	if (G.initial_poll_complete) while (item != NULL) {
+	while (item != NULL) {
 		double rd, offset;
 
 		p = (peer_t *) item->data;
@@ -1657,7 +1648,7 @@ update_local_clock(peer_t *p)
 	if (G.ntp_status & LI_MINUSSEC)
 		tmx.status |= STA_DEL;
 
-	tmx.constant = G.poll_exp - 4;
+	tmx.constant = (int)G.poll_exp - 4 > 0 ? (int)G.poll_exp - 4 : 0;
 	/* EXPERIMENTAL.
 	 * The below if statement should be unnecessary, but...
 	 * It looks like Linux kernel's PLL is far too gentle in changing
@@ -2293,7 +2284,6 @@ int ntpd_main(int argc UNUSED_PARAM, cha
 						VERB4 bb_error_msg("disabling burst mode");
 						G.polladj_count = 0;
 						G.poll_exp = MINPOLL;
-						G.initial_poll_complete = 1;
 					}
 					send_query_to_peer(p);
 				} else {
diff -Nurp busybox.old/networking/route.c busybox/networking/route.c
--- busybox.old/networking/route.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/networking/route.c	2015-05-29 07:00:58.199259146 +0800
@@ -55,6 +55,7 @@
 #define RTF_WINDOW      0x0080	/* per route window clamping    */
 #define RTF_IRTT        0x0100	/* Initial round trip time      */
 #define RTF_REJECT      0x0200	/* Reject route                 */
+#define RTF_NONEXTHOP   0x00200000 /* route with no nexthop	*/
 #endif
 
 #if defined(SIOCADDRTOLD) || defined(RTF_IRTT)	/* route */
@@ -128,7 +129,7 @@ static const char tbl_ipvx[] ALIGN1 =
 	"\013\043reinstate"			/* Since last, we can save a byte. */
 ;
 
-static const int flags_ipvx[] = { /* MUST match tbl_ipvx[] values above. */
+static const uint16_t flags_ipvx[] = { /* MUST match tbl_ipvx[] values above. */
 #ifdef RTF_REJECT
 	RTF_REJECT,
 #endif
@@ -449,7 +450,11 @@ static NOINLINE void INET6_setroute(int
 }
 #endif
 
-static const unsigned flagvals[] = { /* Must agree with flagchars[]. */
+static const
+IF_NOT_FEATURE_IPV6(uint16_t)
+IF_FEATURE_IPV6(unsigned)
+flagvals[] = { /* Must agree with flagchars[]. */
+	RTF_UP,
 	RTF_GATEWAY,
 	RTF_HOST,
 	RTF_REINSTATE,
@@ -458,27 +463,25 @@ static const unsigned flagvals[] = { /*
 #if ENABLE_FEATURE_IPV6
 	RTF_DEFAULT,
 	RTF_ADDRCONF,
-	RTF_CACHE
+	RTF_CACHE,
+	RTF_REJECT,
+	RTF_NONEXTHOP, /* this one doesn't fit into 16 bits */
 #endif
 };
-
-#define IPV4_MASK (RTF_GATEWAY|RTF_HOST|RTF_REINSTATE|RTF_DYNAMIC|RTF_MODIFIED)
-#define IPV6_MASK (RTF_GATEWAY|RTF_HOST|RTF_DEFAULT|RTF_ADDRCONF|RTF_CACHE)
-
 /* Must agree with flagvals[]. */
 static const char flagchars[] ALIGN1 =
-	"GHRDM"
+	"UGHRDM"
 #if ENABLE_FEATURE_IPV6
-	"DAC"
+	"DAC!n"
 #endif
 ;
+#define IPV4_MASK (RTF_UP|RTF_GATEWAY|RTF_HOST|RTF_REINSTATE|RTF_DYNAMIC|RTF_MODIFIED)
+#define IPV6_MASK (RTF_UP|RTF_GATEWAY|RTF_HOST|RTF_DEFAULT|RTF_ADDRCONF|RTF_CACHE|RTF_REJECT|RTF_NONEXTHOP)
 
 static void set_flags(char *flagstr, int flags)
 {
 	int i;
 
-	*flagstr++ = 'U';
-
 	for (i = 0; (*flagstr = flagchars[i]) != 0; i++) {
 		if (flags & flagvals[i]) {
 			++flagstr;
@@ -491,6 +494,7 @@ void FAST_FUNC bb_displayroutes(int nore
 {
 	char devname[64], flags[16], *sdest, *sgw;
 	unsigned long d, g, m;
+	int r;
 	int flgs, ref, use, metric, mtu, win, ir;
 	struct sockaddr_in s_addr;
 	struct in_addr mask;
@@ -501,20 +505,24 @@ void FAST_FUNC bb_displayroutes(int nore
 		"Destination     Gateway         Genmask         Flags %s Iface\n",
 			netstatfmt ? "  MSS Window  irtt" : "Metric Ref    Use");
 
-	if (fscanf(fp, "%*[^\n]\n") < 0) { /* Skip the first line. */
-		goto ERROR;                /* Empty or missing line, or read error. */
+	/* Skip the first line. */
+	r = fscanf(fp, "%*[^\n]\n");
+	if (r < 0) {
+		/* Empty line, read error, or EOF. Yes, if routing table
+		 * is completely empty, /proc/net/route has no header.
+		 */
+		goto ERROR;
 	}
 	while (1) {
-		int r;
 		r = fscanf(fp, "%63s%lx%lx%X%d%d%d%lx%d%d%d\n",
 				devname, &d, &g, &flgs, &ref, &use, &metric, &m,
 				&mtu, &win, &ir);
 		if (r != 11) {
+ ERROR:
 			if ((r < 0) && feof(fp)) { /* EOF with no (nonspace) chars read. */
 				break;
 			}
- ERROR:
-			bb_error_msg_and_die("fscanf");
+			bb_perror_msg_and_die(bb_msg_read_error);
 		}
 
 		if (!(flgs & RTF_UP)) { /* Skip interfaces that are down. */
@@ -574,13 +582,13 @@ static void INET6_displayroutes(void)
 		int r;
 		r = fscanf(fp, "%32s%x%*s%x%32s%x%x%x%x%s\n",
 				addr6x+14, &prefix_len, &slen, addr6x+40+7,
-				&metric, &use, &refcnt, &iflags, iface);
+				&metric, &refcnt, &use, &iflags, iface);
 		if (r != 9) {
 			if ((r < 0) && feof(fp)) { /* EOF with no (nonspace) chars read. */
 				break;
 			}
  ERROR:
-			bb_error_msg_and_die("fscanf");
+			bb_perror_msg_and_die(bb_msg_read_error);
 		}
 
 		/* Do the addr6x shift-and-insert changes to ':'-delimit addresses.
@@ -606,10 +614,6 @@ static void INET6_displayroutes(void)
 			} while (i < 40+28+7);
 		}
 
-		if (!(iflags & RTF_UP)) { /* Skip interfaces that are down. */
-			continue;
-		}
-
 		set_flags(flags, (iflags & IPV6_MASK));
 
 		r = 0;
diff -Nurp busybox.old/networking/tc.c busybox/networking/tc.c
--- busybox.old/networking/tc.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/networking/tc.c	2015-05-29 07:00:58.199259146 +0800
@@ -151,17 +151,17 @@ static void print_rate(char *buf, int le
 	double tmp = (double)rate*8;
 
 	if (use_iec) {
-		if (tmp >= 1000.0*1024.0*1024.0)
-			snprintf(buf, len, "%.0fMibit", tmp/1024.0*1024.0);
-		else if (tmp >= 1000.0*1024)
+		if (tmp >= 1000*1024*1024)
+			snprintf(buf, len, "%.0fMibit", tmp/(1024*1024));
+		else if (tmp >= 1000*1024)
 			snprintf(buf, len, "%.0fKibit", tmp/1024);
 		else
 			snprintf(buf, len, "%.0fbit", tmp);
 	} else {
-		if (tmp >= 1000.0*1000000.0)
-			snprintf(buf, len, "%.0fMbit", tmp/1000000.0);
-		else if (tmp >= 1000.0 * 1000.0)
-			snprintf(buf, len, "%.0fKbit", tmp/1000.0);
+		if (tmp >= 1000*1000000)
+			snprintf(buf, len, "%.0fMbit", tmp/1000000);
+		else if (tmp >= 1000*1000)
+			snprintf(buf, len, "%.0fKbit", tmp/1000);
 		else
 			snprintf(buf, len, "%.0fbit",  tmp);
 	}
diff -Nurp busybox.old/networking/telnetd.c busybox/networking/telnetd.c
--- busybox.old/networking/telnetd.c	2015-05-29 06:54:59.000000000 +0800
+++ busybox/networking/telnetd.c	2015-05-29 07:00:58.199259146 +0800
@@ -331,7 +331,6 @@ make_new_session(
 
 	/* Restore default signal handling ASAP */
 	bb_signals((1 << SIGCHLD) + (1 << SIGPIPE), SIG_DFL);
-	signal(SIGINT, SIG_DFL);
 
 	pid = getpid();
 
@@ -463,15 +462,7 @@ static void handle_sigchld(int sig UNUSE
 		while (ts) {
 			if (ts->shell_pid == pid) {
 				ts->shell_pid = -1;
-// man utmp:
-// When init(8) finds that a process has exited, it locates its utmp entry
-// by ut_pid, sets ut_type to DEAD_PROCESS, and clears ut_user, ut_host
-// and ut_time with null bytes.
-// [same applies to other processes which maintain utmp entries, like telnetd]
-//
-// We do not bother actually clearing fields:
-// it might be interesting to know who was logged in and from where
-				update_utmp(pid, DEAD_PROCESS, /*tty_name:*/ NULL, /*username:*/ NULL, /*hostname:*/ NULL);
+				update_utmp_DEAD_PROCESS(pid);
 				break;
 			}
 			ts = ts->next;
@@ -740,7 +731,7 @@ int telnetd_main(int argc UNUSED_PARAM,
 		continue;
  kill_session:
 		if (ts->shell_pid > 0)
-			update_utmp(ts->shell_pid, DEAD_PROCESS, /*tty_name:*/ NULL, /*username:*/ NULL, /*hostname:*/ NULL);
+			update_utmp_DEAD_PROCESS(ts->shell_pid);
 		free_session(ts);
 		ts = next;
 	}
diff -Nurp busybox.old/networking/udhcp/dhcpc.c busybox/networking/udhcp/dhcpc.c
--- busybox.old/networking/udhcp/dhcpc.c	2015-05-29 06:54:59.000000000 +0800
+++ busybox/networking/udhcp/dhcpc.c	2015-05-29 07:00:58.202592480 +0800
@@ -663,10 +663,10 @@ static void add_client_options(struct dh
  * client reverts to using the IP broadcast address.
  */
 
-static int raw_bcast_from_client_config_ifindex(struct dhcp_packet *packet, uint32_t src_nip)
+static int raw_bcast_from_client_config_ifindex(struct dhcp_packet *packet)
 {
 	return udhcp_send_raw_packet(packet,
-		/*src*/ src_nip, CLIENT_PORT,
+		/*src*/ INADDR_ANY, CLIENT_PORT,
 		/*dst*/ INADDR_BROADCAST, SERVER_PORT, MAC_BCAST_ADDR,
 		client_config.ifindex);
 }
@@ -677,7 +677,7 @@ static int bcast_or_ucast(struct dhcp_pa
 		return udhcp_send_kernel_packet(packet,
 			ciaddr, CLIENT_PORT,
 			server, SERVER_PORT);
-	return raw_bcast_from_client_config_ifindex(packet, ciaddr);
+	return raw_bcast_from_client_config_ifindex(packet);
 }
 
 /* Broadcast a DHCP discover packet to the network, with an optionally requested IP */
@@ -685,7 +685,6 @@ static int bcast_or_ucast(struct dhcp_pa
 static NOINLINE int send_discover(uint32_t xid, uint32_t requested)
 {
 	struct dhcp_packet packet;
-	static int msgs = 0;
 
 	/* Fill in: op, htype, hlen, cookie, chaddr fields,
 	 * random xid field (we override it below),
@@ -703,9 +702,8 @@ static NOINLINE int send_discover(uint32
 	 */
 	add_client_options(&packet);
 
-	if (msgs++ < 3)
 	bb_info_msg("Sending discover...");
-	return raw_bcast_from_client_config_ifindex(&packet, INADDR_ANY);
+	return raw_bcast_from_client_config_ifindex(&packet);
 }
 
 /* Broadcast a DHCP request message */
@@ -749,7 +747,7 @@ static NOINLINE int send_select(uint32_t
 
 	addr.s_addr = requested;
 	bb_info_msg("Sending select for %s...", inet_ntoa(addr));
-	return raw_bcast_from_client_config_ifindex(&packet, INADDR_ANY);
+	return raw_bcast_from_client_config_ifindex(&packet);
 }
 
 /* Unicast or broadcast a DHCP renew message */
@@ -817,7 +815,7 @@ static NOINLINE int send_decline(/*uint3
 	udhcp_add_simple_option(&packet, DHCP_SERVER_ID, server);
 
 	bb_info_msg("Sending decline...");
-	return raw_bcast_from_client_config_ifindex(&packet, INADDR_ANY);
+	return raw_bcast_from_client_config_ifindex(&packet);
 }
 #endif
 
@@ -1093,6 +1091,7 @@ static void perform_renew(void)
 		state = RENEW_REQUESTED;
 		break;
 	case RENEW_REQUESTED: /* impatient are we? fine, square 1 */
+		udhcp_run_script(NULL, "deconfig");
 	case REQUESTING:
 	case RELEASED:
 		change_listen_mode(LISTEN_RAW);
@@ -1409,12 +1408,6 @@ int udhcpc_main(int argc UNUSED_PARAM, c
 		/* silence "uninitialized!" warning */
 		unsigned timestamp_before_wait = timestamp_before_wait;
 
-		/* When running on a bridge, the ifindex may have changed (e.g. if
-		 * member interfaces were added/removed or if the status of the
-		 * bridge changed).
-		 * Workaround: refresh it here before processing the next packet */
-		udhcp_read_interface(client_config.interface, &client_config.ifindex, NULL, client_config.client_mac);
-
 		//bb_error_msg("sockfd:%d, listen_mode:%d", sockfd, listen_mode);
 
 		/* Was opening raw or udp socket here
@@ -1759,7 +1752,6 @@ int udhcpc_main(int argc UNUSED_PARAM, c
 				}
 #endif
 				/* enter bound state */
-				timeout = lease_seconds / 2;
 				temp_addr.s_addr = packet.yiaddr;
 				bb_info_msg("Lease of %s obtained, lease time %u",
 					inet_ntoa(temp_addr), (unsigned)lease_seconds);
@@ -1768,6 +1760,11 @@ int udhcpc_main(int argc UNUSED_PARAM, c
 				start = monotonic_sec();
 				udhcp_run_script(&packet, state == REQUESTING ? "bound" : "renew");
 				already_waited_sec = (unsigned)monotonic_sec() - start;
+				timeout = lease_seconds / 2;
+				if ((unsigned)timeout < already_waited_sec) {
+					/* Something went wrong. Back to discover state */
+					timeout = already_waited_sec = 0;
+				}
 
 				state = BOUND;
 				change_listen_mode(LISTEN_NONE);
diff -Nurp busybox.old/networking/udhcp/dhcpd.c busybox/networking/udhcp/dhcpd.c
--- busybox.old/networking/udhcp/dhcpd.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/networking/udhcp/dhcpd.c	2015-05-29 07:00:58.202592480 +0800
@@ -413,7 +413,8 @@ int udhcpd_main(int argc UNUSED_PARAM, c
 
 		max_sock = udhcp_sp_fd_set(&rfds, server_socket);
 		if (server_config.auto_time) {
-			tv.tv_sec = timeout_end - monotonic_sec();
+			/* cast to signed is essential if tv_sec is wider than int */
+			tv.tv_sec = (int)(timeout_end - monotonic_sec());
 			tv.tv_usec = 0;
 		}
 		retval = 0;
diff -Nurp busybox.old/networking/zcip.c busybox/networking/zcip.c
--- busybox.old/networking/zcip.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/networking/zcip.c	2015-05-29 07:00:58.205925813 +0800
@@ -521,7 +521,7 @@ int zcip_main(int argc UNUSED_PARAM, cha
 			target_ip_conflict = 0;
 
 			if (memcmp(&p.arp.arp_sha, &eth_addr, ETH_ALEN) != 0) {
-				if (memcmp(p.arp.arp_spa, &ip.s_addr, sizeof(struct in_addr))) {
+				if (memcmp(p.arp.arp_spa, &ip.s_addr, sizeof(struct in_addr)) == 0) {
 					/* A probe or reply with source_ip == chosen ip */
 					source_ip_conflict = 1;
 				}
diff -Nurp busybox.old/printutils/lpd.c busybox/printutils/lpd.c
--- busybox.old/printutils/lpd.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/printutils/lpd.c	2015-05-29 07:00:58.205925813 +0800
@@ -204,7 +204,7 @@ int lpd_main(int argc UNUSED_PARAM, char
 			goto err_exit;
 		}
 		// get filename
-		*strchrnul(s, '\n') = '\0';
+		chomp(s);
 		fname = strchr(s, ' ');
 		if (!fname) {
 // bad_fname:
diff -Nurp busybox.old/procps/free.c busybox/procps/free.c
--- busybox.old/procps/free.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/procps/free.c	2015-05-29 07:00:58.205925813 +0800
@@ -44,11 +44,28 @@ static unsigned long long scale(unsigned
 	return ((unsigned long long)d * G.mem_unit) >> G_unit_steps;
 }
 
+static unsigned long parse_cached_kb(void)
+{
+	char buf[60]; /* actual lines we expect are ~30 chars or less */
+	FILE *fp;
+	unsigned long cached = 0;
+
+	fp = xfopen_for_read("/proc/meminfo");
+	while (fgets(buf, sizeof(buf), fp) != NULL) {
+		if (sscanf(buf, "Cached: %lu %*s\n", &cached) == 1)
+			break;
+	}
+	if (ENABLE_FEATURE_CLEAN_UP)
+		fclose(fp);
+
+	return cached;
+}
 
 int free_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
 int free_main(int argc UNUSED_PARAM, char **argv IF_NOT_DESKTOP(UNUSED_PARAM))
 {
 	struct sysinfo info;
+	unsigned long long cached;
 
 	INIT_G();
 
@@ -73,49 +90,47 @@ int free_main(int argc UNUSED_PARAM, cha
 		}
 	}
 #endif
-
-	sysinfo(&info);
-
-	/* Kernels prior to 2.4.x will return info.mem_unit==0, so cope... */
-	G.mem_unit = (info.mem_unit ? info.mem_unit : 1);
-
-	printf("     %13s%13s%13s%13s%13s\n",
+	printf("       %11s%11s%11s%11s%11s%11s\n"
+	"Mem:   ",
 		"total",
 		"used",
 		"free",
-		"shared", "buffers" /* swap and total don't have these columns */
-		/* procps version 3.2.8 also shows "cached" column, but
-		 * sysinfo() does not provide this value, need to parse
-		 * /proc/meminfo instead and get "Cached: NNN kB" from there.
-		 */
+		"shared", "buffers", "cached" /* swap and total don't have these columns */
 	);
 
-#define FIELDS_5 "%13llu%13llu%13llu%13llu%13llu\n"
-#define FIELDS_3 (FIELDS_5 + 2*6)
-#define FIELDS_2 (FIELDS_5 + 3*6)
-
-	printf("Mem: ");
-	printf(FIELDS_5,
-		scale(info.totalram),
-		scale(info.totalram - info.freeram),
-		scale(info.freeram),
-		scale(info.sharedram),
-		scale(info.bufferram)
+	sysinfo(&info);
+	/* Kernels prior to 2.4.x will return info.mem_unit==0, so cope... */
+	G.mem_unit = (info.mem_unit ? info.mem_unit : 1);
+	/* Extract cached from /proc/meminfo and convert to mem_units */
+	cached = ((unsigned long long) parse_cached_kb() * 1024) / G.mem_unit;
+
+#define FIELDS_6 "%11llu%11llu%11llu%11llu%11llu%11llu\n"
+#define FIELDS_3 (FIELDS_6 + 3*6)
+#define FIELDS_2 (FIELDS_6 + 4*6)
+
+	printf(FIELDS_6,
+		scale(info.totalram),                //total
+		scale(info.totalram - info.freeram), //used
+		scale(info.freeram),                 //free
+		scale(info.sharedram),               //shared
+		scale(info.bufferram),               //buffers
+		scale(cached)                        //cached
 	);
 	/* Show alternate, more meaningful busy/free numbers by counting
-	 * buffer cache as free memory (make it "-/+ buffers/cache"
-	 * if/when we add support for "cached" column): */
-	printf("-/+ buffers:      ");
+	 * buffer cache as free memory. */
+	printf("-/+ buffers/cache:");
+	cached += info.freeram;
+	cached += info.bufferram;
 	printf(FIELDS_2,
-		scale(info.totalram - info.freeram - info.bufferram),
-		scale(info.freeram + info.bufferram)
+		scale(info.totalram - cached), //used
+		scale(cached)                  //free
 	);
 #if BB_MMU
-	printf("Swap:");
+	printf("Swap:  ");
 	printf(FIELDS_3,
-		scale(info.totalswap),
-		scale(info.totalswap - info.freeswap),
-		scale(info.freeswap)
+		scale(info.totalswap),                 //total
+		scale(info.totalswap - info.freeswap), //used
+		scale(info.freeswap)                   //free
 	);
 #endif
 	return EXIT_SUCCESS;
diff -Nurp busybox.old/procps/mpstat.c busybox/procps/mpstat.c
--- busybox.old/procps/mpstat.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/procps/mpstat.c	2015-05-29 07:00:58.205925813 +0800
@@ -522,13 +522,11 @@ static void get_irqs_from_stat(struct st
 	FILE *fp;
 	char buf[1024];
 
-	fp = fopen_for_read(PROCFS_STAT);
-	if (!fp)
-		return;
+	fp = xfopen_for_read(PROCFS_STAT);
 
 	while (fgets(buf, sizeof(buf), fp)) {
 		//bb_error_msg("/proc/stat:'%s'", buf);
-		if (strncmp(buf, "intr ", 5) == 0) {
+		if (is_prefixed_with(buf, "intr ")) {
 			/* Read total number of IRQs since system boot */
 			sscanf(buf + 5, "%"FMT_DATA"u", &irq->irq_nr);
 		}
@@ -644,9 +642,7 @@ static void get_uptime(data_t *uptime)
 	char buf[sizeof(long)*3 * 2 + 4]; /* enough for long.long */
 	unsigned long uptime_sec, decimal;
 
-	fp = fopen_for_read(PROCFS_UPTIME);
-	if (!fp)
-		return;
+	fp = xfopen_for_read(PROCFS_UPTIME);
 	if (fgets(buf, sizeof(buf), fp)) {
 		if (sscanf(buf, "%lu.%lu", &uptime_sec, &decimal) == 2) {
 			*uptime = (data_t)uptime_sec * G.hz + decimal * G.hz / 100;
diff -Nurp busybox.old/procps/powertop.c busybox/procps/powertop.c
--- busybox.old/procps/powertop.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/procps/powertop.c	2015-05-29 07:00:58.205925813 +0800
@@ -360,7 +360,7 @@ static void process_irq_counts(void)
 		}
 
 		name = p;
-		strchrnul(name, '\n')[0] = '\0';
+		chomp(p);
 		/* Save description of the interrupt */
 		if (nr >= 20000)
 			sprintf(irq_desc, "   <kernel IPI> : %s", name);
@@ -458,9 +458,9 @@ static NOINLINE int process_timer_stats(
 			//	func = "Load balancing tick";
 			//}
 
-			if (strncmp(func, "tick_nohz_", 10) == 0)
+			if (is_prefixed_with(func, "tick_nohz_"))
 				continue;
-			if (strncmp(func, "tick_setup_sched_timer", 20) == 0)
+			if (is_prefixed_with(func, "tick_setup_sched_timer"))
 				continue;
 			//if (strcmp(process, "powertop") == 0)
 			//	continue;
@@ -470,7 +470,7 @@ static NOINLINE int process_timer_stats(
 				process = idx < 2 ? "[kernel module]" : "<kernel core>";
 			}
 
-			strchrnul(p, '\n')[0] = '\0';
+			chomp(p);
 
 			// 46D\01136\0kondemand/1\0do_dbs_timer (delayed_work_timer_fn)
 			// ^          ^            ^
@@ -674,7 +674,7 @@ static void show_timerstats(void)
 //usage:#define powertop_trivial_usage
 //usage:       ""
 //usage:#define powertop_full_usage "\n\n"
-//usage:       "Analyze power consumption on Intel-based laptops\n"
+//usage:       "Analyze power consumption on Intel-based laptops"
 
 int powertop_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
 int powertop_main(int UNUSED_PARAM argc, char UNUSED_PARAM **argv)
diff -Nurp busybox.old/procps/pwdx.c busybox/procps/pwdx.c
--- busybox.old/procps/pwdx.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/procps/pwdx.c	2015-05-29 07:00:58.205925813 +0800
@@ -21,7 +21,7 @@
 //usage:#define pwdx_trivial_usage
 //usage:       "PID..."
 //usage:#define pwdx_full_usage "\n\n"
-//usage:       "Show current directory for PIDs\n"
+//usage:       "Show current directory for PIDs"
 
 #include "libbb.h"
 
@@ -41,7 +41,7 @@ int pwdx_main(int argc UNUSED_PARAM, cha
 		// Allowed on the command line:
 		// /proc/NUM
 		// NUM
-		if (strncmp(arg, "/proc/", 6) == 0)
+		if (is_prefixed_with(arg, "/proc/"))
 			arg += 6;
 
 		pid = bb_strtou(arg, NULL, 10);
diff -Nurp busybox.old/procps/uptime.c busybox/procps/uptime.c
--- busybox.old/procps/uptime.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/procps/uptime.c	2015-05-29 07:00:58.209259146 +0800
@@ -81,10 +81,10 @@ int uptime_main(int argc UNUSED_PARAM, c
 
 #if ENABLE_FEATURE_UPTIME_UTMP_SUPPORT
 	{
-		struct utmp *ut;
+		struct utmpx *ut;
 		unsigned users = 0;
-		while ((ut = getutent()) != NULL) {
-			if ((ut->ut_type == USER_PROCESS) && (ut->ut_name[0] != '\0'))
+		while ((ut = getutxent()) != NULL) {
+			if ((ut->ut_type == USER_PROCESS) && (ut->ut_user[0] != '\0'))
 				users++;
 		}
 		printf(",  %u users", users);
diff -Nurp busybox.old/README busybox/README
--- busybox.old/README	2015-03-23 11:06:55.000000000 +0800
+++ busybox/README	2015-05-29 07:00:58.095925812 +0800
@@ -185,7 +185,7 @@ Supported hardware:
   Under 2.4 Linux kernels, kernel module loading was implemented in a
   platform-specific manner.  Busybox's insmod utility has been reported to
   work under ARM, CRIS, H8/300, x86, ia64, x86_64, m68k, MIPS, PowerPC, S390,
-  SH3/4/5, Sparc, v850e, and x86_64.  Anything else probably won't work.
+  SH3/4/5, Sparc, and v850e.  Anything else probably won't work.
 
   The module loading mechanism for the 2.6 kernel is much more generic, and
   we believe 2.6.x kernel module loading support should work on all
diff -Nurp busybox.old/runit/built-in.o busybox/runit/built-in.o
--- busybox.old/runit/built-in.o	2015-05-29 06:55:23.000000000 +0800
+++ busybox/runit/built-in.o	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-!<arch>
diff -Nurp busybox.old/runit/.built-in.o.cmd busybox/runit/.built-in.o.cmd
--- busybox.old/runit/.built-in.o.cmd	2015-05-29 06:55:23.000000000 +0800
+++ busybox/runit/.built-in.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-cmd_runit/built-in.o :=  rm -f runit/built-in.o; mips-openwrt-linux-uclibc-ar rcs runit/built-in.o
diff -Nurp busybox.old/runit/Config.in busybox/runit/Config.in
--- busybox.old/runit/Config.in	2015-05-29 06:55:00.000000000 +0800
+++ busybox/runit/Config.in	1970-01-01 08:00:00.000000000 +0800
@@ -1,89 +0,0 @@
-# DO NOT EDIT. This file is generated from Config.src
-#
-# For a description of the syntax of this configuration file,
-# see scripts/kbuild/config-language.txt.
-#
-
-menu "Runit Utilities"
-
-
-config RUNSV
-	bool "runsv"
-	default y
-	help
-	  runsv starts and monitors a service and optionally an appendant log
-	  service.
-
-config RUNSVDIR
-	bool "runsvdir"
-	default y
-	help
-	  runsvdir starts a runsv process for each subdirectory, or symlink to
-	  a directory, in the services directory dir, up to a limit of 1000
-	  subdirectories, and restarts a runsv process if it terminates.
-
-config FEATURE_RUNSVDIR_LOG
-	bool "Enable scrolling argument log"
-	depends on RUNSVDIR
-	default n
-	help
-	  Enable feature where second parameter of runsvdir holds last error
-	  message (viewable via top/ps). Otherwise (feature is off
-	  or no parameter), error messages go to stderr only.
-
-config SV
-	bool "sv"
-	default y
-	help
-	  sv reports the current status and controls the state of services
-	  monitored by the runsv supervisor.
-
-config SV_DEFAULT_SERVICE_DIR
-	string "Default directory for services"
-	default "/var/service"
-	depends on SV
-	help
-	  Default directory for services.
-	  Defaults to "/var/service"
-
-config SVLOGD
-	bool "svlogd"
-	default y
-	help
-	  svlogd continuously reads log data from its standard input, optionally
-	  filters log messages, and writes the data to one or more automatically
-	  rotated logs.
-
-config CHPST
-	bool "chpst"
-	default y
-	help
-	  chpst changes the process state according to the given options, and
-	  execs specified program.
-
-config SETUIDGID
-	bool "setuidgid"
-	default y
-	help
-	  Sets soft resource limits as specified by options
-
-config ENVUIDGID
-	bool "envuidgid"
-	default y
-	help
-	  Sets $UID to account's uid and $GID to account's gid
-
-config ENVDIR
-	bool "envdir"
-	default y
-	help
-	  Sets various environment variables as specified by files
-	  in the given directory
-
-config SOFTLIMIT
-	bool "softlimit"
-	default y
-	help
-	  Sets soft resource limits as specified by options
-
-endmenu
diff -Nurp busybox.old/runit/Kbuild busybox/runit/Kbuild
--- busybox.old/runit/Kbuild	2015-05-29 06:55:00.000000000 +0800
+++ busybox/runit/Kbuild	1970-01-01 08:00:00.000000000 +0800
@@ -1,20 +0,0 @@
-# DO NOT EDIT. This file is generated from Kbuild.src
-# Makefile for busybox
-#
-# Copyright (C) 1999-2005 by Erik Andersen <andersen@codepoet.org>
-#
-# Licensed under GPLv2, see file LICENSE in this source tree.
-
-lib-y:=
-
-
-lib-$(CONFIG_RUNSV) += runsv.o
-lib-$(CONFIG_RUNSVDIR) += runsvdir.o
-lib-$(CONFIG_SV) += sv.o
-lib-$(CONFIG_SVLOGD) += svlogd.o
-lib-$(CONFIG_CHPST) += chpst.o
-
-lib-$(CONFIG_ENVDIR) += chpst.o
-lib-$(CONFIG_ENVUIDGID) += chpst.o
-lib-$(CONFIG_SETUIDGID) += chpst.o
-lib-$(CONFIG_SOFTLIMIT) += chpst.o
diff -Nurp busybox.old/runit/lib.a busybox/runit/lib.a
--- busybox.old/runit/lib.a	2015-05-29 06:55:23.000000000 +0800
+++ busybox/runit/lib.a	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-!<arch>
diff -Nurp busybox.old/runit/.lib.a.cmd busybox/runit/.lib.a.cmd
--- busybox.old/runit/.lib.a.cmd	2015-05-29 06:55:23.000000000 +0800
+++ busybox/runit/.lib.a.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-cmd_runit/lib.a := rm -f runit/lib.a; mips-openwrt-linux-uclibc-ar  rcs runit/lib.a 
diff -Nurp busybox.old/runit/runsvdir.c busybox/runit/runsvdir.c
--- busybox.old/runit/runsvdir.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/runit/runsvdir.c	2015-05-29 07:00:58.209259146 +0800
@@ -59,7 +59,6 @@ struct globals {
 	int svnum;
 #if ENABLE_FEATURE_RUNSVDIR_LOG
 	char *rplog;
-	int rploglen;
 	struct fd_pair logpipe;
 	struct pollfd pfd[1];
 	unsigned stamplog;
@@ -70,7 +69,6 @@ struct globals {
 #define svdir       (G.svdir       )
 #define svnum       (G.svnum       )
 #define rplog       (G.rplog       )
-#define rploglen    (G.rploglen    )
 #define logpipe     (G.logpipe     )
 #define pfd         (G.pfd         )
 #define stamplog    (G.stamplog    )
@@ -219,15 +217,12 @@ int runsvdir_main(int argc UNUSED_PARAM,
 	struct stat s;
 	dev_t last_dev = last_dev; /* for gcc */
 	ino_t last_ino = last_ino; /* for gcc */
-	time_t last_mtime = 0;
-	int wstat;
+	time_t last_mtime;
 	int curdir;
-	pid_t pid;
-	unsigned deadline;
-	unsigned now;
 	unsigned stampcheck;
 	int i;
-	int need_rescan = 1;
+	int need_rescan;
+	bool i_am_init;
 	char *opt_s_argv[3];
 
 	INIT_G();
@@ -238,18 +233,21 @@ int runsvdir_main(int argc UNUSED_PARAM,
 	getopt32(argv, "Ps:", &opt_s_argv[0]);
 	argv += optind;
 
+	i_am_init = (getpid() == 1);
 	bb_signals(0
 		| (1 << SIGTERM)
 		| (1 << SIGHUP)
 		/* For busybox's init, SIGTERM == reboot,
-		 * SIGUSR1 == halt
-		 * SIGUSR2 == poweroff
-		 * so we need to intercept SIGUSRn too.
+		 * SIGUSR1 == halt,
+		 * SIGUSR2 == poweroff,
+		 * Ctlr-ALt-Del sends SIGINT to init,
+		 * so we need to intercept SIGUSRn and SIGINT too.
 		 * Note that we do not implement actual reboot
 		 * (killall(TERM) + umount, etc), we just pause
 		 * respawing and avoid exiting (-> making kernel oops).
-		 * The user is responsible for the rest. */
-		| (getpid() == 1 ? ((1 << SIGUSR1) | (1 << SIGUSR2)) : 0)
+		 * The user is responsible for the rest.
+		 */
+		| (i_am_init ? ((1 << SIGUSR1) | (1 << SIGUSR2) | (1 << SIGINT)) : 0)
 		, record_signo);
 	svdir = *argv++;
 
@@ -257,8 +255,7 @@ int runsvdir_main(int argc UNUSED_PARAM,
 	/* setup log */
 	if (*argv) {
 		rplog = *argv;
-		rploglen = strlen(rplog);
-		if (rploglen < 7) {
+		if (strlen(rplog) < 7) {
 			warnx("log must have at least seven characters");
 		} else if (piped_pair(logpipe)) {
 			warnx("can't create pipe for log");
@@ -287,11 +284,16 @@ int runsvdir_main(int argc UNUSED_PARAM,
 	close_on_exec_on(curdir);
 
 	stampcheck = monotonic_sec();
+	need_rescan = 1;
+	last_mtime = 0;
 
 	for (;;) {
+		unsigned now;
+		unsigned sig;
+
 		/* collect children */
 		for (;;) {
-			pid = wait_any_nohang(&wstat);
+			pid_t pid = wait_any_nohang(NULL);
 			if (pid <= 0)
 				break;
 			for (i = 0; i < svnum; i++) {
@@ -345,15 +347,15 @@ int runsvdir_main(int argc UNUSED_PARAM,
 		}
 		pfd[0].revents = 0;
 #endif
-		deadline = (need_rescan ? 1 : 5);
-		sig_block(SIGCHLD);
+		{
+			unsigned deadline = (need_rescan ? 1 : 5);
 #if ENABLE_FEATURE_RUNSVDIR_LOG
-		if (rplog)
-			poll(pfd, 1, deadline*1000);
-		else
+			if (rplog)
+				poll(pfd, 1, deadline*1000);
+			else
 #endif
-			sleep(deadline);
-		sig_unblock(SIGCHLD);
+				sleep(deadline);
+		}
 
 #if ENABLE_FEATURE_RUNSVDIR_LOG
 		if (pfd[0].revents & POLLIN) {
@@ -361,21 +363,25 @@ int runsvdir_main(int argc UNUSED_PARAM,
 			while (read(logpipe.rd, &ch, 1) > 0) {
 				if (ch < ' ')
 					ch = ' ';
-				for (i = 6; i < rploglen; i++)
+				for (i = 6; rplog[i] != '\0'; i++)
 					rplog[i-1] = rplog[i];
-				rplog[rploglen-1] = ch;
+				rplog[i-1] = ch;
 			}
 		}
 #endif
-		if (!bb_got_signal)
+		sig = bb_got_signal;
+		if (!sig)
 			continue;
+		bb_got_signal = 0;
 
 		/* -s SCRIPT: useful if we are init.
 		 * In this case typically script never returns,
 		 * it halts/powers off/reboots the system. */
 		if (opt_s_argv[0]) {
+			pid_t pid;
+
 			/* Single parameter: signal# */
-			opt_s_argv[1] = utoa(bb_got_signal);
+			opt_s_argv[1] = utoa(sig);
 			pid = spawn(opt_s_argv);
 			if (pid > 0) {
 				/* Remembering to wait for _any_ children,
@@ -385,17 +391,16 @@ int runsvdir_main(int argc UNUSED_PARAM,
 			}
 		}
 
-		if (bb_got_signal == SIGHUP) {
+		if (sig == SIGHUP) {
 			for (i = 0; i < svnum; i++)
 				if (sv[i].pid)
 					kill(sv[i].pid, SIGTERM);
 		}
 		/* SIGHUP or SIGTERM (or SIGUSRn if we are init) */
 		/* Exit unless we are init */
-		if (getpid() != 1)
-			return (SIGHUP == bb_got_signal) ? 111 : EXIT_SUCCESS;
+		if (!i_am_init)
+			return (SIGHUP == sig) ? 111 : EXIT_SUCCESS;
 
 		/* init continues to monitor services forever */
-		bb_got_signal = 0;
 	} /* for (;;) */
 }
Binary files busybox.old/scripts/basic/docproc and busybox/scripts/basic/docproc differ
diff -Nurp busybox.old/scripts/basic/docproc.c busybox/scripts/basic/docproc.c
--- busybox.old/scripts/basic/docproc.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/scripts/basic/docproc.c	2015-05-29 07:00:58.209259146 +0800
@@ -264,7 +264,7 @@ void singfunc(char * filename, char * li
 	vec[idx++] = KERNELDOC;
 	vec[idx++] = DOCBOOK;
 
-	/* Split line up in individual parameters preceeded by FUNCTION */
+	/* Split line up in individual parameters preceded by FUNCTION */
 	for (i=0; line[i]; i++) {
 		if (isspace(line[i])) {
 			line[i] = '\0';
diff -Nurp busybox.old/scripts/basic/.docproc.cmd busybox/scripts/basic/.docproc.cmd
--- busybox.old/scripts/basic/.docproc.cmd	2015-05-29 06:54:59.000000000 +0800
+++ busybox/scripts/basic/.docproc.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,69 +0,0 @@
-cmd_scripts/basic/docproc := gcc -Wp,-MD,scripts/basic/.docproc.d  -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer       -o scripts/basic/docproc scripts/basic/docproc.c  
-
-deps_scripts/basic/docproc := \
-  scripts/basic/docproc.c \
-  /usr/include/stdc-predef.h \
-  /usr/include/stdio.h \
-  /usr/include/features.h \
-  /usr/include/sys/cdefs.h \
-  /usr/include/bits/wordsize.h \
-  /usr/include/gnu/stubs.h \
-  /usr/include/gnu/stubs-64.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stddef.h \
-  /usr/include/bits/types.h \
-  /usr/include/bits/typesizes.h \
-  /usr/include/libio.h \
-  /usr/include/_G_config.h \
-  /usr/include/wchar.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdarg.h \
-  /usr/include/bits/stdio_lim.h \
-  /usr/include/bits/sys_errlist.h \
-  /usr/include/bits/stdio.h \
-  /usr/include/stdlib.h \
-  /usr/include/bits/waitflags.h \
-  /usr/include/bits/waitstatus.h \
-  /usr/include/endian.h \
-  /usr/include/bits/endian.h \
-  /usr/include/bits/byteswap.h \
-  /usr/include/bits/byteswap-16.h \
-  /usr/include/sys/types.h \
-  /usr/include/time.h \
-  /usr/include/sys/select.h \
-  /usr/include/bits/select.h \
-  /usr/include/bits/sigset.h \
-  /usr/include/bits/time.h \
-  /usr/include/sys/sysmacros.h \
-  /usr/include/bits/pthreadtypes.h \
-  /usr/include/alloca.h \
-  /usr/include/bits/stdlib-bsearch.h \
-  /usr/include/bits/stdlib-float.h \
-  /usr/include/string.h \
-  /usr/include/xlocale.h \
-  /usr/include/bits/string.h \
-  /usr/include/bits/string2.h \
-  /usr/include/ctype.h \
-  /usr/include/unistd.h \
-  /usr/include/bits/posix_opt.h \
-  /usr/include/bits/environments.h \
-  /usr/include/bits/confname.h \
-  /usr/include/getopt.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include-fixed/limits.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include-fixed/syslimits.h \
-  /usr/include/limits.h \
-  /usr/include/bits/posix1_lim.h \
-  /usr/include/bits/local_lim.h \
-  /usr/include/linux/limits.h \
-  /usr/include/bits/posix2_lim.h \
-  /usr/include/sys/wait.h \
-  /usr/include/signal.h \
-  /usr/include/bits/signum.h \
-  /usr/include/bits/siginfo.h \
-  /usr/include/bits/sigaction.h \
-  /usr/include/bits/sigcontext.h \
-  /usr/include/bits/sigstack.h \
-  /usr/include/sys/ucontext.h \
-  /usr/include/bits/sigthread.h \
-
-scripts/basic/docproc: $(deps_scripts/basic/docproc)
-
-$(deps_scripts/basic/docproc):
Binary files busybox.old/scripts/basic/fixdep and busybox/scripts/basic/fixdep differ
diff -Nurp busybox.old/scripts/basic/.fixdep.cmd busybox/scripts/basic/.fixdep.cmd
--- busybox.old/scripts/basic/.fixdep.cmd	2015-05-29 06:54:59.000000000 +0800
+++ busybox/scripts/basic/.fixdep.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,89 +0,0 @@
-cmd_scripts/basic/fixdep := gcc -Wp,-MD,scripts/basic/.fixdep.d  -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer       -o scripts/basic/fixdep scripts/basic/fixdep.c  
-
-deps_scripts/basic/fixdep := \
-  scripts/basic/fixdep.c \
-    $(wildcard include/config/his/driver.h) \
-    $(wildcard include/config/my/option.h) \
-    $(wildcard include/config/foo.h) \
-    $(wildcard include/config/boom.h) \
-    $(wildcard include/config/not.h) \
-  /usr/include/stdc-predef.h \
-  /usr/include/sys/types.h \
-  /usr/include/features.h \
-  /usr/include/sys/cdefs.h \
-  /usr/include/bits/wordsize.h \
-  /usr/include/gnu/stubs.h \
-  /usr/include/gnu/stubs-64.h \
-  /usr/include/bits/types.h \
-  /usr/include/bits/typesizes.h \
-  /usr/include/time.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stddef.h \
-  /usr/include/endian.h \
-  /usr/include/bits/endian.h \
-  /usr/include/bits/byteswap.h \
-  /usr/include/bits/byteswap-16.h \
-  /usr/include/sys/select.h \
-  /usr/include/bits/select.h \
-  /usr/include/bits/sigset.h \
-  /usr/include/bits/time.h \
-  /usr/include/sys/sysmacros.h \
-  /usr/include/bits/pthreadtypes.h \
-  /usr/include/sys/stat.h \
-  /usr/include/bits/stat.h \
-  /usr/include/sys/mman.h \
-  /usr/include/bits/mman.h \
-  /usr/include/bits/mman-linux.h \
-  /usr/include/unistd.h \
-  /usr/include/bits/posix_opt.h \
-  /usr/include/bits/environments.h \
-  /usr/include/bits/confname.h \
-  /usr/include/getopt.h \
-  /usr/include/fcntl.h \
-  /usr/include/bits/fcntl.h \
-  /usr/include/bits/fcntl-linux.h \
-  /usr/include/string.h \
-  /usr/include/xlocale.h \
-  /usr/include/bits/string.h \
-  /usr/include/bits/string2.h \
-  /usr/include/stdlib.h \
-  /usr/include/bits/waitflags.h \
-  /usr/include/bits/waitstatus.h \
-  /usr/include/alloca.h \
-  /usr/include/bits/stdlib-bsearch.h \
-  /usr/include/bits/stdlib-float.h \
-  /usr/include/stdio.h \
-  /usr/include/libio.h \
-  /usr/include/_G_config.h \
-  /usr/include/wchar.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdarg.h \
-  /usr/include/bits/stdio_lim.h \
-  /usr/include/bits/sys_errlist.h \
-  /usr/include/bits/stdio.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include-fixed/limits.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include-fixed/syslimits.h \
-  /usr/include/limits.h \
-  /usr/include/bits/posix1_lim.h \
-  /usr/include/bits/local_lim.h \
-  /usr/include/linux/limits.h \
-  /usr/include/bits/posix2_lim.h \
-  /usr/include/ctype.h \
-  /usr/include/arpa/inet.h \
-  /usr/include/netinet/in.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdint.h \
-  /usr/include/stdint.h \
-  /usr/include/bits/wchar.h \
-  /usr/include/sys/socket.h \
-  /usr/include/sys/uio.h \
-  /usr/include/bits/uio.h \
-  /usr/include/bits/socket.h \
-  /usr/include/bits/socket_type.h \
-  /usr/include/bits/sockaddr.h \
-  /usr/include/asm/socket.h \
-  /usr/include/asm-generic/socket.h \
-  /usr/include/asm/sockios.h \
-  /usr/include/asm-generic/sockios.h \
-  /usr/include/bits/in.h \
-
-scripts/basic/fixdep: $(deps_scripts/basic/fixdep)
-
-$(deps_scripts/basic/fixdep):
diff -Nurp busybox.old/scripts/basic/.gitignore busybox/scripts/basic/.gitignore
--- busybox.old/scripts/basic/.gitignore	1970-01-01 08:00:00.000000000 +0800
+++ busybox/scripts/basic/.gitignore	2015-05-29 07:00:58.209259146 +0800
@@ -0,0 +1,4 @@
+hash
+fixdep
+docproc
+split-include
Binary files busybox.old/scripts/basic/split-include and busybox/scripts/basic/split-include differ
diff -Nurp busybox.old/scripts/basic/.split-include.cmd busybox/scripts/basic/.split-include.cmd
--- busybox.old/scripts/basic/.split-include.cmd	2015-05-29 06:54:59.000000000 +0800
+++ busybox/scripts/basic/.split-include.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,65 +0,0 @@
-cmd_scripts/basic/split-include := gcc -Wp,-MD,scripts/basic/.split-include.d  -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer       -o scripts/basic/split-include scripts/basic/split-include.c  
-
-deps_scripts/basic/split-include := \
-  scripts/basic/split-include.c \
-    $(wildcard include/config/foo.h) \
-  /usr/include/stdc-predef.h \
-  /usr/include/sys/stat.h \
-  /usr/include/features.h \
-  /usr/include/sys/cdefs.h \
-  /usr/include/bits/wordsize.h \
-  /usr/include/gnu/stubs.h \
-  /usr/include/gnu/stubs-64.h \
-  /usr/include/bits/types.h \
-  /usr/include/bits/typesizes.h \
-  /usr/include/time.h \
-  /usr/include/bits/stat.h \
-  /usr/include/sys/types.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stddef.h \
-  /usr/include/endian.h \
-  /usr/include/bits/endian.h \
-  /usr/include/bits/byteswap.h \
-  /usr/include/bits/byteswap-16.h \
-  /usr/include/sys/select.h \
-  /usr/include/bits/select.h \
-  /usr/include/bits/sigset.h \
-  /usr/include/bits/time.h \
-  /usr/include/sys/sysmacros.h \
-  /usr/include/bits/pthreadtypes.h \
-  /usr/include/ctype.h \
-  /usr/include/xlocale.h \
-  /usr/include/errno.h \
-  /usr/include/bits/errno.h \
-  /usr/include/linux/errno.h \
-  /usr/include/asm/errno.h \
-  /usr/include/asm-generic/errno.h \
-  /usr/include/asm-generic/errno-base.h \
-  /usr/include/fcntl.h \
-  /usr/include/bits/fcntl.h \
-  /usr/include/bits/fcntl-linux.h \
-  /usr/include/stdio.h \
-  /usr/include/libio.h \
-  /usr/include/_G_config.h \
-  /usr/include/wchar.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdarg.h \
-  /usr/include/bits/stdio_lim.h \
-  /usr/include/bits/sys_errlist.h \
-  /usr/include/bits/stdio.h \
-  /usr/include/stdlib.h \
-  /usr/include/bits/waitflags.h \
-  /usr/include/bits/waitstatus.h \
-  /usr/include/alloca.h \
-  /usr/include/bits/stdlib-bsearch.h \
-  /usr/include/bits/stdlib-float.h \
-  /usr/include/string.h \
-  /usr/include/bits/string.h \
-  /usr/include/bits/string2.h \
-  /usr/include/unistd.h \
-  /usr/include/bits/posix_opt.h \
-  /usr/include/bits/environments.h \
-  /usr/include/bits/confname.h \
-  /usr/include/getopt.h \
-
-scripts/basic/split-include: $(deps_scripts/basic/split-include)
-
-$(deps_scripts/basic/split-include):
diff -Nurp busybox.old/scripts/gen_build_files.sh busybox/scripts/gen_build_files.sh
--- busybox.old/scripts/gen_build_files.sh	2015-05-29 06:54:59.000000000 +0800
+++ busybox/scripts/gen_build_files.sh	2015-05-29 07:00:58.209259146 +0800
@@ -1,4 +1,4 @@
-#!/usr/bin/env bash
+#!/bin/sh
 
 # Note: was using sed OPTS CMD -- FILES
 # but users complain that many sed implementations
diff -Nurp busybox.old/scripts/Kbuild busybox/scripts/Kbuild
--- busybox.old/scripts/Kbuild	2015-05-29 06:55:00.000000000 +0800
+++ busybox/scripts/Kbuild	1970-01-01 08:00:00.000000000 +0800
@@ -1,8 +0,0 @@
-# DO NOT EDIT. This file is generated from Kbuild.src
-###
-# scripts contains sources for various helper programs used throughout
-# the kernel for the build process.
-# ---------------------------------------------------------------------------
-
-# Let clean descend into subdirs
-subdir- += basic kconfig
Binary files busybox.old/scripts/kconfig/conf and busybox/scripts/kconfig/conf differ
diff -Nurp busybox.old/scripts/kconfig/.conf.cmd busybox/scripts/kconfig/.conf.cmd
--- busybox.old/scripts/kconfig/.conf.cmd	2015-05-29 06:55:01.000000000 +0800
+++ busybox/scripts/kconfig/.conf.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-cmd_scripts/kconfig/conf := gcc  -o scripts/kconfig/conf scripts/kconfig/conf.o scripts/kconfig/zconf.tab.o  
Binary files busybox.old/scripts/kconfig/conf.o and busybox/scripts/kconfig/conf.o differ
diff -Nurp busybox.old/scripts/kconfig/.conf.o.cmd busybox/scripts/kconfig/.conf.o.cmd
--- busybox.old/scripts/kconfig/.conf.o.cmd	2015-05-29 06:55:00.000000000 +0800
+++ busybox/scripts/kconfig/.conf.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,55 +0,0 @@
-cmd_scripts/kconfig/conf.o := gcc -Wp,-MD,scripts/kconfig/.conf.o.d  -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer       -c -o scripts/kconfig/conf.o scripts/kconfig/conf.c
-
-deps_scripts/kconfig/conf.o := \
-  scripts/kconfig/conf.c \
-  /usr/include/stdc-predef.h \
-  /usr/include/ctype.h \
-  /usr/include/features.h \
-  /usr/include/sys/cdefs.h \
-  /usr/include/bits/wordsize.h \
-  /usr/include/gnu/stubs.h \
-  /usr/include/gnu/stubs-64.h \
-  /usr/include/bits/types.h \
-  /usr/include/bits/typesizes.h \
-  /usr/include/endian.h \
-  /usr/include/bits/endian.h \
-  /usr/include/xlocale.h \
-  /usr/include/stdlib.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stddef.h \
-  /usr/include/bits/waitflags.h \
-  /usr/include/bits/waitstatus.h \
-  /usr/include/sys/types.h \
-  /usr/include/time.h \
-  /usr/include/bits/pthreadtypes.h \
-  /usr/include/bits/stdlib-bsearch.h \
-  /usr/include/bits/stdlib-float.h \
-  /usr/include/stdio.h \
-  /usr/include/libio.h \
-  /usr/include/_G_config.h \
-  /usr/include/wchar.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdarg.h \
-  /usr/include/bits/stdio_lim.h \
-  /usr/include/bits/sys_errlist.h \
-  /usr/include/bits/stdio.h \
-  /usr/include/string.h \
-  /usr/include/bits/string.h \
-  /usr/include/bits/string2.h \
-  /usr/include/unistd.h \
-  /usr/include/bits/posix_opt.h \
-  /usr/include/bits/environments.h \
-  /usr/include/bits/confname.h \
-  /usr/include/getopt.h \
-  /usr/include/bits/time.h \
-  /usr/include/sys/stat.h \
-  /usr/include/bits/stat.h \
-  scripts/kconfig/lkc.h \
-  scripts/kconfig/expr.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdbool.h \
-  /usr/include/libintl.h \
-  /usr/include/locale.h \
-  /usr/include/bits/locale.h \
-  scripts/kconfig/lkc_proto.h \
-
-scripts/kconfig/conf.o: $(deps_scripts/kconfig/conf.o)
-
-$(deps_scripts/kconfig/conf.o):
diff -Nurp busybox.old/scripts/kconfig/.gitignore busybox/scripts/kconfig/.gitignore
--- busybox.old/scripts/kconfig/.gitignore	1970-01-01 08:00:00.000000000 +0800
+++ busybox/scripts/kconfig/.gitignore	2015-05-29 07:00:58.209259146 +0800
@@ -0,0 +1,19 @@
+#
+# Generated files
+#
+config*
+lex.*.c
+*.tab.c
+*.tab.h
+zconf.hash.c
+*.moc
+lkc_defs.h
+
+#
+# configuration programs
+#
+conf
+mconf
+qconf
+gconf
+kxgettext
Binary files busybox.old/scripts/kconfig/kxgettext.o and busybox/scripts/kconfig/kxgettext.o differ
diff -Nurp busybox.old/scripts/kconfig/.kxgettext.o.cmd busybox/scripts/kconfig/.kxgettext.o.cmd
--- busybox.old/scripts/kconfig/.kxgettext.o.cmd	2015-05-29 06:55:00.000000000 +0800
+++ busybox/scripts/kconfig/.kxgettext.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,54 +0,0 @@
-cmd_scripts/kconfig/kxgettext.o := gcc -Wp,-MD,scripts/kconfig/.kxgettext.o.d  -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer       -c -o scripts/kconfig/kxgettext.o scripts/kconfig/kxgettext.c
-
-deps_scripts/kconfig/kxgettext.o := \
-  scripts/kconfig/kxgettext.c \
-  /usr/include/stdc-predef.h \
-  /usr/include/stdlib.h \
-  /usr/include/features.h \
-  /usr/include/sys/cdefs.h \
-  /usr/include/bits/wordsize.h \
-  /usr/include/gnu/stubs.h \
-  /usr/include/gnu/stubs-64.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stddef.h \
-  /usr/include/bits/waitflags.h \
-  /usr/include/bits/waitstatus.h \
-  /usr/include/endian.h \
-  /usr/include/bits/endian.h \
-  /usr/include/bits/byteswap.h \
-  /usr/include/bits/types.h \
-  /usr/include/bits/typesizes.h \
-  /usr/include/bits/byteswap-16.h \
-  /usr/include/sys/types.h \
-  /usr/include/time.h \
-  /usr/include/sys/select.h \
-  /usr/include/bits/select.h \
-  /usr/include/bits/sigset.h \
-  /usr/include/bits/time.h \
-  /usr/include/sys/sysmacros.h \
-  /usr/include/bits/pthreadtypes.h \
-  /usr/include/alloca.h \
-  /usr/include/bits/stdlib-bsearch.h \
-  /usr/include/bits/stdlib-float.h \
-  /usr/include/string.h \
-  /usr/include/xlocale.h \
-  /usr/include/bits/string.h \
-  /usr/include/bits/string2.h \
-  scripts/kconfig/lkc.h \
-  scripts/kconfig/expr.h \
-  /usr/include/stdio.h \
-  /usr/include/libio.h \
-  /usr/include/_G_config.h \
-  /usr/include/wchar.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdarg.h \
-  /usr/include/bits/stdio_lim.h \
-  /usr/include/bits/sys_errlist.h \
-  /usr/include/bits/stdio.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdbool.h \
-  /usr/include/libintl.h \
-  /usr/include/locale.h \
-  /usr/include/bits/locale.h \
-  scripts/kconfig/lkc_proto.h \
-
-scripts/kconfig/kxgettext.o: $(deps_scripts/kconfig/kxgettext.o)
-
-$(deps_scripts/kconfig/kxgettext.o):
diff -Nurp busybox.old/scripts/kconfig/lex.zconf.c busybox/scripts/kconfig/lex.zconf.c
--- busybox.old/scripts/kconfig/lex.zconf.c	2015-05-29 06:55:00.000000000 +0800
+++ busybox/scripts/kconfig/lex.zconf.c	1970-01-01 08:00:00.000000000 +0800
@@ -1,2325 +0,0 @@
-
-#line 3 "scripts/kconfig/lex.zconf.c"
-
-#define  YY_INT_ALIGNED short int
-
-/* A lexical scanner generated by flex */
-
-#define FLEX_SCANNER
-#define YY_FLEX_MAJOR_VERSION 2
-#define YY_FLEX_MINOR_VERSION 5
-#define YY_FLEX_SUBMINOR_VERSION 31
-#if YY_FLEX_SUBMINOR_VERSION > 0
-#define FLEX_BETA
-#endif
-
-/* First, we deal with  platform-specific or compiler-specific issues. */
-
-/* begin standard C headers. */
-#include <stdio.h>
-#include <string.h>
-#include <errno.h>
-#include <stdlib.h>
-
-/* end standard C headers. */
-
-/* flex integer type definitions */
-
-#ifndef FLEXINT_H
-#define FLEXINT_H
-
-/* C99 systems have <inttypes.h>. Non-C99 systems may or may not. */
-
-#if defined __STDC_VERSION__ && __STDC_VERSION__ >= 199901L
-#include <inttypes.h>
-typedef int8_t flex_int8_t;
-typedef uint8_t flex_uint8_t;
-typedef int16_t flex_int16_t;
-typedef uint16_t flex_uint16_t;
-typedef int32_t flex_int32_t;
-typedef uint32_t flex_uint32_t;
-#else
-typedef signed char flex_int8_t;
-typedef short int flex_int16_t;
-typedef int flex_int32_t;
-typedef unsigned char flex_uint8_t;
-typedef unsigned short int flex_uint16_t;
-typedef unsigned int flex_uint32_t;
-#endif /* ! C99 */
-
-/* Limits of integral types. */
-#ifndef INT8_MIN
-#define INT8_MIN               (-128)
-#endif
-#ifndef INT16_MIN
-#define INT16_MIN              (-32767-1)
-#endif
-#ifndef INT32_MIN
-#define INT32_MIN              (-2147483647-1)
-#endif
-#ifndef INT8_MAX
-#define INT8_MAX               (127)
-#endif
-#ifndef INT16_MAX
-#define INT16_MAX              (32767)
-#endif
-#ifndef INT32_MAX
-#define INT32_MAX              (2147483647)
-#endif
-#ifndef UINT8_MAX
-#define UINT8_MAX              (255U)
-#endif
-#ifndef UINT16_MAX
-#define UINT16_MAX             (65535U)
-#endif
-#ifndef UINT32_MAX
-#define UINT32_MAX             (4294967295U)
-#endif
-
-#endif /* ! FLEXINT_H */
-
-#ifdef __cplusplus
-
-/* The "const" storage-class-modifier is valid. */
-#define YY_USE_CONST
-
-#else	/* ! __cplusplus */
-
-#if __STDC__
-
-#define YY_USE_CONST
-
-#endif	/* __STDC__ */
-#endif	/* ! __cplusplus */
-
-#ifdef YY_USE_CONST
-#define yyconst const
-#else
-#define yyconst
-#endif
-
-/* Returned upon end-of-file. */
-#define YY_NULL 0
-
-/* Promotes a possibly negative, possibly signed char to an unsigned
- * integer for use as an array index.  If the signed char is negative,
- * we want to instead treat it as an 8-bit unsigned char, hence the
- * double cast.
- */
-#define YY_SC_TO_UI(c) ((unsigned int) (unsigned char) c)
-
-/* Enter a start condition.  This macro really ought to take a parameter,
- * but we do it the disgusting crufty way forced on us by the ()-less
- * definition of BEGIN.
- */
-#define BEGIN (yy_start) = 1 + 2 *
-
-/* Translate the current start state into a value that can be later handed
- * to BEGIN to return to the state.  The YYSTATE alias is for lex
- * compatibility.
- */
-#define YY_START (((yy_start) - 1) / 2)
-#define YYSTATE YY_START
-
-/* Action number for EOF rule of a given start state. */
-#define YY_STATE_EOF(state) (YY_END_OF_BUFFER + state + 1)
-
-/* Special action meaning "start processing a new file". */
-#define YY_NEW_FILE zconfrestart(zconfin  )
-
-#define YY_END_OF_BUFFER_CHAR 0
-
-/* Size of default input buffer. */
-#ifndef YY_BUF_SIZE
-#define YY_BUF_SIZE 16384
-#endif
-
-#ifndef YY_TYPEDEF_YY_BUFFER_STATE
-#define YY_TYPEDEF_YY_BUFFER_STATE
-typedef struct yy_buffer_state *YY_BUFFER_STATE;
-#endif
-
-extern int zconfleng;
-
-extern FILE *zconfin, *zconfout;
-
-#define EOB_ACT_CONTINUE_SCAN 0
-#define EOB_ACT_END_OF_FILE 1
-#define EOB_ACT_LAST_MATCH 2
-
-    #define YY_LESS_LINENO(n)
-
-/* Return all but the first "n" matched characters back to the input stream. */
-#define yyless(n) \
-	do \
-		{ \
-		/* Undo effects of setting up zconftext. */ \
-        int yyless_macro_arg = (n); \
-        YY_LESS_LINENO(yyless_macro_arg);\
-		*yy_cp = (yy_hold_char); \
-		YY_RESTORE_YY_MORE_OFFSET \
-		(yy_c_buf_p) = yy_cp = yy_bp + yyless_macro_arg - YY_MORE_ADJ; \
-		YY_DO_BEFORE_ACTION; /* set up zconftext again */ \
-		} \
-	while ( 0 )
-
-#define unput(c) yyunput( c, (yytext_ptr)  )
-
-/* The following is because we cannot portably get our hands on size_t
- * (without autoconf's help, which isn't available because we want
- * flex-generated scanners to compile on their own).
- */
-
-#ifndef YY_TYPEDEF_YY_SIZE_T
-#define YY_TYPEDEF_YY_SIZE_T
-typedef unsigned int yy_size_t;
-#endif
-
-#ifndef YY_STRUCT_YY_BUFFER_STATE
-#define YY_STRUCT_YY_BUFFER_STATE
-struct yy_buffer_state
-	{
-	FILE *yy_input_file;
-
-	char *yy_ch_buf;		/* input buffer */
-	char *yy_buf_pos;		/* current position in input buffer */
-
-	/* Size of input buffer in bytes, not including room for EOB
-	 * characters.
-	 */
-	yy_size_t yy_buf_size;
-
-	/* Number of characters read into yy_ch_buf, not including EOB
-	 * characters.
-	 */
-	int yy_n_chars;
-
-	/* Whether we "own" the buffer - i.e., we know we created it,
-	 * and can realloc() it to grow it, and should free() it to
-	 * delete it.
-	 */
-	int yy_is_our_buffer;
-
-	/* Whether this is an "interactive" input source; if so, and
-	 * if we're using stdio for input, then we want to use getc()
-	 * instead of fread(), to make sure we stop fetching input after
-	 * each newline.
-	 */
-	int yy_is_interactive;
-
-	/* Whether we're considered to be at the beginning of a line.
-	 * If so, '^' rules will be active on the next match, otherwise
-	 * not.
-	 */
-	int yy_at_bol;
-
-    int yy_bs_lineno; /**< The line count. */
-    int yy_bs_column; /**< The column count. */
-
-	/* Whether to try to fill the input buffer when we reach the
-	 * end of it.
-	 */
-	int yy_fill_buffer;
-
-	int yy_buffer_status;
-
-#define YY_BUFFER_NEW 0
-#define YY_BUFFER_NORMAL 1
-	/* When an EOF's been seen but there's still some text to process
-	 * then we mark the buffer as YY_EOF_PENDING, to indicate that we
-	 * shouldn't try reading from the input source any more.  We might
-	 * still have a bunch of tokens to match, though, because of
-	 * possible backing-up.
-	 *
-	 * When we actually see the EOF, we change the status to "new"
-	 * (via zconfrestart()), so that the user can continue scanning by
-	 * just pointing zconfin at a new input file.
-	 */
-#define YY_BUFFER_EOF_PENDING 2
-
-	};
-#endif /* !YY_STRUCT_YY_BUFFER_STATE */
-
-/* Stack of input buffers. */
-static size_t yy_buffer_stack_top = 0; /**< index of top of stack. */
-static size_t yy_buffer_stack_max = 0; /**< capacity of stack. */
-static YY_BUFFER_STATE * yy_buffer_stack = 0; /**< Stack as an array. */
-
-/* We provide macros for accessing buffer states in case in the
- * future we want to put the buffer states in a more general
- * "scanner state".
- *
- * Returns the top of the stack, or NULL.
- */
-#define YY_CURRENT_BUFFER ( (yy_buffer_stack) \
-                          ? (yy_buffer_stack)[(yy_buffer_stack_top)] \
-                          : NULL)
-
-/* Same as previous macro, but useful when we know that the buffer stack is not
- * NULL or when we need an lvalue. For internal use only.
- */
-#define YY_CURRENT_BUFFER_LVALUE (yy_buffer_stack)[(yy_buffer_stack_top)]
-
-/* yy_hold_char holds the character lost when zconftext is formed. */
-static char yy_hold_char;
-static int yy_n_chars;		/* number of characters read into yy_ch_buf */
-int zconfleng;
-
-/* Points to current character in buffer. */
-static char *yy_c_buf_p = (char *) 0;
-static int yy_init = 1;		/* whether we need to initialize */
-static int yy_start = 0;	/* start state number */
-
-/* Flag which is used to allow zconfwrap()'s to do buffer switches
- * instead of setting up a fresh zconfin.  A bit of a hack ...
- */
-static int yy_did_buffer_switch_on_eof;
-
-void zconfrestart (FILE *input_file  );
-void zconf_switch_to_buffer (YY_BUFFER_STATE new_buffer  );
-YY_BUFFER_STATE zconf_create_buffer (FILE *file,int size  );
-void zconf_delete_buffer (YY_BUFFER_STATE b  );
-void zconf_flush_buffer (YY_BUFFER_STATE b  );
-void zconfpush_buffer_state (YY_BUFFER_STATE new_buffer  );
-void zconfpop_buffer_state (void );
-
-static void zconfensure_buffer_stack (void );
-static void zconf_load_buffer_state (void );
-static void zconf_init_buffer (YY_BUFFER_STATE b,FILE *file  );
-
-#define YY_FLUSH_BUFFER zconf_flush_buffer(YY_CURRENT_BUFFER )
-
-YY_BUFFER_STATE zconf_scan_buffer (char *base,yy_size_t size  );
-YY_BUFFER_STATE zconf_scan_string (yyconst char *yy_str  );
-YY_BUFFER_STATE zconf_scan_bytes (yyconst char *bytes,int len  );
-
-void *zconfalloc (yy_size_t  );
-void *zconfrealloc (void *,yy_size_t  );
-void zconffree (void *  );
-
-#define yy_new_buffer zconf_create_buffer
-
-#define yy_set_interactive(is_interactive) \
-	{ \
-	if ( ! YY_CURRENT_BUFFER ){ \
-        zconfensure_buffer_stack (); \
-		YY_CURRENT_BUFFER_LVALUE =    \
-            zconf_create_buffer(zconfin,YY_BUF_SIZE ); \
-	} \
-	YY_CURRENT_BUFFER_LVALUE->yy_is_interactive = is_interactive; \
-	}
-
-#define yy_set_bol(at_bol) \
-	{ \
-	if ( ! YY_CURRENT_BUFFER ){\
-        zconfensure_buffer_stack (); \
-		YY_CURRENT_BUFFER_LVALUE =    \
-            zconf_create_buffer(zconfin,YY_BUF_SIZE ); \
-	} \
-	YY_CURRENT_BUFFER_LVALUE->yy_at_bol = at_bol; \
-	}
-
-#define YY_AT_BOL() (YY_CURRENT_BUFFER_LVALUE->yy_at_bol)
-
-/* Begin user sect3 */
-
-#define zconfwrap() 1
-#define YY_SKIP_YYWRAP
-
-typedef unsigned char YY_CHAR;
-
-FILE *zconfin = (FILE *) 0, *zconfout = (FILE *) 0;
-
-typedef int yy_state_type;
-
-extern int zconflineno;
-
-int zconflineno = 1;
-
-extern char *zconftext;
-#define yytext_ptr zconftext
-static yyconst flex_int16_t yy_nxt[][17] =
-    {
-    {
-        0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
-        0,    0,    0,    0,    0,    0,    0
-    },
-
-    {
-       11,   12,   13,   14,   12,   12,   15,   12,   12,   12,
-       12,   12,   12,   12,   12,   12,   12
-    },
-
-    {
-       11,   12,   13,   14,   12,   12,   15,   12,   12,   12,
-       12,   12,   12,   12,   12,   12,   12
-    },
-
-    {
-       11,   16,   16,   17,   16,   16,   16,   16,   16,   16,
-       16,   16,   16,   18,   16,   16,   16
-    },
-
-    {
-       11,   16,   16,   17,   16,   16,   16,   16,   16,   16,
-       16,   16,   16,   18,   16,   16,   16
-
-    },
-
-    {
-       11,   19,   20,   21,   19,   19,   19,   19,   19,   19,
-       19,   19,   19,   19,   19,   19,   19
-    },
-
-    {
-       11,   19,   20,   21,   19,   19,   19,   19,   19,   19,
-       19,   19,   19,   19,   19,   19,   19
-    },
-
-    {
-       11,   22,   22,   23,   22,   24,   22,   22,   24,   22,
-       22,   22,   22,   22,   22,   25,   22
-    },
-
-    {
-       11,   22,   22,   23,   22,   24,   22,   22,   24,   22,
-       22,   22,   22,   22,   22,   25,   22
-    },
-
-    {
-       11,   26,   26,   27,   28,   29,   30,   31,   29,   32,
-       33,   34,   35,   35,   36,   37,   38
-
-    },
-
-    {
-       11,   26,   26,   27,   28,   29,   30,   31,   29,   32,
-       33,   34,   35,   35,   36,   37,   38
-    },
-
-    {
-      -11,  -11,  -11,  -11,  -11,  -11,  -11,  -11,  -11,  -11,
-      -11,  -11,  -11,  -11,  -11,  -11,  -11
-    },
-
-    {
-       11,  -12,  -12,  -12,  -12,  -12,  -12,  -12,  -12,  -12,
-      -12,  -12,  -12,  -12,  -12,  -12,  -12
-    },
-
-    {
-       11,  -13,   39,   40,  -13,  -13,   41,  -13,  -13,  -13,
-      -13,  -13,  -13,  -13,  -13,  -13,  -13
-    },
-
-    {
-       11,  -14,  -14,  -14,  -14,  -14,  -14,  -14,  -14,  -14,
-      -14,  -14,  -14,  -14,  -14,  -14,  -14
-
-    },
-
-    {
-       11,   42,   42,   43,   42,   42,   42,   42,   42,   42,
-       42,   42,   42,   42,   42,   42,   42
-    },
-
-    {
-       11,  -16,  -16,  -16,  -16,  -16,  -16,  -16,  -16,  -16,
-      -16,  -16,  -16,  -16,  -16,  -16,  -16
-    },
-
-    {
-       11,  -17,  -17,  -17,  -17,  -17,  -17,  -17,  -17,  -17,
-      -17,  -17,  -17,  -17,  -17,  -17,  -17
-    },
-
-    {
-       11,  -18,  -18,  -18,  -18,  -18,  -18,  -18,  -18,  -18,
-      -18,  -18,  -18,   44,  -18,  -18,  -18
-    },
-
-    {
-       11,   45,   45,  -19,   45,   45,   45,   45,   45,   45,
-       45,   45,   45,   45,   45,   45,   45
-
-    },
-
-    {
-       11,  -20,   46,   47,  -20,  -20,  -20,  -20,  -20,  -20,
-      -20,  -20,  -20,  -20,  -20,  -20,  -20
-    },
-
-    {
-       11,   48,  -21,  -21,   48,   48,   48,   48,   48,   48,
-       48,   48,   48,   48,   48,   48,   48
-    },
-
-    {
-       11,   49,   49,   50,   49,  -22,   49,   49,  -22,   49,
-       49,   49,   49,   49,   49,  -22,   49
-    },
-
-    {
-       11,  -23,  -23,  -23,  -23,  -23,  -23,  -23,  -23,  -23,
-      -23,  -23,  -23,  -23,  -23,  -23,  -23
-    },
-
-    {
-       11,  -24,  -24,  -24,  -24,  -24,  -24,  -24,  -24,  -24,
-      -24,  -24,  -24,  -24,  -24,  -24,  -24
-
-    },
-
-    {
-       11,   51,   51,   52,   51,   51,   51,   51,   51,   51,
-       51,   51,   51,   51,   51,   51,   51
-    },
-
-    {
-       11,  -26,  -26,  -26,  -26,  -26,  -26,  -26,  -26,  -26,
-      -26,  -26,  -26,  -26,  -26,  -26,  -26
-    },
-
-    {
-       11,  -27,  -27,  -27,  -27,  -27,  -27,  -27,  -27,  -27,
-      -27,  -27,  -27,  -27,  -27,  -27,  -27
-    },
-
-    {
-       11,  -28,  -28,  -28,  -28,  -28,  -28,  -28,  -28,  -28,
-      -28,  -28,  -28,  -28,   53,  -28,  -28
-    },
-
-    {
-       11,  -29,  -29,  -29,  -29,  -29,  -29,  -29,  -29,  -29,
-      -29,  -29,  -29,  -29,  -29,  -29,  -29
-
-    },
-
-    {
-       11,   54,   54,  -30,   54,   54,   54,   54,   54,   54,
-       54,   54,   54,   54,   54,   54,   54
-    },
-
-    {
-       11,  -31,  -31,  -31,  -31,  -31,  -31,   55,  -31,  -31,
-      -31,  -31,  -31,  -31,  -31,  -31,  -31
-    },
-
-    {
-       11,  -32,  -32,  -32,  -32,  -32,  -32,  -32,  -32,  -32,
-      -32,  -32,  -32,  -32,  -32,  -32,  -32
-    },
-
-    {
-       11,  -33,  -33,  -33,  -33,  -33,  -33,  -33,  -33,  -33,
-      -33,  -33,  -33,  -33,  -33,  -33,  -33
-    },
-
-    {
-       11,  -34,  -34,  -34,  -34,  -34,  -34,  -34,  -34,  -34,
-      -34,   56,   57,   57,  -34,  -34,  -34
-
-    },
-
-    {
-       11,  -35,  -35,  -35,  -35,  -35,  -35,  -35,  -35,  -35,
-      -35,   57,   57,   57,  -35,  -35,  -35
-    },
-
-    {
-       11,  -36,  -36,  -36,  -36,  -36,  -36,  -36,  -36,  -36,
-      -36,  -36,  -36,  -36,  -36,  -36,  -36
-    },
-
-    {
-       11,  -37,  -37,   58,  -37,  -37,  -37,  -37,  -37,  -37,
-      -37,  -37,  -37,  -37,  -37,  -37,  -37
-    },
-
-    {
-       11,  -38,  -38,  -38,  -38,  -38,  -38,  -38,  -38,  -38,
-      -38,  -38,  -38,  -38,  -38,  -38,   59
-    },
-
-    {
-       11,  -39,   39,   40,  -39,  -39,   41,  -39,  -39,  -39,
-      -39,  -39,  -39,  -39,  -39,  -39,  -39
-
-    },
-
-    {
-       11,  -40,  -40,  -40,  -40,  -40,  -40,  -40,  -40,  -40,
-      -40,  -40,  -40,  -40,  -40,  -40,  -40
-    },
-
-    {
-       11,   42,   42,   43,   42,   42,   42,   42,   42,   42,
-       42,   42,   42,   42,   42,   42,   42
-    },
-
-    {
-       11,   42,   42,   43,   42,   42,   42,   42,   42,   42,
-       42,   42,   42,   42,   42,   42,   42
-    },
-
-    {
-       11,  -43,  -43,  -43,  -43,  -43,  -43,  -43,  -43,  -43,
-      -43,  -43,  -43,  -43,  -43,  -43,  -43
-    },
-
-    {
-       11,  -44,  -44,  -44,  -44,  -44,  -44,  -44,  -44,  -44,
-      -44,  -44,  -44,   44,  -44,  -44,  -44
-
-    },
-
-    {
-       11,   45,   45,  -45,   45,   45,   45,   45,   45,   45,
-       45,   45,   45,   45,   45,   45,   45
-    },
-
-    {
-       11,  -46,   46,   47,  -46,  -46,  -46,  -46,  -46,  -46,
-      -46,  -46,  -46,  -46,  -46,  -46,  -46
-    },
-
-    {
-       11,   48,  -47,  -47,   48,   48,   48,   48,   48,   48,
-       48,   48,   48,   48,   48,   48,   48
-    },
-
-    {
-       11,  -48,  -48,  -48,  -48,  -48,  -48,  -48,  -48,  -48,
-      -48,  -48,  -48,  -48,  -48,  -48,  -48
-    },
-
-    {
-       11,   49,   49,   50,   49,  -49,   49,   49,  -49,   49,
-       49,   49,   49,   49,   49,  -49,   49
-
-    },
-
-    {
-       11,  -50,  -50,  -50,  -50,  -50,  -50,  -50,  -50,  -50,
-      -50,  -50,  -50,  -50,  -50,  -50,  -50
-    },
-
-    {
-       11,  -51,  -51,   52,  -51,  -51,  -51,  -51,  -51,  -51,
-      -51,  -51,  -51,  -51,  -51,  -51,  -51
-    },
-
-    {
-       11,  -52,  -52,  -52,  -52,  -52,  -52,  -52,  -52,  -52,
-      -52,  -52,  -52,  -52,  -52,  -52,  -52
-    },
-
-    {
-       11,  -53,  -53,  -53,  -53,  -53,  -53,  -53,  -53,  -53,
-      -53,  -53,  -53,  -53,  -53,  -53,  -53
-    },
-
-    {
-       11,   54,   54,  -54,   54,   54,   54,   54,   54,   54,
-       54,   54,   54,   54,   54,   54,   54
-
-    },
-
-    {
-       11,  -55,  -55,  -55,  -55,  -55,  -55,  -55,  -55,  -55,
-      -55,  -55,  -55,  -55,  -55,  -55,  -55
-    },
-
-    {
-       11,  -56,  -56,  -56,  -56,  -56,  -56,  -56,  -56,  -56,
-      -56,   60,   57,   57,  -56,  -56,  -56
-    },
-
-    {
-       11,  -57,  -57,  -57,  -57,  -57,  -57,  -57,  -57,  -57,
-      -57,   57,   57,   57,  -57,  -57,  -57
-    },
-
-    {
-       11,  -58,  -58,  -58,  -58,  -58,  -58,  -58,  -58,  -58,
-      -58,  -58,  -58,  -58,  -58,  -58,  -58
-    },
-
-    {
-       11,  -59,  -59,  -59,  -59,  -59,  -59,  -59,  -59,  -59,
-      -59,  -59,  -59,  -59,  -59,  -59,  -59
-
-    },
-
-    {
-       11,  -60,  -60,  -60,  -60,  -60,  -60,  -60,  -60,  -60,
-      -60,   57,   57,   57,  -60,  -60,  -60
-    },
-
-    } ;
-
-static yy_state_type yy_get_previous_state (void );
-static yy_state_type yy_try_NUL_trans (yy_state_type current_state  );
-static int yy_get_next_buffer (void );
-static void yy_fatal_error (yyconst char msg[]  );
-
-/* Done after the current pattern has been matched and before the
- * corresponding action - sets up zconftext.
- */
-#define YY_DO_BEFORE_ACTION \
-	(yytext_ptr) = yy_bp; \
-	zconfleng = (size_t) (yy_cp - yy_bp); \
-	(yy_hold_char) = *yy_cp; \
-	*yy_cp = '\0'; \
-	(yy_c_buf_p) = yy_cp;
-
-#define YY_NUM_RULES 33
-#define YY_END_OF_BUFFER 34
-/* This struct is not used in this scanner,
-   but its presence is necessary. */
-struct yy_trans_info
-	{
-	flex_int32_t yy_verify;
-	flex_int32_t yy_nxt;
-	};
-static yyconst flex_int16_t yy_accept[61] =
-    {   0,
-        0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
-       34,    5,    4,    2,    3,    7,    8,    6,   32,   29,
-       31,   24,   28,   27,   26,   22,   17,   13,   16,   20,
-       22,   11,   12,   19,   19,   14,   22,   22,    4,    2,
-        3,    3,    1,    6,   32,   29,   31,   30,   24,   23,
-       26,   25,   15,   20,    9,   19,   19,   21,   10,   18
-    } ;
-
-static yyconst flex_int32_t yy_ec[256] =
-    {   0,
-        1,    1,    1,    1,    1,    1,    1,    1,    2,    3,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    2,    4,    5,    6,    1,    1,    7,    8,    9,
-       10,    1,    1,    1,   11,   12,   12,   13,   13,   13,
-       13,   13,   13,   13,   13,   13,   13,    1,    1,    1,
-       14,    1,    1,    1,   13,   13,   13,   13,   13,   13,
-       13,   13,   13,   13,   13,   13,   13,   13,   13,   13,
-       13,   13,   13,   13,   13,   13,   13,   13,   13,   13,
-        1,   15,    1,    1,   13,    1,   13,   13,   13,   13,
-
-       13,   13,   13,   13,   13,   13,   13,   13,   13,   13,
-       13,   13,   13,   13,   13,   13,   13,   13,   13,   13,
-       13,   13,    1,   16,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1
-    } ;
-
-extern int zconf_flex_debug;
-int zconf_flex_debug = 0;
-
-/* The intent behind this definition is that it'll catch
- * any uses of REJECT which flex missed.
- */
-#define REJECT reject_used_but_not_detected
-#define yymore() yymore_used_but_not_detected
-#define YY_MORE_ADJ 0
-#define YY_RESTORE_YY_MORE_OFFSET
-char *zconftext;
-
-/*
- * Copyright (C) 2002 Roman Zippel <zippel@linux-m68k.org>
- * Released under the terms of the GNU GPL v2.0.
- */
-
-#include <limits.h>
-#include <stdio.h>
-#include <stdlib.h>
-#include <string.h>
-#include <unistd.h>
-
-#define LKC_DIRECT_LINK
-#include "lkc.h"
-
-#define START_STRSIZE	16
-
-static struct {
-	struct file *file;
-	int lineno;
-} current_pos;
-
-static char *text;
-static int text_size, text_asize;
-
-struct buffer {
-        struct buffer *parent;
-        YY_BUFFER_STATE state;
-};
-
-struct buffer *current_buf;
-
-static int last_ts, first_ts;
-
-static void zconf_endhelp(void);
-static void zconf_endfile(void);
-
-void new_string(void)
-{
-	text = malloc(START_STRSIZE);
-	text_asize = START_STRSIZE;
-	text_size = 0;
-	*text = 0;
-}
-
-void append_string(const char *str, int size)
-{
-	int new_size = text_size + size + 1;
-	if (size > 70) {
-		fprintf (stderr, "%s:%d error: Overlong line\n",
-		current_file->name, current_file->lineno);
-	}
-
-	if (new_size > text_asize) {
-		new_size += START_STRSIZE - 1;
-		new_size &= -START_STRSIZE;
-		text = realloc(text, new_size);
-		text_asize = new_size;
-	}
-	memcpy(text + text_size, str, size);
-	text_size += size;
-	text[text_size] = 0;
-}
-
-void alloc_string(const char *str, int size)
-{
-	text = malloc(size + 1);
-	memcpy(text, str, size);
-	text[size] = 0;
-}
-
-#define INITIAL 0
-#define COMMAND 1
-#define HELP 2
-#define STRING 3
-#define PARAM 4
-
-#ifndef YY_NO_UNISTD_H
-/* Special case for "unistd.h", since it is non-ANSI. We include it way
- * down here because we want the user's section 1 to have been scanned first.
- * The user has a chance to override it with an option.
- */
-#include <unistd.h>
-#endif
-
-#ifndef YY_EXTRA_TYPE
-#define YY_EXTRA_TYPE void *
-#endif
-
-/* Macros after this point can all be overridden by user definitions in
- * section 1.
- */
-
-#ifndef YY_SKIP_YYWRAP
-#ifdef __cplusplus
-extern "C" int zconfwrap (void );
-#else
-extern int zconfwrap (void );
-#endif
-#endif
-
-    static void yyunput (int c,char *buf_ptr  );
-
-#ifndef yytext_ptr
-static void yy_flex_strncpy (char *,yyconst char *,int );
-#endif
-
-#ifdef YY_NEED_STRLEN
-static int yy_flex_strlen (yyconst char * );
-#endif
-
-//bbox: suppressing "defined but not used" warning
-#define YY_NO_INPUT 1
-
-#ifndef YY_NO_INPUT
-
-#ifdef __cplusplus
-static int yyinput (void );
-#else
-static int input (void );
-#endif
-
-#endif
-
-/* Amount of stuff to slurp up with each read. */
-#ifndef YY_READ_BUF_SIZE
-#define YY_READ_BUF_SIZE 8192
-#endif
-
-/* Copy whatever the last rule matched to the standard output. */
-#ifndef ECHO
-/* This used to be an fputs(), but since the string might contain NUL's,
- * we now use fwrite().
- */
-#define ECHO (void) fwrite( zconftext, zconfleng, 1, zconfout )
-#endif
-
-/* Gets input and stuffs it into "buf".  number of characters read, or YY_NULL,
- * is returned in "result".
- */
-#ifndef YY_INPUT
-#define YY_INPUT(buf,result,max_size) \
-	errno=0; \
-	while ( (result = read( fileno(zconfin), (char *) buf, max_size )) < 0 ) \
-	{ \
-		if( errno != EINTR) \
-		{ \
-			YY_FATAL_ERROR( "input in flex scanner failed" ); \
-			break; \
-		} \
-		errno=0; \
-		clearerr(zconfin); \
-	}\
-\
-
-#endif
-
-/* No semi-colon after return; correct usage is to write "yyterminate();" -
- * we don't want an extra ';' after the "return" because that will cause
- * some compilers to complain about unreachable statements.
- */
-#ifndef yyterminate
-#define yyterminate() return YY_NULL
-#endif
-
-/* Number of entries by which start-condition stack grows. */
-#ifndef YY_START_STACK_INCR
-#define YY_START_STACK_INCR 25
-#endif
-
-/* Report a fatal error. */
-#ifndef YY_FATAL_ERROR
-#define YY_FATAL_ERROR(msg) yy_fatal_error( msg )
-#endif
-
-/* end tables serialization structures and prototypes */
-
-/* Default declaration of generated scanner - a define so the user can
- * easily add parameters.
- */
-#ifndef YY_DECL
-#define YY_DECL_IS_OURS 1
-
-extern int zconflex (void);
-
-#define YY_DECL int zconflex (void)
-#endif /* !YY_DECL */
-
-/* Code executed at the beginning of each rule, after zconftext and zconfleng
- * have been set up.
- */
-#ifndef YY_USER_ACTION
-#define YY_USER_ACTION
-#endif
-
-/* Code executed at the end of each rule. */
-#ifndef YY_BREAK
-#define YY_BREAK break;
-#endif
-
-#define YY_RULE_SETUP \
-	YY_USER_ACTION
-
-/** The main scanner function which does all the work.
- */
-YY_DECL
-{
-	register yy_state_type yy_current_state;
-	register char *yy_cp, *yy_bp;
-	register int yy_act;
-
-	int str = 0;
-	int ts, i;
-
-	if ( (yy_init) )
-		{
-		(yy_init) = 0;
-
-#ifdef YY_USER_INIT
-		YY_USER_INIT;
-#endif
-
-		if ( ! (yy_start) )
-			(yy_start) = 1;	/* first start state */
-
-		if ( ! zconfin )
-			zconfin = stdin;
-
-		if ( ! zconfout )
-			zconfout = stdout;
-
-		if ( ! YY_CURRENT_BUFFER ) {
-			zconfensure_buffer_stack ();
-			YY_CURRENT_BUFFER_LVALUE =
-				zconf_create_buffer(zconfin,YY_BUF_SIZE );
-		}
-
-		zconf_load_buffer_state( );
-		}
-
-	while ( 1 )		/* loops until end-of-file is reached */
-		{
-		yy_cp = (yy_c_buf_p);
-
-		/* Support of zconftext. */
-		*yy_cp = (yy_hold_char);
-
-		/* yy_bp points to the position in yy_ch_buf of the start of
-		 * the current run.
-		 */
-		yy_bp = yy_cp;
-
-		yy_current_state = (yy_start);
-yy_match:
-		while ( (yy_current_state = yy_nxt[yy_current_state][ yy_ec[YY_SC_TO_UI(*yy_cp)]  ]) > 0 )
-			++yy_cp;
-
-		yy_current_state = -yy_current_state;
-
-yy_find_action:
-		yy_act = yy_accept[yy_current_state];
-
-		YY_DO_BEFORE_ACTION;
-
-do_action:	/* This label is used only to access EOF actions. */
-
-		switch ( yy_act )
-	{ /* beginning of action switch */
-case 1:
-/* rule 1 can match eol */
-case 2:
-/* rule 2 can match eol */
-YY_RULE_SETUP
-{
-	current_file->lineno++;
-	return T_EOL;
-}
-	YY_BREAK
-case 3:
-YY_RULE_SETUP
-
-	YY_BREAK
-case 4:
-YY_RULE_SETUP
-{
-	BEGIN(COMMAND);
-}
-	YY_BREAK
-case 5:
-YY_RULE_SETUP
-{
-	unput(zconftext[0]);
-	BEGIN(COMMAND);
-}
-	YY_BREAK
-
-case 6:
-YY_RULE_SETUP
-{
-		struct kconf_id *id = kconf_id_lookup(zconftext, zconfleng);
-		BEGIN(PARAM);
-		current_pos.file = current_file;
-		current_pos.lineno = current_file->lineno;
-		if (id && id->flags & TF_COMMAND) {
-			zconflval.id = id;
-			return id->token;
-		}
-		alloc_string(zconftext, zconfleng);
-		zconflval.string = text;
-		return T_WORD;
-	}
-	YY_BREAK
-case 7:
-YY_RULE_SETUP
-
-	YY_BREAK
-case 8:
-/* rule 8 can match eol */
-YY_RULE_SETUP
-{
-		BEGIN(INITIAL);
-		current_file->lineno++;
-		return T_EOL;
-	}
-	YY_BREAK
-
-case 9:
-YY_RULE_SETUP
-return T_AND;
-	YY_BREAK
-case 10:
-YY_RULE_SETUP
-return T_OR;
-	YY_BREAK
-case 11:
-YY_RULE_SETUP
-return T_OPEN_PAREN;
-	YY_BREAK
-case 12:
-YY_RULE_SETUP
-return T_CLOSE_PAREN;
-	YY_BREAK
-case 13:
-YY_RULE_SETUP
-return T_NOT;
-	YY_BREAK
-case 14:
-YY_RULE_SETUP
-return T_EQUAL;
-	YY_BREAK
-case 15:
-YY_RULE_SETUP
-return T_UNEQUAL;
-	YY_BREAK
-case 16:
-YY_RULE_SETUP
-{
-		str = zconftext[0];
-		new_string();
-		BEGIN(STRING);
-	}
-	YY_BREAK
-case 17:
-/* rule 17 can match eol */
-YY_RULE_SETUP
-BEGIN(INITIAL); current_file->lineno++; return T_EOL;
-	YY_BREAK
-case 18:
-YY_RULE_SETUP
-/* ignore */
-	YY_BREAK
-case 19:
-YY_RULE_SETUP
-{
-		struct kconf_id *id = kconf_id_lookup(zconftext, zconfleng);
-		if (id && id->flags & TF_PARAM) {
-			zconflval.id = id;
-			return id->token;
-		}
-		alloc_string(zconftext, zconfleng);
-		zconflval.string = text;
-		return T_WORD;
-	}
-	YY_BREAK
-case 20:
-YY_RULE_SETUP
-/* comment */
-	YY_BREAK
-case 21:
-/* rule 21 can match eol */
-YY_RULE_SETUP
-current_file->lineno++;
-	YY_BREAK
-case 22:
-YY_RULE_SETUP
-
-	YY_BREAK
-case YY_STATE_EOF(PARAM):
-{
-		BEGIN(INITIAL);
-	}
-	YY_BREAK
-
-case 23:
-/* rule 23 can match eol */
-*yy_cp = (yy_hold_char); /* undo effects of setting up zconftext */
-(yy_c_buf_p) = yy_cp -= 1;
-YY_DO_BEFORE_ACTION; /* set up zconftext again */
-YY_RULE_SETUP
-{
-		append_string(zconftext, zconfleng);
-		zconflval.string = text;
-		return T_WORD_QUOTE;
-	}
-	YY_BREAK
-case 24:
-YY_RULE_SETUP
-{
-		append_string(zconftext, zconfleng);
-	}
-	YY_BREAK
-case 25:
-/* rule 25 can match eol */
-*yy_cp = (yy_hold_char); /* undo effects of setting up zconftext */
-(yy_c_buf_p) = yy_cp -= 1;
-YY_DO_BEFORE_ACTION; /* set up zconftext again */
-YY_RULE_SETUP
-{
-		append_string(zconftext + 1, zconfleng - 1);
-		zconflval.string = text;
-		return T_WORD_QUOTE;
-	}
-	YY_BREAK
-case 26:
-YY_RULE_SETUP
-{
-		append_string(zconftext + 1, zconfleng - 1);
-	}
-	YY_BREAK
-case 27:
-YY_RULE_SETUP
-{
-		if (str == zconftext[0]) {
-			BEGIN(PARAM);
-			zconflval.string = text;
-			return T_WORD_QUOTE;
-		} else
-			append_string(zconftext, 1);
-	}
-	YY_BREAK
-case 28:
-/* rule 28 can match eol */
-YY_RULE_SETUP
-{
-		printf("%s:%d:warning: multi-line strings not supported\n", zconf_curname(), zconf_lineno());
-		current_file->lineno++;
-		BEGIN(INITIAL);
-		return T_EOL;
-	}
-	YY_BREAK
-case YY_STATE_EOF(STRING):
-{
-		BEGIN(INITIAL);
-	}
-	YY_BREAK
-
-case 29:
-YY_RULE_SETUP
-{
-		ts = 0;
-		for (i = 0; i < zconfleng; i++) {
-			if (zconftext[i] == '\t')
-				ts = (ts & ~7) + 8;
-			else
-				ts++;
-		}
-		last_ts = ts;
-		if (first_ts) {
-			if (ts < first_ts) {
-				zconf_endhelp();
-				return T_HELPTEXT;
-			}
-			ts -= first_ts;
-			while (ts > 8) {
-				append_string("        ", 8);
-				ts -= 8;
-			}
-			append_string("        ", ts);
-		}
-	}
-	YY_BREAK
-case 30:
-/* rule 30 can match eol */
-*yy_cp = (yy_hold_char); /* undo effects of setting up zconftext */
-(yy_c_buf_p) = yy_cp -= 1;
-YY_DO_BEFORE_ACTION; /* set up zconftext again */
-YY_RULE_SETUP
-{
-		current_file->lineno++;
-		zconf_endhelp();
-		return T_HELPTEXT;
-	}
-	YY_BREAK
-case 31:
-/* rule 31 can match eol */
-YY_RULE_SETUP
-{
-		current_file->lineno++;
-		append_string("\n", 1);
-	}
-	YY_BREAK
-case 32:
-YY_RULE_SETUP
-{
-		append_string(zconftext, zconfleng);
-		if (!first_ts)
-			first_ts = last_ts;
-	}
-	YY_BREAK
-case YY_STATE_EOF(HELP):
-{
-		zconf_endhelp();
-		return T_HELPTEXT;
-	}
-	YY_BREAK
-
-case YY_STATE_EOF(INITIAL):
-case YY_STATE_EOF(COMMAND):
-{
-	if (current_file) {
-		zconf_endfile();
-		return T_EOL;
-	}
-	fclose(zconfin);
-	yyterminate();
-}
-	YY_BREAK
-case 33:
-YY_RULE_SETUP
-YY_FATAL_ERROR( "flex scanner jammed" );
-	YY_BREAK
-
-	case YY_END_OF_BUFFER:
-		{
-		/* Amount of text matched not including the EOB char. */
-		int yy_amount_of_matched_text = (int) (yy_cp - (yytext_ptr)) - 1;
-
-		/* Undo the effects of YY_DO_BEFORE_ACTION. */
-		*yy_cp = (yy_hold_char);
-		YY_RESTORE_YY_MORE_OFFSET
-
-		if ( YY_CURRENT_BUFFER_LVALUE->yy_buffer_status == YY_BUFFER_NEW )
-			{
-			/* We're scanning a new file or input source.  It's
-			 * possible that this happened because the user
-			 * just pointed zconfin at a new source and called
-			 * zconflex().  If so, then we have to assure
-			 * consistency between YY_CURRENT_BUFFER and our
-			 * globals.  Here is the right place to do so, because
-			 * this is the first action (other than possibly a
-			 * back-up) that will match for the new input source.
-			 */
-			(yy_n_chars) = YY_CURRENT_BUFFER_LVALUE->yy_n_chars;
-			YY_CURRENT_BUFFER_LVALUE->yy_input_file = zconfin;
-			YY_CURRENT_BUFFER_LVALUE->yy_buffer_status = YY_BUFFER_NORMAL;
-			}
-
-		/* Note that here we test for yy_c_buf_p "<=" to the position
-		 * of the first EOB in the buffer, since yy_c_buf_p will
-		 * already have been incremented past the NUL character
-		 * (since all states make transitions on EOB to the
-		 * end-of-buffer state).  Contrast this with the test
-		 * in input().
-		 */
-		if ( (yy_c_buf_p) <= &YY_CURRENT_BUFFER_LVALUE->yy_ch_buf[(yy_n_chars)] )
-			{ /* This was really a NUL. */
-			yy_state_type yy_next_state;
-
-			(yy_c_buf_p) = (yytext_ptr) + yy_amount_of_matched_text;
-
-			yy_current_state = yy_get_previous_state(  );
-
-			/* Okay, we're now positioned to make the NUL
-			 * transition.  We couldn't have
-			 * yy_get_previous_state() go ahead and do it
-			 * for us because it doesn't know how to deal
-			 * with the possibility of jamming (and we don't
-			 * want to build jamming into it because then it
-			 * will run more slowly).
-			 */
-
-			yy_next_state = yy_try_NUL_trans( yy_current_state );
-
-			yy_bp = (yytext_ptr) + YY_MORE_ADJ;
-
-			if ( yy_next_state )
-				{
-				/* Consume the NUL. */
-				yy_cp = ++(yy_c_buf_p);
-				yy_current_state = yy_next_state;
-				goto yy_match;
-				}
-
-			else
-				{
-				yy_cp = (yy_c_buf_p);
-				goto yy_find_action;
-				}
-			}
-
-		else switch ( yy_get_next_buffer(  ) )
-			{
-			case EOB_ACT_END_OF_FILE:
-				{
-				(yy_did_buffer_switch_on_eof) = 0;
-
-				if ( zconfwrap( ) )
-					{
-					/* Note: because we've taken care in
-					 * yy_get_next_buffer() to have set up
-					 * zconftext, we can now set up
-					 * yy_c_buf_p so that if some total
-					 * hoser (like flex itself) wants to
-					 * call the scanner after we return the
-					 * YY_NULL, it'll still work - another
-					 * YY_NULL will get returned.
-					 */
-					(yy_c_buf_p) = (yytext_ptr) + YY_MORE_ADJ;
-
-					yy_act = YY_STATE_EOF(YY_START);
-					goto do_action;
-					}
-
-				else
-					{
-					if ( ! (yy_did_buffer_switch_on_eof) )
-						YY_NEW_FILE;
-					}
-				break;
-				}
-
-			case EOB_ACT_CONTINUE_SCAN:
-				(yy_c_buf_p) =
-					(yytext_ptr) + yy_amount_of_matched_text;
-
-				yy_current_state = yy_get_previous_state(  );
-
-				yy_cp = (yy_c_buf_p);
-				yy_bp = (yytext_ptr) + YY_MORE_ADJ;
-				goto yy_match;
-
-			case EOB_ACT_LAST_MATCH:
-				(yy_c_buf_p) =
-				&YY_CURRENT_BUFFER_LVALUE->yy_ch_buf[(yy_n_chars)];
-
-				yy_current_state = yy_get_previous_state(  );
-
-				yy_cp = (yy_c_buf_p);
-				yy_bp = (yytext_ptr) + YY_MORE_ADJ;
-				goto yy_find_action;
-			}
-		break;
-		}
-
-	default:
-		YY_FATAL_ERROR(
-			"fatal flex scanner internal error--no action found" );
-	} /* end of action switch */
-		} /* end of scanning one token */
-} /* end of zconflex */
-
-/* yy_get_next_buffer - try to read in a new buffer
- *
- * Returns a code representing an action:
- *	EOB_ACT_LAST_MATCH -
- *	EOB_ACT_CONTINUE_SCAN - continue scanning from current position
- *	EOB_ACT_END_OF_FILE - end of file
- */
-static int yy_get_next_buffer (void)
-{
-    	register char *dest = YY_CURRENT_BUFFER_LVALUE->yy_ch_buf;
-	register char *source = (yytext_ptr);
-	register int number_to_move, i;
-	int ret_val;
-
-	if ( (yy_c_buf_p) > &YY_CURRENT_BUFFER_LVALUE->yy_ch_buf[(yy_n_chars) + 1] )
-		YY_FATAL_ERROR(
-		"fatal flex scanner internal error--end of buffer missed" );
-
-	if ( YY_CURRENT_BUFFER_LVALUE->yy_fill_buffer == 0 )
-		{ /* Don't try to fill the buffer, so this is an EOF. */
-		if ( (yy_c_buf_p) - (yytext_ptr) - YY_MORE_ADJ == 1 )
-			{
-			/* We matched a single character, the EOB, so
-			 * treat this as a final EOF.
-			 */
-			return EOB_ACT_END_OF_FILE;
-			}
-
-		else
-			{
-			/* We matched some text prior to the EOB, first
-			 * process it.
-			 */
-			return EOB_ACT_LAST_MATCH;
-			}
-		}
-
-	/* Try to read more data. */
-
-	/* First move last chars to start of buffer. */
-	number_to_move = (int) ((yy_c_buf_p) - (yytext_ptr)) - 1;
-
-	for ( i = 0; i < number_to_move; ++i )
-		*(dest++) = *(source++);
-
-	if ( YY_CURRENT_BUFFER_LVALUE->yy_buffer_status == YY_BUFFER_EOF_PENDING )
-		/* don't do the read, it's not guaranteed to return an EOF,
-		 * just force an EOF
-		 */
-		YY_CURRENT_BUFFER_LVALUE->yy_n_chars = (yy_n_chars) = 0;
-
-	else
-		{
-			size_t num_to_read =
-			YY_CURRENT_BUFFER_LVALUE->yy_buf_size - number_to_move - 1;
-
-		while ( num_to_read <= 0 )
-			{ /* Not enough room in the buffer - grow it. */
-
-			/* just a shorter name for the current buffer */
-			YY_BUFFER_STATE b = YY_CURRENT_BUFFER;
-
-			int yy_c_buf_p_offset =
-				(int) ((yy_c_buf_p) - b->yy_ch_buf);
-
-			if ( b->yy_is_our_buffer )
-				{
-				int new_size = b->yy_buf_size * 2;
-
-				if ( new_size <= 0 )
-					b->yy_buf_size += b->yy_buf_size / 8;
-				else
-					b->yy_buf_size *= 2;
-
-				b->yy_ch_buf = (char *)
-					/* Include room in for 2 EOB chars. */
-					zconfrealloc((void *) b->yy_ch_buf,b->yy_buf_size + 2  );
-				}
-			else
-				/* Can't grow it, we don't own it. */
-				b->yy_ch_buf = 0;
-
-			if ( ! b->yy_ch_buf )
-				YY_FATAL_ERROR(
-				"fatal error - scanner input buffer overflow" );
-
-			(yy_c_buf_p) = &b->yy_ch_buf[yy_c_buf_p_offset];
-
-			num_to_read = YY_CURRENT_BUFFER_LVALUE->yy_buf_size -
-						number_to_move - 1;
-
-			}
-
-		if ( num_to_read > YY_READ_BUF_SIZE )
-			num_to_read = YY_READ_BUF_SIZE;
-
-		/* Read in more data. */
-		YY_INPUT( (&YY_CURRENT_BUFFER_LVALUE->yy_ch_buf[number_to_move]),
-			(yy_n_chars), num_to_read );
-
-		YY_CURRENT_BUFFER_LVALUE->yy_n_chars = (yy_n_chars);
-		}
-
-	if ( (yy_n_chars) == 0 )
-		{
-		if ( number_to_move == YY_MORE_ADJ )
-			{
-			ret_val = EOB_ACT_END_OF_FILE;
-			zconfrestart(zconfin  );
-			}
-
-		else
-			{
-			ret_val = EOB_ACT_LAST_MATCH;
-			YY_CURRENT_BUFFER_LVALUE->yy_buffer_status =
-				YY_BUFFER_EOF_PENDING;
-			}
-		}
-
-	else
-		ret_val = EOB_ACT_CONTINUE_SCAN;
-
-	(yy_n_chars) += number_to_move;
-	YY_CURRENT_BUFFER_LVALUE->yy_ch_buf[(yy_n_chars)] = YY_END_OF_BUFFER_CHAR;
-	YY_CURRENT_BUFFER_LVALUE->yy_ch_buf[(yy_n_chars) + 1] = YY_END_OF_BUFFER_CHAR;
-
-	(yytext_ptr) = &YY_CURRENT_BUFFER_LVALUE->yy_ch_buf[0];
-
-	return ret_val;
-}
-
-/* yy_get_previous_state - get the state just before the EOB char was reached */
-
-    static yy_state_type yy_get_previous_state (void)
-{
-	register yy_state_type yy_current_state;
-	register char *yy_cp;
-
-	yy_current_state = (yy_start);
-
-	for ( yy_cp = (yytext_ptr) + YY_MORE_ADJ; yy_cp < (yy_c_buf_p); ++yy_cp )
-		{
-		yy_current_state = yy_nxt[yy_current_state][(*yy_cp ? yy_ec[YY_SC_TO_UI(*yy_cp)] : 1)];
-		}
-
-	return yy_current_state;
-}
-
-/* yy_try_NUL_trans - try to make a transition on the NUL character
- *
- * synopsis
- *	next_state = yy_try_NUL_trans( current_state );
- */
-    static yy_state_type yy_try_NUL_trans  (yy_state_type yy_current_state )
-{
-	register int yy_is_jam;
-
-	yy_current_state = yy_nxt[yy_current_state][1];
-	yy_is_jam = (yy_current_state <= 0);
-
-	return yy_is_jam ? 0 : yy_current_state;
-}
-
-    static void yyunput (int c, register char * yy_bp )
-{
-	register char *yy_cp;
-
-    yy_cp = (yy_c_buf_p);
-
-	/* undo effects of setting up zconftext */
-	*yy_cp = (yy_hold_char);
-
-	if ( yy_cp < YY_CURRENT_BUFFER_LVALUE->yy_ch_buf + 2 )
-		{ /* need to shift things up to make room */
-		/* +2 for EOB chars. */
-		register int number_to_move = (yy_n_chars) + 2;
-		register char *dest = &YY_CURRENT_BUFFER_LVALUE->yy_ch_buf[
-					YY_CURRENT_BUFFER_LVALUE->yy_buf_size + 2];
-		register char *source =
-				&YY_CURRENT_BUFFER_LVALUE->yy_ch_buf[number_to_move];
-
-		while ( source > YY_CURRENT_BUFFER_LVALUE->yy_ch_buf )
-			*--dest = *--source;
-
-		yy_cp += (int) (dest - source);
-		yy_bp += (int) (dest - source);
-		YY_CURRENT_BUFFER_LVALUE->yy_n_chars =
-			(yy_n_chars) = YY_CURRENT_BUFFER_LVALUE->yy_buf_size;
-
-		if ( yy_cp < YY_CURRENT_BUFFER_LVALUE->yy_ch_buf + 2 )
-			YY_FATAL_ERROR( "flex scanner push-back overflow" );
-		}
-
-	*--yy_cp = (char) c;
-
-	(yytext_ptr) = yy_bp;
-	(yy_hold_char) = *yy_cp;
-	(yy_c_buf_p) = yy_cp;
-}
-
-#ifndef YY_NO_INPUT
-#ifdef __cplusplus
-    static int yyinput (void)
-#else
-    static int input  (void)
-#endif
-
-{
-	int c;
-
-	*(yy_c_buf_p) = (yy_hold_char);
-
-	if ( *(yy_c_buf_p) == YY_END_OF_BUFFER_CHAR )
-		{
-		/* yy_c_buf_p now points to the character we want to return.
-		 * If this occurs *before* the EOB characters, then it's a
-		 * valid NUL; if not, then we've hit the end of the buffer.
-		 */
-		if ( (yy_c_buf_p) < &YY_CURRENT_BUFFER_LVALUE->yy_ch_buf[(yy_n_chars)] )
-			/* This was really a NUL. */
-			*(yy_c_buf_p) = '\0';
-
-		else
-			{ /* need more input */
-			int offset = (yy_c_buf_p) - (yytext_ptr);
-			++(yy_c_buf_p);
-
-			switch ( yy_get_next_buffer(  ) )
-				{
-				case EOB_ACT_LAST_MATCH:
-					/* This happens because yy_g_n_b()
-					 * sees that we've accumulated a
-					 * token and flags that we need to
-					 * try matching the token before
-					 * proceeding.  But for input(),
-					 * there's no matching to consider.
-					 * So convert the EOB_ACT_LAST_MATCH
-					 * to EOB_ACT_END_OF_FILE.
-					 */
-
-					/* Reset buffer status. */
-					zconfrestart(zconfin );
-
-					/*FALLTHROUGH*/
-
-				case EOB_ACT_END_OF_FILE:
-					{
-					if ( zconfwrap( ) )
-						return EOF;
-
-					if ( ! (yy_did_buffer_switch_on_eof) )
-						YY_NEW_FILE;
-#ifdef __cplusplus
-					return yyinput();
-#else
-					return input();
-#endif
-					}
-
-				case EOB_ACT_CONTINUE_SCAN:
-					(yy_c_buf_p) = (yytext_ptr) + offset;
-					break;
-				}
-			}
-		}
-
-	c = *(unsigned char *) (yy_c_buf_p);	/* cast for 8-bit char's */
-	*(yy_c_buf_p) = '\0';	/* preserve zconftext */
-	(yy_hold_char) = *++(yy_c_buf_p);
-
-	return c;
-}
-#endif	/* ifndef YY_NO_INPUT */
-
-/** Immediately switch to a different input stream.
- * @param input_file A readable stream.
- *
- * @note This function does not reset the start condition to @c INITIAL .
- */
-    void zconfrestart  (FILE * input_file )
-{
-
-	if ( ! YY_CURRENT_BUFFER ){
-        zconfensure_buffer_stack ();
-		YY_CURRENT_BUFFER_LVALUE =
-            zconf_create_buffer(zconfin,YY_BUF_SIZE );
-	}
-
-	zconf_init_buffer(YY_CURRENT_BUFFER,input_file );
-	zconf_load_buffer_state( );
-}
-
-/** Switch to a different input buffer.
- * @param new_buffer The new input buffer.
- *
- */
-    void zconf_switch_to_buffer  (YY_BUFFER_STATE  new_buffer )
-{
-
-	/* TODO. We should be able to replace this entire function body
-	 * with
-	 *		zconfpop_buffer_state();
-	 *		zconfpush_buffer_state(new_buffer);
-     */
-	zconfensure_buffer_stack ();
-	if ( YY_CURRENT_BUFFER == new_buffer )
-		return;
-
-	if ( YY_CURRENT_BUFFER )
-		{
-		/* Flush out information for old buffer. */
-		*(yy_c_buf_p) = (yy_hold_char);
-		YY_CURRENT_BUFFER_LVALUE->yy_buf_pos = (yy_c_buf_p);
-		YY_CURRENT_BUFFER_LVALUE->yy_n_chars = (yy_n_chars);
-		}
-
-	YY_CURRENT_BUFFER_LVALUE = new_buffer;
-	zconf_load_buffer_state( );
-
-	/* We don't actually know whether we did this switch during
-	 * EOF (zconfwrap()) processing, but the only time this flag
-	 * is looked at is after zconfwrap() is called, so it's safe
-	 * to go ahead and always set it.
-	 */
-	(yy_did_buffer_switch_on_eof) = 1;
-}
-
-static void zconf_load_buffer_state  (void)
-{
-    	(yy_n_chars) = YY_CURRENT_BUFFER_LVALUE->yy_n_chars;
-	(yytext_ptr) = (yy_c_buf_p) = YY_CURRENT_BUFFER_LVALUE->yy_buf_pos;
-	zconfin = YY_CURRENT_BUFFER_LVALUE->yy_input_file;
-	(yy_hold_char) = *(yy_c_buf_p);
-}
-
-/** Allocate and initialize an input buffer state.
- * @param file A readable stream.
- * @param size The character buffer size in bytes. When in doubt, use @c YY_BUF_SIZE.
- *
- * @return the allocated buffer state.
- */
-    YY_BUFFER_STATE zconf_create_buffer  (FILE * file, int  size )
-{
-	YY_BUFFER_STATE b;
-
-	b = (YY_BUFFER_STATE) zconfalloc(sizeof( struct yy_buffer_state )  );
-	if ( ! b )
-		YY_FATAL_ERROR( "out of dynamic memory in zconf_create_buffer()" );
-
-	b->yy_buf_size = size;
-
-	/* yy_ch_buf has to be 2 characters longer than the size given because
-	 * we need to put in 2 end-of-buffer characters.
-	 */
-	b->yy_ch_buf = (char *) zconfalloc(b->yy_buf_size + 2  );
-	if ( ! b->yy_ch_buf )
-		YY_FATAL_ERROR( "out of dynamic memory in zconf_create_buffer()" );
-
-	b->yy_is_our_buffer = 1;
-
-	zconf_init_buffer(b,file );
-
-	return b;
-}
-
-/** Destroy the buffer.
- * @param b a buffer created with zconf_create_buffer()
- *
- */
-    void zconf_delete_buffer (YY_BUFFER_STATE  b )
-{
-
-	if ( ! b )
-		return;
-
-	if ( b == YY_CURRENT_BUFFER ) /* Not sure if we should pop here. */
-		YY_CURRENT_BUFFER_LVALUE = (YY_BUFFER_STATE) 0;
-
-	if ( b->yy_is_our_buffer )
-		zconffree((void *) b->yy_ch_buf  );
-
-	zconffree((void *) b  );
-}
-
-/* Initializes or reinitializes a buffer.
- * This function is sometimes called more than once on the same buffer,
- * such as during a zconfrestart() or at EOF.
- */
-    static void zconf_init_buffer  (YY_BUFFER_STATE  b, FILE * file )
-
-{
-	int oerrno = errno;
-
-	zconf_flush_buffer(b );
-
-	b->yy_input_file = file;
-	b->yy_fill_buffer = 1;
-
-    /* If b is the current buffer, then zconf_init_buffer was _probably_
-     * called from zconfrestart() or through yy_get_next_buffer.
-     * In that case, we don't want to reset the lineno or column.
-     */
-    if (b != YY_CURRENT_BUFFER){
-        b->yy_bs_lineno = 1;
-        b->yy_bs_column = 0;
-    }
-
-        b->yy_is_interactive = 0;
-
-	errno = oerrno;
-}
-
-/** Discard all buffered characters. On the next scan, YY_INPUT will be called.
- * @param b the buffer state to be flushed, usually @c YY_CURRENT_BUFFER.
- *
- */
-    void zconf_flush_buffer (YY_BUFFER_STATE  b )
-{
-    	if ( ! b )
-		return;
-
-	b->yy_n_chars = 0;
-
-	/* We always need two end-of-buffer characters.  The first causes
-	 * a transition to the end-of-buffer state.  The second causes
-	 * a jam in that state.
-	 */
-	b->yy_ch_buf[0] = YY_END_OF_BUFFER_CHAR;
-	b->yy_ch_buf[1] = YY_END_OF_BUFFER_CHAR;
-
-	b->yy_buf_pos = &b->yy_ch_buf[0];
-
-	b->yy_at_bol = 1;
-	b->yy_buffer_status = YY_BUFFER_NEW;
-
-	if ( b == YY_CURRENT_BUFFER )
-		zconf_load_buffer_state( );
-}
-
-/** Pushes the new state onto the stack. The new state becomes
- *  the current state. This function will allocate the stack
- *  if necessary.
- *  @param new_buffer The new state.
- *
- */
-void zconfpush_buffer_state (YY_BUFFER_STATE new_buffer )
-{
-    	if (new_buffer == NULL)
-		return;
-
-	zconfensure_buffer_stack();
-
-	/* This block is copied from zconf_switch_to_buffer. */
-	if ( YY_CURRENT_BUFFER )
-		{
-		/* Flush out information for old buffer. */
-		*(yy_c_buf_p) = (yy_hold_char);
-		YY_CURRENT_BUFFER_LVALUE->yy_buf_pos = (yy_c_buf_p);
-		YY_CURRENT_BUFFER_LVALUE->yy_n_chars = (yy_n_chars);
-		}
-
-	/* Only push if top exists. Otherwise, replace top. */
-	if (YY_CURRENT_BUFFER)
-		(yy_buffer_stack_top)++;
-	YY_CURRENT_BUFFER_LVALUE = new_buffer;
-
-	/* copied from zconf_switch_to_buffer. */
-	zconf_load_buffer_state( );
-	(yy_did_buffer_switch_on_eof) = 1;
-}
-
-/** Removes and deletes the top of the stack, if present.
- *  The next element becomes the new top.
- *
- */
-void zconfpop_buffer_state (void)
-{
-    	if (!YY_CURRENT_BUFFER)
-		return;
-
-	zconf_delete_buffer(YY_CURRENT_BUFFER );
-	YY_CURRENT_BUFFER_LVALUE = NULL;
-	if ((yy_buffer_stack_top) > 0)
-		--(yy_buffer_stack_top);
-
-	if (YY_CURRENT_BUFFER) {
-		zconf_load_buffer_state( );
-		(yy_did_buffer_switch_on_eof) = 1;
-	}
-}
-
-/* Allocates the stack if it does not exist.
- *  Guarantees space for at least one push.
- */
-static void zconfensure_buffer_stack (void)
-{
-	int num_to_alloc;
-
-	if (!(yy_buffer_stack)) {
-
-		/* First allocation is just for 2 elements, since we don't know if this
-		 * scanner will even need a stack. We use 2 instead of 1 to avoid an
-		 * immediate realloc on the next call.
-         */
-		num_to_alloc = 1;
-		(yy_buffer_stack) = (struct yy_buffer_state**)zconfalloc
-								(num_to_alloc * sizeof(struct yy_buffer_state*)
-								);
-
-		memset((yy_buffer_stack), 0, num_to_alloc * sizeof(struct yy_buffer_state*));
-
-		(yy_buffer_stack_max) = num_to_alloc;
-		(yy_buffer_stack_top) = 0;
-		return;
-	}
-
-	if ((yy_buffer_stack_top) >= ((yy_buffer_stack_max)) - 1){
-
-		/* Increase the buffer to prepare for a possible push. */
-		int grow_size = 8 /* arbitrary grow size */;
-
-		num_to_alloc = (yy_buffer_stack_max) + grow_size;
-		(yy_buffer_stack) = (struct yy_buffer_state**)zconfrealloc
-								((yy_buffer_stack),
-								num_to_alloc * sizeof(struct yy_buffer_state*)
-								);
-
-		/* zero only the new slots.*/
-		memset((yy_buffer_stack) + (yy_buffer_stack_max), 0, grow_size * sizeof(struct yy_buffer_state*));
-		(yy_buffer_stack_max) = num_to_alloc;
-	}
-}
-
-/** Setup the input buffer state to scan directly from a user-specified character buffer.
- * @param base the character buffer
- * @param size the size in bytes of the character buffer
- *
- * @return the newly allocated buffer state object.
- */
-YY_BUFFER_STATE zconf_scan_buffer  (char * base, yy_size_t  size )
-{
-	YY_BUFFER_STATE b;
-
-	if ( size < 2 ||
-	     base[size-2] != YY_END_OF_BUFFER_CHAR ||
-	     base[size-1] != YY_END_OF_BUFFER_CHAR )
-		/* They forgot to leave room for the EOB's. */
-		return 0;
-
-	b = (YY_BUFFER_STATE) zconfalloc(sizeof( struct yy_buffer_state )  );
-	if ( ! b )
-		YY_FATAL_ERROR( "out of dynamic memory in zconf_scan_buffer()" );
-
-	b->yy_buf_size = size - 2;	/* "- 2" to take care of EOB's */
-	b->yy_buf_pos = b->yy_ch_buf = base;
-	b->yy_is_our_buffer = 0;
-	b->yy_input_file = 0;
-	b->yy_n_chars = b->yy_buf_size;
-	b->yy_is_interactive = 0;
-	b->yy_at_bol = 1;
-	b->yy_fill_buffer = 0;
-	b->yy_buffer_status = YY_BUFFER_NEW;
-
-	zconf_switch_to_buffer(b  );
-
-	return b;
-}
-
-/** Setup the input buffer state to scan a string. The next call to zconflex() will
- * scan from a @e copy of @a str.
- * @param yy_str a NUL-terminated string to scan
- *
- * @return the newly allocated buffer state object.
- * @note If you want to scan bytes that may contain NUL values, then use
- *       zconf_scan_bytes() instead.
- */
-YY_BUFFER_STATE zconf_scan_string (yyconst char * yy_str )
-{
-
-	return zconf_scan_bytes(yy_str,strlen(yy_str) );
-}
-
-/** Setup the input buffer state to scan the given bytes. The next call to zconflex() will
- * scan from a @e copy of @a bytes.
- * @param bytes the byte buffer to scan
- * @param len the number of bytes in the buffer pointed to by @a bytes.
- *
- * @return the newly allocated buffer state object.
- */
-YY_BUFFER_STATE zconf_scan_bytes  (yyconst char * bytes, int  len )
-{
-	YY_BUFFER_STATE b;
-	char *buf;
-	yy_size_t n;
-	int i;
-
-	/* Get memory for full buffer, including space for trailing EOB's. */
-	n = len + 2;
-	buf = (char *) zconfalloc(n  );
-	if ( ! buf )
-		YY_FATAL_ERROR( "out of dynamic memory in zconf_scan_bytes()" );
-
-	for ( i = 0; i < len; ++i )
-		buf[i] = bytes[i];
-
-	buf[len] = buf[len+1] = YY_END_OF_BUFFER_CHAR;
-
-	b = zconf_scan_buffer(buf,n );
-	if ( ! b )
-		YY_FATAL_ERROR( "bad buffer in zconf_scan_bytes()" );
-
-	/* It's okay to grow etc. this buffer, and we should throw it
-	 * away when we're done.
-	 */
-	b->yy_is_our_buffer = 1;
-
-	return b;
-}
-
-#ifndef YY_EXIT_FAILURE
-#define YY_EXIT_FAILURE 2
-#endif
-
-static void yy_fatal_error (yyconst char* msg )
-{
-    	(void) fprintf( stderr, "%s\n", msg );
-	exit( YY_EXIT_FAILURE );
-}
-
-/* Redefine yyless() so it works in section 3 code. */
-
-#undef yyless
-#define yyless(n) \
-	do \
-		{ \
-		/* Undo effects of setting up zconftext. */ \
-        int yyless_macro_arg = (n); \
-        YY_LESS_LINENO(yyless_macro_arg);\
-		zconftext[zconfleng] = (yy_hold_char); \
-		(yy_c_buf_p) = zconftext + yyless_macro_arg; \
-		(yy_hold_char) = *(yy_c_buf_p); \
-		*(yy_c_buf_p) = '\0'; \
-		zconfleng = yyless_macro_arg; \
-		} \
-	while ( 0 )
-
-/* Accessor  methods (get/set functions) to struct members. */
-
-/** Get the current line number.
- *
- */
-int zconfget_lineno  (void)
-{
-
-    return zconflineno;
-}
-
-/** Get the input stream.
- *
- */
-FILE *zconfget_in  (void)
-{
-        return zconfin;
-}
-
-/** Get the output stream.
- *
- */
-FILE *zconfget_out  (void)
-{
-        return zconfout;
-}
-
-/** Get the length of the current token.
- *
- */
-int zconfget_leng  (void)
-{
-        return zconfleng;
-}
-
-/** Get the current token.
- *
- */
-
-char *zconfget_text  (void)
-{
-        return zconftext;
-}
-
-/** Set the current line number.
- * @param line_number
- *
- */
-void zconfset_lineno (int  line_number )
-{
-
-    zconflineno = line_number;
-}
-
-/** Set the input stream. This does not discard the current
- * input buffer.
- * @param in_str A readable stream.
- *
- * @see zconf_switch_to_buffer
- */
-void zconfset_in (FILE *  in_str )
-{
-        zconfin = in_str ;
-}
-
-void zconfset_out (FILE *  out_str )
-{
-        zconfout = out_str ;
-}
-
-int zconfget_debug  (void)
-{
-        return zconf_flex_debug;
-}
-
-void zconfset_debug (int  bdebug )
-{
-        zconf_flex_debug = bdebug ;
-}
-
-/* zconflex_destroy is for both reentrant and non-reentrant scanners. */
-int zconflex_destroy  (void)
-{
-
-    /* Pop the buffer stack, destroying each element. */
-	while(YY_CURRENT_BUFFER){
-		zconf_delete_buffer(YY_CURRENT_BUFFER  );
-		YY_CURRENT_BUFFER_LVALUE = NULL;
-		zconfpop_buffer_state();
-	}
-
-	/* Destroy the stack itself. */
-	zconffree((yy_buffer_stack) );
-	(yy_buffer_stack) = NULL;
-
-    return 0;
-}
-
-/*
- * Internal utility routines.
- */
-
-#ifndef yytext_ptr
-static void yy_flex_strncpy (char* s1, yyconst char * s2, int n )
-{
-	register int i;
-    	for ( i = 0; i < n; ++i )
-		s1[i] = s2[i];
-}
-#endif
-
-#ifdef YY_NEED_STRLEN
-static int yy_flex_strlen (yyconst char * s )
-{
-	register int n;
-    	for ( n = 0; s[n]; ++n )
-		;
-
-	return n;
-}
-#endif
-
-void *zconfalloc (yy_size_t  size )
-{
-	return (void *) malloc( size );
-}
-
-void *zconfrealloc  (void * ptr, yy_size_t  size )
-{
-	/* The cast to (char *) in the following accommodates both
-	 * implementations that use char* generic pointers, and those
-	 * that use void* generic pointers.  It works with the latter
-	 * because both ANSI C and C++ allow castless assignment from
-	 * any pointer type to void*, and deal with argument conversions
-	 * as though doing an assignment.
-	 */
-	return (void *) realloc( (char *) ptr, size );
-}
-
-void zconffree (void * ptr )
-{
-	free( (char *) ptr );	/* see zconfrealloc() for (char *) cast */
-}
-
-#define YYTABLES_NAME "yytables"
-
-#undef YY_NEW_FILE
-#undef YY_FLUSH_BUFFER
-#undef yy_set_bol
-#undef yy_new_buffer
-#undef yy_set_interactive
-#undef yytext_ptr
-#undef YY_DO_BEFORE_ACTION
-
-#ifdef YY_DECL_IS_OURS
-#undef YY_DECL_IS_OURS
-#undef YY_DECL
-#endif
-
-void zconf_starthelp(void)
-{
-	new_string();
-	last_ts = first_ts = 0;
-	BEGIN(HELP);
-}
-
-static void zconf_endhelp(void)
-{
-	zconflval.string = text;
-	BEGIN(INITIAL);
-}
-
-/*
- * Try to open specified file with following names:
- * ./name
- * $(srctree)/name
- * The latter is used when srctree is separate from objtree
- * when compiling the kernel.
- * Return NULL if file is not found.
- */
-FILE *zconf_fopen(const char *name)
-{
-	char *env;
-	FILE *f;
-
-	f = fopen(name, "r");
-	if (!f && name[0] != '/') {
-		env = getenv(SRCTREE);
-		if (env) {
-			char *fullname = alloca(strlen(env) + strlen(name) + 2);
-			sprintf(fullname, "%s/%s", env, name);
-			f = fopen(fullname, "r");
-		}
-	}
-	return f;
-}
-
-void zconf_initscan(const char *name)
-{
-	zconfin = zconf_fopen(name);
-	if (!zconfin) {
-		printf("can't find file %s\n", name);
-		exit(1);
-	}
-
-	current_buf = malloc(sizeof(*current_buf));
-	memset(current_buf, 0, sizeof(*current_buf));
-
-	current_file = file_lookup(name);
-	current_file->lineno = 1;
-	current_file->flags = FILE_BUSY;
-}
-
-void zconf_nextfile(const char *name)
-{
-	struct file *file = file_lookup(name);
-	struct buffer *buf = malloc(sizeof(*buf));
-	memset(buf, 0, sizeof(*buf));
-
-	current_buf->state = YY_CURRENT_BUFFER;
-	zconfin = zconf_fopen(name);
-	if (!zconfin) {
-		printf("%s:%d: can't open file \"%s\"\n", zconf_curname(), zconf_lineno(), name);
-		exit(1);
-	}
-	zconf_switch_to_buffer(zconf_create_buffer(zconfin,YY_BUF_SIZE));
-	buf->parent = current_buf;
-	current_buf = buf;
-
-	if (file->flags & FILE_BUSY) {
-		printf("recursive scan (%s)?\n", name);
-		exit(1);
-	}
-	if (file->flags & FILE_SCANNED) {
-		printf("file %s already scanned?\n", name);
-		exit(1);
-	}
-	file->flags |= FILE_BUSY;
-	file->lineno = 1;
-	file->parent = current_file;
-	current_file = file;
-}
-
-static void zconf_endfile(void)
-{
-	struct buffer *parent;
-
-	current_file->flags |= FILE_SCANNED;
-	current_file->flags &= ~FILE_BUSY;
-	current_file = current_file->parent;
-
-	parent = current_buf->parent;
-	if (parent) {
-		fclose(zconfin);
-		zconf_delete_buffer(YY_CURRENT_BUFFER);
-		zconf_switch_to_buffer(parent->state);
-	}
-	free(current_buf);
-	current_buf = parent;
-}
-
-int zconf_lineno(void)
-{
-	return current_pos.lineno;
-}
-
-char *zconf_curname(void)
-{
-	return current_pos.file ? current_pos.file->name : "<none>";
-}
diff -Nurp busybox.old/scripts/kconfig/lxdialog/.gitignore busybox/scripts/kconfig/lxdialog/.gitignore
--- busybox.old/scripts/kconfig/lxdialog/.gitignore	1970-01-01 08:00:00.000000000 +0800
+++ busybox/scripts/kconfig/lxdialog/.gitignore	2015-05-29 07:00:58.212592479 +0800
@@ -0,0 +1,4 @@
+#
+# Generated files
+#
+lxdialog
diff -Nurp busybox.old/scripts/kconfig/mconf.c busybox/scripts/kconfig/mconf.c
--- busybox.old/scripts/kconfig/mconf.c	2015-05-29 06:54:59.000000000 +0800
+++ busybox/scripts/kconfig/mconf.c	2015-05-29 07:00:58.212592479 +0800
@@ -27,10 +27,6 @@
 #include <unistd.h>
 #include <locale.h>
 
-#ifndef SIGWINCH
-#define SIGWINCH 28
-#endif
-
 #define LKC_DIRECT_LINK
 #include "lkc.h"
 
Binary files busybox.old/scripts/kconfig/mconf.o and busybox/scripts/kconfig/mconf.o differ
diff -Nurp busybox.old/scripts/kconfig/.mconf.o.cmd busybox/scripts/kconfig/.mconf.o.cmd
--- busybox.old/scripts/kconfig/.mconf.o.cmd	2015-05-29 06:55:00.000000000 +0800
+++ busybox/scripts/kconfig/.mconf.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,92 +0,0 @@
-cmd_scripts/kconfig/mconf.o := gcc -Wp,-MD,scripts/kconfig/.mconf.o.d  -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer       -c -o scripts/kconfig/mconf.o scripts/kconfig/mconf.c
-
-deps_scripts/kconfig/mconf.o := \
-  scripts/kconfig/mconf.c \
-  /usr/include/stdc-predef.h \
-  /usr/include/sys/ioctl.h \
-  /usr/include/features.h \
-  /usr/include/sys/cdefs.h \
-  /usr/include/bits/wordsize.h \
-  /usr/include/gnu/stubs.h \
-  /usr/include/gnu/stubs-64.h \
-  /usr/include/bits/ioctls.h \
-  /usr/include/asm/ioctls.h \
-  /usr/include/asm-generic/ioctls.h \
-  /usr/include/linux/ioctl.h \
-  /usr/include/asm/ioctl.h \
-  /usr/include/asm-generic/ioctl.h \
-  /usr/include/bits/ioctl-types.h \
-  /usr/include/sys/ttydefaults.h \
-  /usr/include/sys/wait.h \
-  /usr/include/signal.h \
-  /usr/include/bits/sigset.h \
-  /usr/include/bits/types.h \
-  /usr/include/bits/typesizes.h \
-  /usr/include/bits/signum.h \
-  /usr/include/time.h \
-  /usr/include/bits/siginfo.h \
-  /usr/include/bits/sigaction.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stddef.h \
-  /usr/include/bits/sigstack.h \
-  /usr/include/sys/ucontext.h \
-  /usr/include/bits/sigcontext.h \
-  /usr/include/bits/pthreadtypes.h \
-  /usr/include/bits/sigthread.h \
-  /usr/include/bits/waitflags.h \
-  /usr/include/bits/waitstatus.h \
-  /usr/include/ctype.h \
-  /usr/include/endian.h \
-  /usr/include/bits/endian.h \
-  /usr/include/xlocale.h \
-  /usr/include/errno.h \
-  /usr/include/bits/errno.h \
-  /usr/include/linux/errno.h \
-  /usr/include/asm/errno.h \
-  /usr/include/asm-generic/errno.h \
-  /usr/include/asm-generic/errno-base.h \
-  /usr/include/fcntl.h \
-  /usr/include/bits/fcntl.h \
-  /usr/include/bits/fcntl-linux.h \
-  /usr/include/bits/stat.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include-fixed/limits.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include-fixed/syslimits.h \
-  /usr/include/limits.h \
-  /usr/include/bits/posix1_lim.h \
-  /usr/include/bits/local_lim.h \
-  /usr/include/linux/limits.h \
-  /usr/include/bits/posix2_lim.h \
-  /usr/include/bits/xopen_lim.h \
-  /usr/include/bits/stdio_lim.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdarg.h \
-  /usr/include/stdlib.h \
-  /usr/include/sys/types.h \
-  /usr/include/bits/stdlib-bsearch.h \
-  /usr/include/bits/stdlib-float.h \
-  /usr/include/string.h \
-  /usr/include/bits/string.h \
-  /usr/include/bits/string2.h \
-  /usr/include/strings.h \
-  /usr/include/termios.h \
-  /usr/include/bits/termios.h \
-  /usr/include/unistd.h \
-  /usr/include/bits/posix_opt.h \
-  /usr/include/bits/environments.h \
-  /usr/include/bits/confname.h \
-  /usr/include/getopt.h \
-  /usr/include/locale.h \
-  /usr/include/bits/locale.h \
-  scripts/kconfig/lkc.h \
-  scripts/kconfig/expr.h \
-  /usr/include/stdio.h \
-  /usr/include/libio.h \
-  /usr/include/_G_config.h \
-  /usr/include/wchar.h \
-  /usr/include/bits/sys_errlist.h \
-  /usr/include/bits/stdio.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdbool.h \
-  /usr/include/libintl.h \
-  scripts/kconfig/lkc_proto.h \
-
-scripts/kconfig/mconf.o: $(deps_scripts/kconfig/mconf.o)
-
-$(deps_scripts/kconfig/mconf.o):
diff -Nurp busybox.old/scripts/kconfig/zconf.hash.c busybox/scripts/kconfig/zconf.hash.c
--- busybox.old/scripts/kconfig/zconf.hash.c	2015-05-29 06:55:00.000000000 +0800
+++ busybox/scripts/kconfig/zconf.hash.c	1970-01-01 08:00:00.000000000 +0800
@@ -1,230 +0,0 @@
-/* ANSI-C code produced by gperf version 3.0.1 */
-/* Command-line: gperf  */
-/* Computed positions: -k'1,3' */
-
-#if !((' ' == 32) && ('!' == 33) && ('"' == 34) && ('#' == 35) \
-      && ('%' == 37) && ('&' == 38) && ('\'' == 39) && ('(' == 40) \
-      && (')' == 41) && ('*' == 42) && ('+' == 43) && (',' == 44) \
-      && ('-' == 45) && ('.' == 46) && ('/' == 47) && ('0' == 48) \
-      && ('1' == 49) && ('2' == 50) && ('3' == 51) && ('4' == 52) \
-      && ('5' == 53) && ('6' == 54) && ('7' == 55) && ('8' == 56) \
-      && ('9' == 57) && (':' == 58) && (';' == 59) && ('<' == 60) \
-      && ('=' == 61) && ('>' == 62) && ('?' == 63) && ('A' == 65) \
-      && ('B' == 66) && ('C' == 67) && ('D' == 68) && ('E' == 69) \
-      && ('F' == 70) && ('G' == 71) && ('H' == 72) && ('I' == 73) \
-      && ('J' == 74) && ('K' == 75) && ('L' == 76) && ('M' == 77) \
-      && ('N' == 78) && ('O' == 79) && ('P' == 80) && ('Q' == 81) \
-      && ('R' == 82) && ('S' == 83) && ('T' == 84) && ('U' == 85) \
-      && ('V' == 86) && ('W' == 87) && ('X' == 88) && ('Y' == 89) \
-      && ('Z' == 90) && ('[' == 91) && ('\\' == 92) && (']' == 93) \
-      && ('^' == 94) && ('_' == 95) && ('a' == 97) && ('b' == 98) \
-      && ('c' == 99) && ('d' == 100) && ('e' == 101) && ('f' == 102) \
-      && ('g' == 103) && ('h' == 104) && ('i' == 105) && ('j' == 106) \
-      && ('k' == 107) && ('l' == 108) && ('m' == 109) && ('n' == 110) \
-      && ('o' == 111) && ('p' == 112) && ('q' == 113) && ('r' == 114) \
-      && ('s' == 115) && ('t' == 116) && ('u' == 117) && ('v' == 118) \
-      && ('w' == 119) && ('x' == 120) && ('y' == 121) && ('z' == 122) \
-      && ('{' == 123) && ('|' == 124) && ('}' == 125) && ('~' == 126))
-/* The character set is not based on ISO-646.  */
-#error "gperf generated tables don't work with this execution character set. Please report a bug to <bug-gnu-gperf@gnu.org>."
-#endif
-
-struct kconf_id;
-/* maximum key range = 45, duplicates = 0 */
-
-#ifdef __GNUC__
-__inline
-#else
-#ifdef __cplusplus
-inline
-#endif
-#endif
-static unsigned int
-kconf_id_hash (register const char *str, register unsigned int len)
-{
-  static unsigned char asso_values[] =
-    {
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 25, 10, 15,
-       0,  0,  5, 47,  0,  0, 47, 47,  0, 10,
-       0, 20, 20, 20,  5,  0,  0, 20, 47, 47,
-      20, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47, 47, 47, 47, 47,
-      47, 47, 47, 47, 47, 47
-    };
-  register int hval = len;
-
-  switch (hval)
-    {
-      default:
-        hval += asso_values[(unsigned char)str[2]];
-      /*FALLTHROUGH*/
-      case 2:
-      case 1:
-        hval += asso_values[(unsigned char)str[0]];
-        break;
-    }
-  return hval;
-}
-
-struct kconf_id_strings_t
-  {
-    char kconf_id_strings_str2[sizeof("if")];
-    char kconf_id_strings_str3[sizeof("int")];
-    char kconf_id_strings_str4[sizeof("help")];
-    char kconf_id_strings_str5[sizeof("endif")];
-    char kconf_id_strings_str6[sizeof("select")];
-    char kconf_id_strings_str7[sizeof("endmenu")];
-    char kconf_id_strings_str8[sizeof("tristate")];
-    char kconf_id_strings_str9[sizeof("endchoice")];
-    char kconf_id_strings_str10[sizeof("range")];
-    char kconf_id_strings_str11[sizeof("string")];
-    char kconf_id_strings_str12[sizeof("default")];
-    char kconf_id_strings_str13[sizeof("def_bool")];
-    char kconf_id_strings_str14[sizeof("menu")];
-    char kconf_id_strings_str16[sizeof("def_boolean")];
-    char kconf_id_strings_str17[sizeof("def_tristate")];
-    char kconf_id_strings_str18[sizeof("mainmenu")];
-    char kconf_id_strings_str20[sizeof("menuconfig")];
-    char kconf_id_strings_str21[sizeof("config")];
-    char kconf_id_strings_str22[sizeof("on")];
-    char kconf_id_strings_str23[sizeof("hex")];
-    char kconf_id_strings_str26[sizeof("source")];
-    char kconf_id_strings_str27[sizeof("depends")];
-    char kconf_id_strings_str28[sizeof("optional")];
-    char kconf_id_strings_str31[sizeof("enable")];
-    char kconf_id_strings_str32[sizeof("comment")];
-    char kconf_id_strings_str33[sizeof("requires")];
-    char kconf_id_strings_str34[sizeof("bool")];
-    char kconf_id_strings_str37[sizeof("boolean")];
-    char kconf_id_strings_str41[sizeof("choice")];
-    char kconf_id_strings_str46[sizeof("prompt")];
-  };
-static struct kconf_id_strings_t kconf_id_strings_contents =
-  {
-    "if",
-    "int",
-    "help",
-    "endif",
-    "select",
-    "endmenu",
-    "tristate",
-    "endchoice",
-    "range",
-    "string",
-    "default",
-    "def_bool",
-    "menu",
-    "def_boolean",
-    "def_tristate",
-    "mainmenu",
-    "menuconfig",
-    "config",
-    "on",
-    "hex",
-    "source",
-    "depends",
-    "optional",
-    "enable",
-    "comment",
-    "requires",
-    "bool",
-    "boolean",
-    "choice",
-    "prompt"
-  };
-#define kconf_id_strings ((const char *) &kconf_id_strings_contents)
-#ifdef __GNUC__
-__inline
-#endif
-struct kconf_id *
-kconf_id_lookup (register const char *str, register unsigned int len)
-{
-  enum
-    {
-      TOTAL_KEYWORDS = 30,
-      MIN_WORD_LENGTH = 2,
-      MAX_WORD_LENGTH = 12,
-      MIN_HASH_VALUE = 2,
-      MAX_HASH_VALUE = 46
-    };
-
-  static struct kconf_id wordlist[] =
-    {
-      {-1}, {-1},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str2,		T_IF,		TF_COMMAND|TF_PARAM},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str3,		T_TYPE,		TF_COMMAND, S_INT},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str4,		T_HELP,		TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str5,		T_ENDIF,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str6,		T_SELECT,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str7,	T_ENDMENU,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str8,	T_TYPE,		TF_COMMAND, S_TRISTATE},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str9,	T_ENDCHOICE,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str10,		T_RANGE,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str11,		T_TYPE,		TF_COMMAND, S_STRING},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str12,	T_DEFAULT,	TF_COMMAND, S_UNKNOWN},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str13,	T_DEFAULT,	TF_COMMAND, S_BOOLEAN},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str14,		T_MENU,		TF_COMMAND},
-      {-1},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str16,	T_DEFAULT,	TF_COMMAND, S_BOOLEAN},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str17,	T_DEFAULT,	TF_COMMAND, S_TRISTATE},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str18,	T_MAINMENU,	TF_COMMAND},
-      {-1},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str20,	T_MENUCONFIG,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str21,		T_CONFIG,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str22,		T_ON,		TF_PARAM},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str23,		T_TYPE,		TF_COMMAND, S_HEX},
-      {-1}, {-1},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str26,		T_SOURCE,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str27,	T_DEPENDS,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str28,	T_OPTIONAL,	TF_COMMAND},
-      {-1}, {-1},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str31,		T_SELECT,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str32,	T_COMMENT,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str33,	T_REQUIRES,	TF_COMMAND},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str34,		T_TYPE,		TF_COMMAND, S_BOOLEAN},
-      {-1}, {-1},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str37,	T_TYPE,		TF_COMMAND, S_BOOLEAN},
-      {-1}, {-1}, {-1},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str41,		T_CHOICE,	TF_COMMAND},
-      {-1}, {-1}, {-1}, {-1},
-      {(int)(long)&((struct kconf_id_strings_t *)0)->kconf_id_strings_str46,		T_PROMPT,	TF_COMMAND}
-    };
-
-  if (len <= MAX_WORD_LENGTH && len >= MIN_WORD_LENGTH)
-    {
-      register int key = kconf_id_hash (str, len);
-
-      if (key <= MAX_HASH_VALUE && key >= 0)
-        {
-          register int o = wordlist[key].name;
-          if (o >= 0)
-            {
-              register const char *s = o + kconf_id_strings;
-
-              if (*str == *s && !strncmp (str + 1, s + 1, len - 1) && s[len] == '\0')
-                return &wordlist[key];
-            }
-        }
-    }
-  return 0;
-}
diff -Nurp busybox.old/scripts/kconfig/zconf.tab.c busybox/scripts/kconfig/zconf.tab.c
--- busybox.old/scripts/kconfig/zconf.tab.c	2015-05-29 06:55:00.000000000 +0800
+++ busybox/scripts/kconfig/zconf.tab.c	1970-01-01 08:00:00.000000000 +0800
@@ -1,2171 +0,0 @@
-/* A Bison parser, made by GNU Bison 2.0.  */
-
-/* Skeleton parser for Yacc-like parsing with Bison,
-   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002, 2003, 2004 Free Software Foundation, Inc.
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2, or (at your option)
-   any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 59 Temple Place - Suite 330,
-   Boston, MA 02111-1307, USA.  */
-
-/* As a special exception, when this file is copied by Bison into a
-   Bison output file, you may use that output file without restriction.
-   This special exception was added by the Free Software Foundation
-   in version 1.24 of Bison.  */
-
-/* Written by Richard Stallman by simplifying the original so called
-   ``semantic'' parser.  */
-
-/* All symbols defined below should begin with yy or YY, to avoid
-   infringing on user name space.  This should be done even for local
-   variables, as they might otherwise be expanded by user macros.
-   There are some unavoidable exceptions within include files to
-   define necessary library symbols; they are noted "INFRINGES ON
-   USER NAME SPACE" below.  */
-
-/* Identify Bison output.  */
-#define YYBISON 1
-
-/* Skeleton name.  */
-#define YYSKELETON_NAME "yacc.c"
-
-/* Pure parsers.  */
-#define YYPURE 0
-
-/* Using locations.  */
-#define YYLSP_NEEDED 0
-
-/* Substitute the variable and function names.  */
-#define yyparse zconfparse
-#define yylex   zconflex
-#define yyerror zconferror
-#define yylval  zconflval
-#define yychar  zconfchar
-#define yydebug zconfdebug
-#define yynerrs zconfnerrs
-
-
-/* Tokens.  */
-#ifndef YYTOKENTYPE
-# define YYTOKENTYPE
-   /* Put the tokens into the symbol table, so that GDB and other debuggers
-      know about them.  */
-   enum yytokentype {
-     T_MAINMENU = 258,
-     T_MENU = 259,
-     T_ENDMENU = 260,
-     T_SOURCE = 261,
-     T_CHOICE = 262,
-     T_ENDCHOICE = 263,
-     T_COMMENT = 264,
-     T_CONFIG = 265,
-     T_MENUCONFIG = 266,
-     T_HELP = 267,
-     T_HELPTEXT = 268,
-     T_IF = 269,
-     T_ENDIF = 270,
-     T_DEPENDS = 271,
-     T_REQUIRES = 272,
-     T_OPTIONAL = 273,
-     T_PROMPT = 274,
-     T_TYPE = 275,
-     T_DEFAULT = 276,
-     T_SELECT = 277,
-     T_RANGE = 278,
-     T_ON = 279,
-     T_WORD = 280,
-     T_WORD_QUOTE = 281,
-     T_UNEQUAL = 282,
-     T_CLOSE_PAREN = 283,
-     T_OPEN_PAREN = 284,
-     T_EOL = 285,
-     T_OR = 286,
-     T_AND = 287,
-     T_EQUAL = 288,
-     T_NOT = 289
-   };
-#endif
-#define T_MAINMENU 258
-#define T_MENU 259
-#define T_ENDMENU 260
-#define T_SOURCE 261
-#define T_CHOICE 262
-#define T_ENDCHOICE 263
-#define T_COMMENT 264
-#define T_CONFIG 265
-#define T_MENUCONFIG 266
-#define T_HELP 267
-#define T_HELPTEXT 268
-#define T_IF 269
-#define T_ENDIF 270
-#define T_DEPENDS 271
-#define T_REQUIRES 272
-#define T_OPTIONAL 273
-#define T_PROMPT 274
-#define T_TYPE 275
-#define T_DEFAULT 276
-#define T_SELECT 277
-#define T_RANGE 278
-#define T_ON 279
-#define T_WORD 280
-#define T_WORD_QUOTE 281
-#define T_UNEQUAL 282
-#define T_CLOSE_PAREN 283
-#define T_OPEN_PAREN 284
-#define T_EOL 285
-#define T_OR 286
-#define T_AND 287
-#define T_EQUAL 288
-#define T_NOT 289
-
-
-
-
-/* Copy the first part of user declarations.  */
-
-
-/*
- * Copyright (C) 2002 Roman Zippel <zippel@linux-m68k.org>
- * Released under the terms of the GNU GPL v2.0.
- */
-
-#include <ctype.h>
-#include <stdarg.h>
-#include <stdio.h>
-#include <stdlib.h>
-#include <string.h>
-#include <stdbool.h>
-
-#define LKC_DIRECT_LINK
-#include "lkc.h"
-
-#include "zconf.hash.c"
-
-#define printd(mask, fmt...) if (cdebug & (mask)) printf(fmt)
-
-#define PRINTD		0x0001
-#define DEBUG_PARSE	0x0002
-
-int cdebug = PRINTD;
-
-extern int zconflex(void);
-static void zconfprint(const char *err, ...);
-static void zconf_error(const char *err, ...);
-static void zconferror(const char *err);
-static bool zconf_endtoken(struct kconf_id *id, int starttoken, int endtoken);
-
-struct symbol *symbol_hash[257];
-
-static struct menu *current_menu, *current_entry;
-
-#define YYDEBUG 0
-#if YYDEBUG
-#define YYERROR_VERBOSE
-#endif
-
-
-/* Enabling traces.  */
-#ifndef YYDEBUG
-# define YYDEBUG 0
-#endif
-
-/* Enabling verbose error messages.  */
-#ifdef YYERROR_VERBOSE
-# undef YYERROR_VERBOSE
-# define YYERROR_VERBOSE 1
-#else
-# define YYERROR_VERBOSE 0
-#endif
-
-#if ! defined (YYSTYPE) && ! defined (YYSTYPE_IS_DECLARED)
-
-typedef union YYSTYPE {
-	char *string;
-	struct file *file;
-	struct symbol *symbol;
-	struct expr *expr;
-	struct menu *menu;
-	struct kconf_id *id;
-} YYSTYPE;
-/* Line 190 of yacc.c.  */
-
-# define yystype YYSTYPE /* obsolescent; will be withdrawn */
-# define YYSTYPE_IS_DECLARED 1
-# define YYSTYPE_IS_TRIVIAL 1
-#endif
-
-
-
-/* Copy the second part of user declarations.  */
-
-
-/* Line 213 of yacc.c.  */
-
-
-#if ! defined (yyoverflow) || YYERROR_VERBOSE
-
-# ifndef YYFREE
-#  define YYFREE free
-# endif
-# ifndef YYMALLOC
-#  define YYMALLOC malloc
-# endif
-
-/* The parser invokes alloca or malloc; define the necessary symbols.  */
-
-# ifdef YYSTACK_USE_ALLOCA
-#  if YYSTACK_USE_ALLOCA
-#   ifdef __GNUC__
-#    define YYSTACK_ALLOC __builtin_alloca
-#   else
-#    define YYSTACK_ALLOC alloca
-#   endif
-#  endif
-# endif
-
-# ifdef YYSTACK_ALLOC
-   /* Pacify GCC's `empty if-body' warning. */
-#  define YYSTACK_FREE(Ptr) do { /* empty */; } while (0)
-# else
-#  if defined (__STDC__) || defined (__cplusplus)
-#   include <stdlib.h> /* INFRINGES ON USER NAME SPACE */
-#   define YYSIZE_T size_t
-#  endif
-#  define YYSTACK_ALLOC YYMALLOC
-#  define YYSTACK_FREE YYFREE
-# endif
-#endif /* ! defined (yyoverflow) || YYERROR_VERBOSE */
-
-
-#if (! defined (yyoverflow) \
-     && (! defined (__cplusplus) \
-	 || (defined (YYSTYPE_IS_TRIVIAL) && YYSTYPE_IS_TRIVIAL)))
-
-/* A type that is properly aligned for any stack member.  */
-union yyalloc
-{
-  short int yyss;
-  YYSTYPE yyvs;
-  };
-
-/* The size of the maximum gap between one aligned stack and the next.  */
-# define YYSTACK_GAP_MAXIMUM (sizeof (union yyalloc) - 1)
-
-/* The size of an array large to enough to hold all stacks, each with
-   N elements.  */
-# define YYSTACK_BYTES(N) \
-     ((N) * (sizeof (short int) + sizeof (YYSTYPE))			\
-      + YYSTACK_GAP_MAXIMUM)
-
-/* Copy COUNT objects from FROM to TO.  The source and destination do
-   not overlap.  */
-# ifndef YYCOPY
-#  if defined (__GNUC__) && 1 < __GNUC__
-#   define YYCOPY(To, From, Count) \
-      __builtin_memcpy (To, From, (Count) * sizeof (*(From)))
-#  else
-#   define YYCOPY(To, From, Count)		\
-      do					\
-	{					\
-	  register YYSIZE_T yyi;		\
-	  for (yyi = 0; yyi < (Count); yyi++)	\
-	    (To)[yyi] = (From)[yyi];		\
-	}					\
-      while (0)
-#  endif
-# endif
-
-/* Relocate STACK from its old location to the new one.  The
-   local variables YYSIZE and YYSTACKSIZE give the old and new number of
-   elements in the stack, and YYPTR gives the new location of the
-   stack.  Advance YYPTR to a properly aligned location for the next
-   stack.  */
-# define YYSTACK_RELOCATE(Stack)					\
-    do									\
-      {									\
-	YYSIZE_T yynewbytes;						\
-	YYCOPY (&yyptr->Stack, Stack, yysize);				\
-	Stack = &yyptr->Stack;						\
-	yynewbytes = yystacksize * sizeof (*Stack) + YYSTACK_GAP_MAXIMUM; \
-	yyptr += yynewbytes / sizeof (*yyptr);				\
-      }									\
-    while (0)
-
-#endif
-
-#if defined (__STDC__) || defined (__cplusplus)
-   typedef signed char yysigned_char;
-#else
-   typedef short int yysigned_char;
-#endif
-
-/* YYFINAL -- State number of the termination state. */
-#define YYFINAL  3
-/* YYLAST -- Last index in YYTABLE.  */
-#define YYLAST   264
-
-/* YYNTOKENS -- Number of terminals. */
-#define YYNTOKENS  35
-/* YYNNTS -- Number of nonterminals. */
-#define YYNNTS  42
-/* YYNRULES -- Number of rules. */
-#define YYNRULES  104
-/* YYNRULES -- Number of states. */
-#define YYNSTATES  175
-
-/* YYTRANSLATE(YYLEX) -- Bison symbol number corresponding to YYLEX.  */
-#define YYUNDEFTOK  2
-#define YYMAXUTOK   289
-
-#define YYTRANSLATE(YYX) 						\
-  ((unsigned int) (YYX) <= YYMAXUTOK ? yytranslate[YYX] : YYUNDEFTOK)
-
-/* YYTRANSLATE[YYLEX] -- Bison symbol number corresponding to YYLEX.  */
-static const unsigned char yytranslate[] =
-{
-       0,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     1,     2,     3,     4,
-       5,     6,     7,     8,     9,    10,    11,    12,    13,    14,
-      15,    16,    17,    18,    19,    20,    21,    22,    23,    24,
-      25,    26,    27,    28,    29,    30,    31,    32,    33,    34
-};
-
-#if YYDEBUG
-/* YYPRHS[YYN] -- Index of the first RHS symbol of rule number YYN in
-   YYRHS.  */
-static const unsigned short int yyprhs[] =
-{
-       0,     0,     3,     5,     6,     9,    12,    15,    20,    23,
-      28,    33,    37,    39,    41,    43,    45,    47,    49,    51,
-      53,    55,    57,    59,    61,    63,    67,    70,    74,    77,
-      81,    84,    85,    88,    91,    94,    97,   100,   104,   109,
-     114,   119,   125,   128,   131,   133,   137,   138,   141,   144,
-     147,   150,   153,   158,   162,   165,   170,   171,   174,   178,
-     180,   184,   185,   188,   191,   194,   198,   201,   203,   207,
-     208,   211,   214,   217,   221,   225,   228,   231,   234,   235,
-     238,   241,   244,   249,   253,   257,   258,   261,   263,   265,
-     268,   271,   274,   276,   279,   280,   283,   285,   289,   293,
-     297,   300,   304,   308,   310
-};
-
-/* YYRHS -- A `-1'-separated list of the rules' RHS. */
-static const yysigned_char yyrhs[] =
-{
-      36,     0,    -1,    37,    -1,    -1,    37,    39,    -1,    37,
-      50,    -1,    37,    61,    -1,    37,     3,    71,    73,    -1,
-      37,    72,    -1,    37,    25,     1,    30,    -1,    37,    38,
-       1,    30,    -1,    37,     1,    30,    -1,    16,    -1,    19,
-      -1,    20,    -1,    22,    -1,    18,    -1,    23,    -1,    21,
-      -1,    30,    -1,    56,    -1,    65,    -1,    42,    -1,    44,
-      -1,    63,    -1,    25,     1,    30,    -1,     1,    30,    -1,
-      10,    25,    30,    -1,    41,    45,    -1,    11,    25,    30,
-      -1,    43,    45,    -1,    -1,    45,    46,    -1,    45,    69,
-      -1,    45,    67,    -1,    45,    40,    -1,    45,    30,    -1,
-      20,    70,    30,    -1,    19,    71,    74,    30,    -1,    21,
-      75,    74,    30,    -1,    22,    25,    74,    30,    -1,    23,
-      76,    76,    74,    30,    -1,     7,    30,    -1,    47,    51,
-      -1,    72,    -1,    48,    53,    49,    -1,    -1,    51,    52,
-      -1,    51,    69,    -1,    51,    67,    -1,    51,    30,    -1,
-      51,    40,    -1,    19,    71,    74,    30,    -1,    20,    70,
-      30,    -1,    18,    30,    -1,    21,    25,    74,    30,    -1,
-      -1,    53,    39,    -1,    14,    75,    73,    -1,    72,    -1,
-      54,    57,    55,    -1,    -1,    57,    39,    -1,    57,    61,
-      -1,    57,    50,    -1,     4,    71,    30,    -1,    58,    68,
-      -1,    72,    -1,    59,    62,    60,    -1,    -1,    62,    39,
-      -1,    62,    61,    -1,    62,    50,    -1,     6,    71,    30,
-      -1,     9,    71,    30,    -1,    64,    68,    -1,    12,    30,
-      -1,    66,    13,    -1,    -1,    68,    69,    -1,    68,    30,
-      -1,    68,    40,    -1,    16,    24,    75,    30,    -1,    16,
-      75,    30,    -1,    17,    75,    30,    -1,    -1,    71,    74,
-      -1,    25,    -1,    26,    -1,     5,    30,    -1,     8,    30,
-      -1,    15,    30,    -1,    30,    -1,    73,    30,    -1,    -1,
-      14,    75,    -1,    76,    -1,    76,    33,    76,    -1,    76,
-      27,    76,    -1,    29,    75,    28,    -1,    34,    75,    -1,
-      75,    31,    75,    -1,    75,    32,    75,    -1,    25,    -1,
-      26,    -1
-};
-
-/* YYRLINE[YYN] -- source line where rule number YYN was defined.  */
-static const unsigned short int yyrline[] =
-{
-       0,   103,   103,   105,   107,   108,   109,   110,   111,   112,
-     113,   117,   121,   121,   121,   121,   121,   121,   121,   125,
-     126,   127,   128,   129,   130,   134,   135,   141,   149,   155,
-     163,   173,   175,   176,   177,   178,   179,   182,   190,   196,
-     206,   212,   220,   229,   234,   242,   245,   247,   248,   249,
-     250,   251,   254,   260,   271,   277,   287,   289,   294,   302,
-     310,   313,   315,   316,   317,   322,   329,   334,   342,   345,
-     347,   348,   349,   352,   360,   367,   374,   380,   387,   389,
-     390,   391,   394,   399,   404,   412,   414,   419,   420,   423,
-     424,   425,   429,   430,   433,   434,   437,   438,   439,   440,
-     441,   442,   443,   446,   447
-};
-#endif
-
-#if YYDEBUG || YYERROR_VERBOSE
-/* YYTNME[SYMBOL-NUM] -- String name of the symbol SYMBOL-NUM.
-   First, the terminals, then, starting at YYNTOKENS, nonterminals. */
-static const char *const yytname[] =
-{
-  "$end", "error", "$undefined", "T_MAINMENU", "T_MENU", "T_ENDMENU",
-  "T_SOURCE", "T_CHOICE", "T_ENDCHOICE", "T_COMMENT", "T_CONFIG",
-  "T_MENUCONFIG", "T_HELP", "T_HELPTEXT", "T_IF", "T_ENDIF", "T_DEPENDS",
-  "T_REQUIRES", "T_OPTIONAL", "T_PROMPT", "T_TYPE", "T_DEFAULT",
-  "T_SELECT", "T_RANGE", "T_ON", "T_WORD", "T_WORD_QUOTE", "T_UNEQUAL",
-  "T_CLOSE_PAREN", "T_OPEN_PAREN", "T_EOL", "T_OR", "T_AND", "T_EQUAL",
-  "T_NOT", "$accept", "input", "stmt_list", "option_name", "common_stmt",
-  "option_error", "config_entry_start", "config_stmt",
-  "menuconfig_entry_start", "menuconfig_stmt", "config_option_list",
-  "config_option", "choice", "choice_entry", "choice_end", "choice_stmt",
-  "choice_option_list", "choice_option", "choice_block", "if_entry",
-  "if_end", "if_stmt", "if_block", "menu", "menu_entry", "menu_end",
-  "menu_stmt", "menu_block", "source_stmt", "comment", "comment_stmt",
-  "help_start", "help", "depends_list", "depends", "prompt_stmt_opt",
-  "prompt", "end", "nl", "if_expr", "expr", "symbol", 0
-};
-#endif
-
-# ifdef YYPRINT
-/* YYTOKNUM[YYLEX-NUM] -- Internal token number corresponding to
-   token YYLEX-NUM.  */
-static const unsigned short int yytoknum[] =
-{
-       0,   256,   257,   258,   259,   260,   261,   262,   263,   264,
-     265,   266,   267,   268,   269,   270,   271,   272,   273,   274,
-     275,   276,   277,   278,   279,   280,   281,   282,   283,   284,
-     285,   286,   287,   288,   289
-};
-# endif
-
-/* YYR1[YYN] -- Symbol number of symbol that rule YYN derives.  */
-static const unsigned char yyr1[] =
-{
-       0,    35,    36,    37,    37,    37,    37,    37,    37,    37,
-      37,    37,    38,    38,    38,    38,    38,    38,    38,    39,
-      39,    39,    39,    39,    39,    40,    40,    41,    42,    43,
-      44,    45,    45,    45,    45,    45,    45,    46,    46,    46,
-      46,    46,    47,    48,    49,    50,    51,    51,    51,    51,
-      51,    51,    52,    52,    52,    52,    53,    53,    54,    55,
-      56,    57,    57,    57,    57,    58,    59,    60,    61,    62,
-      62,    62,    62,    63,    64,    65,    66,    67,    68,    68,
-      68,    68,    69,    69,    69,    70,    70,    71,    71,    72,
-      72,    72,    73,    73,    74,    74,    75,    75,    75,    75,
-      75,    75,    75,    76,    76
-};
-
-/* YYR2[YYN] -- Number of symbols composing right hand side of rule YYN.  */
-static const unsigned char yyr2[] =
-{
-       0,     2,     1,     0,     2,     2,     2,     4,     2,     4,
-       4,     3,     1,     1,     1,     1,     1,     1,     1,     1,
-       1,     1,     1,     1,     1,     3,     2,     3,     2,     3,
-       2,     0,     2,     2,     2,     2,     2,     3,     4,     4,
-       4,     5,     2,     2,     1,     3,     0,     2,     2,     2,
-       2,     2,     4,     3,     2,     4,     0,     2,     3,     1,
-       3,     0,     2,     2,     2,     3,     2,     1,     3,     0,
-       2,     2,     2,     3,     3,     2,     2,     2,     0,     2,
-       2,     2,     4,     3,     3,     0,     2,     1,     1,     2,
-       2,     2,     1,     2,     0,     2,     1,     3,     3,     3,
-       2,     3,     3,     1,     1
-};
-
-/* YYDEFACT[STATE-NAME] -- Default rule to reduce with in state
-   STATE-NUM when YYTABLE doesn't specify something else to do.  Zero
-   means the default is an error.  */
-static const unsigned char yydefact[] =
-{
-       3,     0,     0,     1,     0,     0,     0,     0,     0,     0,
-       0,     0,     0,     0,     0,     0,    12,    16,    13,    14,
-      18,    15,    17,     0,    19,     0,     4,    31,    22,    31,
-      23,    46,    56,     5,    61,    20,    78,    69,     6,    24,
-      78,    21,     8,    11,    87,    88,     0,     0,    89,     0,
-      42,    90,     0,     0,     0,   103,   104,     0,     0,     0,
-      96,    91,     0,     0,     0,     0,     0,     0,     0,     0,
-       0,     0,    92,     7,    65,    73,    74,    27,    29,     0,
-     100,     0,     0,    58,     0,     0,     9,    10,     0,     0,
-       0,     0,     0,    85,     0,     0,     0,     0,    36,    35,
-      32,     0,    34,    33,     0,     0,    85,     0,    50,    51,
-      47,    49,    48,    57,    45,    44,    62,    64,    60,    63,
-      59,    80,    81,    79,    70,    72,    68,    71,    67,    93,
-      99,   101,   102,    98,    97,    26,    76,     0,     0,     0,
-      94,     0,    94,    94,    94,     0,     0,    77,    54,    94,
-       0,    94,     0,    83,    84,     0,     0,    37,    86,     0,
-       0,    94,    25,     0,    53,     0,    82,    95,    38,    39,
-      40,     0,    52,    55,    41
-};
-
-/* YYDEFGOTO[NTERM-NUM]. */
-static const short int yydefgoto[] =
-{
-      -1,     1,     2,    25,    26,    99,    27,    28,    29,    30,
-      64,   100,    31,    32,   114,    33,    66,   110,    67,    34,
-     118,    35,    68,    36,    37,   126,    38,    70,    39,    40,
-      41,   101,   102,    69,   103,   141,   142,    42,    73,   156,
-      59,    60
-};
-
-/* YYPACT[STATE-NUM] -- Index in YYTABLE of the portion describing
-   STATE-NUM.  */
-#define YYPACT_NINF -78
-static const short int yypact[] =
-{
-     -78,     2,   159,   -78,   -21,     0,     0,   -12,     0,     1,
-       4,     0,    27,    38,    60,    58,   -78,   -78,   -78,   -78,
-     -78,   -78,   -78,   100,   -78,   104,   -78,   -78,   -78,   -78,
-     -78,   -78,   -78,   -78,   -78,   -78,   -78,   -78,   -78,   -78,
-     -78,   -78,   -78,   -78,   -78,   -78,    86,   113,   -78,   114,
-     -78,   -78,   125,   127,   128,   -78,   -78,    60,    60,   210,
-      65,   -78,   141,   142,    39,   103,   182,   200,     6,    66,
-       6,   131,   -78,   146,   -78,   -78,   -78,   -78,   -78,   196,
-     -78,    60,    60,   146,    40,    40,   -78,   -78,   155,   156,
-      -2,    60,     0,     0,    60,   105,    40,   194,   -78,   -78,
-     -78,   206,   -78,   -78,   183,     0,     0,   195,   -78,   -78,
-     -78,   -78,   -78,   -78,   -78,   -78,   -78,   -78,   -78,   -78,
-     -78,   -78,   -78,   -78,   -78,   -78,   -78,   -78,   -78,   -78,
-     -78,   197,   -78,   -78,   -78,   -78,   -78,    60,   213,   216,
-     212,   203,   212,   190,   212,    40,   208,   -78,   -78,   212,
-     222,   212,   219,   -78,   -78,    60,   223,   -78,   -78,   224,
-     225,   212,   -78,   226,   -78,   227,   -78,    47,   -78,   -78,
-     -78,   228,   -78,   -78,   -78
-};
-
-/* YYPGOTO[NTERM-NUM].  */
-static const short int yypgoto[] =
-{
-     -78,   -78,   -78,   -78,   164,   -36,   -78,   -78,   -78,   -78,
-     230,   -78,   -78,   -78,   -78,    29,   -78,   -78,   -78,   -78,
-     -78,   -78,   -78,   -78,   -78,   -78,    59,   -78,   -78,   -78,
-     -78,   -78,   198,   220,    24,   157,    -5,   169,   202,    74,
-     -53,   -77
-};
-
-/* YYTABLE[YYPACT[STATE-NUM]].  What to do in state STATE-NUM.  If
-   positive, shift that token.  If negative, reduce the rule which
-   number is the opposite.  If zero, do what YYDEFACT says.
-   If YYTABLE_NINF, syntax error.  */
-#define YYTABLE_NINF -76
-static const short int yytable[] =
-{
-      46,    47,     3,    49,    79,    80,    52,   133,   134,    43,
-       6,     7,     8,     9,    10,    11,    12,    13,    48,   145,
-      14,    15,   137,    55,    56,    44,    45,    57,   131,   132,
-     109,    50,    58,   122,    51,   122,    24,   138,   139,   -28,
-      88,   143,   -28,   -28,   -28,   -28,   -28,   -28,   -28,   -28,
-     -28,    89,    53,   -28,   -28,    90,    91,   -28,    92,    93,
-      94,    95,    96,    54,    97,    55,    56,    88,   161,    98,
-     -66,   -66,   -66,   -66,   -66,   -66,   -66,   -66,    81,    82,
-     -66,   -66,    90,    91,   152,    55,    56,   140,    61,    57,
-     112,    97,    84,   123,    58,   123,   121,   117,    85,   125,
-     149,    62,   167,   -30,    88,    63,   -30,   -30,   -30,   -30,
-     -30,   -30,   -30,   -30,   -30,    89,    72,   -30,   -30,    90,
-      91,   -30,    92,    93,    94,    95,    96,   119,    97,   127,
-     144,   -75,    88,    98,   -75,   -75,   -75,   -75,   -75,   -75,
-     -75,   -75,   -75,    74,    75,   -75,   -75,    90,    91,   -75,
-     -75,   -75,   -75,   -75,   -75,    76,    97,    77,    78,    -2,
-       4,   121,     5,     6,     7,     8,     9,    10,    11,    12,
-      13,    86,    87,    14,    15,    16,   129,    17,    18,    19,
-      20,    21,    22,    88,    23,   135,   136,   -43,   -43,    24,
-     -43,   -43,   -43,   -43,    89,   146,   -43,   -43,    90,    91,
-     104,   105,   106,   107,   155,     7,     8,    97,    10,    11,
-      12,    13,   108,   148,    14,    15,   158,   159,   160,   147,
-     151,    81,    82,   163,   130,   165,   155,    81,    82,    82,
-      24,   113,   116,   157,   124,   171,   115,   120,   162,   128,
-      72,    81,    82,   153,    81,    82,   154,    81,    82,   166,
-      81,    82,   164,   168,   169,   170,   172,   173,   174,    65,
-      71,    83,     0,   150,   111
-};
-
-static const short int yycheck[] =
-{
-       5,     6,     0,     8,    57,    58,    11,    84,    85,    30,
-       4,     5,     6,     7,     8,     9,    10,    11,    30,    96,
-      14,    15,    24,    25,    26,    25,    26,    29,    81,    82,
-      66,    30,    34,    69,    30,    71,    30,    90,    91,     0,
-       1,    94,     3,     4,     5,     6,     7,     8,     9,    10,
-      11,    12,    25,    14,    15,    16,    17,    18,    19,    20,
-      21,    22,    23,    25,    25,    25,    26,     1,   145,    30,
-       4,     5,     6,     7,     8,     9,    10,    11,    31,    32,
-      14,    15,    16,    17,   137,    25,    26,    92,    30,    29,
-      66,    25,    27,    69,    34,    71,    30,    68,    33,    70,
-     105,     1,   155,     0,     1,     1,     3,     4,     5,     6,
-       7,     8,     9,    10,    11,    12,    30,    14,    15,    16,
-      17,    18,    19,    20,    21,    22,    23,    68,    25,    70,
-      25,     0,     1,    30,     3,     4,     5,     6,     7,     8,
-       9,    10,    11,    30,    30,    14,    15,    16,    17,    18,
-      19,    20,    21,    22,    23,    30,    25,    30,    30,     0,
-       1,    30,     3,     4,     5,     6,     7,     8,     9,    10,
-      11,    30,    30,    14,    15,    16,    30,    18,    19,    20,
-      21,    22,    23,     1,    25,    30,    30,     5,     6,    30,
-       8,     9,    10,    11,    12,     1,    14,    15,    16,    17,
-      18,    19,    20,    21,    14,     5,     6,    25,     8,     9,
-      10,    11,    30,    30,    14,    15,   142,   143,   144,    13,
-      25,    31,    32,   149,    28,   151,    14,    31,    32,    32,
-      30,    67,    68,    30,    70,   161,    67,    68,    30,    70,
-      30,    31,    32,    30,    31,    32,    30,    31,    32,    30,
-      31,    32,    30,    30,    30,    30,    30,    30,    30,    29,
-      40,    59,    -1,   106,    66
-};
-
-/* YYSTOS[STATE-NUM] -- The (internal number of the) accessing
-   symbol of state STATE-NUM.  */
-static const unsigned char yystos[] =
-{
-       0,    36,    37,     0,     1,     3,     4,     5,     6,     7,
-       8,     9,    10,    11,    14,    15,    16,    18,    19,    20,
-      21,    22,    23,    25,    30,    38,    39,    41,    42,    43,
-      44,    47,    48,    50,    54,    56,    58,    59,    61,    63,
-      64,    65,    72,    30,    25,    26,    71,    71,    30,    71,
-      30,    30,    71,    25,    25,    25,    26,    29,    34,    75,
-      76,    30,     1,     1,    45,    45,    51,    53,    57,    68,
-      62,    68,    30,    73,    30,    30,    30,    30,    30,    75,
-      75,    31,    32,    73,    27,    33,    30,    30,     1,    12,
-      16,    17,    19,    20,    21,    22,    23,    25,    30,    40,
-      46,    66,    67,    69,    18,    19,    20,    21,    30,    40,
-      52,    67,    69,    39,    49,    72,    39,    50,    55,    61,
-      72,    30,    40,    69,    39,    50,    60,    61,    72,    30,
-      28,    75,    75,    76,    76,    30,    30,    24,    75,    75,
-      71,    70,    71,    75,    25,    76,     1,    13,    30,    71,
-      70,    25,    75,    30,    30,    14,    74,    30,    74,    74,
-      74,    76,    30,    74,    30,    74,    30,    75,    30,    30,
-      30,    74,    30,    30,    30
-};
-
-#if ! defined (YYSIZE_T) && defined (__SIZE_TYPE__)
-# define YYSIZE_T __SIZE_TYPE__
-#endif
-#if ! defined (YYSIZE_T) && defined (size_t)
-# define YYSIZE_T size_t
-#endif
-#if ! defined (YYSIZE_T)
-# if defined (__STDC__) || defined (__cplusplus)
-#  include <stddef.h> /* INFRINGES ON USER NAME SPACE */
-#  define YYSIZE_T size_t
-# endif
-#endif
-#if ! defined (YYSIZE_T)
-# define YYSIZE_T unsigned int
-#endif
-
-#define yyerrok		(yyerrstatus = 0)
-#define yyclearin	(yychar = YYEMPTY)
-#define YYEMPTY		(-2)
-#define YYEOF		0
-
-#define YYACCEPT	goto yyacceptlab
-#define YYABORT		goto yyabortlab
-#define YYERROR		goto yyerrorlab
-
-
-/* Like YYERROR except do call yyerror.  This remains here temporarily
-   to ease the transition to the new meaning of YYERROR, for GCC.
-   Once GCC version 2 has supplanted version 1, this can go.  */
-
-#define YYFAIL		goto yyerrlab
-
-#define YYRECOVERING()  (!!yyerrstatus)
-
-#define YYBACKUP(Token, Value)					\
-do								\
-  if (yychar == YYEMPTY && yylen == 1)				\
-    {								\
-      yychar = (Token);						\
-      yylval = (Value);						\
-      yytoken = YYTRANSLATE (yychar);				\
-      YYPOPSTACK;						\
-      goto yybackup;						\
-    }								\
-  else								\
-    { 								\
-      yyerror ("syntax error: cannot back up");\
-      YYERROR;							\
-    }								\
-while (0)
-
-
-#define YYTERROR	1
-#define YYERRCODE	256
-
-
-/* YYLLOC_DEFAULT -- Set CURRENT to span from RHS[1] to RHS[N].
-   If N is 0, then set CURRENT to the empty location which ends
-   the previous symbol: RHS[0] (always defined).  */
-
-#define YYRHSLOC(Rhs, K) ((Rhs)[K])
-#ifndef YYLLOC_DEFAULT
-# define YYLLOC_DEFAULT(Current, Rhs, N)				\
-    do									\
-      if (N)								\
-	{								\
-	  (Current).first_line   = YYRHSLOC (Rhs, 1).first_line;	\
-	  (Current).first_column = YYRHSLOC (Rhs, 1).first_column;	\
-	  (Current).last_line    = YYRHSLOC (Rhs, N).last_line;		\
-	  (Current).last_column  = YYRHSLOC (Rhs, N).last_column;	\
-	}								\
-      else								\
-	{								\
-	  (Current).first_line   = (Current).last_line   =		\
-	    YYRHSLOC (Rhs, 0).last_line;				\
-	  (Current).first_column = (Current).last_column =		\
-	    YYRHSLOC (Rhs, 0).last_column;				\
-	}								\
-    while (0)
-#endif
-
-
-/* YY_LOCATION_PRINT -- Print the location on the stream.
-   This macro was not mandated originally: define only if we know
-   we won't break user code: when these are the locations we know.  */
-
-#ifndef YY_LOCATION_PRINT
-# if YYLTYPE_IS_TRIVIAL
-#  define YY_LOCATION_PRINT(File, Loc)			\
-     fprintf (File, "%d.%d-%d.%d",			\
-              (Loc).first_line, (Loc).first_column,	\
-              (Loc).last_line,  (Loc).last_column)
-# else
-#  define YY_LOCATION_PRINT(File, Loc) ((void) 0)
-# endif
-#endif
-
-
-/* YYLEX -- calling `yylex' with the right arguments.  */
-
-#ifdef YYLEX_PARAM
-# define YYLEX yylex (YYLEX_PARAM)
-#else
-# define YYLEX yylex ()
-#endif
-
-/* Enable debugging if requested.  */
-#if YYDEBUG
-
-# ifndef YYFPRINTF
-#  include <stdio.h> /* INFRINGES ON USER NAME SPACE */
-#  define YYFPRINTF fprintf
-# endif
-
-# define YYDPRINTF(Args)			\
-do {						\
-  if (yydebug)					\
-    YYFPRINTF Args;				\
-} while (0)
-
-# define YY_SYMBOL_PRINT(Title, Type, Value, Location)		\
-do {								\
-  if (yydebug)							\
-    {								\
-      YYFPRINTF (stderr, "%s ", Title);				\
-      yysymprint (stderr, 					\
-                  Type, Value);	\
-      YYFPRINTF (stderr, "\n");					\
-    }								\
-} while (0)
-
-/*------------------------------------------------------------------.
-| yy_stack_print -- Print the state stack from its BOTTOM up to its |
-| TOP (included).                                                   |
-`------------------------------------------------------------------*/
-
-#if defined (__STDC__) || defined (__cplusplus)
-static void
-yy_stack_print (short int *bottom, short int *top)
-#else
-static void
-yy_stack_print (bottom, top)
-    short int *bottom;
-    short int *top;
-#endif
-{
-  YYFPRINTF (stderr, "Stack now");
-  for (/* Nothing. */; bottom <= top; ++bottom)
-    YYFPRINTF (stderr, " %d", *bottom);
-  YYFPRINTF (stderr, "\n");
-}
-
-# define YY_STACK_PRINT(Bottom, Top)				\
-do {								\
-  if (yydebug)							\
-    yy_stack_print ((Bottom), (Top));				\
-} while (0)
-
-
-/*------------------------------------------------.
-| Report that the YYRULE is going to be reduced.  |
-`------------------------------------------------*/
-
-#if defined (__STDC__) || defined (__cplusplus)
-static void
-yy_reduce_print (int yyrule)
-#else
-static void
-yy_reduce_print (yyrule)
-    int yyrule;
-#endif
-{
-  int yyi;
-  unsigned int yylno = yyrline[yyrule];
-  YYFPRINTF (stderr, "Reducing stack by rule %d (line %u), ",
-             yyrule - 1, yylno);
-  /* Print the symbols being reduced, and their result.  */
-  for (yyi = yyprhs[yyrule]; 0 <= yyrhs[yyi]; yyi++)
-    YYFPRINTF (stderr, "%s ", yytname [yyrhs[yyi]]);
-  YYFPRINTF (stderr, "-> %s\n", yytname [yyr1[yyrule]]);
-}
-
-# define YY_REDUCE_PRINT(Rule)		\
-do {					\
-  if (yydebug)				\
-    yy_reduce_print (Rule);		\
-} while (0)
-
-/* Nonzero means print parse trace.  It is left uninitialized so that
-   multiple parsers can coexist.  */
-int yydebug;
-#else /* !YYDEBUG */
-# define YYDPRINTF(Args)
-# define YY_SYMBOL_PRINT(Title, Type, Value, Location)
-# define YY_STACK_PRINT(Bottom, Top)
-# define YY_REDUCE_PRINT(Rule)
-#endif /* !YYDEBUG */
-
-
-/* YYINITDEPTH -- initial size of the parser's stacks.  */
-#ifndef	YYINITDEPTH
-# define YYINITDEPTH 200
-#endif
-
-/* YYMAXDEPTH -- maximum size the stacks can grow to (effective only
-   if the built-in stack extension method is used).
-
-   Do not make this value too large; the results are undefined if
-   SIZE_MAX < YYSTACK_BYTES (YYMAXDEPTH)
-   evaluated with infinite-precision integer arithmetic.  */
-
-#ifndef YYMAXDEPTH
-# define YYMAXDEPTH 10000
-#endif
-
-
-
-#if YYERROR_VERBOSE
-
-# ifndef yystrlen
-#  if defined (__GLIBC__) && defined (_STRING_H)
-#   define yystrlen strlen
-#  else
-/* Return the length of YYSTR.  */
-static YYSIZE_T
-#   if defined (__STDC__) || defined (__cplusplus)
-yystrlen (const char *yystr)
-#   else
-yystrlen (yystr)
-     const char *yystr;
-#   endif
-{
-  register const char *yys = yystr;
-
-  while (*yys++ != '\0')
-    continue;
-
-  return yys - yystr - 1;
-}
-#  endif
-# endif
-
-# ifndef yystpcpy
-#  if defined (__GLIBC__) && defined (_STRING_H) && defined (_GNU_SOURCE)
-#   define yystpcpy stpcpy
-#  else
-/* Copy YYSRC to YYDEST, returning the address of the terminating '\0' in
-   YYDEST.  */
-static char *
-#   if defined (__STDC__) || defined (__cplusplus)
-yystpcpy (char *yydest, const char *yysrc)
-#   else
-yystpcpy (yydest, yysrc)
-     char *yydest;
-     const char *yysrc;
-#   endif
-{
-  register char *yyd = yydest;
-  register const char *yys = yysrc;
-
-  while ((*yyd++ = *yys++) != '\0')
-    continue;
-
-  return yyd - 1;
-}
-#  endif
-# endif
-
-#endif /* !YYERROR_VERBOSE */
-
-
-
-#if YYDEBUG
-/*--------------------------------.
-| Print this symbol on YYOUTPUT.  |
-`--------------------------------*/
-
-#if defined (__STDC__) || defined (__cplusplus)
-static void
-yysymprint (FILE *yyoutput, int yytype, YYSTYPE *yyvaluep)
-#else
-static void
-yysymprint (yyoutput, yytype, yyvaluep)
-    FILE *yyoutput;
-    int yytype;
-    YYSTYPE *yyvaluep;
-#endif
-{
-  /* Pacify ``unused variable'' warnings.  */
-  (void) yyvaluep;
-
-  if (yytype < YYNTOKENS)
-    YYFPRINTF (yyoutput, "token %s (", yytname[yytype]);
-  else
-    YYFPRINTF (yyoutput, "nterm %s (", yytname[yytype]);
-
-
-# ifdef YYPRINT
-  if (yytype < YYNTOKENS)
-    YYPRINT (yyoutput, yytoknum[yytype], *yyvaluep);
-# endif
-  switch (yytype)
-    {
-      default:
-        break;
-    }
-  YYFPRINTF (yyoutput, ")");
-}
-
-#endif /* ! YYDEBUG */
-/*-----------------------------------------------.
-| Release the memory associated to this symbol.  |
-`-----------------------------------------------*/
-
-#if defined (__STDC__) || defined (__cplusplus)
-static void
-yydestruct (const char *yymsg, int yytype, YYSTYPE *yyvaluep)
-#else
-static void
-yydestruct (yymsg, yytype, yyvaluep)
-    const char *yymsg;
-    int yytype;
-    YYSTYPE *yyvaluep;
-#endif
-{
-  /* Pacify ``unused variable'' warnings.  */
-  (void) yyvaluep;
-
-  if (!yymsg)
-    yymsg = "Deleting";
-  YY_SYMBOL_PRINT (yymsg, yytype, yyvaluep, yylocationp);
-
-  switch (yytype)
-    {
-      case 48: /* choice_entry */
-
-        {
-	fprintf(stderr, "%s:%d: missing end statement for this entry\n",
-		(yyvaluep->menu)->file->name, (yyvaluep->menu)->lineno);
-	if (current_menu == (yyvaluep->menu))
-		menu_end_menu();
-};
-
-        break;
-      case 54: /* if_entry */
-
-        {
-	fprintf(stderr, "%s:%d: missing end statement for this entry\n",
-		(yyvaluep->menu)->file->name, (yyvaluep->menu)->lineno);
-	if (current_menu == (yyvaluep->menu))
-		menu_end_menu();
-};
-
-        break;
-      case 59: /* menu_entry */
-
-        {
-	fprintf(stderr, "%s:%d: missing end statement for this entry\n",
-		(yyvaluep->menu)->file->name, (yyvaluep->menu)->lineno);
-	if (current_menu == (yyvaluep->menu))
-		menu_end_menu();
-};
-
-        break;
-
-      default:
-        break;
-    }
-}
-
-
-/* Prevent warnings from -Wmissing-prototypes.  */
-
-#ifdef YYPARSE_PARAM
-# if defined (__STDC__) || defined (__cplusplus)
-int yyparse (void *YYPARSE_PARAM);
-# else
-int yyparse ();
-# endif
-#else /* ! YYPARSE_PARAM */
-#if defined (__STDC__) || defined (__cplusplus)
-int yyparse (void);
-#else
-int yyparse ();
-#endif
-#endif /* ! YYPARSE_PARAM */
-
-
-
-/* The look-ahead symbol.  */
-int yychar;
-
-/* The semantic value of the look-ahead symbol.  */
-YYSTYPE yylval;
-
-/* Number of syntax errors so far.  */
-int yynerrs;
-
-
-
-/*----------.
-| yyparse.  |
-`----------*/
-
-#ifdef YYPARSE_PARAM
-# if defined (__STDC__) || defined (__cplusplus)
-int yyparse (void *YYPARSE_PARAM)
-# else
-int yyparse (YYPARSE_PARAM)
-  void *YYPARSE_PARAM;
-# endif
-#else /* ! YYPARSE_PARAM */
-#if defined (__STDC__) || defined (__cplusplus)
-int
-yyparse (void)
-#else
-int
-yyparse ()
-
-#endif
-#endif
-{
-
-  register int yystate;
-  register int yyn;
-  int yyresult;
-  /* Number of tokens to shift before error messages enabled.  */
-  int yyerrstatus;
-  /* Look-ahead token as an internal (translated) token number.  */
-  int yytoken = 0;
-
-  /* Three stacks and their tools:
-     `yyss': related to states,
-     `yyvs': related to semantic values,
-     `yyls': related to locations.
-
-     Refer to the stacks through separate pointers, to allow yyoverflow
-     to reallocate them elsewhere.  */
-
-  /* The state stack.  */
-  short int yyssa[YYINITDEPTH];
-  short int *yyss = yyssa;
-  register short int *yyssp;
-
-  /* The semantic value stack.  */
-  YYSTYPE yyvsa[YYINITDEPTH];
-  YYSTYPE *yyvs = yyvsa;
-  register YYSTYPE *yyvsp;
-
-
-
-#define YYPOPSTACK   (yyvsp--, yyssp--)
-
-  YYSIZE_T yystacksize = YYINITDEPTH;
-
-  /* The variables used to return semantic value and location from the
-     action routines.  */
-  YYSTYPE yyval;
-
-
-  /* When reducing, the number of symbols on the RHS of the reduced
-     rule.  */
-  int yylen;
-
-  YYDPRINTF ((stderr, "Starting parse\n"));
-
-  yystate = 0;
-  yyerrstatus = 0;
-  yynerrs = 0;
-  yychar = YYEMPTY;		/* Cause a token to be read.  */
-
-  /* Initialize stack pointers.
-     Waste one element of value and location stack
-     so that they stay on the same level as the state stack.
-     The wasted elements are never initialized.  */
-
-  yyssp = yyss;
-  yyvsp = yyvs;
-
-
-  yyvsp[0] = yylval;
-
-  goto yysetstate;
-
-/*------------------------------------------------------------.
-| yynewstate -- Push a new state, which is found in yystate.  |
-`------------------------------------------------------------*/
- yynewstate:
-  /* In all cases, when you get here, the value and location stacks
-     have just been pushed. so pushing a state here evens the stacks.
-     */
-  yyssp++;
-
- yysetstate:
-  *yyssp = yystate;
-
-  if (yyss + yystacksize - 1 <= yyssp)
-    {
-      /* Get the current used size of the three stacks, in elements.  */
-      YYSIZE_T yysize = yyssp - yyss + 1;
-
-#ifdef yyoverflow
-      {
-	/* Give user a chance to reallocate the stack. Use copies of
-	   these so that the &'s don't force the real ones into
-	   memory.  */
-	YYSTYPE *yyvs1 = yyvs;
-	short int *yyss1 = yyss;
-
-
-	/* Each stack pointer address is followed by the size of the
-	   data in use in that stack, in bytes.  This used to be a
-	   conditional around just the two extra args, but that might
-	   be undefined if yyoverflow is a macro.  */
-	yyoverflow ("parser stack overflow",
-		    &yyss1, yysize * sizeof (*yyssp),
-		    &yyvs1, yysize * sizeof (*yyvsp),
-
-		    &yystacksize);
-
-	yyss = yyss1;
-	yyvs = yyvs1;
-      }
-#else /* no yyoverflow */
-# ifndef YYSTACK_RELOCATE
-      goto yyoverflowlab;
-# else
-      /* Extend the stack our own way.  */
-      if (YYMAXDEPTH <= yystacksize)
-	goto yyoverflowlab;
-      yystacksize *= 2;
-      if (YYMAXDEPTH < yystacksize)
-	yystacksize = YYMAXDEPTH;
-
-      {
-	short int *yyss1 = yyss;
-	union yyalloc *yyptr =
-	  (union yyalloc *) YYSTACK_ALLOC (YYSTACK_BYTES (yystacksize));
-	if (! yyptr)
-	  goto yyoverflowlab;
-	YYSTACK_RELOCATE (yyss);
-	YYSTACK_RELOCATE (yyvs);
-
-#  undef YYSTACK_RELOCATE
-	if (yyss1 != yyssa)
-	  YYSTACK_FREE (yyss1);
-      }
-# endif
-#endif /* no yyoverflow */
-
-      yyssp = yyss + yysize - 1;
-      yyvsp = yyvs + yysize - 1;
-
-
-      YYDPRINTF ((stderr, "Stack size increased to %lu\n",
-		  (unsigned long) yystacksize));
-
-      if (yyss + yystacksize - 1 <= yyssp)
-	YYABORT;
-    }
-
-  YYDPRINTF ((stderr, "Entering state %d\n", yystate));
-
-  goto yybackup;
-
-/*-----------.
-| yybackup.  |
-`-----------*/
-yybackup:
-
-/* Do appropriate processing given the current state.  */
-/* Read a look-ahead token if we need one and don't already have one.  */
-/* yyresume: */
-
-  /* First try to decide what to do without reference to look-ahead token.  */
-
-  yyn = yypact[yystate];
-  if (yyn == YYPACT_NINF)
-    goto yydefault;
-
-  /* Not known => get a look-ahead token if don't already have one.  */
-
-  /* YYCHAR is either YYEMPTY or YYEOF or a valid look-ahead symbol.  */
-  if (yychar == YYEMPTY)
-    {
-      YYDPRINTF ((stderr, "Reading a token: "));
-      yychar = YYLEX;
-    }
-
-  if (yychar <= YYEOF)
-    {
-      yychar = yytoken = YYEOF;
-      YYDPRINTF ((stderr, "Now at end of input.\n"));
-    }
-  else
-    {
-      yytoken = YYTRANSLATE (yychar);
-      YY_SYMBOL_PRINT ("Next token is", yytoken, &yylval, &yylloc);
-    }
-
-  /* If the proper action on seeing token YYTOKEN is to reduce or to
-     detect an error, take that action.  */
-  yyn += yytoken;
-  if (yyn < 0 || YYLAST < yyn || yycheck[yyn] != yytoken)
-    goto yydefault;
-  yyn = yytable[yyn];
-  if (yyn <= 0)
-    {
-      if (yyn == 0 || yyn == YYTABLE_NINF)
-	goto yyerrlab;
-      yyn = -yyn;
-      goto yyreduce;
-    }
-
-  if (yyn == YYFINAL)
-    YYACCEPT;
-
-  /* Shift the look-ahead token.  */
-  YY_SYMBOL_PRINT ("Shifting", yytoken, &yylval, &yylloc);
-
-  /* Discard the token being shifted unless it is eof.  */
-  if (yychar != YYEOF)
-    yychar = YYEMPTY;
-
-  *++yyvsp = yylval;
-
-
-  /* Count tokens shifted since error; after three, turn off error
-     status.  */
-  if (yyerrstatus)
-    yyerrstatus--;
-
-  yystate = yyn;
-  goto yynewstate;
-
-
-/*-----------------------------------------------------------.
-| yydefault -- do the default action for the current state.  |
-`-----------------------------------------------------------*/
-yydefault:
-  yyn = yydefact[yystate];
-  if (yyn == 0)
-    goto yyerrlab;
-  goto yyreduce;
-
-
-/*-----------------------------.
-| yyreduce -- Do a reduction.  |
-`-----------------------------*/
-yyreduce:
-  /* yyn is the number of a rule to reduce with.  */
-  yylen = yyr2[yyn];
-
-  /* If YYLEN is nonzero, implement the default value of the action:
-     `$$ = $1'.
-
-     Otherwise, the following line sets YYVAL to garbage.
-     This behavior is undocumented and Bison
-     users should not rely upon it.  Assigning to YYVAL
-     unconditionally makes the parser a bit smaller, and it avoids a
-     GCC warning that YYVAL may be used uninitialized.  */
-  yyval = yyvsp[1-yylen];
-
-
-  YY_REDUCE_PRINT (yyn);
-  switch (yyn)
-    {
-        case 8:
-
-    { zconf_error("unexpected end statement"); ;}
-    break;
-
-  case 9:
-
-    { zconf_error("unknown statement \"%s\"", (yyvsp[-2].string)); ;}
-    break;
-
-  case 10:
-
-    {
-	zconf_error("unexpected option \"%s\"", kconf_id_strings + (yyvsp[-2].id)->name);
-;}
-    break;
-
-  case 11:
-
-    { zconf_error("invalid statement"); ;}
-    break;
-
-  case 25:
-
-    { zconf_error("unknown option \"%s\"", (yyvsp[-2].string)); ;}
-    break;
-
-  case 26:
-
-    { zconf_error("invalid option"); ;}
-    break;
-
-  case 27:
-
-    {
-	struct symbol *sym = sym_lookup((yyvsp[-1].string), 0);
-	sym->flags |= SYMBOL_OPTIONAL;
-	menu_add_entry(sym);
-	printd(DEBUG_PARSE, "%s:%d:config %s\n", zconf_curname(), zconf_lineno(), (yyvsp[-1].string));
-;}
-    break;
-
-  case 28:
-
-    {
-	menu_end_entry();
-	printd(DEBUG_PARSE, "%s:%d:endconfig\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 29:
-
-    {
-	struct symbol *sym = sym_lookup((yyvsp[-1].string), 0);
-	sym->flags |= SYMBOL_OPTIONAL;
-	menu_add_entry(sym);
-	printd(DEBUG_PARSE, "%s:%d:menuconfig %s\n", zconf_curname(), zconf_lineno(), (yyvsp[-1].string));
-;}
-    break;
-
-  case 30:
-
-    {
-	if (current_entry->prompt)
-		current_entry->prompt->type = P_MENU;
-	else
-		zconfprint("warning: menuconfig statement without prompt");
-	menu_end_entry();
-	printd(DEBUG_PARSE, "%s:%d:endconfig\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 37:
-
-    {
-	menu_set_type((yyvsp[-2].id)->stype);
-	printd(DEBUG_PARSE, "%s:%d:type(%u)\n",
-		zconf_curname(), zconf_lineno(),
-		(yyvsp[-2].id)->stype);
-;}
-    break;
-
-  case 38:
-
-    {
-	menu_add_prompt(P_PROMPT, (yyvsp[-2].string), (yyvsp[-1].expr));
-	printd(DEBUG_PARSE, "%s:%d:prompt\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 39:
-
-    {
-	menu_add_expr(P_DEFAULT, (yyvsp[-2].expr), (yyvsp[-1].expr));
-	if ((yyvsp[-3].id)->stype != S_UNKNOWN)
-		menu_set_type((yyvsp[-3].id)->stype);
-	printd(DEBUG_PARSE, "%s:%d:default(%u)\n",
-		zconf_curname(), zconf_lineno(),
-		(yyvsp[-3].id)->stype);
-;}
-    break;
-
-  case 40:
-
-    {
-	menu_add_symbol(P_SELECT, sym_lookup((yyvsp[-2].string), 0), (yyvsp[-1].expr));
-	printd(DEBUG_PARSE, "%s:%d:select\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 41:
-
-    {
-	menu_add_expr(P_RANGE, expr_alloc_comp(E_RANGE,(yyvsp[-3].symbol), (yyvsp[-2].symbol)), (yyvsp[-1].expr));
-	printd(DEBUG_PARSE, "%s:%d:range\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 42:
-
-    {
-	struct symbol *sym = sym_lookup(NULL, 0);
-	sym->flags |= SYMBOL_CHOICE;
-	menu_add_entry(sym);
-	menu_add_expr(P_CHOICE, NULL, NULL);
-	printd(DEBUG_PARSE, "%s:%d:choice\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 43:
-
-    {
-	(yyval.menu) = menu_add_menu();
-;}
-    break;
-
-  case 44:
-
-    {
-	if (zconf_endtoken((yyvsp[0].id), T_CHOICE, T_ENDCHOICE)) {
-		menu_end_menu();
-		printd(DEBUG_PARSE, "%s:%d:endchoice\n", zconf_curname(), zconf_lineno());
-	}
-;}
-    break;
-
-  case 52:
-
-    {
-	menu_add_prompt(P_PROMPT, (yyvsp[-2].string), (yyvsp[-1].expr));
-	printd(DEBUG_PARSE, "%s:%d:prompt\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 53:
-
-    {
-	if ((yyvsp[-2].id)->stype == S_BOOLEAN || (yyvsp[-2].id)->stype == S_TRISTATE) {
-		menu_set_type((yyvsp[-2].id)->stype);
-		printd(DEBUG_PARSE, "%s:%d:type(%u)\n",
-			zconf_curname(), zconf_lineno(),
-			(yyvsp[-2].id)->stype);
-	} else
-		YYERROR;
-;}
-    break;
-
-  case 54:
-
-    {
-	current_entry->sym->flags |= SYMBOL_OPTIONAL;
-	printd(DEBUG_PARSE, "%s:%d:optional\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 55:
-
-    {
-	if ((yyvsp[-3].id)->stype == S_UNKNOWN) {
-		menu_add_symbol(P_DEFAULT, sym_lookup((yyvsp[-2].string), 0), (yyvsp[-1].expr));
-		printd(DEBUG_PARSE, "%s:%d:default\n",
-			zconf_curname(), zconf_lineno());
-	} else
-		YYERROR;
-;}
-    break;
-
-  case 58:
-
-    {
-	printd(DEBUG_PARSE, "%s:%d:if\n", zconf_curname(), zconf_lineno());
-	menu_add_entry(NULL);
-	menu_add_dep((yyvsp[-1].expr));
-	(yyval.menu) = menu_add_menu();
-;}
-    break;
-
-  case 59:
-
-    {
-	if (zconf_endtoken((yyvsp[0].id), T_IF, T_ENDIF)) {
-		menu_end_menu();
-		printd(DEBUG_PARSE, "%s:%d:endif\n", zconf_curname(), zconf_lineno());
-	}
-;}
-    break;
-
-  case 65:
-
-    {
-	menu_add_entry(NULL);
-	menu_add_prompt(P_MENU, (yyvsp[-1].string), NULL);
-	printd(DEBUG_PARSE, "%s:%d:menu\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 66:
-
-    {
-	(yyval.menu) = menu_add_menu();
-;}
-    break;
-
-  case 67:
-
-    {
-	if (zconf_endtoken((yyvsp[0].id), T_MENU, T_ENDMENU)) {
-		menu_end_menu();
-		printd(DEBUG_PARSE, "%s:%d:endmenu\n", zconf_curname(), zconf_lineno());
-	}
-;}
-    break;
-
-  case 73:
-
-    {
-	printd(DEBUG_PARSE, "%s:%d:source %s\n", zconf_curname(), zconf_lineno(), (yyvsp[-1].string));
-	zconf_nextfile((yyvsp[-1].string));
-;}
-    break;
-
-  case 74:
-
-    {
-	menu_add_entry(NULL);
-	menu_add_prompt(P_COMMENT, (yyvsp[-1].string), NULL);
-	printd(DEBUG_PARSE, "%s:%d:comment\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 75:
-
-    {
-	menu_end_entry();
-;}
-    break;
-
-  case 76:
-
-    {
-	printd(DEBUG_PARSE, "%s:%d:help\n", zconf_curname(), zconf_lineno());
-	zconf_starthelp();
-;}
-    break;
-
-  case 77:
-
-    {
-	current_entry->sym->help = (yyvsp[0].string);
-;}
-    break;
-
-  case 82:
-
-    {
-	menu_add_dep((yyvsp[-1].expr));
-	printd(DEBUG_PARSE, "%s:%d:depends on\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 83:
-
-    {
-	menu_add_dep((yyvsp[-1].expr));
-	printd(DEBUG_PARSE, "%s:%d:depends\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 84:
-
-    {
-	menu_add_dep((yyvsp[-1].expr));
-	printd(DEBUG_PARSE, "%s:%d:requires\n", zconf_curname(), zconf_lineno());
-;}
-    break;
-
-  case 86:
-
-    {
-	menu_add_prompt(P_PROMPT, (yyvsp[-1].string), (yyvsp[0].expr));
-;}
-    break;
-
-  case 89:
-
-    { (yyval.id) = (yyvsp[-1].id); ;}
-    break;
-
-  case 90:
-
-    { (yyval.id) = (yyvsp[-1].id); ;}
-    break;
-
-  case 91:
-
-    { (yyval.id) = (yyvsp[-1].id); ;}
-    break;
-
-  case 94:
-
-    { (yyval.expr) = NULL; ;}
-    break;
-
-  case 95:
-
-    { (yyval.expr) = (yyvsp[0].expr); ;}
-    break;
-
-  case 96:
-
-    { (yyval.expr) = expr_alloc_symbol((yyvsp[0].symbol)); ;}
-    break;
-
-  case 97:
-
-    { (yyval.expr) = expr_alloc_comp(E_EQUAL, (yyvsp[-2].symbol), (yyvsp[0].symbol)); ;}
-    break;
-
-  case 98:
-
-    { (yyval.expr) = expr_alloc_comp(E_UNEQUAL, (yyvsp[-2].symbol), (yyvsp[0].symbol)); ;}
-    break;
-
-  case 99:
-
-    { (yyval.expr) = (yyvsp[-1].expr); ;}
-    break;
-
-  case 100:
-
-    { (yyval.expr) = expr_alloc_one(E_NOT, (yyvsp[0].expr)); ;}
-    break;
-
-  case 101:
-
-    { (yyval.expr) = expr_alloc_two(E_OR, (yyvsp[-2].expr), (yyvsp[0].expr)); ;}
-    break;
-
-  case 102:
-
-    { (yyval.expr) = expr_alloc_two(E_AND, (yyvsp[-2].expr), (yyvsp[0].expr)); ;}
-    break;
-
-  case 103:
-
-    { (yyval.symbol) = sym_lookup((yyvsp[0].string), 0); free((yyvsp[0].string)); ;}
-    break;
-
-  case 104:
-
-    { (yyval.symbol) = sym_lookup((yyvsp[0].string), 1); free((yyvsp[0].string)); ;}
-    break;
-
-
-    }
-
-/* Line 1037 of yacc.c.  */
-
-
-  yyvsp -= yylen;
-  yyssp -= yylen;
-
-
-  YY_STACK_PRINT (yyss, yyssp);
-
-  *++yyvsp = yyval;
-
-
-  /* Now `shift' the result of the reduction.  Determine what state
-     that goes to, based on the state we popped back to and the rule
-     number reduced by.  */
-
-  yyn = yyr1[yyn];
-
-  yystate = yypgoto[yyn - YYNTOKENS] + *yyssp;
-  if (0 <= yystate && yystate <= YYLAST && yycheck[yystate] == *yyssp)
-    yystate = yytable[yystate];
-  else
-    yystate = yydefgoto[yyn - YYNTOKENS];
-
-  goto yynewstate;
-
-
-/*------------------------------------.
-| yyerrlab -- here on detecting error |
-`------------------------------------*/
-yyerrlab:
-  /* If not already recovering from an error, report this error.  */
-  if (!yyerrstatus)
-    {
-      ++yynerrs;
-#if YYERROR_VERBOSE
-      yyn = yypact[yystate];
-
-      if (YYPACT_NINF < yyn && yyn < YYLAST)
-	{
-	  YYSIZE_T yysize = 0;
-	  int yytype = YYTRANSLATE (yychar);
-	  const char* yyprefix;
-	  char *yymsg;
-	  int yyx;
-
-	  /* Start YYX at -YYN if negative to avoid negative indexes in
-	     YYCHECK.  */
-	  int yyxbegin = yyn < 0 ? -yyn : 0;
-
-	  /* Stay within bounds of both yycheck and yytname.  */
-	  int yychecklim = YYLAST - yyn;
-	  int yyxend = yychecklim < YYNTOKENS ? yychecklim : YYNTOKENS;
-	  int yycount = 0;
-
-	  yyprefix = ", expecting ";
-	  for (yyx = yyxbegin; yyx < yyxend; ++yyx)
-	    if (yycheck[yyx + yyn] == yyx && yyx != YYTERROR)
-	      {
-		yysize += yystrlen (yyprefix) + yystrlen (yytname [yyx]);
-		yycount += 1;
-		if (yycount == 5)
-		  {
-		    yysize = 0;
-		    break;
-		  }
-	      }
-	  yysize += (sizeof ("syntax error, unexpected ")
-		     + yystrlen (yytname[yytype]));
-	  yymsg = (char *) YYSTACK_ALLOC (yysize);
-	  if (yymsg != 0)
-	    {
-	      char *yyp = yystpcpy (yymsg, "syntax error, unexpected ");
-	      yyp = yystpcpy (yyp, yytname[yytype]);
-
-	      if (yycount < 5)
-		{
-		  yyprefix = ", expecting ";
-		  for (yyx = yyxbegin; yyx < yyxend; ++yyx)
-		    if (yycheck[yyx + yyn] == yyx && yyx != YYTERROR)
-		      {
-			yyp = yystpcpy (yyp, yyprefix);
-			yyp = yystpcpy (yyp, yytname[yyx]);
-			yyprefix = " or ";
-		      }
-		}
-	      yyerror (yymsg);
-	      YYSTACK_FREE (yymsg);
-	    }
-	  else
-	    yyerror ("syntax error; also virtual memory exhausted");
-	}
-      else
-#endif /* YYERROR_VERBOSE */
-	yyerror ("syntax error");
-    }
-
-
-
-  if (yyerrstatus == 3)
-    {
-      /* If just tried and failed to reuse look-ahead token after an
-	 error, discard it.  */
-
-      if (yychar <= YYEOF)
-        {
-          /* If at end of input, pop the error token,
-	     then the rest of the stack, then return failure.  */
-	  if (yychar == YYEOF)
-	     for (;;)
-	       {
-
-		 YYPOPSTACK;
-		 if (yyssp == yyss)
-		   YYABORT;
-		 yydestruct ("Error: popping",
-                             yystos[*yyssp], yyvsp);
-	       }
-        }
-      else
-	{
-	  yydestruct ("Error: discarding", yytoken, &yylval);
-	  yychar = YYEMPTY;
-	}
-    }
-
-  /* Else will try to reuse look-ahead token after shifting the error
-     token.  */
-  goto yyerrlab1;
-
-
-/*---------------------------------------------------.
-| yyerrorlab -- error raised explicitly by YYERROR.  |
-`---------------------------------------------------*/
-yyerrorlab:
-
-#ifdef __GNUC__
-  /* Pacify GCC when the user code never invokes YYERROR and the label
-     yyerrorlab therefore never appears in user code.  */
-  if (0)
-     goto yyerrorlab;
-#endif
-
-yyvsp -= yylen;
-  yyssp -= yylen;
-  yystate = *yyssp;
-  goto yyerrlab1;
-
-
-/*-------------------------------------------------------------.
-| yyerrlab1 -- common code for both syntax error and YYERROR.  |
-`-------------------------------------------------------------*/
-yyerrlab1:
-  yyerrstatus = 3;	/* Each real token shifted decrements this.  */
-
-  for (;;)
-    {
-      yyn = yypact[yystate];
-      if (yyn != YYPACT_NINF)
-	{
-	  yyn += YYTERROR;
-	  if (0 <= yyn && yyn <= YYLAST && yycheck[yyn] == YYTERROR)
-	    {
-	      yyn = yytable[yyn];
-	      if (0 < yyn)
-		break;
-	    }
-	}
-
-      /* Pop the current state because it cannot handle the error token.  */
-      if (yyssp == yyss)
-	YYABORT;
-
-
-      yydestruct ("Error: popping", yystos[yystate], yyvsp);
-      YYPOPSTACK;
-      yystate = *yyssp;
-      YY_STACK_PRINT (yyss, yyssp);
-    }
-
-  if (yyn == YYFINAL)
-    YYACCEPT;
-
-  *++yyvsp = yylval;
-
-
-  /* Shift the error token. */
-  YY_SYMBOL_PRINT ("Shifting", yystos[yyn], yyvsp, yylsp);
-
-  yystate = yyn;
-  goto yynewstate;
-
-
-/*-------------------------------------.
-| yyacceptlab -- YYACCEPT comes here.  |
-`-------------------------------------*/
-yyacceptlab:
-  yyresult = 0;
-  goto yyreturn;
-
-/*-----------------------------------.
-| yyabortlab -- YYABORT comes here.  |
-`-----------------------------------*/
-yyabortlab:
-  yydestruct ("Error: discarding lookahead",
-              yytoken, &yylval);
-  yychar = YYEMPTY;
-  yyresult = 1;
-  goto yyreturn;
-
-#ifndef yyoverflow
-/*----------------------------------------------.
-| yyoverflowlab -- parser overflow comes here.  |
-`----------------------------------------------*/
-yyoverflowlab:
-  yyerror ("parser stack overflow");
-  yyresult = 2;
-  /* Fall through.  */
-#endif
-
-yyreturn:
-#ifndef yyoverflow
-  if (yyss != yyssa)
-    YYSTACK_FREE (yyss);
-#endif
-  return yyresult;
-}
-
-
-
-
-
-void conf_parse(const char *name)
-{
-	struct symbol *sym;
-	int i;
-
-	zconf_initscan(name);
-
-	sym_init();
-	menu_init();
-	modules_sym = sym_lookup("MODULES", 0);
-	rootmenu.prompt = menu_add_prompt(P_MENU, "Busybox Configuration", NULL);
-
-#if YYDEBUG
-	if (getenv("ZCONF_DEBUG"))
-		zconfdebug = 1;
-#endif
-	zconfparse();
-	if (zconfnerrs)
-		exit(1);
-	menu_finalize(&rootmenu);
-	for_all_symbols(i, sym) {
-		sym_check_deps(sym);
-        }
-
-	sym_change_count = 1;
-}
-
-const char *zconf_tokenname(int token)
-{
-	switch (token) {
-	case T_MENU:		return "menu";
-	case T_ENDMENU:		return "endmenu";
-	case T_CHOICE:		return "choice";
-	case T_ENDCHOICE:	return "endchoice";
-	case T_IF:		return "if";
-	case T_ENDIF:		return "endif";
-	case T_DEPENDS:		return "depends";
-	}
-	return "<token>";
-}
-
-static bool zconf_endtoken(struct kconf_id *id, int starttoken, int endtoken)
-{
-	if (id->token != endtoken) {
-		zconf_error("unexpected '%s' within %s block",
-			kconf_id_strings + id->name, zconf_tokenname(starttoken));
-		zconfnerrs++;
-		return false;
-	}
-	if (current_menu->file != current_file) {
-		zconf_error("'%s' in different file than '%s'",
-			kconf_id_strings + id->name, zconf_tokenname(starttoken));
-		fprintf(stderr, "%s:%d: location of the '%s'\n",
-			current_menu->file->name, current_menu->lineno,
-			zconf_tokenname(starttoken));
-		zconfnerrs++;
-		return false;
-	}
-	return true;
-}
-
-static void zconfprint(const char *err, ...)
-{
-	va_list ap;
-
-	fprintf(stderr, "%s:%d: ", zconf_curname(), zconf_lineno());
-	va_start(ap, err);
-	vfprintf(stderr, err, ap);
-	va_end(ap);
-	fprintf(stderr, "\n");
-}
-
-static void zconf_error(const char *err, ...)
-{
-	va_list ap;
-
-	zconfnerrs++;
-	fprintf(stderr, "%s:%d: ", zconf_curname(), zconf_lineno());
-	va_start(ap, err);
-	vfprintf(stderr, err, ap);
-	va_end(ap);
-	fprintf(stderr, "\n");
-}
-
-static void zconferror(const char *err)
-{
-#if YYDEBUG
-	fprintf(stderr, "%s:%d: %s\n", zconf_curname(), zconf_lineno() + 1, err);
-#endif
-}
-
-void print_quoted_string(FILE *out, const char *str)
-{
-	const char *p;
-	int len;
-
-	putc('"', out);
-	while ((p = strchr(str, '"'))) {
-		len = p - str;
-		if (len)
-			fprintf(out, "%.*s", len, str);
-		fputs("\\\"", out);
-		str = p + 1;
-	}
-	fputs(str, out);
-	putc('"', out);
-}
-
-void print_symbol(FILE *out, struct menu *menu)
-{
-	struct symbol *sym = menu->sym;
-	struct property *prop;
-
-	if (sym_is_choice(sym))
-		fprintf(out, "choice\n");
-	else
-		fprintf(out, "config %s\n", sym->name);
-	switch (sym->type) {
-	case S_BOOLEAN:
-		fputs("  boolean\n", out);
-		break;
-	case S_TRISTATE:
-		fputs("  tristate\n", out);
-		break;
-	case S_STRING:
-		fputs("  string\n", out);
-		break;
-	case S_INT:
-		fputs("  integer\n", out);
-		break;
-	case S_HEX:
-		fputs("  hex\n", out);
-		break;
-	default:
-		fputs("  ???\n", out);
-		break;
-	}
-	for (prop = sym->prop; prop; prop = prop->next) {
-		if (prop->menu != menu)
-			continue;
-		switch (prop->type) {
-		case P_PROMPT:
-			fputs("  prompt ", out);
-			print_quoted_string(out, prop->text);
-			if (!expr_is_yes(prop->visible.expr)) {
-				fputs(" if ", out);
-				expr_fprint(prop->visible.expr, out);
-			}
-			fputc('\n', out);
-			break;
-		case P_DEFAULT:
-			fputs( "  default ", out);
-			expr_fprint(prop->expr, out);
-			if (!expr_is_yes(prop->visible.expr)) {
-				fputs(" if ", out);
-				expr_fprint(prop->visible.expr, out);
-			}
-			fputc('\n', out);
-			break;
-		case P_CHOICE:
-			fputs("  #choice value\n", out);
-			break;
-		default:
-			fprintf(out, "  unknown prop %d!\n", prop->type);
-			break;
-		}
-	}
-	if (sym->help) {
-		int len = strlen(sym->help);
-		while (sym->help[--len] == '\n')
-			sym->help[len] = 0;
-		fprintf(out, "  help\n%s\n", sym->help);
-	}
-	fputc('\n', out);
-}
-
-void zconfdump(FILE *out)
-{
-	struct property *prop;
-	struct symbol *sym;
-	struct menu *menu;
-
-	menu = rootmenu.list;
-	while (menu) {
-		if ((sym = menu->sym))
-			print_symbol(out, menu);
-		else if ((prop = menu->prompt)) {
-			switch (prop->type) {
-			case P_COMMENT:
-				fputs("\ncomment ", out);
-				print_quoted_string(out, prop->text);
-				fputs("\n", out);
-				break;
-			case P_MENU:
-				fputs("\nmenu ", out);
-				print_quoted_string(out, prop->text);
-				fputs("\n", out);
-				break;
-			default:
-				;
-			}
-			if (!expr_is_yes(prop->visible.expr)) {
-				fputs("  depends ", out);
-				expr_fprint(prop->visible.expr, out);
-				fputc('\n', out);
-			}
-			fputs("\n", out);
-		}
-
-		if (menu->list)
-			menu = menu->list;
-		else if (menu->next)
-			menu = menu->next;
-		else while ((menu = menu->parent)) {
-			if (menu->prompt && menu->prompt->type == P_MENU)
-				fputs("\nendmenu\n", out);
-			if (menu->next) {
-				menu = menu->next;
-				break;
-			}
-		}
-	}
-}
-
-#include "lex.zconf.c"
-#include "util.c"
-#include "confdata.c"
-#include "expr.c"
-#include "symbol.c"
-#include "menu.c"
Binary files busybox.old/scripts/kconfig/zconf.tab.o and busybox/scripts/kconfig/zconf.tab.o differ
diff -Nurp busybox.old/scripts/kconfig/.zconf.tab.o.cmd busybox/scripts/kconfig/.zconf.tab.o.cmd
--- busybox.old/scripts/kconfig/.zconf.tab.o.cmd	2015-05-29 06:55:01.000000000 +0800
+++ busybox/scripts/kconfig/.zconf.tab.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,89 +0,0 @@
-cmd_scripts/kconfig/zconf.tab.o := gcc -Wp,-MD,scripts/kconfig/.zconf.tab.o.d  -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer      -Iscripts/kconfig -c -o scripts/kconfig/zconf.tab.o scripts/kconfig/zconf.tab.c
-
-deps_scripts/kconfig/zconf.tab.o := \
-  scripts/kconfig/zconf.tab.c \
-  /usr/include/stdc-predef.h \
-  /usr/include/ctype.h \
-  /usr/include/features.h \
-  /usr/include/sys/cdefs.h \
-  /usr/include/bits/wordsize.h \
-  /usr/include/gnu/stubs.h \
-  /usr/include/gnu/stubs-64.h \
-  /usr/include/bits/types.h \
-  /usr/include/bits/typesizes.h \
-  /usr/include/endian.h \
-  /usr/include/bits/endian.h \
-  /usr/include/bits/byteswap.h \
-  /usr/include/bits/byteswap-16.h \
-  /usr/include/xlocale.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdarg.h \
-  /usr/include/stdio.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stddef.h \
-  /usr/include/libio.h \
-  /usr/include/_G_config.h \
-  /usr/include/wchar.h \
-  /usr/include/bits/stdio_lim.h \
-  /usr/include/bits/sys_errlist.h \
-  /usr/include/bits/stdio.h \
-  /usr/include/stdlib.h \
-  /usr/include/bits/waitflags.h \
-  /usr/include/bits/waitstatus.h \
-  /usr/include/sys/types.h \
-  /usr/include/time.h \
-  /usr/include/sys/select.h \
-  /usr/include/bits/select.h \
-  /usr/include/bits/sigset.h \
-  /usr/include/bits/time.h \
-  /usr/include/sys/sysmacros.h \
-  /usr/include/bits/pthreadtypes.h \
-  /usr/include/alloca.h \
-  /usr/include/bits/stdlib-bsearch.h \
-  /usr/include/bits/stdlib-float.h \
-  /usr/include/string.h \
-  /usr/include/bits/string.h \
-  /usr/include/bits/string2.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdbool.h \
-  scripts/kconfig/lkc.h \
-  scripts/kconfig/expr.h \
-  /usr/include/libintl.h \
-  /usr/include/locale.h \
-  /usr/include/bits/locale.h \
-  scripts/kconfig/lkc_proto.h \
-  scripts/kconfig/zconf.hash.c \
-  scripts/kconfig/lex.zconf.c \
-  /usr/include/errno.h \
-  /usr/include/bits/errno.h \
-  /usr/include/linux/errno.h \
-  /usr/include/asm/errno.h \
-  /usr/include/asm-generic/errno.h \
-  /usr/include/asm-generic/errno-base.h \
-  /usr/include/inttypes.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include/stdint.h \
-  /usr/include/stdint.h \
-  /usr/include/bits/wchar.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include-fixed/limits.h \
-  /usr/lib/gcc/x86_64-unknown-linux-gnu/5.1.0/include-fixed/syslimits.h \
-  /usr/include/limits.h \
-  /usr/include/bits/posix1_lim.h \
-  /usr/include/bits/local_lim.h \
-  /usr/include/linux/limits.h \
-  /usr/include/bits/posix2_lim.h \
-  /usr/include/unistd.h \
-  /usr/include/bits/posix_opt.h \
-  /usr/include/bits/environments.h \
-  /usr/include/bits/confname.h \
-  /usr/include/getopt.h \
-  scripts/kconfig/util.c \
-  scripts/kconfig/confdata.c \
-  /usr/include/sys/stat.h \
-  /usr/include/bits/stat.h \
-  scripts/kconfig/expr.c \
-  scripts/kconfig/symbol.c \
-  /usr/include/regex.h \
-  /usr/include/sys/utsname.h \
-  /usr/include/bits/utsname.h \
-  scripts/kconfig/menu.c \
-
-scripts/kconfig/zconf.tab.o: $(deps_scripts/kconfig/zconf.tab.o)
-
-$(deps_scripts/kconfig/zconf.tab.o):
diff -Nurp busybox.old/scripts/trylink busybox/scripts/trylink
--- busybox.old/scripts/trylink	2015-05-29 06:54:59.000000000 +0800
+++ busybox/scripts/trylink	2015-05-29 07:00:58.215925813 +0800
@@ -1,4 +1,4 @@
-#!/usr/bin/env bash
+#!/bin/sh
 
 debug=false
 
@@ -46,19 +46,19 @@ try() {
 }
 
 check_cc() {
-    local tempname="/tmp/temp.$$.$RANDOM"
+    local tempname="$(mktemp)"
     # Can use "-o /dev/null", but older gcc tend to *unlink it* on failure! :(
     # "-xc": C language. "/dev/null" is an empty source file.
-    if $CC $1 -shared -xc /dev/null -o "$tempname".o >/dev/null 2>&1; then
+    if $CC $CPPFLAGS $CFLAGS $1 -shared -xc /dev/null -o "$tempname".o >/dev/null 2>&1; then
 	echo "$1";
     else
 	echo "$2";
     fi
-    rm "$tempname".o 2>/dev/null
+    rm -f "$tempname" "$tempname".o
 }
 
 check_libc_is_glibc() {
-    local tempname="/tmp/temp.$$.$RANDOM"
+    local tempname="$(mktemp)"
     echo "\
 	#include <stdlib.h>
 	/* Apparently uclibc defines __GLIBC__ (compat trick?). Oh well. */
@@ -66,12 +66,12 @@ check_libc_is_glibc() {
 	syntax error here
 	#endif
 	" >"$tempname".c
-    if $CC "$tempname".c -c -o "$tempname".o >/dev/null 2>&1; then
+    if $CC $CPPFLAGS $CFLAGS "$tempname".c -c -o "$tempname".o >/dev/null 2>&1; then
 	echo "$2";
     else
 	echo "$1";
     fi
-    rm "$tempname".c "$tempname".o 2>/dev/null
+    rm -f "$tempname" "$tempname".[co]
 }
 
 EXE="$1"
diff -Nurp busybox.old/selinux/built-in.o busybox/selinux/built-in.o
--- busybox.old/selinux/built-in.o	2015-05-29 06:55:23.000000000 +0800
+++ busybox/selinux/built-in.o	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-!<arch>
diff -Nurp busybox.old/selinux/.built-in.o.cmd busybox/selinux/.built-in.o.cmd
--- busybox.old/selinux/.built-in.o.cmd	2015-05-29 06:55:23.000000000 +0800
+++ busybox/selinux/.built-in.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-cmd_selinux/built-in.o :=  rm -f selinux/built-in.o; mips-openwrt-linux-uclibc-ar rcs selinux/built-in.o
diff -Nurp busybox.old/selinux/Config.in busybox/selinux/Config.in
--- busybox.old/selinux/Config.in	2015-05-29 06:55:00.000000000 +0800
+++ busybox/selinux/Config.in	1970-01-01 08:00:00.000000000 +0800
@@ -1,124 +0,0 @@
-# DO NOT EDIT. This file is generated from Config.src
-#
-# For a description of the syntax of this configuration file,
-# see scripts/kbuild/config-language.txt.
-#
-
-menu "SELinux Utilities"
-	depends on SELINUX
-
-
-config CHCON
-	bool "chcon"
-	default n
-	depends on SELINUX
-	help
-	  Enable support to change the security context of file.
-
-config FEATURE_CHCON_LONG_OPTIONS
-	bool "Enable long options"
-	default y
-	depends on CHCON && LONG_OPTS
-	help
-	  Support long options for the chcon applet.
-
-config GETENFORCE
-	bool "getenforce"
-	default n
-	depends on SELINUX
-	help
-	  Enable support to get the current mode of SELinux.
-
-config GETSEBOOL
-	bool "getsebool"
-	default n
-	depends on SELINUX
-	help
-	  Enable support to get SELinux boolean values.
-
-config LOAD_POLICY
-	bool "load_policy"
-	default n
-	depends on SELINUX
-	help
-	  Enable support to load SELinux policy.
-
-config MATCHPATHCON
-	bool "matchpathcon"
-	default n
-	depends on SELINUX
-	help
-	  Enable support to get default security context of the
-	  specified path from the file contexts configuration.
-
-config RESTORECON
-	bool "restorecon"
-	default n
-	depends on SELINUX
-	help
-	  Enable support to relabel files. The feature is almost
-	  the same as setfiles, but usage is a little different.
-
-config RUNCON
-	bool "runcon"
-	default n
-	depends on SELINUX
-	help
-	  Enable support to run command in speficied security context.
-
-config FEATURE_RUNCON_LONG_OPTIONS
-	bool "Enable long options"
-	default y
-	depends on RUNCON && LONG_OPTS
-	help
-	  Support long options for the runcon applet.
-
-config SELINUXENABLED
-	bool "selinuxenabled"
-	default n
-	depends on SELINUX
-	help
-	  Enable support for this command to be used within shell scripts
-	  to determine if selinux is enabled.
-
-config SETENFORCE
-	bool "setenforce"
-	default n
-	depends on SELINUX
-	help
-	  Enable support to modify the mode SELinux is running in.
-
-config SETFILES
-	bool "setfiles"
-	default n
-	depends on SELINUX
-	help
-	  Enable support to modify to relabel files.
-	  Notice: If you built libselinux with -D_FILE_OFFSET_BITS=64,
-	  (It is default in libselinux's Makefile), you _must_ enable
-	  CONFIG_LFS.
-
-config FEATURE_SETFILES_CHECK_OPTION
-	bool "Enable check option"
-	default n
-	depends on SETFILES
-	help
-	  Support "-c" option (check the validity of the contexts against
-	  the specified binary policy) for setfiles. Requires libsepol.
-
-config SETSEBOOL
-	bool "setsebool"
-	default n
-	depends on SELINUX
-	help
-	  Enable support for change boolean.
-	  semanage and -P option is not supported yet.
-
-config SESTATUS
-	bool "sestatus"
-	default n
-	depends on SELINUX
-	help
-	  Displays the status of SELinux.
-
-endmenu
diff -Nurp busybox.old/selinux/Config.src busybox/selinux/Config.src
--- busybox.old/selinux/Config.src	2015-03-23 11:06:55.000000000 +0800
+++ busybox/selinux/Config.src	2015-05-29 07:00:58.215925813 +0800
@@ -64,7 +64,7 @@ config RUNCON
 	default n
 	depends on SELINUX
 	help
-	  Enable support to run command in speficied security context.
+	  Enable support to run command in specified security context.
 
 config FEATURE_RUNCON_LONG_OPTIONS
 	bool "Enable long options"
diff -Nurp busybox.old/selinux/Kbuild busybox/selinux/Kbuild
--- busybox.old/selinux/Kbuild	2015-05-29 06:55:00.000000000 +0800
+++ busybox/selinux/Kbuild	1970-01-01 08:00:00.000000000 +0800
@@ -1,22 +0,0 @@
-# DO NOT EDIT. This file is generated from Kbuild.src
-# Makefile for busybox
-#
-# Copyright (C) 1999-2005 by Erik Andersen <andersen@codepoet.org>
-# Copyright (C) 2007 by KaiGai Kohei <kaigai@kaigai.gr.jp>
-#
-# Licensed under GPLv2, see file LICENSE in this source tree.
-
-lib-y:=
-
-lib-$(CONFIG_CHCON)		+= chcon.o
-lib-$(CONFIG_GETENFORCE)	+= getenforce.o
-lib-$(CONFIG_GETSEBOOL)		+= getsebool.o
-lib-$(CONFIG_LOAD_POLICY)	+= load_policy.o
-lib-$(CONFIG_MATCHPATHCON)	+= matchpathcon.o
-lib-$(CONFIG_RUNCON)		+= runcon.o
-lib-$(CONFIG_SELINUXENABLED)	+= selinuxenabled.o
-lib-$(CONFIG_SETENFORCE)	+= setenforce.o
-lib-$(CONFIG_SETFILES)		+= setfiles.o
-lib-$(CONFIG_RESTORECON)	+= setfiles.o
-lib-$(CONFIG_SETSEBOOL)		+= setsebool.o
-lib-$(CONFIG_SESTATUS)		+= sestatus.o
diff -Nurp busybox.old/selinux/lib.a busybox/selinux/lib.a
--- busybox.old/selinux/lib.a	2015-05-29 06:55:23.000000000 +0800
+++ busybox/selinux/lib.a	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-!<arch>
diff -Nurp busybox.old/selinux/.lib.a.cmd busybox/selinux/.lib.a.cmd
--- busybox.old/selinux/.lib.a.cmd	2015-05-29 06:55:23.000000000 +0800
+++ busybox/selinux/.lib.a.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-cmd_selinux/lib.a := rm -f selinux/lib.a; mips-openwrt-linux-uclibc-ar  rcs selinux/lib.a 
diff -Nurp busybox.old/shell/ash.c busybox/shell/ash.c
--- busybox.old/shell/ash.c	2015-05-29 06:54:59.000000000 +0800
+++ busybox/shell/ash.c	2015-05-29 07:00:58.219259146 +0800
@@ -598,8 +598,6 @@ out2str(const char *p)
 #define CTLVAR       ((unsigned char)'\202')    /* variable defn */
 #define CTLENDVAR    ((unsigned char)'\203')
 #define CTLBACKQ     ((unsigned char)'\204')
-#define CTLQUOTE 01             /* ored with CTLBACKQ code if in quotes */
-/*      CTLBACKQ | CTLQUOTE == '\205' */
 #define CTLARI       ((unsigned char)'\206')    /* arithmetic expression */
 #define CTLENDARI    ((unsigned char)'\207')
 #define CTLQUOTEMARK ((unsigned char)'\210')
@@ -608,7 +606,6 @@ out2str(const char *p)
 /* variable substitution byte (follows CTLVAR) */
 #define VSTYPE  0x0f            /* type of variable substitution */
 #define VSNUL   0x10            /* colon--treat the empty string as unset */
-#define VSQUOTE 0x80            /* inside double quotes--suppress splitting */
 
 /* values of VSTYPE field */
 #define VSNORMAL        0x1     /* normal variable:  $var or ${var} */
@@ -628,8 +625,9 @@ out2str(const char *p)
 #endif
 
 static const char dolatstr[] ALIGN1 = {
-	CTLVAR, VSNORMAL|VSQUOTE, '@', '=', '\0'
+	CTLQUOTEMARK, CTLVAR, VSNORMAL, '@', '=', CTLQUOTEMARK, '\0'
 };
+#define DOLATSTRLEN 6
 
 #define NCMD      0
 #define NPIPE     1
@@ -865,9 +863,7 @@ trace_puts_quoted(char *s)
 		case '\\': c = '\\'; goto backslash;
 		case CTLESC: c = 'e'; goto backslash;
 		case CTLVAR: c = 'v'; goto backslash;
-		case CTLVAR+CTLQUOTE: c = 'V'; goto backslash;
 		case CTLBACKQ: c = 'q'; goto backslash;
-		case CTLBACKQ+CTLQUOTE: c = 'Q'; goto backslash;
  backslash:
 			putc('\\', tracefile);
 			putc(c, tracefile);
@@ -1030,7 +1026,6 @@ sharg(union node *arg, FILE *fp)
 			putc('}', fp);
 			break;
 		case CTLBACKQ:
-		case CTLBACKQ|CTLQUOTE:
 			putc('$', fp);
 			putc('(', fp);
 			shtree(bqlist->n, -1, NULL, fp);
@@ -2030,7 +2025,7 @@ varcmp(const char *p, const char *q)
 	int c, d;
 
 	while ((c = *p) == (d = *q)) {
-		if (!c || c == '=')
+		if (c == '\0' || c == '=')
 			goto out;
 		p++;
 		q++;
@@ -2247,7 +2242,7 @@ setvar(const char *name, const char *val
 }
 
 static void FAST_FUNC
-setvar2(const char *name, const char *val)
+setvar0(const char *name, const char *val)
 {
 	setvar(name, val, 0);
 }
@@ -2310,7 +2305,7 @@ unsetvar(const char *s)
 			free(vp);
 			INT_ON;
 		} else {
-			setvar2(s, 0);
+			setvar0(s, NULL);
 			vp->flags &= ~VEXPORT;
 		}
  ok:
@@ -4413,11 +4408,7 @@ cmdputs(const char *s)
 				str = "${#";
 			else
 				str = "${";
-			if (!(subtype & VSQUOTE) == !(quoted & 1))
-				goto dostr;
-			quoted ^= 1;
-			c = '"';
-			break;
+			goto dostr;
 		case CTLENDVAR:
 			str = "\"}" + !(quoted & 1);
 			quoted >>= 1;
@@ -4426,9 +4417,6 @@ cmdputs(const char *s)
 		case CTLBACKQ:
 			str = "$(...)";
 			goto dostr;
-		case CTLBACKQ+CTLQUOTE:
-			str = "\"$(...)\"";
-			goto dostr;
 #if ENABLE_SH_MATH_SUPPORT
 		case CTLARI:
 			str = "$((";
@@ -5505,7 +5493,7 @@ ash_arith(const char *s)
 	arith_t result;
 
 	math_state.lookupvar = lookupvar;
-	math_state.setvar    = setvar2;
+	math_state.setvar    = setvar0;
 	//math_state.endofname = endofname;
 
 	INT_OFF;
@@ -5526,18 +5514,23 @@ ash_arith(const char *s)
 #define EXP_VARTILDE    0x4     /* expand tildes in an assignment */
 #define EXP_REDIR       0x8     /* file glob for a redirection (1 match only) */
 #define EXP_CASE        0x10    /* keeps quotes around for CASE pattern */
-#define EXP_RECORD      0x20    /* need to record arguments for ifs breakup */
+#define EXP_QPAT        0x20    /* pattern in quoted parameter expansion */
 #define EXP_VARTILDE2   0x40    /* expand tildes after colons only */
 #define EXP_WORD        0x80    /* expand word in parameter expansion */
-#define EXP_QWORD       0x100   /* expand word in quoted parameter expansion */
+#define EXP_QUOTED      0x100   /* expand word in double quotes */
 /*
  * rmescape() flags
  */
 #define RMESCAPE_ALLOC  0x1     /* Allocate a new string */
 #define RMESCAPE_GLOB   0x2     /* Add backslashes for glob */
-#define RMESCAPE_QUOTED 0x4     /* Remove CTLESC unless in quotes */
 #define RMESCAPE_GROW   0x8     /* Grow strings instead of stalloc */
 #define RMESCAPE_HEAP   0x10    /* Malloc strings instead of stalloc */
+#define RMESCAPE_SLASH  0x20    /* Stop globbing after slash */
+
+/* Add CTLESC when necessary. */
+#define QUOTES_ESC     (EXP_FULL | EXP_CASE | EXP_QPAT | EXP_REDIR)
+/* Do not skip NUL characters. */
+#define QUOTES_KEEPNUL EXP_TILDE
 
 /*
  * Structure specifying which parts of the string should be searched
@@ -5602,14 +5595,16 @@ esclen(const char *start, const char *p)
 static char *
 rmescapes(char *str, int flag)
 {
-	static const char qchars[] ALIGN1 = { CTLESC, CTLQUOTEMARK, '\0' };
+	static const char qchars[] ALIGN1 = {
+		IF_ASH_BASH_COMPAT('/',) CTLESC, CTLQUOTEMARK, '\0' };
 
 	char *p, *q, *r;
 	unsigned inquotes;
 	unsigned protect_against_glob;
 	unsigned globbing;
+	IF_ASH_BASH_COMPAT(unsigned slash = flag & RMESCAPE_SLASH;)
 
-	p = strpbrk(str, qchars);
+	p = strpbrk(str, qchars IF_ASH_BASH_COMPAT(+ !slash));
 	if (!p)
 		return str;
 
@@ -5636,13 +5631,11 @@ rmescapes(char *str, int flag)
 		}
 	}
 
-	inquotes = (flag & RMESCAPE_QUOTED) ^ RMESCAPE_QUOTED;
+	inquotes = 0;
 	globbing = flag & RMESCAPE_GLOB;
 	protect_against_glob = globbing;
 	while (*p) {
 		if ((unsigned char)*p == CTLQUOTEMARK) {
-// TODO: if no RMESCAPE_QUOTED in flags, inquotes never becomes 0
-// (alternates between RMESCAPE_QUOTED and ~RMESCAPE_QUOTED). Is it ok?
 // Note: both inquotes and protect_against_glob only affect whether
 // CTLESC,<ch> gets converted to <ch> or to \<ch>
 			inquotes = ~inquotes;
@@ -5650,17 +5643,23 @@ rmescapes(char *str, int flag)
 			protect_against_glob = globbing;
 			continue;
 		}
-		if (*p == '\\') {
-			/* naked back slash */
-			protect_against_glob = 0;
-			goto copy;
-		}
 		if ((unsigned char)*p == CTLESC) {
 			p++;
-			if (protect_against_glob && inquotes && *p != '/') {
+			if (protect_against_glob) {
 				*q++ = '\\';
 			}
+		} else if (*p == '\\' && !inquotes) {
+			/* naked back slash */
+			protect_against_glob = 0;
+			goto copy;
 		}
+#if ENABLE_ASH_BASH_COMPAT
+		else if (*p == '/' && slash) {
+			/* stop handling globbing and mark location of slash */
+			globbing = slash = 0;
+			*p = CTLESC;
+		}
+#endif
 		protect_against_glob = globbing;
  copy:
 		*q++ = *p++;
@@ -5680,13 +5679,9 @@ rmescapes(char *str, int flag)
  * Returns an stalloced string.
  */
 static char *
-preglob(const char *pattern, int quoted, int flag)
+preglob(const char *pattern, int flag)
 {
-	flag |= RMESCAPE_GLOB;
-	if (quoted) {
-		flag |= RMESCAPE_QUOTED;
-	}
-	return rmescapes((char *)pattern, flag);
+	return rmescapes((char *)pattern, flag | RMESCAPE_GLOB);
 }
 
 /*
@@ -5695,29 +5690,36 @@ preglob(const char *pattern, int quoted,
 static void
 memtodest(const char *p, size_t len, int syntax, int quotes)
 {
-	char *q = expdest;
+	char *q;
+
+	if (!len)
+		return;
 
-	q = makestrspace(quotes ? len * 2 : len, q);
+	q = makestrspace((quotes & QUOTES_ESC) ? len * 2 : len, expdest);
 
-	while (len--) {
+	do {
 		unsigned char c = *p++;
-		if (c == '\0')
-			continue;
-		if (quotes) {
+		if (c) {
 			int n = SIT(c, syntax);
-			if (n == CCTL || n == CBACK)
+			if ((quotes & QUOTES_ESC) &&
+					((n == CCTL) ||
+					(((quotes & EXP_FULL) || syntax != BASESYNTAX) &&
+					n == CBACK)))
 				USTPUTC(CTLESC, q);
-		}
+		} else if (!(quotes & QUOTES_KEEPNUL))
+			continue;
 		USTPUTC(c, q);
-	}
+	} while (--len);
 
 	expdest = q;
 }
 
-static void
+static size_t
 strtodest(const char *p, int syntax, int quotes)
 {
-	memtodest(p, strlen(p), syntax, quotes);
+	size_t len = strlen(p);
+	memtodest(p, len, syntax, quotes);
+	return len;
 }
 
 /*
@@ -5790,8 +5792,7 @@ exptilde(char *startp, char *p, int flag
 	char *name;
 	struct passwd *pw;
 	const char *home;
-	int quotes = flags & (EXP_FULL | EXP_CASE | EXP_REDIR);
-	int startloc;
+	int quotes = flags & QUOTES_ESC;
 
 	name = p + 1;
 
@@ -5823,9 +5824,7 @@ exptilde(char *startp, char *p, int flag
 	if (!home || !*home)
 		goto lose;
 	*p = c;
-	startloc = expdest - (char *)stackblock();
 	strtodest(home, SQSYNTAX, quotes);
-	recordregion(startloc, expdest - (char *)stackblock(), 0);
 	return p;
  lose:
 	*p = c;
@@ -5898,7 +5897,7 @@ evalbackcmd(union node *n, struct backcm
  * Expand stuff in backwards quotes.
  */
 static void
-expbackq(union node *cmd, int quoted, int quotes)
+expbackq(union node *cmd, int flag)
 {
 	struct backcmd in;
 	int i;
@@ -5906,7 +5905,7 @@ expbackq(union node *cmd, int quoted, in
 	char *p;
 	char *dest;
 	int startloc;
-	int syntax = quoted ? DQSYNTAX : BASESYNTAX;
+	int syntax = flag & EXP_QUOTED ? DQSYNTAX : BASESYNTAX;
 	struct stackmark smark;
 
 	INT_OFF;
@@ -5922,11 +5921,11 @@ expbackq(union node *cmd, int quoted, in
 	if (i == 0)
 		goto read;
 	for (;;) {
-		memtodest(p, i, syntax, quotes);
+		memtodest(p, i, syntax, flag & QUOTES_ESC);
  read:
 		if (in.fd < 0)
 			break;
-		i = nonblock_immune_read(in.fd, buf, sizeof(buf), /*loop_on_EINTR:*/ 1);
+		i = nonblock_immune_read(in.fd, buf, sizeof(buf));
 		TRACE(("expbackq: read returns %d\n", i));
 		if (i <= 0)
 			break;
@@ -5946,7 +5945,7 @@ expbackq(union node *cmd, int quoted, in
 		STUNPUTC(dest);
 	expdest = dest;
 
-	if (quoted == 0)
+	if (!(flag & EXP_QUOTED))
 		recordregion(startloc, dest - (char *)stackblock(), 0);
 	TRACE(("evalbackq: size:%d:'%.*s'\n",
 		(int)((dest - (char *)stackblock()) - startloc),
@@ -5960,11 +5959,10 @@ expbackq(union node *cmd, int quoted, in
  * evaluate, place result in (backed up) result, adjust string position.
  */
 static void
-expari(int quotes)
+expari(int flag)
 {
 	char *p, *start;
 	int begoff;
-	int flag;
 	int len;
 
 	/* ifsfree(); */
@@ -6002,16 +6000,14 @@ expari(int quotes)
 
 	removerecordregions(begoff);
 
-	flag = p[1];
-
 	expdest = p;
 
-	if (quotes)
-		rmescapes(p + 2, 0);
+	if (flag & QUOTES_ESC)
+		rmescapes(p + 1, 0);
 
-	len = cvtnum(ash_arith(p + 2));
+	len = cvtnum(ash_arith(p + 1));
 
-	if (flag != '"')
+	if (!(flag & EXP_QUOTED))
 		recordregion(begoff, begoff + len, 0);
 }
 #endif
@@ -6039,15 +6035,13 @@ argstr(char *p, int flags, struct strlis
 		CTLESC,
 		CTLVAR,
 		CTLBACKQ,
-		CTLBACKQ | CTLQUOTE,
 #if ENABLE_SH_MATH_SUPPORT
 		CTLENDARI,
 #endif
 		'\0'
 	};
 	const char *reject = spclchars;
-	int quotes = flags & (EXP_FULL | EXP_CASE | EXP_REDIR); /* do CTLESC */
-	int breakall = flags & EXP_WORD;
+	int breakall = (flags & (EXP_WORD | EXP_QUOTED)) == EXP_WORD;
 	int inquotes;
 	size_t length;
 	int startloc;
@@ -6065,8 +6059,6 @@ argstr(char *p, int flags, struct strlis
 		flags &= ~EXP_TILDE;
  tilde:
 		q = p;
-		if ((unsigned char)*q == CTLESC && (flags & EXP_QWORD))
-			q++;
 		if (*q == '~')
 			p = exptilde(p, q, flags);
 	}
@@ -6123,19 +6115,14 @@ argstr(char *p, int flags, struct strlis
 		case CTLENDVAR: /* ??? */
 			goto breakloop;
 		case CTLQUOTEMARK:
+			inquotes ^= EXP_QUOTED;
 			/* "$@" syntax adherence hack */
-			if (!inquotes
-			 && memcmp(p, dolatstr, 4) == 0
-			 && (  p[4] == (char)CTLQUOTEMARK
-			    || (p[4] == (char)CTLENDVAR && p[5] == (char)CTLQUOTEMARK)
-			    )
-			) {
-				p = evalvar(p + 1, flags, /* var_str_list: */ NULL) + 1;
+			if (inquotes && !memcmp(p, dolatstr + 1, DOLATSTRLEN - 1)) {
+				p = evalvar(p + 1, flags | inquotes, /* var_str_list: */ NULL) + 1;
 				goto start;
 			}
-			inquotes = !inquotes;
  addquote:
-			if (quotes) {
+			if (flags & QUOTES_ESC) {
 				p--;
 				length++;
 				startloc++;
@@ -6144,22 +6131,30 @@ argstr(char *p, int flags, struct strlis
 		case CTLESC:
 			startloc++;
 			length++;
+
+			/*
+			 * Quoted parameter expansion pattern: remove quote
+			 * unless inside inner quotes or we have a literal
+			 * backslash.
+			 */
+			if (((flags | inquotes) & (EXP_QPAT | EXP_QUOTED)) ==
+			    EXP_QPAT && *p != '\\')
+				break;
+
 			goto addquote;
 		case CTLVAR:
 			TRACE(("argstr: evalvar('%s')\n", p));
-			p = evalvar(p, flags, var_str_list);
+			p = evalvar(p, flags | inquotes, var_str_list);
 			TRACE(("argstr: evalvar:'%s'\n", (char *)stackblock()));
 			goto start;
 		case CTLBACKQ:
-			c = '\0';
-		case CTLBACKQ|CTLQUOTE:
-			expbackq(argbackq->n, c, quotes);
+			expbackq(argbackq->n, flags | inquotes);
 			argbackq = argbackq->next;
 			goto start;
 #if ENABLE_SH_MATH_SUPPORT
 		case CTLENDARI:
 			p--;
-			expari(quotes);
+			expari(flags | inquotes);
 			goto start;
 #endif
 		}
@@ -6289,60 +6284,17 @@ varunset(const char *end, const char *va
 	ash_msg_and_raise_error("%.*s: %s%s", (int)(end - var - 1), var, msg, tail);
 }
 
-#if ENABLE_ASH_BASH_COMPAT
-static char *
-parse_sub_pattern(char *arg, int varflags)
-{
-	char *idx, *repl = NULL;
-	unsigned char c;
-
-	//char *org_arg = arg;
-	//bb_error_msg("arg:'%s' varflags:%x", arg, varflags);
-	idx = arg;
-	while (1) {
-		c = *arg;
-		if (!c)
-			break;
-		if (c == '/') {
-			/* Only the first '/' seen is our separator */
-			if (!repl) {
-				repl = idx + 1;
-				c = '\0';
-			}
-		}
-		*idx++ = c;
-		arg++;
-		/*
-		 * Example: v='ab\c'; echo ${v/\\b/_\\_\z_}
-		 * The result is a_\_z_c (not a\_\_z_c)!
-		 *
-		 * Enable debug prints in this function and you'll see:
-		 * ash: arg:'\\b/_\\_z_' varflags:d
-		 * ash: pattern:'\\b' repl:'_\_z_'
-		 * That is, \\b is interpreted as \\b, but \\_ as \_!
-		 * IOW: search pattern and replace string treat backslashes
-		 * differently! That is the reason why we check repl below:
-		 */
-		if (c == '\\' && *arg == '\\' && repl && !(varflags & VSQUOTE))
-			arg++; /* skip both '\', not just first one */
-	}
-	*idx = c; /* NUL */
-	//bb_error_msg("pattern:'%s' repl:'%s'", org_arg, repl);
-
-	return repl;
-}
-#endif /* ENABLE_ASH_BASH_COMPAT */
-
 static const char *
 subevalvar(char *p, char *varname, int strloc, int subtype,
-		int startloc, int varflags, int quotes, struct strlist *var_str_list)
+		int startloc, int varflags, int flag, struct strlist *var_str_list)
 {
 	struct nodelist *saveargbackq = argbackq;
+	int quotes = flag & QUOTES_ESC;
 	char *startp;
 	char *loc;
 	char *rmesc, *rmescend;
 	char *str;
-	IF_ASH_BASH_COMPAT(const char *repl = NULL;)
+	IF_ASH_BASH_COMPAT(char *repl = NULL;)
 	IF_ASH_BASH_COMPAT(int pos, len, orig_len;)
 	int saveherefd = herefd;
 	int amount, resetloc;
@@ -6354,7 +6306,8 @@ subevalvar(char *p, char *varname, int s
 	//		p, varname, strloc, subtype, startloc, varflags, quotes);
 
 	herefd = -1;
-	argstr(p, (subtype != VSASSIGN && subtype != VSQUESTION) ? EXP_CASE : 0,
+	argstr(p, EXP_TILDE | (subtype != VSASSIGN && subtype != VSQUESTION ?
+			(flag & (EXP_QUOTED | EXP_QPAT) ? EXP_QPAT : EXP_CASE) : 0),
 			var_str_list);
 	STPUTC('\0', expdest);
 	herefd = saveherefd;
@@ -6363,7 +6316,7 @@ subevalvar(char *p, char *varname, int s
 
 	switch (subtype) {
 	case VSASSIGN:
-		setvar2(varname, startp);
+		setvar0(varname, startp);
 		amount = startp - expdest;
 		STADJUST(amount, expdest);
 		return startp;
@@ -6466,7 +6419,17 @@ subevalvar(char *p, char *varname, int s
 	}
 	rmescend--;
 	str = (char *)stackblock() + strloc;
-	preglob(str, varflags & VSQUOTE, 0);
+	/*
+	 * Example: v='a\bc'; echo ${v/\\b/_\\_\z_}
+	 * The result is a_\_z_c (not a\_\_z_c)!
+	 *
+	 * The search pattern and replace string treat backslashes differently!
+	 * RMESCAPE_SLASH causes preglob to work differently on the pattern
+	 * and string.  It's only used on the first call.
+	 */
+	preglob(str, IF_ASH_BASH_COMPAT(
+		(subtype == VSREPLACE || subtype == VSREPLACEALL) && !repl ?
+			RMESCAPE_SLASH :) 0);
 
 #if ENABLE_ASH_BASH_COMPAT
 	workloc = expdest - (char *)stackblock();
@@ -6474,11 +6437,12 @@ subevalvar(char *p, char *varname, int s
 		char *idx, *end;
 
 		if (!repl) {
-			repl = parse_sub_pattern(str, varflags);
-			//bb_error_msg("repl:'%s'", repl);
-			if (!repl)
+			if ((repl=strchr(str, CTLESC)))
+				*repl++ = '\0';
+			else
 				repl = nullstr;
 		}
+		//bb_error_msg("str:'%s' repl:'%s'", str, repl);
 
 		/* If there's no pattern to match, return the expansion unmolested */
 		if (str[0] == '\0')
@@ -6611,13 +6575,16 @@ varvalue(char *name, int varflags, int f
 	const char *p;
 	int num;
 	int i;
-	int sepq = 0;
 	ssize_t len = 0;
+	int sep;
+	int quoted = flags & EXP_QUOTED;
 	int subtype = varflags & VSTYPE;
-	int quotes = flags & (EXP_FULL | EXP_CASE | EXP_REDIR);
-	int quoted = varflags & VSQUOTE;
+	int discard = subtype == VSPLUS || subtype == VSLENGTH;
+	int quotes = (discard ? 0 : (flags & QUOTES_ESC)) | QUOTES_KEEPNUL;
 	int syntax = quoted ? DQSYNTAX : BASESYNTAX;
 
+	sep = quoted ? ((flags & EXP_FULL) << CHAR_BIT) : 0;
+
 	switch (*name) {
 	case '$':
 		num = rootpid;
@@ -6652,7 +6619,7 @@ varvalue(char *name, int varflags, int f
 		break;
 	case '@': {
 		char **ap;
-		int sep;
+		char sepc;
 
 		if (quoted && (flags & EXP_FULL)) {
 			/* note: this is not meant as PEOF value */
@@ -6662,39 +6629,20 @@ varvalue(char *name, int varflags, int f
 		/* fall through */
 	case '*':
 		sep = ifsset() ? (unsigned char)(ifsval()[0]) : ' ';
-		i = SIT(sep, syntax);
-		if (quotes && (i == CCTL || i == CBACK))
-			sepq = 1;
  param:
 		ap = shellparam.p;
+		sepc = sep;
 		if (!ap)
 			return -1;
 		while ((p = *ap++) != NULL) {
-			size_t partlen;
-
-			partlen = strlen(p);
-			len += partlen;
-
-			if (!(subtype == VSPLUS || subtype == VSLENGTH))
-				memtodest(p, partlen, syntax, quotes);
+			len += strtodest(p, syntax, quotes);
 
 			if (*ap && sep) {
-				char *q;
-
 				len++;
-				if (subtype == VSPLUS || subtype == VSLENGTH) {
-					continue;
-				}
-				q = expdest;
-				if (sepq)
-					STPUTC(CTLESC, q);
-				/* note: may put NUL despite sep != 0
-				 * (see sep = 1 << CHAR_BIT above) */
-				STPUTC(sep, q);
-				expdest = q;
+				memtodest(&sepc, 1, syntax, quotes);
 			}
 		}
-		return len;
+		break;
 	} /* case '@' and '*' */
 	case '0':
 	case '1':
@@ -6743,9 +6691,7 @@ varvalue(char *name, int varflags, int f
 		if (!p)
 			return -1;
 
-		len = strlen(p);
-		if (!(subtype == VSPLUS || subtype == VSLENGTH))
-			memtodest(p, len, syntax, quotes);
+		len = strtodest(p, syntax, quotes);
 #if ENABLE_UNICODE_SUPPORT
 		if (subtype == VSLENGTH && len > 0) {
 			reinit_unicode_for_ash();
@@ -6754,10 +6700,10 @@ varvalue(char *name, int varflags, int f
 			}
 		}
 #endif
-		return len;
+		break;
 	}
 
-	if (subtype == VSPLUS || subtype == VSLENGTH)
+	if (discard)
 		STADJUST(-len, expdest);
 	return len;
 }
@@ -6771,7 +6717,7 @@ evalvar(char *p, int flags, struct strli
 {
 	char varflags;
 	char subtype;
-	char quoted;
+	int quoted;
 	char easy;
 	char *var;
 	int patloc;
@@ -6780,7 +6726,7 @@ evalvar(char *p, int flags, struct strli
 
 	varflags = (unsigned char) *p++;
 	subtype = varflags & VSTYPE;
-	quoted = varflags & VSQUOTE;
+	quoted = flags & EXP_QUOTED;
 	var = p;
 	easy = (!quoted || (*var == '@' && shellparam.nparam));
 	startloc = expdest - (char *)stackblock();
@@ -6801,7 +6747,7 @@ evalvar(char *p, int flags, struct strli
 		if (varlen < 0) {
 			argstr(
 				p,
-				flags | (quoted ? EXP_TILDE|EXP_QWORD : EXP_TILDE|EXP_WORD),
+				flags | EXP_TILDE | EXP_WORD,
 				var_str_list
 			);
 			goto end;
@@ -6815,7 +6761,7 @@ evalvar(char *p, int flags, struct strli
 		if (varlen < 0) {
 			if (subevalvar(p, var, /* strloc: */ 0,
 					subtype, startloc, varflags,
-					/* quotes: */ 0,
+					/* quotes: */ flags & ~QUOTES_ESC,
 					var_str_list)
 			) {
 				varflags &= ~VSNUL;
@@ -6872,10 +6818,7 @@ evalvar(char *p, int flags, struct strli
 		STPUTC('\0', expdest);
 		patloc = expdest - (char *)stackblock();
 		if (NULL == subevalvar(p, /* varname: */ NULL, patloc, subtype,
-				startloc, varflags,
-				/* quotes: */ flags & (EXP_FULL | EXP_CASE | EXP_REDIR),
-				var_str_list)
-		) {
+				startloc, varflags, flags, var_str_list)) {
 			int amount = expdest - (
 				(char *)stackblock() + patloc - 1
 			);
@@ -6894,7 +6837,7 @@ evalvar(char *p, int flags, struct strli
 			unsigned char c = *p++;
 			if (c == CTLESC)
 				p++;
-			else if (c == CTLBACKQ || c == (CTLBACKQ|CTLQUOTE)) {
+			else if (c == CTLBACKQ) {
 				if (varlen >= 0)
 					argbackq = argbackq->next;
 			} else if (c == CTLVAR) {
@@ -7230,7 +7173,7 @@ expandmeta(struct strlist *str /*, int f
 		savelastp = exparg.lastp;
 
 		INT_OFF;
-		p = preglob(str->text, 0, RMESCAPE_ALLOC | RMESCAPE_HEAP);
+		p = preglob(str->text, RMESCAPE_ALLOC | RMESCAPE_HEAP);
 		{
 			int i = strlen(str->text);
 			expdir = ckmalloc(i < 2048 ? 2048 : i); /* XXX */
@@ -7320,7 +7263,7 @@ static void
 expandhere(union node *arg, int fd)
 {
 	herefd = fd;
-	expandarg(arg, (struct arglist *)NULL, 0);
+	expandarg(arg, (struct arglist *)NULL, EXP_QUOTED);
 	full_write(fd, stackblock(), expdest - (char *)stackblock());
 }
 
@@ -7330,7 +7273,7 @@ expandhere(union node *arg, int fd)
 static int
 patmatch(char *pattern, const char *string)
 {
-	return pmatch(preglob(pattern, 0, 0), string);
+	return pmatch(preglob(pattern, 0), string);
 }
 
 /*
@@ -8583,7 +8526,7 @@ evalfor(union node *n, int flags)
 	arglist.list = NULL;
 	arglist.lastp = &arglist.list;
 	for (argp = n->nfor.args; argp; argp = argp->narg.next) {
-		expandarg(argp, &arglist, EXP_FULL | EXP_TILDE | EXP_RECORD);
+		expandarg(argp, &arglist, EXP_FULL | EXP_TILDE);
 		/* XXX */
 		if (evalskip)
 			goto out;
@@ -8594,7 +8537,7 @@ evalfor(union node *n, int flags)
 	loopnest++;
 	flags &= EV_TESTED;
 	for (sp = arglist.list; sp; sp = sp->next) {
-		setvar2(n->nfor.var, sp->text);
+		setvar0(n->nfor.var, sp->text);
 		evaltree(n->nfor.body, flags);
 		if (evalskip) {
 			if (evalskip == SKIPCONT && --skipcount <= 0) {
@@ -8961,26 +8904,12 @@ parse_command_args(char **argv, const ch
 }
 #endif
 
-static bool
-findlocal(struct var *vp)
-{
-	struct localvar *lvp = localvars;
-
-	while (lvp) {
-		if (lvp->vp == vp)
-			return true;
-
-		lvp = lvp->next;
-	}
-
-	return false;
-}
-
 /*
  * Make a variable a local variable.  When a variable is made local, it's
  * value and flags are saved in a localvar structure.  The saved values
  * will be restored when the shell function returns.  We handle the name
- * "-" as a special case.
+ * "-" as a special case: it makes changes to "set +-options" local
+ * (options will be restored on return from the function).
  */
 static void
 mklocal(char *name)
@@ -8988,21 +8917,37 @@ mklocal(char *name)
 	struct localvar *lvp;
 	struct var **vpp;
 	struct var *vp;
+	char *eq = strchr(name, '=');
 
 	INT_OFF;
-	lvp = ckzalloc(sizeof(struct localvar));
+	/* Cater for duplicate "local". Examples:
+	 * x=0; f() { local x=1; echo $x; local x; echo $x; }; f; echo $x
+	 * x=0; f() { local x=1; echo $x; local x=2; echo $x; }; f; echo $x
+	 */
+	lvp = localvars;
+	while (lvp) {
+		if (lvp->vp && varcmp(lvp->vp->var_text, name) == 0) {
+			if (eq)
+				setvareq(name, 0);
+			/* else:
+			 * it's a duplicate "local VAR" declaration, do nothing
+			 */
+			return;
+		}
+		lvp = lvp->next;
+	}
+
+	lvp = ckzalloc(sizeof(*lvp));
 	if (LONE_DASH(name)) {
 		char *p;
 		p = ckmalloc(sizeof(optlist));
 		lvp->text = memcpy(p, optlist, sizeof(optlist));
 		vp = NULL;
 	} else {
-		char *eq;
-
 		vpp = hashvar(name);
 		vp = *findvar(vpp, name);
-		eq = strchr(name, '=');
 		if (vp == NULL) {
+			/* variable did not exist yet */
 			if (eq)
 				setvareq(name, VSTRFIXED);
 			else
@@ -9012,12 +8957,15 @@ mklocal(char *name)
 		} else {
 			lvp->text = vp->var_text;
 			lvp->flags = vp->flags;
+			/* make sure neither "struct var" nor string gets freed
+			 * during (un)setting:
+			 */
 			vp->flags |= VSTRFIXED|VTEXTFIXED;
 			if (eq)
 				setvareq(name, 0);
-			else if (!findlocal(vp))
+			else
 				/* "local VAR" unsets VAR: */
-				setvar(name, NULL, 0);
+				setvar0(name, NULL);
 		}
 	}
 	lvp->vp = vp;
@@ -9509,7 +9457,7 @@ evalcommand(union node *cmd, int flags)
 		 * '_' in 'vi' command mode during line editing...
 		 * However I implemented that within libedit itself.
 		 */
-		setvar2("_", lastarg);
+		setvar0("_", lastarg);
 	}
 	popstackmark(&smark);
 }
@@ -9695,7 +9643,7 @@ preadfd(void)
 #if ENABLE_FEATURE_EDITING
  retry:
 	if (!iflag || g_parsefile->pf_fd != STDIN_FILENO)
-		nr = nonblock_immune_read(g_parsefile->pf_fd, buf, IBUFSIZ - 1, /*loop_on_EINTR:*/ 1);
+		nr = nonblock_immune_read(g_parsefile->pf_fd, buf, IBUFSIZ - 1);
 	else {
 		int timeout = -1;
 # if ENABLE_ASH_IDLE_TIMEOUT
@@ -9737,7 +9685,7 @@ preadfd(void)
 		}
 	}
 #else
-	nr = nonblock_immune_read(g_parsefile->pf_fd, buf, IBUFSIZ - 1, /*loop_on_EINTR:*/ 1);
+	nr = nonblock_immune_read(g_parsefile->pf_fd, buf, IBUFSIZ - 1);
 #endif
 
 #if 0 /* disabled: nonblock_immune_read() handles this problem */
@@ -10571,7 +10519,7 @@ static union node *andor(void);
 static union node *pipeline(void);
 static union node *parse_command(void);
 static void parseheredoc(void);
-static char peektoken(void);
+static char nexttoken_ends_list(void);
 static int readtoken(void);
 
 static union node *
@@ -10581,7 +10529,7 @@ list(int nlflag)
 	int tok;
 
 	checkkwd = CHKNL | CHKKWD | CHKALIAS;
-	if (nlflag == 2 && peektoken())
+	if (nlflag == 2 && nexttoken_ends_list())
 		return NULL;
 	n1 = NULL;
 	for (;;) {
@@ -10623,8 +10571,15 @@ list(int nlflag)
 				tokpushback = 1;
 			}
 			checkkwd = CHKNL | CHKKWD | CHKALIAS;
-			if (peektoken())
+			if (nexttoken_ends_list()) {
+				/* Testcase: "<<EOF; then <W".
+				 * It used to segfault w/o this check:
+				 */
+				if (heredoclist) {
+					raise_error_unexpected_syntax(-1);
+				}
 				return n1;
+			}
 			break;
 		case TEOF:
 			if (heredoclist)
@@ -11261,11 +11216,9 @@ readtoken1(int c, int syntax, char *eofm
 				 && c != '$'
 				 && (c != '"' || eofmark != NULL)
 				) {
-					USTPUTC(CTLESC, out);
 					USTPUTC('\\', out);
 				}
-				if (SIT(c, SQSYNTAX) == CCTL)
-					USTPUTC(CTLESC, out);
+				USTPUTC(CTLESC, out);
 				USTPUTC(c, out);
 				quotef = 1;
 			}
@@ -11283,9 +11236,7 @@ readtoken1(int c, int syntax, char *eofm
 			goto quotemark;
 		case CENDQUOTE:
 			IF_ASH_BASH_COMPAT(bash_dollar_squote = 0;)
-			if (eofmark != NULL && arinest == 0
-			 && varnest == 0
-			) {
+			if (eofmark != NULL && varnest == 0) {
 				USTPUTC(c, out);
 			} else {
 				if (dqvarnest == 0) {
@@ -11319,10 +11270,9 @@ readtoken1(int c, int syntax, char *eofm
 				parenlevel--;
 			} else {
 				if (pgetc() == ')') {
+					c = CTLENDARI;
 					if (--arinest == 0) {
 						syntax = prevsyntax;
-						dblquote = (syntax == DQSYNTAX);
-						c = CTLENDARI;
 					}
 				} else {
 					/*
@@ -11641,12 +11591,10 @@ parsesub: {
  do_pungetc:
 			pungetc();
 		}
-		if (dblquote || arinest)
-			flags |= VSQUOTE;
 		((unsigned char *)stackblock())[typeloc] = subtype | flags;
 		if (subtype != VSNORMAL) {
 			varnest++;
-			if (dblquote || arinest) {
+			if (dblquote) {
 				dqvarnest++;
 			}
 		}
@@ -11796,10 +11744,7 @@ parsebackq: {
 	}
 	parsebackquote = savepbq;
 	exception_handler = savehandler;
-	if (arinest || dblquote)
-		USTPUTC(CTLBACKQ | CTLQUOTE, out);
-	else
-		USTPUTC(CTLBACKQ, out);
+	USTPUTC(CTLBACKQ, out);
 	if (oldstyle)
 		goto parsebackq_oldreturn;
 	goto parsebackq_newreturn;
@@ -11813,18 +11758,8 @@ parsearith: {
 	if (++arinest == 1) {
 		prevsyntax = syntax;
 		syntax = ARISYNTAX;
-		USTPUTC(CTLARI, out);
-		if (dblquote)
-			USTPUTC('"', out);
-		else
-			USTPUTC(' ', out);
-	} else {
-		/*
-		 * we collapse embedded arithmetic expansion to
-		 * parenthesis, which should be equivalent
-		 */
-		USTPUTC('(', out);
 	}
+	USTPUTC(CTLARI, out);
 	goto parsearith_return;
 }
 #endif
@@ -12061,7 +11996,7 @@ readtoken(void)
 }
 
 static char
-peektoken(void)
+nexttoken_ends_list(void)
 {
 	int t;
 
@@ -12139,7 +12074,7 @@ expandstr(const char *ps)
 	n.narg.text = wordtext;
 	n.narg.backquote = backquotelist;
 
-	expandarg(&n, NULL, 0);
+	expandarg(&n, NULL, EXP_QUOTED);
 	return stackblock();
 }
 #endif
@@ -12896,7 +12831,7 @@ readcmd(int argc UNUSED_PARAM, char **ar
 	 * to jump out of it.
 	 */
 	INT_OFF;
-	r = shell_builtin_read(setvar2,
+	r = shell_builtin_read(setvar0,
 		argptr,
 		bltinlookup("IFS"), /* can be NULL */
 		read_flags,
@@ -13057,14 +12992,14 @@ init(void)
 			}
 		}
 
-		setvar2("PPID", utoa(getppid()));
+		setvar0("PPID", utoa(getppid()));
 #if ENABLE_ASH_BASH_COMPAT
 		p = lookupvar("SHLVL");
 		setvar("SHLVL", utoa((p ? atoi(p) : 0) + 1), VEXPORT);
 		if (!lookupvar("HOSTNAME")) {
 			struct utsname uts;
 			uname(&uts);
-			setvar2("HOSTNAME", uts.nodename);
+			setvar0("HOSTNAME", uts.nodename);
 		}
 #endif
 		p = lookupvar("PWD");
@@ -13320,7 +13255,7 @@ int ash_main(int argc UNUSED_PARAM, char
 				hp = lookupvar("HOME");
 				if (hp) {
 					hp = concat_path_file(hp, ".ash_history");
-					setvar2("HISTFILE", hp);
+					setvar0("HISTFILE", hp);
 					free((char*)hp);
 					hp = lookupvar("HISTFILE");
 				}
Binary files busybox.old/shell/ash.o and busybox/shell/ash.o differ
diff -Nurp busybox.old/shell/.ash.o.cmd busybox/shell/.ash.o.cmd
--- busybox.old/shell/.ash.o.cmd	2015-05-29 06:55:24.000000000 +0800
+++ busybox/shell/.ash.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,241 +0,0 @@
-cmd_shell/ash.o := mips-openwrt-linux-uclibc-gcc -Wp,-MD,shell/.ash.o.d   -std=gnu99 -Iinclude -Ilibbb  -include include/autoconf.h -D_GNU_SOURCE -DNDEBUG -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -D"BB_VER=KBUILD_STR(1.23.2)" -DBB_BT=AUTOCONF_TIMESTAMP  -Wall -Wshadow -Wwrite-strings -Wundef -Wstrict-prototypes -Wunused -Wunused-parameter -Wunused-function -Wunused-value -Wmissing-prototypes -Wmissing-declarations -Wno-format-security -Wdeclaration-after-statement -Wold-style-definition -fno-builtin-strlen -finline-limit=0 -fomit-frame-pointer -ffunction-sections -fdata-sections -fno-guess-branch-probability -funsigned-char -falign-functions=1 -falign-jumps=1 -falign-labels=1 -falign-loops=1 -fno-unwind-tables -fno-asynchronous-unwind-tables -Os  -Os -pipe -mno-branch-likely -mips32r2 -mtune=74kc -fno-caller-saves -fhonour-copts -Wno-error=unused-but-set-variable -msoft-float -mips16 -minterlink-mips16   -D"KBUILD_STR(s)=\#s" -D"KBUILD_BASENAME=KBUILD_STR(ash)"  -D"KBUILD_MODNAME=KBUILD_STR(ash)" -c -o shell/ash.o shell/ash.c
-
-deps_shell/ash.o := \
-  shell/ash.c \
-    $(wildcard include/config/ash/job/control.h) \
-    $(wildcard include/config/sh/math/support.h) \
-    $(wildcard include/config/ash/random/support.h) \
-    $(wildcard include/config/feature/sh/standalone.h) \
-    $(wildcard include/config/ash.h) \
-    $(wildcard include/config/feature/sh/is/ash.h) \
-    $(wildcard include/config/feature/bash/is/ash.h) \
-    $(wildcard include/config/ash/bash/compat.h) \
-    $(wildcard include/config/ash/optimize/for/size.h) \
-    $(wildcard include/config/ash/alias.h) \
-    $(wildcard include/config/ash/getopts.h) \
-    $(wildcard include/config/locale/support.h) \
-    $(wildcard include/config/ash/mail.h) \
-    $(wildcard include/config/feature/editing/savehistory.h) \
-    $(wildcard include/config/feature/editing.h) \
-    $(wildcard include/config/feature/editing/fancy/prompt.h) \
-    $(wildcard include/config/feature/check/unicode/in/env.h) \
-    $(wildcard include/config/unicode/using/locale.h) \
-    $(wildcard include/config/ash/expand/prmt.h) \
-    $(wildcard include/config/feature/editing/max/len.h) \
-    $(wildcard include/config/unicode/support.h) \
-    $(wildcard include/config/ash/cmdcmd.h) \
-    $(wildcard include/config/feature/sh/extra/quiet.h) \
-    $(wildcard include/config/ash/help.h) \
-    $(wildcard include/config/feature/editing/vi.h) \
-    $(wildcard include/config/ash/builtin/echo.h) \
-    $(wildcard include/config/ash/builtin/printf.h) \
-    $(wildcard include/config/ash/builtin/test.h) \
-    $(wildcard include/config/feature/sh/nofork.h) \
-    $(wildcard include/config/ash/idle/timeout.h) \
-    $(wildcard include/config/feature/tab/completion.h) \
-    $(wildcard include/config/feature/editing/save/on/exit.h) \
-    $(wildcard include/config/feature/sh/histfilesize.h) \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/paths.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/features.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_config.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/cdefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sgidefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigset.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/fnmatch.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/times.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wordsize.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/typesizes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/utsname.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/utsname.h \
-  include/busybox.h \
-    $(wildcard include/config/feature/suid.h) \
-    $(wildcard include/config/feature/prefer/applets.h) \
-    $(wildcard include/config/feature/installer.h) \
-    $(wildcard include/config/build/libbusybox.h) \
-    $(wildcard include/config/feature/shared/busybox.h) \
-  include/libbb.h \
-    $(wildcard include/config/feature/shadowpasswds.h) \
-    $(wildcard include/config/use/bb/shadow.h) \
-    $(wildcard include/config/selinux.h) \
-    $(wildcard include/config/feature/utmp.h) \
-    $(wildcard include/config/use/bb/pwd/grp.h) \
-    $(wildcard include/config/lfs.h) \
-    $(wildcard include/config/feature/buffers/go/on/stack.h) \
-    $(wildcard include/config/feature/buffers/go/in/bss.h) \
-    $(wildcard include/config/feature/verbose.h) \
-    $(wildcard include/config/feature/ipv6.h) \
-    $(wildcard include/config/feature/seamless/xz.h) \
-    $(wildcard include/config/feature/seamless/lzma.h) \
-    $(wildcard include/config/feature/seamless/bz2.h) \
-    $(wildcard include/config/feature/seamless/gz.h) \
-    $(wildcard include/config/feature/seamless/z.h) \
-    $(wildcard include/config/feature/check/names.h) \
-    $(wildcard include/config/long/opts.h) \
-    $(wildcard include/config/feature/getopt/long.h) \
-    $(wildcard include/config/feature/pidfile.h) \
-    $(wildcard include/config/feature/syslog.h) \
-    $(wildcard include/config/feature/individual.h) \
-    $(wildcard include/config/echo.h) \
-    $(wildcard include/config/printf.h) \
-    $(wildcard include/config/test.h) \
-    $(wildcard include/config/kill.h) \
-    $(wildcard include/config/chown.h) \
-    $(wildcard include/config/ls.h) \
-    $(wildcard include/config/xxx.h) \
-    $(wildcard include/config/route.h) \
-    $(wildcard include/config/feature/hwib.h) \
-    $(wildcard include/config/desktop.h) \
-    $(wildcard include/config/feature/crond/d.h) \
-    $(wildcard include/config/use/bb/crypt.h) \
-    $(wildcard include/config/feature/adduser/to/group.h) \
-    $(wildcard include/config/feature/del/user/from/group.h) \
-    $(wildcard include/config/ioctl/hex2str/error.h) \
-    $(wildcard include/config/feature/editing/history.h) \
-    $(wildcard include/config/feature/username/completion.h) \
-    $(wildcard include/config/pmap.h) \
-    $(wildcard include/config/feature/show/threads.h) \
-    $(wildcard include/config/feature/ps/additional/columns.h) \
-    $(wildcard include/config/feature/topmem.h) \
-    $(wildcard include/config/feature/top/smp/process.h) \
-    $(wildcard include/config/killall.h) \
-    $(wildcard include/config/pgrep.h) \
-    $(wildcard include/config/pkill.h) \
-    $(wildcard include/config/pidof.h) \
-    $(wildcard include/config/sestatus.h) \
-    $(wildcard include/config/feature/mtab/support.h) \
-    $(wildcard include/config/feature/clean/up.h) \
-    $(wildcard include/config/feature/devfs.h) \
-  include/platform.h \
-    $(wildcard include/config/werror.h) \
-    $(wildcard include/config/big/endian.h) \
-    $(wildcard include/config/little/endian.h) \
-    $(wildcard include/config/nommu.h) \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/syslimits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix1_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix2_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/xopen_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stdio_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap-common.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdbool.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/unistd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/environments.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stddef.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/confname.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/getopt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/ctype.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_touplow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/errno-base.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/syscall.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sysnum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/sysmacros.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/pthreadtypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/inttypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netinet/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket_type.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sockaddr.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/sockios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/siginfo.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/signal.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/signum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigaction.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigcontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigstack.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ucontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigthread.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdarg.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdlib.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitflags.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitstatus.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/alloca.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/string.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/libgen.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctl-types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ttydefaults.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/wait.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_clk_tck.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/pwd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/grp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/shadow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/mntent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/arpa/inet.h \
-  include/xatonum.h \
-  include/applet_metadata.h \
-    $(wildcard include/config/install/no/usr.h) \
-  include/unicode.h \
-    $(wildcard include/config/last/supported/wchar.h) \
-    $(wildcard include/config/unicode/combining/wchars.h) \
-    $(wildcard include/config/unicode/wide/wchars.h) \
-    $(wildcard include/config/unicode/bidi/support.h) \
-    $(wildcard include/config/unicode/neutral/table.h) \
-  shell/shell_common.h \
-  shell/math.h \
-    $(wildcard include/config/sh/math/support/64.h) \
-  include/NUM_APPLETS.h \
-
-shell/ash.o: $(deps_shell/ash.o)
-
-$(deps_shell/ash.o):
Binary files busybox.old/shell/ash_ptr_hack.o and busybox/shell/ash_ptr_hack.o differ
diff -Nurp busybox.old/shell/.ash_ptr_hack.o.cmd busybox/shell/.ash_ptr_hack.o.cmd
--- busybox.old/shell/.ash_ptr_hack.o.cmd	2015-05-29 06:55:24.000000000 +0800
+++ busybox/shell/.ash_ptr_hack.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,8 +0,0 @@
-cmd_shell/ash_ptr_hack.o := mips-openwrt-linux-uclibc-gcc -Wp,-MD,shell/.ash_ptr_hack.o.d   -std=gnu99 -Iinclude -Ilibbb  -include include/autoconf.h -D_GNU_SOURCE -DNDEBUG -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -D"BB_VER=KBUILD_STR(1.23.2)" -DBB_BT=AUTOCONF_TIMESTAMP  -Wall -Wshadow -Wwrite-strings -Wundef -Wstrict-prototypes -Wunused -Wunused-parameter -Wunused-function -Wunused-value -Wmissing-prototypes -Wmissing-declarations -Wno-format-security -Wdeclaration-after-statement -Wold-style-definition -fno-builtin-strlen -finline-limit=0 -fomit-frame-pointer -ffunction-sections -fdata-sections -fno-guess-branch-probability -funsigned-char -falign-functions=1 -falign-jumps=1 -falign-labels=1 -falign-loops=1 -fno-unwind-tables -fno-asynchronous-unwind-tables -Os  -Os -pipe -mno-branch-likely -mips32r2 -mtune=74kc -fno-caller-saves -fhonour-copts -Wno-error=unused-but-set-variable -msoft-float -mips16 -minterlink-mips16   -D"KBUILD_STR(s)=\#s" -D"KBUILD_BASENAME=KBUILD_STR(ash_ptr_hack)"  -D"KBUILD_MODNAME=KBUILD_STR(ash_ptr_hack)" -c -o shell/ash_ptr_hack.o shell/ash_ptr_hack.c
-
-deps_shell/ash_ptr_hack.o := \
-  shell/ash_ptr_hack.c \
-
-shell/ash_ptr_hack.o: $(deps_shell/ash_ptr_hack.o)
-
-$(deps_shell/ash_ptr_hack.o):
diff -Nurp busybox.old/shell/ash_test/ash-heredoc/heredoc1.right busybox/shell/ash_test/ash-heredoc/heredoc1.right
--- busybox.old/shell/ash_test/ash-heredoc/heredoc1.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-heredoc/heredoc1.right	2015-05-29 07:00:58.219259146 +0800
@@ -0,0 +1 @@
+./heredoc1.tests: line 3: syntax error: unexpected "then"
diff -Nurp busybox.old/shell/ash_test/ash-heredoc/heredoc1.tests busybox/shell/ash_test/ash-heredoc/heredoc1.tests
--- busybox.old/shell/ash_test/ash-heredoc/heredoc1.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-heredoc/heredoc1.tests	2015-05-29 07:00:58.219259146 +0800
@@ -0,0 +1,3 @@
+# We used to SEGV on this:
+
+<<EOF; then <W
diff -Nurp busybox.old/shell/ash_test/ash-misc/local1.right busybox/shell/ash_test/ash-misc/local1.right
--- busybox.old/shell/ash_test/ash-misc/local1.right	2015-05-29 06:54:59.000000000 +0800
+++ busybox/shell/ash_test/ash-misc/local1.right	2015-05-29 07:00:58.222592480 +0800
@@ -1,5 +1,4 @@
 A1:'A'
 A2:''
-A3:'B'
-A4:''
-A5:'A'
+A3:''
+A4:'A'
diff -Nurp busybox.old/shell/ash_test/ash-misc/local1.tests busybox/shell/ash_test/ash-misc/local1.tests
--- busybox.old/shell/ash_test/ash-misc/local1.tests	2015-05-29 06:54:59.000000000 +0800
+++ busybox/shell/ash_test/ash-misc/local1.tests	2015-05-29 07:00:58.222592480 +0800
@@ -3,12 +3,9 @@ f() {
 	local a
 	# the above line unsets $a
 	echo "A2:'$a'"
-	a=B
-	local a
-	echo "A3:'$a'"
 	unset a
-	echo "A4:'$a'"
+	echo "A3:'$a'"
 }
 echo "A1:'$a'"
 f
-echo "A5:'$a'"
+echo "A4:'$a'"
diff -Nurp busybox.old/shell/ash_test/ash-vars/var3.right busybox/shell/ash_test/ash-vars/var3.right
--- busybox.old/shell/ash_test/ash-vars/var3.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var3.right	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1,5 @@
+1
+1
+
+
+0
diff -Nurp busybox.old/shell/ash_test/ash-vars/var3.tests busybox/shell/ash_test/ash-vars/var3.tests
--- busybox.old/shell/ash_test/ash-vars/var3.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var3.tests	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1 @@
+x=0; f() { local x=1; echo $x; local x; echo $x; unset x; echo $x; local x; echo $x; }; f; echo $x
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.right busybox/shell/ash_test/ash-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.right
--- busybox.old/shell/ash_test/ash-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.right	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1,2 @@
+12
+9
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.tests busybox/shell/ash_test/ash-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.tests
--- busybox.old/shell/ash_test/ash-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.tests	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1,3 @@
+unset a
+echo $((3 + ${a:=$((4 + 5))}))
+echo $a
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.right busybox/shell/ash_test/ash-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.right
--- busybox.old/shell/ash_test/ash-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.right	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1 @@
+~root
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.tests busybox/shell/ash_test/ash-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.tests
--- busybox.old/shell/ash_test/ash-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.tests	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1,2 @@
+unset a
+echo "${a:-~root}"
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.right busybox/shell/ash_test/ash-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.right
--- busybox.old/shell/ash_test/ash-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.right	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1 @@
+/b/c/
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.tests busybox/shell/ash_test/ash-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.tests
--- busybox.old/shell/ash_test/ash-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.tests	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1,3 @@
+a=/b/c/*
+b=\\
+echo ${a%$b*}
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-expand-tilde-in-parameter-expansion.right busybox/shell/ash_test/ash-vars/var-expand-tilde-in-parameter-expansion.right
--- busybox.old/shell/ash_test/ash-vars/var-expand-tilde-in-parameter-expansion.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-expand-tilde-in-parameter-expansion.right	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1 @@
+:/root
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-expand-tilde-in-parameter-expansion.tests busybox/shell/ash_test/ash-vars/var-expand-tilde-in-parameter-expansion.tests
--- busybox.old/shell/ash_test/ash-vars/var-expand-tilde-in-parameter-expansion.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-expand-tilde-in-parameter-expansion.tests	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1,2 @@
+a=~root:~root
+echo ${a#~root}
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-1.right busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-1.right
--- busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-1.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-1.right	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1 @@
+a_\_z_c
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-1.tests busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-1.tests
--- busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-1.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-1.tests	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1,2 @@
+v="a\bc"
+echo ${v/\\b/_\\_\z_}
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-2.right busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-2.right
--- busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-2.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-2.right	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1 @@
+ax/yc
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-2.tests busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-2.tests
--- busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-2.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-2.tests	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1,2 @@
+v="abc"
+echo ${v/b/x/y}
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-3.right busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-3.right
--- busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-3.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-3.right	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1 @@
+axcabc
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-3.tests busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-3.tests
--- busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-3.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-3.tests	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1,2 @@
+v="abcabc"
+echo ${v/b/x}
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-4.right busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-4.right
--- busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-4.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-4.right	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1 @@
+axcaxc
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-4.tests busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-4.tests
--- busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-4.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-4.tests	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1,2 @@
+v="abcabc"
+echo ${v//b/x}
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-5.right busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-5.right
--- busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-5.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-5.right	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1 @@
+axc
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-5.tests busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-5.tests
--- busybox.old/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-5.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-pattern-replacement-in-parameter-expansion-5.tests	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1,2 @@
+v="ab/c"
+echo ${v/b\//x}
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-runtime-quote-detection.right busybox/shell/ash_test/ash-vars/var-runtime-quote-detection.right
--- busybox.old/shell/ash_test/ash-vars/var-runtime-quote-detection.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-runtime-quote-detection.right	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1 @@
+<>
diff -Nurp busybox.old/shell/ash_test/ash-vars/var-runtime-quote-detection.tests busybox/shell/ash_test/ash-vars/var-runtime-quote-detection.tests
--- busybox.old/shell/ash_test/ash-vars/var-runtime-quote-detection.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/ash_test/ash-vars/var-runtime-quote-detection.tests	2015-05-29 07:00:58.222592480 +0800
@@ -0,0 +1 @@
+foo=\\ echo "<${foo#[\\]}>"
diff -Nurp busybox.old/shell/built-in.o busybox/shell/built-in.o
--- busybox.old/shell/built-in.o	2015-05-29 06:55:23.000000000 +0800
+++ busybox/shell/built-in.o	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-!<arch>
diff -Nurp busybox.old/shell/.built-in.o.cmd busybox/shell/.built-in.o.cmd
--- busybox.old/shell/.built-in.o.cmd	2015-05-29 06:55:23.000000000 +0800
+++ busybox/shell/.built-in.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-cmd_shell/built-in.o :=  rm -f shell/built-in.o; mips-openwrt-linux-uclibc-ar rcs shell/built-in.o
diff -Nurp busybox.old/shell/Config.in busybox/shell/Config.in
--- busybox.old/shell/Config.in	2015-05-29 06:55:00.000000000 +0800
+++ busybox/shell/Config.in	1970-01-01 08:00:00.000000000 +0800
@@ -1,444 +0,0 @@
-# DO NOT EDIT. This file is generated from Config.src
-#
-# For a description of the syntax of this configuration file,
-# see scripts/kbuild/config-language.txt.
-#
-
-menu "Shells"
-
-config ASH
-	bool "ash"
-	default y
-	depends on !NOMMU
-	help
-	  Tha 'ash' shell adds about 60k in the default configuration and is
-	  the most complete and most pedantically correct shell included with
-	  busybox. This shell is actually a derivative of the Debian 'dash'
-	  shell (by Herbert Xu), which was created by porting the 'ash' shell
-	  (written by Kenneth Almquist) from NetBSD.
-
-config ASH_BASH_COMPAT
-	bool "bash-compatible extensions"
-	default y
-	depends on ASH
-	help
-	  Enable bash-compatible extensions.
-
-config ASH_IDLE_TIMEOUT
-	bool "Idle timeout variable"
-	default n
-	depends on ASH
-	help
-	  Enables bash-like auto-logout after $TMOUT seconds of idle time.
-
-config ASH_JOB_CONTROL
-	bool "Job control"
-	default y
-	depends on ASH
-	help
-	  Enable job control in the ash shell.
-
-config ASH_ALIAS
-	bool "Alias support"
-	default y
-	depends on ASH
-	help
-	  Enable alias support in the ash shell.
-
-config ASH_GETOPTS
-	bool "Builtin getopt to parse positional parameters"
-	default y
-	depends on ASH
-	help
-	  Enable support for getopts builtin in ash.
-
-config ASH_BUILTIN_ECHO
-	bool "Builtin version of 'echo'"
-	default y
-	depends on ASH
-	help
-	  Enable support for echo builtin in ash.
-
-config ASH_BUILTIN_PRINTF
-	bool "Builtin version of 'printf'"
-	default y
-	depends on ASH
-	help
-	  Enable support for printf builtin in ash.
-
-config ASH_BUILTIN_TEST
-	bool "Builtin version of 'test'"
-	default y
-	depends on ASH
-	help
-	  Enable support for test builtin in ash.
-
-config ASH_HELP
-	bool "help builtin"
-	default y
-	depends on ASH
-	help
-	  Enable help builtin in ash.
-
-config ASH_CMDCMD
-	bool "'command' command to override shell builtins"
-	default y
-	depends on ASH
-	help
-	  Enable support for the ash 'command' builtin, which allows
-	  you to run the specified command with the specified arguments,
-	  even when there is an ash builtin command with the same name.
-
-config ASH_MAIL
-	bool "Check for new mail on interactive shells"
-	default n
-	depends on ASH
-	help
-	  Enable "check for new mail" function in the ash shell.
-
-config ASH_OPTIMIZE_FOR_SIZE
-	bool "Optimize for size instead of speed"
-	default y
-	depends on ASH
-	help
-	  Compile ash for reduced size at the price of speed.
-
-config ASH_RANDOM_SUPPORT
-	bool "Pseudorandom generator and $RANDOM variable"
-	default y
-	depends on ASH
-	help
-	  Enable pseudorandom generator and dynamic variable "$RANDOM".
-	  Each read of "$RANDOM" will generate a new pseudorandom value.
-	  You can reset the generator by using a specified start value.
-	  After "unset RANDOM" the generator will switch off and this
-	  variable will no longer have special treatment.
-
-config ASH_EXPAND_PRMT
-	bool "Expand prompt string"
-	default y
-	depends on ASH
-	help
-	  "PS#" may contain volatile content, such as backquote commands.
-	  This option recreates the prompt string from the environment
-	  variable each time it is displayed.
-
-config CTTYHACK
-	bool "cttyhack"
-	default y
-	help
-	  One common problem reported on the mailing list is the "can't
-	  access tty; job control turned off" error message, which typically
-	  appears when one tries to use a shell with stdin/stdout on
-	  /dev/console.
-	  This device is special - it cannot be a controlling tty.
-
-	  The proper solution is to use the correct device instead of
-	  /dev/console.
-
-	  cttyhack provides a "quick and dirty" solution to this problem.
-	  It analyzes stdin with various ioctls, trying to determine whether
-	  it is a /dev/ttyN or /dev/ttySN (virtual terminal or serial line).
-	  On Linux it also checks sysfs for a pointer to the active console.
-	  If cttyhack is able to find the real console device, it closes
-	  stdin/out/err and reopens that device.
-	  Then it executes the given program. Opening the device will make
-	  that device a controlling tty. This may require cttyhack
-	  to be a session leader.
-
-	  Example for /etc/inittab (for busybox init):
-
-	  ::respawn:/bin/cttyhack /bin/sh
-
-	  Starting an interactive shell from boot shell script:
-
-	  setsid cttyhack sh
-
-	  Giving controlling tty to shell running with PID 1:
-
-	  # exec cttyhack sh
-
-	  Without cttyhack, you need to know exact tty name,
-	  and do something like this:
-
-	  # exec setsid sh -c 'exec sh </dev/tty1 >/dev/tty1 2>&1'
-
-	  Starting getty on a controlling tty from a shell script:
-
-	  # getty 115200 $(cttyhack)
-config HUSH
-	bool "hush"
-	default y
-	help
-	  hush is a small shell (25k). It handles the normal flow control
-	  constructs such as if/then/elif/else/fi, for/in/do/done, while loops,
-	  case/esac. Redirections, here documents, $((arithmetic))
-	  and functions are supported.
-
-	  It will compile and work on no-mmu systems.
-
-	  It does not handle select, aliases, tilde expansion,
-	  &>file and >&file redirection of stdout+stderr.
-
-config HUSH_BASH_COMPAT
-	bool "bash-compatible extensions"
-	default y
-	depends on HUSH
-	help
-	  Enable bash-compatible extensions.
-
-config HUSH_BRACE_EXPANSION
-	bool "Brace expansion"
-	default y
-	depends on HUSH_BASH_COMPAT
-	help
-	  Enable {abc,def} extension.
-
-config HUSH_HELP
-	bool "help builtin"
-	default y
-	depends on HUSH
-	help
-	  Enable help builtin in hush. Code size + ~1 kbyte.
-
-config HUSH_INTERACTIVE
-	bool "Interactive mode"
-	default y
-	depends on HUSH
-	help
-	  Enable interactive mode (prompt and command editing).
-	  Without this, hush simply reads and executes commands
-	  from stdin just like a shell script from a file.
-	  No prompt, no PS1/PS2 magic shell variables.
-
-config HUSH_SAVEHISTORY
-	bool "Save command history to .hush_history"
-	default y
-	depends on HUSH_INTERACTIVE && FEATURE_EDITING_SAVEHISTORY
-	help
-	  Enable history saving in hush.
-
-config HUSH_JOB
-	bool "Job control"
-	default y
-	depends on HUSH_INTERACTIVE
-	help
-	  Enable job control: Ctrl-Z backgrounds, Ctrl-C interrupts current
-	  command (not entire shell), fg/bg builtins work. Without this option,
-	  "cmd &" still works by simply spawning a process and immediately
-	  prompting for next command (or executing next command in a script),
-	  but no separate process group is formed.
-
-config HUSH_TICK
-	bool "Process substitution"
-	default y
-	depends on HUSH
-	help
-	  Enable process substitution `command` and $(command) in hush.
-
-config HUSH_IF
-	bool "Support if/then/elif/else/fi"
-	default y
-	depends on HUSH
-	help
-	  Enable if/then/elif/else/fi in hush.
-
-config HUSH_LOOPS
-	bool "Support for, while and until loops"
-	default y
-	depends on HUSH
-	help
-	  Enable for, while and until loops in hush.
-
-config HUSH_CASE
-	bool "Support case ... esac statement"
-	default y
-	depends on HUSH
-	help
-	  Enable case ... esac statement in hush. +400 bytes.
-
-config HUSH_FUNCTIONS
-	bool "Support funcname() { commands; } syntax"
-	default y
-	depends on HUSH
-	help
-	  Enable support for shell functions in hush. +800 bytes.
-
-config HUSH_LOCAL
-	bool "Support local builtin"
-	default y
-	depends on HUSH_FUNCTIONS
-	help
-	  Enable support for local variables in functions.
-
-config HUSH_RANDOM_SUPPORT
-	bool "Pseudorandom generator and $RANDOM variable"
-	default y
-	depends on HUSH
-	help
-	  Enable pseudorandom generator and dynamic variable "$RANDOM".
-	  Each read of "$RANDOM" will generate a new pseudorandom value.
-
-config HUSH_EXPORT_N
-	bool "Support 'export -n' option"
-	default y
-	depends on HUSH
-	help
-	  export -n unexports variables. It is a bash extension.
-
-config HUSH_MODE_X
-	bool "Support 'hush -x' option and 'set -x' command"
-	default y
-	depends on HUSH
-	help
-	  This instructs hush to print commands before execution.
-	  Adds ~300 bytes.
-
-config MSH
-	bool "msh (deprecated: aliased to hush)"
-	default n
-	select HUSH
-	help
-	  msh is deprecated and will be removed, please migrate to hush.
-
-
-
-choice
-	prompt "Choose which shell is aliased to 'sh' name"
-	default FEATURE_SH_IS_ASH
-	help
-	  Choose which shell you want to be executed by 'sh' alias.
-	  The ash shell is the most bash compatible and full featured one.
-
-# note: cannot use "select ASH" here, it breaks "make allnoconfig"
-config FEATURE_SH_IS_ASH
-	depends on ASH
-	bool "ash"
-	depends on !NOMMU
-
-config FEATURE_SH_IS_HUSH
-	depends on HUSH
-	bool "hush"
-
-config FEATURE_SH_IS_NONE
-	bool "none"
-
-endchoice
-
-choice
-	prompt "Choose which shell is aliased to 'bash' name"
-	default FEATURE_BASH_IS_NONE
-	help
-	  Choose which shell you want to be executed by 'bash' alias.
-	  The ash shell is the most bash compatible and full featured one.
-
-	  Note that selecting this option does not switch on any bash
-	  compatibility code. It merely makes it possible to install
-	  /bin/bash (sym)link and run scripts which start with
-	  #!/bin/bash line.
-
-	  Many systems use it in scripts which use bash-specific features,
-	  even simple ones like $RANDOM. Without this option, busybox
-	  can't be used for running them because it won't recongnize
-	  "bash" as a supported applet name.
-
-config FEATURE_BASH_IS_ASH
-	depends on ASH
-	bool "ash"
-	depends on !NOMMU
-
-config FEATURE_BASH_IS_HUSH
-	depends on HUSH
-	bool "hush"
-
-config FEATURE_BASH_IS_NONE
-	bool "none"
-
-endchoice
-
-
-config SH_MATH_SUPPORT
-	bool "POSIX math support"
-	default y
-	depends on ASH || HUSH
-	help
-	  Enable math support in the shell via $((...)) syntax.
-
-config SH_MATH_SUPPORT_64
-	bool "Extend POSIX math support to 64 bit"
-	default y
-	depends on SH_MATH_SUPPORT
-	help
-	  Enable 64-bit math support in the shell. This will make the shell
-	  slightly larger, but will allow computation with very large numbers.
-	  This is not in POSIX, so do not rely on this in portable code.
-
-config FEATURE_SH_EXTRA_QUIET
-	bool "Hide message on interactive shell startup"
-	default y
-	depends on HUSH || ASH
-	help
-	  Remove the busybox introduction when starting a shell.
-
-config FEATURE_SH_STANDALONE
-	bool "Standalone shell"
-	default n
-	depends on (HUSH || ASH) && FEATURE_PREFER_APPLETS
-	help
-	  This option causes busybox shells to use busybox applets
-	  in preference to executables in the PATH whenever possible. For
-	  example, entering the command 'ifconfig' into the shell would cause
-	  busybox to use the ifconfig busybox applet. Specifying the fully
-	  qualified executable name, such as '/sbin/ifconfig' will still
-	  execute the /sbin/ifconfig executable on the filesystem. This option
-	  is generally used when creating a statically linked version of busybox
-	  for use as a rescue shell, in the event that you screw up your system.
-
-	  This is implemented by re-execing /proc/self/exe (typically)
-	  with right parameters. Some selected applets ("NOFORK" applets)
-	  can even be executed without creating new process.
-	  Instead, busybox will call <applet>_main() internally.
-
-	  However, this causes problems in chroot jails without mounted /proc
-	  and with ps/top (command name can be shown as 'exe' for applets
-	  started this way).
-# untrue?
-#	  Note that this will *also* cause applets to take precedence
-#	  over shell builtins of the same name. So turning this on will
-#	  eliminate any performance gained by turning on the builtin "echo"
-#	  and "test" commands in ash.
-# untrue?
-#	  Note that when using this option, the shell will attempt to directly
-#	  run '/bin/busybox'. If you do not have the busybox binary sitting in
-#	  that exact location with that exact name, this option will not work at
-#	  all.
-
-config FEATURE_SH_NOFORK
-	bool "Run 'nofork' applets directly"
-	default n
-	depends on (HUSH || ASH) && FEATURE_PREFER_APPLETS
-	help
-	  This option causes busybox shells to not execute typical
-	  fork/exec/wait sequence, but call <applet>_main directly,
-	  if possible. (Sometimes it is not possible: for example,
-	  this is not possible in pipes).
-
-	  This will be done only for some applets (those which are marked
-	  NOFORK in include/applets.h).
-
-	  This may significantly speed up some shell scripts.
-
-	  This feature is relatively new. Use with care. Report bugs
-	  to project mailing list.
-
-config FEATURE_SH_HISTFILESIZE
-	bool "Use $HISTFILESIZE"
-	default y
-	depends on HUSH || ASH
-	help
-	  This option makes busybox shells to use $HISTFILESIZE variable
-	  to set shell history size. Note that its max value is capped
-	  by "History size" setting in library tuning section.
-
-
-endmenu
diff -Nurp busybox.old/shell/hush.c busybox/shell/hush.c
--- busybox.old/shell/hush.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/shell/hush.c	2015-05-29 07:00:58.225925812 +0800
@@ -442,7 +442,7 @@ enum {
 	MAYBE_ASSIGNMENT      = 0,
 	DEFINITELY_ASSIGNMENT = 1,
 	NOT_ASSIGNMENT        = 2,
-	/* Not an assigment, but next word may be: "if v=xyz cmd;" */
+	/* Not an assignment, but next word may be: "if v=xyz cmd;" */
 	WORD_IS_KEYWORD       = 3,
 };
 /* Used for initialization: o_string foo = NULL_O_STRING; */
@@ -5884,7 +5884,7 @@ static FILE *generate_stream_from_string
 		 * Our solution: ONLY bare $(trap) or `trap` is special.
 		 */
 		s = skip_whitespace(s);
-		if (strncmp(s, "trap", 4) == 0
+		if (is_prefixed_with(s, "trap")
 		 && skip_whitespace(s + 4)[0] == '\0'
 		) {
 			static const char *const argv[] = { NULL, NULL };
diff -Nurp busybox.old/shell/hush_test/.gitignore busybox/shell/hush_test/.gitignore
--- busybox.old/shell/hush_test/.gitignore	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/.gitignore	2015-05-29 07:00:58.225925812 +0800
@@ -0,0 +1,4 @@
+*.fail
+*.xx
+
+/hush
diff -Nurp busybox.old/shell/hush_test/hush-bugs/var3.right busybox/shell/hush_test/hush-bugs/var3.right
--- busybox.old/shell/hush_test/hush-bugs/var3.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-bugs/var3.right	2015-05-29 07:00:58.225925812 +0800
@@ -0,0 +1,5 @@
+1
+1
+
+
+0
diff -Nurp busybox.old/shell/hush_test/hush-bugs/var3.tests busybox/shell/hush_test/hush-bugs/var3.tests
--- busybox.old/shell/hush_test/hush-bugs/var3.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-bugs/var3.tests	2015-05-29 07:00:58.225925812 +0800
@@ -0,0 +1 @@
+x=0; f() { local x=1; echo $x; local x; echo $x; unset x; echo $x; local x; echo $x; }; f; echo $x
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.right busybox/shell/hush_test/hush-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.right
--- busybox.old/shell/hush_test/hush-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.right	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1,2 @@
+12
+9
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.tests busybox/shell/hush_test/hush-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.tests
--- busybox.old/shell/hush_test/hush-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-do-not-collapse-arithmetic-expansion-at-parse-time.tests	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1,3 @@
+unset a
+echo $((3 + ${a:=$((4 + 5))}))
+echo $a
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.right busybox/shell/hush_test/hush-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.right
--- busybox.old/shell/hush_test/hush-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.right	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1 @@
+~root
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.tests busybox/shell/hush_test/hush-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.tests
--- busybox.old/shell/hush_test/hush-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-do-not-expand-tilde-in-parameter-expansion-in-quotes.tests	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1,2 @@
+unset a
+echo "${a:-~root}"
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.right busybox/shell/hush_test/hush-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.right
--- busybox.old/shell/hush_test/hush-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.right	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1 @@
+/b/c/
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.tests busybox/shell/hush_test/hush-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.tests
--- busybox.old/shell/hush_test/hush-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-do-not-quote-backslashes-in-parameter-expansions-outside-quotes.tests	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1,3 @@
+a=/b/c/*
+b=\\
+echo ${a%$b*}
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-1.right busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-1.right
--- busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-1.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-1.right	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1 @@
+a_\_z_c
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-1.tests busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-1.tests
--- busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-1.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-1.tests	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1,2 @@
+v="a\bc"
+echo ${v/\\b/_\\_\z_}
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-2.right busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-2.right
--- busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-2.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-2.right	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1 @@
+ax/yc
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-2.tests busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-2.tests
--- busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-2.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-2.tests	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1,2 @@
+v="abc"
+echo ${v/b/x/y}
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-3.right busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-3.right
--- busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-3.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-3.right	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1 @@
+axcabc
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-3.tests busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-3.tests
--- busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-3.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-3.tests	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1,2 @@
+v="abcabc"
+echo ${v/b/x}
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-4.right busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-4.right
--- busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-4.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-4.right	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1 @@
+axcaxc
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-4.tests busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-4.tests
--- busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-4.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-4.tests	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1,2 @@
+v="abcabc"
+echo ${v//b/x}
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-5.right busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-5.right
--- busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-5.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-5.right	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1 @@
+axc
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-5.tests busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-5.tests
--- busybox.old/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-5.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-pattern-replacement-in-parameter-expansion-5.tests	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1,2 @@
+v="ab/c"
+echo ${v/b\//x}
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-runtime-quote-detection.right busybox/shell/hush_test/hush-vars/var-runtime-quote-detection.right
--- busybox.old/shell/hush_test/hush-vars/var-runtime-quote-detection.right	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-runtime-quote-detection.right	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1 @@
+<>
diff -Nurp busybox.old/shell/hush_test/hush-vars/var-runtime-quote-detection.tests busybox/shell/hush_test/hush-vars/var-runtime-quote-detection.tests
--- busybox.old/shell/hush_test/hush-vars/var-runtime-quote-detection.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/shell/hush_test/hush-vars/var-runtime-quote-detection.tests	2015-05-29 07:00:58.232592479 +0800
@@ -0,0 +1 @@
+foo=\\ echo "<${foo#[\\]}>"
diff -Nurp busybox.old/shell/Kbuild busybox/shell/Kbuild
--- busybox.old/shell/Kbuild	2015-05-29 06:55:00.000000000 +0800
+++ busybox/shell/Kbuild	1970-01-01 08:00:00.000000000 +0800
@@ -1,16 +0,0 @@
-# DO NOT EDIT. This file is generated from Kbuild.src
-# Makefile for busybox
-#
-# Copyright (C) 1999-2005 by Erik Andersen <andersen@codepoet.org>
-#
-# Licensed under GPLv2, see file LICENSE in this source tree.
-
-lib-y:=
-
-lib-$(CONFIG_ASH) += ash.o ash_ptr_hack.o shell_common.o
-lib-$(CONFIG_ASH_RANDOM_SUPPORT) += random.o
-lib-$(CONFIG_CTTYHACK) += cttyhack.o
-lib-$(CONFIG_HUSH) += hush.o match.o shell_common.o
-lib-$(CONFIG_HUSH_RANDOM_SUPPORT) += random.o
-
-lib-$(CONFIG_SH_MATH_SUPPORT) += math.o
Binary files busybox.old/shell/lib.a and busybox/shell/lib.a differ
diff -Nurp busybox.old/shell/.lib.a.cmd busybox/shell/.lib.a.cmd
--- busybox.old/shell/.lib.a.cmd	2015-05-29 06:55:25.000000000 +0800
+++ busybox/shell/.lib.a.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-cmd_shell/lib.a := rm -f shell/lib.a; mips-openwrt-linux-uclibc-ar  rcs shell/lib.a shell/ash.o shell/ash_ptr_hack.o shell/math.o shell/shell_common.o
Binary files busybox.old/shell/math.o and busybox/shell/math.o differ
diff -Nurp busybox.old/shell/.math.o.cmd busybox/shell/.math.o.cmd
--- busybox.old/shell/.math.o.cmd	2015-05-29 06:55:25.000000000 +0800
+++ busybox/shell/.math.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,196 +0,0 @@
-cmd_shell/math.o := mips-openwrt-linux-uclibc-gcc -Wp,-MD,shell/.math.o.d   -std=gnu99 -Iinclude -Ilibbb  -include include/autoconf.h -D_GNU_SOURCE -DNDEBUG -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -D"BB_VER=KBUILD_STR(1.23.2)" -DBB_BT=AUTOCONF_TIMESTAMP  -Wall -Wshadow -Wwrite-strings -Wundef -Wstrict-prototypes -Wunused -Wunused-parameter -Wunused-function -Wunused-value -Wmissing-prototypes -Wmissing-declarations -Wno-format-security -Wdeclaration-after-statement -Wold-style-definition -fno-builtin-strlen -finline-limit=0 -fomit-frame-pointer -ffunction-sections -fdata-sections -fno-guess-branch-probability -funsigned-char -falign-functions=1 -falign-jumps=1 -falign-labels=1 -falign-loops=1 -fno-unwind-tables -fno-asynchronous-unwind-tables -Os  -Os -pipe -mno-branch-likely -mips32r2 -mtune=74kc -fno-caller-saves -fhonour-copts -Wno-error=unused-but-set-variable -msoft-float -mips16 -minterlink-mips16   -D"KBUILD_STR(s)=\#s" -D"KBUILD_BASENAME=KBUILD_STR(math)"  -D"KBUILD_MODNAME=KBUILD_STR(math)" -c -o shell/math.o shell/math.c
-
-deps_shell/math.o := \
-  shell/math.c \
-  include/libbb.h \
-    $(wildcard include/config/feature/shadowpasswds.h) \
-    $(wildcard include/config/use/bb/shadow.h) \
-    $(wildcard include/config/selinux.h) \
-    $(wildcard include/config/feature/utmp.h) \
-    $(wildcard include/config/locale/support.h) \
-    $(wildcard include/config/use/bb/pwd/grp.h) \
-    $(wildcard include/config/lfs.h) \
-    $(wildcard include/config/feature/buffers/go/on/stack.h) \
-    $(wildcard include/config/feature/buffers/go/in/bss.h) \
-    $(wildcard include/config/feature/verbose.h) \
-    $(wildcard include/config/feature/ipv6.h) \
-    $(wildcard include/config/feature/seamless/xz.h) \
-    $(wildcard include/config/feature/seamless/lzma.h) \
-    $(wildcard include/config/feature/seamless/bz2.h) \
-    $(wildcard include/config/feature/seamless/gz.h) \
-    $(wildcard include/config/feature/seamless/z.h) \
-    $(wildcard include/config/feature/check/names.h) \
-    $(wildcard include/config/feature/prefer/applets.h) \
-    $(wildcard include/config/long/opts.h) \
-    $(wildcard include/config/feature/getopt/long.h) \
-    $(wildcard include/config/feature/pidfile.h) \
-    $(wildcard include/config/feature/syslog.h) \
-    $(wildcard include/config/feature/individual.h) \
-    $(wildcard include/config/echo.h) \
-    $(wildcard include/config/printf.h) \
-    $(wildcard include/config/test.h) \
-    $(wildcard include/config/kill.h) \
-    $(wildcard include/config/chown.h) \
-    $(wildcard include/config/ls.h) \
-    $(wildcard include/config/xxx.h) \
-    $(wildcard include/config/route.h) \
-    $(wildcard include/config/feature/hwib.h) \
-    $(wildcard include/config/desktop.h) \
-    $(wildcard include/config/feature/crond/d.h) \
-    $(wildcard include/config/use/bb/crypt.h) \
-    $(wildcard include/config/feature/adduser/to/group.h) \
-    $(wildcard include/config/feature/del/user/from/group.h) \
-    $(wildcard include/config/ioctl/hex2str/error.h) \
-    $(wildcard include/config/feature/editing.h) \
-    $(wildcard include/config/feature/editing/history.h) \
-    $(wildcard include/config/feature/editing/savehistory.h) \
-    $(wildcard include/config/feature/tab/completion.h) \
-    $(wildcard include/config/feature/username/completion.h) \
-    $(wildcard include/config/feature/editing/vi.h) \
-    $(wildcard include/config/feature/editing/save/on/exit.h) \
-    $(wildcard include/config/pmap.h) \
-    $(wildcard include/config/feature/show/threads.h) \
-    $(wildcard include/config/feature/ps/additional/columns.h) \
-    $(wildcard include/config/feature/topmem.h) \
-    $(wildcard include/config/feature/top/smp/process.h) \
-    $(wildcard include/config/killall.h) \
-    $(wildcard include/config/pgrep.h) \
-    $(wildcard include/config/pkill.h) \
-    $(wildcard include/config/pidof.h) \
-    $(wildcard include/config/sestatus.h) \
-    $(wildcard include/config/unicode/support.h) \
-    $(wildcard include/config/feature/mtab/support.h) \
-    $(wildcard include/config/feature/clean/up.h) \
-    $(wildcard include/config/feature/devfs.h) \
-  include/platform.h \
-    $(wildcard include/config/werror.h) \
-    $(wildcard include/config/big/endian.h) \
-    $(wildcard include/config/little/endian.h) \
-    $(wildcard include/config/nommu.h) \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/syslimits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/features.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_config.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/cdefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix1_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix2_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/xopen_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stdio_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap-common.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wordsize.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdbool.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/unistd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/environments.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/typesizes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stddef.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/confname.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/getopt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/ctype.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_touplow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/errno-base.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/syscall.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sysnum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sgidefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigset.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/sysmacros.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/pthreadtypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/inttypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netinet/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket_type.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sockaddr.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/sockios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/siginfo.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/signal.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/signum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigaction.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigcontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigstack.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ucontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigthread.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdarg.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdlib.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitflags.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitstatus.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/alloca.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/string.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/libgen.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctl-types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ttydefaults.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/wait.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_clk_tck.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/pwd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/grp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/shadow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/paths.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/mntent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/arpa/inet.h \
-  include/xatonum.h \
-  shell/math.h \
-    $(wildcard include/config/sh/math/support/64.h) \
-
-shell/math.o: $(deps_shell/math.o)
-
-$(deps_shell/math.o):
Binary files busybox.old/shell/shell_common.o and busybox/shell/shell_common.o differ
diff -Nurp busybox.old/shell/.shell_common.o.cmd busybox/shell/.shell_common.o.cmd
--- busybox.old/shell/.shell_common.o.cmd	2015-05-29 06:55:25.000000000 +0800
+++ busybox/shell/.shell_common.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,195 +0,0 @@
-cmd_shell/shell_common.o := mips-openwrt-linux-uclibc-gcc -Wp,-MD,shell/.shell_common.o.d   -std=gnu99 -Iinclude -Ilibbb  -include include/autoconf.h -D_GNU_SOURCE -DNDEBUG -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -D"BB_VER=KBUILD_STR(1.23.2)" -DBB_BT=AUTOCONF_TIMESTAMP  -Wall -Wshadow -Wwrite-strings -Wundef -Wstrict-prototypes -Wunused -Wunused-parameter -Wunused-function -Wunused-value -Wmissing-prototypes -Wmissing-declarations -Wno-format-security -Wdeclaration-after-statement -Wold-style-definition -fno-builtin-strlen -finline-limit=0 -fomit-frame-pointer -ffunction-sections -fdata-sections -fno-guess-branch-probability -funsigned-char -falign-functions=1 -falign-jumps=1 -falign-labels=1 -falign-loops=1 -fno-unwind-tables -fno-asynchronous-unwind-tables -Os  -Os -pipe -mno-branch-likely -mips32r2 -mtune=74kc -fno-caller-saves -fhonour-copts -Wno-error=unused-but-set-variable -msoft-float -mips16 -minterlink-mips16   -D"KBUILD_STR(s)=\#s" -D"KBUILD_BASENAME=KBUILD_STR(shell_common)"  -D"KBUILD_MODNAME=KBUILD_STR(shell_common)" -c -o shell/shell_common.o shell/shell_common.c
-
-deps_shell/shell_common.o := \
-  shell/shell_common.c \
-  include/libbb.h \
-    $(wildcard include/config/feature/shadowpasswds.h) \
-    $(wildcard include/config/use/bb/shadow.h) \
-    $(wildcard include/config/selinux.h) \
-    $(wildcard include/config/feature/utmp.h) \
-    $(wildcard include/config/locale/support.h) \
-    $(wildcard include/config/use/bb/pwd/grp.h) \
-    $(wildcard include/config/lfs.h) \
-    $(wildcard include/config/feature/buffers/go/on/stack.h) \
-    $(wildcard include/config/feature/buffers/go/in/bss.h) \
-    $(wildcard include/config/feature/verbose.h) \
-    $(wildcard include/config/feature/ipv6.h) \
-    $(wildcard include/config/feature/seamless/xz.h) \
-    $(wildcard include/config/feature/seamless/lzma.h) \
-    $(wildcard include/config/feature/seamless/bz2.h) \
-    $(wildcard include/config/feature/seamless/gz.h) \
-    $(wildcard include/config/feature/seamless/z.h) \
-    $(wildcard include/config/feature/check/names.h) \
-    $(wildcard include/config/feature/prefer/applets.h) \
-    $(wildcard include/config/long/opts.h) \
-    $(wildcard include/config/feature/getopt/long.h) \
-    $(wildcard include/config/feature/pidfile.h) \
-    $(wildcard include/config/feature/syslog.h) \
-    $(wildcard include/config/feature/individual.h) \
-    $(wildcard include/config/echo.h) \
-    $(wildcard include/config/printf.h) \
-    $(wildcard include/config/test.h) \
-    $(wildcard include/config/kill.h) \
-    $(wildcard include/config/chown.h) \
-    $(wildcard include/config/ls.h) \
-    $(wildcard include/config/xxx.h) \
-    $(wildcard include/config/route.h) \
-    $(wildcard include/config/feature/hwib.h) \
-    $(wildcard include/config/desktop.h) \
-    $(wildcard include/config/feature/crond/d.h) \
-    $(wildcard include/config/use/bb/crypt.h) \
-    $(wildcard include/config/feature/adduser/to/group.h) \
-    $(wildcard include/config/feature/del/user/from/group.h) \
-    $(wildcard include/config/ioctl/hex2str/error.h) \
-    $(wildcard include/config/feature/editing.h) \
-    $(wildcard include/config/feature/editing/history.h) \
-    $(wildcard include/config/feature/editing/savehistory.h) \
-    $(wildcard include/config/feature/tab/completion.h) \
-    $(wildcard include/config/feature/username/completion.h) \
-    $(wildcard include/config/feature/editing/vi.h) \
-    $(wildcard include/config/feature/editing/save/on/exit.h) \
-    $(wildcard include/config/pmap.h) \
-    $(wildcard include/config/feature/show/threads.h) \
-    $(wildcard include/config/feature/ps/additional/columns.h) \
-    $(wildcard include/config/feature/topmem.h) \
-    $(wildcard include/config/feature/top/smp/process.h) \
-    $(wildcard include/config/killall.h) \
-    $(wildcard include/config/pgrep.h) \
-    $(wildcard include/config/pkill.h) \
-    $(wildcard include/config/pidof.h) \
-    $(wildcard include/config/sestatus.h) \
-    $(wildcard include/config/unicode/support.h) \
-    $(wildcard include/config/feature/mtab/support.h) \
-    $(wildcard include/config/feature/clean/up.h) \
-    $(wildcard include/config/feature/devfs.h) \
-  include/platform.h \
-    $(wildcard include/config/werror.h) \
-    $(wildcard include/config/big/endian.h) \
-    $(wildcard include/config/little/endian.h) \
-    $(wildcard include/config/nommu.h) \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/syslimits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/features.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_config.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/cdefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix1_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix2_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/xopen_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stdio_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap-common.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wordsize.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdbool.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/unistd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/environments.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/typesizes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stddef.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/confname.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/getopt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/ctype.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_touplow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/errno-base.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/syscall.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sysnum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sgidefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigset.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/sysmacros.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/pthreadtypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/inttypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netinet/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket_type.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sockaddr.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/sockios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/siginfo.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/signal.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/signum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigaction.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigcontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigstack.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ucontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigthread.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdarg.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdlib.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitflags.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitstatus.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/alloca.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/string.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/libgen.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctl-types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ttydefaults.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/wait.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_clk_tck.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/pwd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/grp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/shadow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/paths.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/mntent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/arpa/inet.h \
-  include/xatonum.h \
-  shell/shell_common.h \
-
-shell/shell_common.o: $(deps_shell/shell_common.o)
-
-$(deps_shell/shell_common.o):
diff -Nurp busybox.old/sysklogd/built-in.o busybox/sysklogd/built-in.o
--- busybox.old/sysklogd/built-in.o	2015-05-29 06:55:25.000000000 +0800
+++ busybox/sysklogd/built-in.o	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-!<arch>
diff -Nurp busybox.old/sysklogd/.built-in.o.cmd busybox/sysklogd/.built-in.o.cmd
--- busybox.old/sysklogd/.built-in.o.cmd	2015-05-29 06:55:25.000000000 +0800
+++ busybox/sysklogd/.built-in.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-cmd_sysklogd/built-in.o :=  rm -f sysklogd/built-in.o; mips-openwrt-linux-uclibc-ar rcs sysklogd/built-in.o
diff -Nurp busybox.old/sysklogd/Config.in busybox/sysklogd/Config.in
--- busybox.old/sysklogd/Config.in	2015-05-29 06:55:00.000000000 +0800
+++ busybox/sysklogd/Config.in	1970-01-01 08:00:00.000000000 +0800
@@ -1,169 +0,0 @@
-# DO NOT EDIT. This file is generated from Config.src
-#
-# For a description of the syntax of this configuration file,
-# see scripts/kbuild/config-language.txt.
-#
-
-menu "System Logging Utilities"
-
-
-config SYSLOGD
-	bool "syslogd"
-	default y
-	help
-	  The syslogd utility is used to record logs of all the
-	  significant events that occur on a system. Every
-	  message that is logged records the date and time of the
-	  event, and will generally also record the name of the
-	  application that generated the message. When used in
-	  conjunction with klogd, messages from the Linux kernel
-	  can also be recorded. This is terribly useful,
-	  especially for finding what happened when something goes
-	  wrong. And something almost always will go wrong if
-	  you wait long enough....
-
-config FEATURE_ROTATE_LOGFILE
-	bool "Rotate message files"
-	default y
-	depends on SYSLOGD
-	help
-	  This enables syslogd to rotate the message files
-	  on his own. No need to use an external rotatescript.
-
-config FEATURE_REMOTE_LOG
-	bool "Remote Log support"
-	default y
-	depends on SYSLOGD
-	help
-	  When you enable this feature, the syslogd utility can
-	  be used to send system log messages to another system
-	  connected via a network. This allows the remote
-	  machine to log all the system messages, which can be
-	  terribly useful for reducing the number of serial
-	  cables you use. It can also be a very good security
-	  measure to prevent system logs from being tampered with
-	  by an intruder.
-
-config FEATURE_SYSLOGD_DUP
-	bool "Support -D (drop dups) option"
-	default y
-	depends on SYSLOGD
-	help
-	  Option -D instructs syslogd to drop consecutive messages
-	  which are totally the same.
-
-config FEATURE_SYSLOGD_CFG
-	bool "Support syslog.conf"
-	default y
-	depends on SYSLOGD
-	help
-	  Supports restricted syslogd config. See docs/syslog.conf.txt
-
-config FEATURE_SYSLOGD_READ_BUFFER_SIZE
-	int "Read buffer size in bytes"
-	default 256
-	range 256 20000
-	depends on SYSLOGD
-	help
-	  This option sets the size of the syslog read buffer.
-	  Actual memory usage increases around five times the
-	  change done here.
-
-config FEATURE_IPC_SYSLOG
-	bool "Circular Buffer support"
-	default y
-	depends on SYSLOGD
-	help
-	  When you enable this feature, the syslogd utility will
-	  use a circular buffer to record system log messages.
-	  When the buffer is filled it will continue to overwrite
-	  the oldest messages. This can be very useful for
-	  systems with little or no permanent storage, since
-	  otherwise system logs can eventually fill up your
-	  entire filesystem, which may cause your system to
-	  break badly.
-
-config FEATURE_IPC_SYSLOG_BUFFER_SIZE
-	int "Circular buffer size in Kbytes (minimum 4KB)"
-	default 16
-	range 4 2147483647
-	depends on FEATURE_IPC_SYSLOG
-	help
-	  This option sets the size of the circular buffer
-	  used to record system log messages.
-
-config LOGREAD
-	bool "logread"
-	default y
-	depends on FEATURE_IPC_SYSLOG
-	help
-	  If you enabled Circular Buffer support, you almost
-	  certainly want to enable this feature as well. This
-	  utility will allow you to read the messages that are
-	  stored in the syslogd circular buffer.
-
-config FEATURE_LOGREAD_REDUCED_LOCKING
-	bool "Double buffering"
-	default y
-	depends on LOGREAD
-	help
-	  'logread' ouput to slow serial terminals can have
-	  side effects on syslog because of the semaphore.
-	  This option make logread to double buffer copy
-	  from circular buffer, minimizing semaphore
-	  contention at some minor memory expense.
-
-config FEATURE_KMSG_SYSLOG
-	bool "Linux kernel printk buffer support"
-	default y
-	depends on SYSLOGD
-	select PLATFORM_LINUX
-	help
-	  When you enable this feature, the syslogd utility will
-	  write system log message to the Linux kernel's printk buffer.
-	  This can be used as a smaller alternative to the syslogd IPC
-	  support, as klogd and logread aren't needed.
-
-	  NOTICE: Syslog facilities in log entries needs kernel 3.5+.
-
-config KLOGD
-	bool "klogd"
-	default y
-	help
-	  klogd is a utility which intercepts and logs all
-	  messages from the Linux kernel and sends the messages
-	  out to the 'syslogd' utility so they can be logged. If
-	  you wish to record the messages produced by the kernel,
-	  you should enable this option.
-
-comment "klogd should not be used together with syslog to kernel printk buffer"
-	depends on KLOGD && FEATURE_KMSG_SYSLOG
-
-config FEATURE_KLOGD_KLOGCTL
-	bool "Use the klogctl() interface"
-	default y
-	depends on KLOGD
-	select PLATFORM_LINUX
-	help
-	  The klogd applet supports two interfaces for reading
-	  kernel messages. Linux provides the klogctl() interface
-	  which allows reading messages from the kernel ring buffer
-	  independently from the file system.
-
-	  If you answer 'N' here, klogd will use the more portable
-	  approach of reading them from /proc or a device node.
-	  However, this method requires the file to be available.
-
-	  If in doubt, say 'Y'.
-
-config LOGGER
-	bool "logger"
-	default y
-	select FEATURE_SYSLOG
-	help
-	    The logger utility allows you to send arbitrary text
-	    messages to the system log (i.e. the 'syslogd' utility) so
-	    they can be logged. This is generally used to help locate
-	    problems that occur within programs and scripts.
-
-endmenu
diff -Nurp busybox.old/sysklogd/Kbuild busybox/sysklogd/Kbuild
--- busybox.old/sysklogd/Kbuild	2015-05-29 06:55:00.000000000 +0800
+++ busybox/sysklogd/Kbuild	1970-01-01 08:00:00.000000000 +0800
@@ -1,13 +0,0 @@
-# DO NOT EDIT. This file is generated from Kbuild.src
-# Makefile for busybox
-#
-# Copyright (C) 1999-2005 by Erik Andersen <andersen@codepoet.org>
-#
-# Licensed under GPLv2, see file LICENSE in this source tree.
-
-lib-y:=
-
-lib-$(CONFIG_KLOGD)		+= klogd.o
-lib-$(CONFIG_LOGGER)		+= syslogd_and_logger.o
-lib-$(CONFIG_LOGREAD)		+= logread.o
-lib-$(CONFIG_SYSLOGD)		+= syslogd_and_logger.o
Binary files busybox.old/sysklogd/lib.a and busybox/sysklogd/lib.a differ
diff -Nurp busybox.old/sysklogd/.lib.a.cmd busybox/sysklogd/.lib.a.cmd
--- busybox.old/sysklogd/.lib.a.cmd	2015-05-29 06:55:25.000000000 +0800
+++ busybox/sysklogd/.lib.a.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-cmd_sysklogd/lib.a := rm -f sysklogd/lib.a; mips-openwrt-linux-uclibc-ar  rcs sysklogd/lib.a sysklogd/syslogd_and_logger.o
diff -Nurp busybox.old/sysklogd/logread.c busybox/sysklogd/logread.c
--- busybox.old/sysklogd/logread.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/sysklogd/logread.c	2015-05-29 07:00:58.235925813 +0800
@@ -10,10 +10,11 @@
  */
 
 //usage:#define logread_trivial_usage
-//usage:       "[-f]"
+//usage:       "[-fF]"
 //usage:#define logread_full_usage "\n\n"
 //usage:       "Show messages in syslogd's circular buffer\n"
 //usage:     "\n	-f	Output data as log grows"
+//usage:     "\n	-F	Same as -f, but dump buffer first"
 
 #include "libbb.h"
 #include <sys/ipc.h>
@@ -83,7 +84,7 @@ int logread_main(int argc UNUSED_PARAM,
 	unsigned cur;
 	int log_semid; /* ipc semaphore id */
 	int log_shmid; /* ipc shared memory id */
-	smallint follow = getopt32(argv, "f");
+	int follow = getopt32(argv, "fF");
 
 	INIT_G();
 
@@ -106,7 +107,7 @@ int logread_main(int argc UNUSED_PARAM,
 	/* Max possible value for tail is shbuf->size - 1 */
 	cur = shbuf->tail;
 
-	/* Loop for logread -f, one pass if there was no -f */
+	/* Loop for -f or -F, one pass otherwise */
 	do {
 		unsigned shbuf_size;
 		unsigned shbuf_tail;
@@ -129,7 +130,12 @@ int logread_main(int argc UNUSED_PARAM,
 			printf("cur:%u tail:%u size:%u\n",
 					cur, shbuf_tail, shbuf_size);
 
-		if (!follow) {
+		if (!(follow & 1)) { /* not -f */
+			/* if -F, "convert" it to -f, so that we dont
+			 * dump the entire buffer on each iteration
+			 */
+			follow >>= 1;
+
 			/* advance to oldest complete message */
 			/* find NUL */
 			cur += strlen(shbuf_data + cur);
@@ -142,7 +148,7 @@ int logread_main(int argc UNUSED_PARAM,
 			cur++;
 			if (cur >= shbuf_size) /* last byte in buffer? */
 				cur = 0;
-		} else { /* logread -f */
+		} else { /* -f */
 			if (cur == shbuf_tail) {
 				sem_up(log_semid);
 				fflush_all();
Binary files busybox.old/sysklogd/syslogd_and_logger.o and busybox/sysklogd/syslogd_and_logger.o differ
diff -Nurp busybox.old/sysklogd/.syslogd_and_logger.o.cmd busybox/sysklogd/.syslogd_and_logger.o.cmd
--- busybox.old/sysklogd/.syslogd_and_logger.o.cmd	2015-05-29 06:55:25.000000000 +0800
+++ busybox/sysklogd/.syslogd_and_logger.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,199 +0,0 @@
-cmd_sysklogd/syslogd_and_logger.o := mips-openwrt-linux-uclibc-gcc -Wp,-MD,sysklogd/.syslogd_and_logger.o.d   -std=gnu99 -Iinclude -Ilibbb  -include include/autoconf.h -D_GNU_SOURCE -DNDEBUG -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -D"BB_VER=KBUILD_STR(1.23.2)" -DBB_BT=AUTOCONF_TIMESTAMP  -Wall -Wshadow -Wwrite-strings -Wundef -Wstrict-prototypes -Wunused -Wunused-parameter -Wunused-function -Wunused-value -Wmissing-prototypes -Wmissing-declarations -Wno-format-security -Wdeclaration-after-statement -Wold-style-definition -fno-builtin-strlen -finline-limit=0 -fomit-frame-pointer -ffunction-sections -fdata-sections -fno-guess-branch-probability -funsigned-char -falign-functions=1 -falign-jumps=1 -falign-labels=1 -falign-loops=1 -fno-unwind-tables -fno-asynchronous-unwind-tables -Os  -Os -pipe -mno-branch-likely -mips32r2 -mtune=74kc -fno-caller-saves -fhonour-copts -Wno-error=unused-but-set-variable -msoft-float -mips16 -minterlink-mips16   -D"KBUILD_STR(s)=\#s" -D"KBUILD_BASENAME=KBUILD_STR(syslogd_and_logger)"  -D"KBUILD_MODNAME=KBUILD_STR(syslogd_and_logger)" -c -o sysklogd/syslogd_and_logger.o sysklogd/syslogd_and_logger.c
-
-deps_sysklogd/syslogd_and_logger.o := \
-  sysklogd/syslogd_and_logger.c \
-    $(wildcard include/config/syslogd.h) \
-    $(wildcard include/config/logger.h) \
-  include/libbb.h \
-    $(wildcard include/config/feature/shadowpasswds.h) \
-    $(wildcard include/config/use/bb/shadow.h) \
-    $(wildcard include/config/selinux.h) \
-    $(wildcard include/config/feature/utmp.h) \
-    $(wildcard include/config/locale/support.h) \
-    $(wildcard include/config/use/bb/pwd/grp.h) \
-    $(wildcard include/config/lfs.h) \
-    $(wildcard include/config/feature/buffers/go/on/stack.h) \
-    $(wildcard include/config/feature/buffers/go/in/bss.h) \
-    $(wildcard include/config/feature/verbose.h) \
-    $(wildcard include/config/feature/ipv6.h) \
-    $(wildcard include/config/feature/seamless/xz.h) \
-    $(wildcard include/config/feature/seamless/lzma.h) \
-    $(wildcard include/config/feature/seamless/bz2.h) \
-    $(wildcard include/config/feature/seamless/gz.h) \
-    $(wildcard include/config/feature/seamless/z.h) \
-    $(wildcard include/config/feature/check/names.h) \
-    $(wildcard include/config/feature/prefer/applets.h) \
-    $(wildcard include/config/long/opts.h) \
-    $(wildcard include/config/feature/getopt/long.h) \
-    $(wildcard include/config/feature/pidfile.h) \
-    $(wildcard include/config/feature/syslog.h) \
-    $(wildcard include/config/feature/individual.h) \
-    $(wildcard include/config/echo.h) \
-    $(wildcard include/config/printf.h) \
-    $(wildcard include/config/test.h) \
-    $(wildcard include/config/kill.h) \
-    $(wildcard include/config/chown.h) \
-    $(wildcard include/config/ls.h) \
-    $(wildcard include/config/xxx.h) \
-    $(wildcard include/config/route.h) \
-    $(wildcard include/config/feature/hwib.h) \
-    $(wildcard include/config/desktop.h) \
-    $(wildcard include/config/feature/crond/d.h) \
-    $(wildcard include/config/use/bb/crypt.h) \
-    $(wildcard include/config/feature/adduser/to/group.h) \
-    $(wildcard include/config/feature/del/user/from/group.h) \
-    $(wildcard include/config/ioctl/hex2str/error.h) \
-    $(wildcard include/config/feature/editing.h) \
-    $(wildcard include/config/feature/editing/history.h) \
-    $(wildcard include/config/feature/editing/savehistory.h) \
-    $(wildcard include/config/feature/tab/completion.h) \
-    $(wildcard include/config/feature/username/completion.h) \
-    $(wildcard include/config/feature/editing/vi.h) \
-    $(wildcard include/config/feature/editing/save/on/exit.h) \
-    $(wildcard include/config/pmap.h) \
-    $(wildcard include/config/feature/show/threads.h) \
-    $(wildcard include/config/feature/ps/additional/columns.h) \
-    $(wildcard include/config/feature/topmem.h) \
-    $(wildcard include/config/feature/top/smp/process.h) \
-    $(wildcard include/config/killall.h) \
-    $(wildcard include/config/pgrep.h) \
-    $(wildcard include/config/pkill.h) \
-    $(wildcard include/config/pidof.h) \
-    $(wildcard include/config/sestatus.h) \
-    $(wildcard include/config/unicode/support.h) \
-    $(wildcard include/config/feature/mtab/support.h) \
-    $(wildcard include/config/feature/clean/up.h) \
-    $(wildcard include/config/feature/devfs.h) \
-  include/platform.h \
-    $(wildcard include/config/werror.h) \
-    $(wildcard include/config/big/endian.h) \
-    $(wildcard include/config/little/endian.h) \
-    $(wildcard include/config/nommu.h) \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/syslimits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/features.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_config.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/cdefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix1_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix2_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/xopen_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stdio_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap-common.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wordsize.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdbool.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/unistd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/environments.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/typesizes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stddef.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/confname.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/getopt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/ctype.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_touplow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/errno-base.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/syscall.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sysnum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sgidefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigset.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/sysmacros.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/pthreadtypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/inttypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netinet/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket_type.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sockaddr.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/sockios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/siginfo.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/signal.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/signum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigaction.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigcontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigstack.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ucontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigthread.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdarg.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdlib.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitflags.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitstatus.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/alloca.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/string.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/libgen.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctl-types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ttydefaults.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/wait.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_clk_tck.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/pwd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/grp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/shadow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/paths.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/mntent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/arpa/inet.h \
-  include/xatonum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/syslog.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/syslog.h \
-  sysklogd/logger.c \
-
-sysklogd/syslogd_and_logger.o: $(deps_sysklogd/syslogd_and_logger.o)
-
-$(deps_sysklogd/syslogd_and_logger.o):
diff -Nurp busybox.old/testsuite/bzcat.tests busybox/testsuite/bzcat.tests
--- busybox.old/testsuite/bzcat.tests	2015-03-23 11:06:55.000000000 +0800
+++ busybox/testsuite/bzcat.tests	2015-05-29 07:00:58.239259146 +0800
@@ -2,8 +2,6 @@
 
 FAILCOUNT=0
 
-ext=bz2
-
 bb="busybox "
 
 unset LC_ALL
@@ -11,6 +9,11 @@ unset LC_MESSAGES
 unset LANG
 unset LANGUAGE
 
+hello_Z() {
+    # Compressed "HELLO\n"
+    $ECHO -ne "\x1f\x9d\x90\x48\x8a\x30\x61\xf2\x44\x01"
+}
+
 hello_gz() {
     # Gzipped "HELLO\n"
     #_________________________ vvv vvv vvv vvv - mtime
@@ -25,32 +28,34 @@ hello_bz2() {
     $ECHO -ne "\x17\x72\x45\x38\x50\x90\x5b\xb8\xe8\xa3"
 }
 
-prep() {
-    rm -f t*
-    hello_$ext >t1.$ext
-    hello_$ext >t2.$ext
-}
-
-check() {
-    eval $2 >t_actual 2>&1
-    if $ECHO -ne "$expected" | cmp - t_actual; then
-	echo "PASS: $1"
-    else
-	echo "FAIL: $1"
-	FAILCOUNT=$((FAILCOUNT + 1))
-    fi
-}
-
-mkdir testdir 2>/dev/null
-(
-cd testdir || { echo "cannot cd testdir!"; exit 1; }
-
-expected="HELLO\nok\n"
-prep; check "bzcat: dont delete src" "${bb}bzcat t2.bz2; test -f t2.bz2 && echo ok"
-
-)
-rm -rf testdir
-
+for ext in gz bz2 Z
+do
+    prep() {
+	rm -f t1.$ext t2.$ext t_actual
+	hello_$ext >t1.$ext
+	hello_$ext >t2.$ext
+    }
+
+    check() {
+	eval $2 >t_actual 2>&1
+	if $ECHO -ne "$expected" | cmp - t_actual; then
+	    echo "PASS: $1"
+	else
+	    echo "FAIL: $1"
+	    FAILCOUNT=$((FAILCOUNT + 1))
+	fi
+    }
+
+    mkdir testdir 2>/dev/null
+    (
+    cd testdir || { echo "cannot cd testdir!"; exit 1; }
+
+    expected="HELLO\nok\n"
+    prep; check "zcat: dont delete $ext src" "${bb}zcat t2.$ext; test -f t2.$ext && echo ok"
+
+    )
+    rm -rf testdir
+done
 
 
 # Copyright 2011 by Denys Vlasenko
@@ -60,6 +65,8 @@ rm -rf testdir
 
 # testing "test name" "command" "expected result" "file input" "stdin"
 
+## bzip algorithm
+
 # "input" file is bzipped file with "a\n" data
 testing "bzcat can print many files" \
 "$ECHO -ne '$hexdump' | bzcat input input; echo \$?" \
@@ -79,6 +86,25 @@ testing "bzcat can handle compressed zer
 "0\n" \
 "\x42\x5a\x68\x39\x17\x72\x45\x38\x50\x90\x00\x00\x00\x00" ""
 
+## compress algorithm
+
+# "input" file is compressed (.Z) file with "a\n" data
+testing "zcat can print many files" \
+"$ECHO -ne '$hexdump' | zcat input input; echo \$?" \
+"\
+a
+a
+0
+" "\
+\x1f\x9d\x90\x61\x14\x00\
+" ""
+
+# "input" file is compressed (.Z) zero byte file
+testing "zcat can handle compressed zero-length compressed (.Z) files" \
+"$ECHO -ne '$hexdump' | zcat input input; echo \$?" \
+"0\n" \
+"\x1f\x9d\x90\x00" ""
+
 
 
 exit $((FAILCOUNT <= 255 ? FAILCOUNT : 255))
diff -Nurp busybox.old/testsuite/dc.tests busybox/testsuite/dc.tests
--- busybox.old/testsuite/dc.tests	1970-01-01 08:00:00.000000000 +0800
+++ busybox/testsuite/dc.tests	2015-05-29 07:00:58.239259146 +0800
@@ -0,0 +1,56 @@
+#!/bin/sh
+# Copyright 2015 by Bernhard Reutner-Fischer
+# Licensed under GPLv2 or later, see file LICENSE in this source tree.
+
+. ./testing.sh
+
+# testing "test name" "command" "expected result" "file input" "stdin"
+
+testing "dc basic syntax (stdin, multiple args)" \
+	"dc" \
+	"30\n" \
+	"" "10 20+p"
+
+testing "dc basic syntax (argv, single arg)" \
+	"dc '10 20+p'" \
+	"30\n" \
+	"" ""
+
+testing "dc basic syntax (argv, multiple args)" \
+	"dc 10 20+p" \
+	"30\n" \
+	"" ""
+
+testing "dc complex with spaces (single arg)" \
+	"dc '8 8 * 2 2 + / p'" \
+	"16\n" \
+	"" ""
+
+testing "dc complex without spaces (single arg)" \
+	"dc '8 8*2 2+/p'" \
+	"16\n" \
+	"" ""
+
+testing "dc complex with spaces (multiple args)" \
+	"dc 8 8 \* 2 2 + / p" \
+	"16\n" \
+	"" ""
+
+testing "dc complex without spaces (multiple args)" \
+	"dc 8 8\*2 2+/p" \
+	"16\n" \
+	"" ""
+
+exit $FAILCOUNT
+
+# we do not support arguments
+testing "dc -e <exprs>" \
+	"dc -e '10 2+f'" \
+	"12\n" \
+	"" ""
+
+testing "dc -f <exprs-from-given-file>" \
+	"dc -f input" \
+	"12\n" \
+	"10 2+f" ""
+
diff -Nurp busybox.old/testsuite/diff.tests busybox/testsuite/diff.tests
--- busybox.old/testsuite/diff.tests	2015-03-23 11:07:19.000000000 +0800
+++ busybox/testsuite/diff.tests	2015-05-29 07:00:58.239259146 +0800
@@ -44,6 +44,17 @@ testing "diff of stdin, twice" \
 	"" \
 	"stdin"
 
+testing "diff of empty file against stdin" \
+	"diff -u - input | $TRIM_TAB" \
+"\
+--- -
++++ input
+@@ -1 +0,0 @@
+-a
+" \
+	"" \
+	"a\n"
+
 testing "diff of empty file against nonempty one" \
 	"diff -u - input | $TRIM_TAB" \
 "\
diff -Nurp busybox.old/testsuite/sed.tests busybox/testsuite/sed.tests
--- busybox.old/testsuite/sed.tests	2015-03-23 11:06:55.000000000 +0800
+++ busybox/testsuite/sed.tests	2015-05-29 07:00:58.242592479 +0800
@@ -333,6 +333,38 @@ testing "sed s///NUM test" \
 	"sed -e 's/a/b/2; s/a/c/g'" \
 	"cb\n" "" "aa\n"
 
+testing "sed /regex/,N{...} addresses work" \
+	"sed /^2/,2{d}" \
+	"1\n3\n4\n5\n" \
+	"" \
+	"1\n2\n3\n4\n5\n"
+
+testing "sed /regex/,+N{...} addresses work" \
+	"sed /^2/,+2{d}" \
+	"1\n5\n" \
+	"" \
+	"1\n2\n3\n4\n5\n"
+
+testing "sed /regex/,+N{...} -i works" \
+	"cat - >input2; sed /^4/,+2{d} -i input input2; echo \$?; cat input input2; rm input2" \
+	"0\n""1\n2\n3\n7\n8\n""1\n2\n7\n8\n" \
+	"1\n2\n3\n4\n5\n6\n7\n8\n" \
+	"1\n2\n4\n5\n6\n7\n8\n" \
+
+# GNU sed 4.2.1 would also accept "/^4/,+{d}" with the same meaning, we don't
+testing "sed /regex/,+0{...} -i works" \
+	"cat - >input2; sed /^4/,+0{d} -i input input2; echo \$?; cat input input2; rm input2" \
+	"0\n""1\n2\n3\n5\n6\n7\n8\n""1\n2\n5\n6\n7\n8\n" \
+	"1\n2\n3\n4\n5\n6\n7\n8\n" \
+	"1\n2\n4\n5\n6\n7\n8\n" \
+
+# GNU sed 4.2.1 would also accept "/^4/,+d" with the same meaning, we don't
+testing "sed /regex/,+0<cmd> -i works" \
+	"cat - >input2; sed /^4/,+0d -i input input2; echo \$?; cat input input2; rm input2" \
+	"0\n""1\n2\n3\n5\n6\n7\n8\n""1\n2\n5\n6\n7\n8\n" \
+	"1\n2\n3\n4\n5\n6\n7\n8\n" \
+	"1\n2\n4\n5\n6\n7\n8\n" \
+
 # testing "description" "commands" "result" "infile" "stdin"
 
 exit $FAILCOUNT
diff -Nurp busybox.old/util-linux/acpid.c busybox/util-linux/acpid.c
--- busybox.old/util-linux/acpid.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/acpid.c	2015-05-29 07:00:58.245925812 +0800
@@ -121,10 +121,8 @@ static void process_event(const char *ev
 	char *handler = xasprintf("./%s", event);
 	const char *args[] = { "run-parts", handler, NULL };
 
-	// debug info
-	if (option_mask32 & OPT_d) {
-		bb_error_msg("%s", event);
-	}
+	// log the event
+	bb_error_msg("%s", event);
 
 	// spawn handler
 	// N.B. run-parts would require scripts to have #!/bin/sh
@@ -153,7 +151,7 @@ static const char *find_action(struct in
 		}
 
 		if (buf) {
-			if (strncmp(buf, evt_tab[i].desc, strlen(buf)) == 0) {
+			if (is_prefixed_with(evt_tab[i].desc, buf)) {
 				action = evt_tab[i].desc;
 				break;
 			}
@@ -256,7 +254,7 @@ int acpid_main(int argc UNUSED_PARAM, ch
 		/* No -d "Debug", we log to log file.
 		 * This includes any output from children.
 		 */
-		xmove_fd(xopen(opt_logfile, O_WRONLY | O_CREAT | O_TRUNC), STDOUT_FILENO);
+		xmove_fd(xopen(opt_logfile, O_WRONLY | O_CREAT | O_APPEND), STDOUT_FILENO);
 		xdup2(STDOUT_FILENO, STDERR_FILENO);
 		/* Also, acpid's messages (but not children) will go to syslog too */
 		openlog(applet_name, LOG_PID, LOG_DAEMON);
diff -Nurp busybox.old/util-linux/built-in.o busybox/util-linux/built-in.o
--- busybox.old/util-linux/built-in.o	2015-05-29 06:55:25.000000000 +0800
+++ busybox/util-linux/built-in.o	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-!<arch>
diff -Nurp busybox.old/util-linux/.built-in.o.cmd busybox/util-linux/.built-in.o.cmd
--- busybox.old/util-linux/.built-in.o.cmd	2015-05-29 06:55:25.000000000 +0800
+++ busybox/util-linux/.built-in.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-cmd_util-linux/built-in.o :=  rm -f util-linux/built-in.o; mips-openwrt-linux-uclibc-ar rcs util-linux/built-in.o
diff -Nurp busybox.old/util-linux/Config.in busybox/util-linux/Config.in
--- busybox.old/util-linux/Config.in	2015-05-29 06:55:00.000000000 +0800
+++ busybox/util-linux/Config.in	1970-01-01 08:00:00.000000000 +0800
@@ -1,792 +0,0 @@
-# DO NOT EDIT. This file is generated from Config.src
-#
-# For a description of the syntax of this configuration file,
-# see scripts/kbuild/config-language.txt.
-#
-
-menu "Linux System Utilities"
-
-config BLOCKDEV
-	bool "blockdev"
-	default y
-	help
-	  Performs some ioctls with block devices.
-config FATATTR
-	bool "fatattr"
-	default y
-	select PLATFORM_LINUX
-	help
-	  fatattr lists or changes the file attributes on a fat file system.
-config FSTRIM
-	bool "fstrim"
-	default y
-	select PLATFORM_LINUX
-	help
-	  Discard unused blocks on a mounted filesystem.
-config MDEV
-	bool "mdev"
-	default y
-	select PLATFORM_LINUX
-	help
-	  mdev is a mini-udev implementation for dynamically creating device
-	  nodes in the /dev directory.
-
-	  For more information, please see docs/mdev.txt
-
-config FEATURE_MDEV_CONF
-	bool "Support /etc/mdev.conf"
-	default y
-	depends on MDEV
-	help
-	  Add support for the mdev config file to control ownership and
-	  permissions of the device nodes.
-
-	  For more information, please see docs/mdev.txt
-
-config FEATURE_MDEV_RENAME
-	bool "Support subdirs/symlinks"
-	default y
-	depends on FEATURE_MDEV_CONF
-	help
-	  Add support for renaming devices and creating symlinks.
-
-	  For more information, please see docs/mdev.txt
-
-config FEATURE_MDEV_RENAME_REGEXP
-	bool "Support regular expressions substitutions when renaming device"
-	default y
-	depends on FEATURE_MDEV_RENAME
-	help
-	  Add support for regular expressions substitutions when renaming
-	  device.
-
-config FEATURE_MDEV_EXEC
-	bool "Support command execution at device addition/removal"
-	default y
-	depends on FEATURE_MDEV_CONF
-	help
-	  This adds support for an optional field to /etc/mdev.conf for
-	  executing commands when devices are created/removed.
-
-	  For more information, please see docs/mdev.txt
-
-config FEATURE_MDEV_LOAD_FIRMWARE
-	bool "Support loading of firmwares"
-	default y
-	depends on MDEV
-	help
-	  Some devices need to load firmware before they can be usable.
-
-	  These devices will request userspace look up the files in
-	  /lib/firmware/ and if it exists, send it to the kernel for
-	  loading into the hardware.
-config REV
-	bool "rev"
-	default y
-	help
-	  Reverse lines of a file or files.
-
-config ACPID
-	bool "acpid"
-	default y
-	select PLATFORM_LINUX
-	help
-	  acpid listens to ACPI events coming either in textual form from
-	  /proc/acpi/event (though it is marked deprecated it is still widely
-	  used and _is_ a standard) or in binary form from specified evdevs
-	  (just use /dev/input/event*).
-
-	  It parses the event to retrieve ACTION and a possible PARAMETER.
-	  It then spawns /etc/acpi/<ACTION>[/<PARAMETER>] either via run-parts
-	  (if the resulting path is a directory) or directly as an executable.
-
-	  N.B. acpid relies on run-parts so have the latter installed.
-
-config FEATURE_ACPID_COMPAT
-	bool "Accept and ignore redundant options"
-	default y
-	depends on ACPID
-	help
-	  Accept and ignore compatibility options -g -m -s -S -v.
-
-config BLKID
-	bool "blkid"
-	default y
-	select PLATFORM_LINUX
-	select VOLUMEID
-	help
-	  Lists labels and UUIDs of all filesystems.
-	  WARNING:
-	  With all submodules selected, it will add ~8k to busybox.
-
-config FEATURE_BLKID_TYPE
-	bool "Print filesystem type"
-	default n
-	depends on BLKID
-	help
-	  Show TYPE="filesystem type"
-
-config DMESG
-	bool "dmesg"
-	default y
-	select PLATFORM_LINUX
-	help
-	  dmesg is used to examine or control the kernel ring buffer. When the
-	  Linux kernel prints messages to the system log, they are stored in
-	  the kernel ring buffer. You can use dmesg to print the kernel's ring
-	  buffer, clear the kernel ring buffer, change the size of the kernel
-	  ring buffer, and change the priority level at which kernel messages
-	  are also logged to the system console. Enable this option if you
-	  wish to enable the 'dmesg' utility.
-
-config FEATURE_DMESG_PRETTY
-	bool "Pretty dmesg output"
-	default y
-	depends on DMESG
-	help
-	  If you wish to scrub the syslog level from the output, say 'Y' here.
-	  The syslog level is a string prefixed to every line with the form
-	  "<#>".
-
-	  With this option you will see:
-	    # dmesg
-	    Linux version 2.6.17.4 .....
-	    BIOS-provided physical RAM map:
-	     BIOS-e820: 0000000000000000 - 000000000009f000 (usable)
-
-	  Without this option you will see:
-	    # dmesg
-	    <5>Linux version 2.6.17.4 .....
-	    <6>BIOS-provided physical RAM map:
-	    <6> BIOS-e820: 0000000000000000 - 000000000009f000 (usable)
-
-config FBSET
-	bool "fbset"
-	default y
-	select PLATFORM_LINUX
-	help
-	  fbset is used to show or change the settings of a Linux frame buffer
-	  device. The frame buffer device provides a simple and unique
-	  interface to access a graphics display. Enable this option
-	  if you wish to enable the 'fbset' utility.
-
-config FEATURE_FBSET_FANCY
-	bool "Turn on extra fbset options"
-	default y
-	depends on FBSET
-	help
-	  This option enables extended fbset options, allowing one to set the
-	  framebuffer size, color depth, etc. interface to access a graphics
-	  display. Enable this option if you wish to enable extended fbset
-	  options.
-
-config FEATURE_FBSET_READMODE
-	bool "Turn on fbset readmode support"
-	default y
-	depends on FBSET
-	help
-	  This option allows fbset to read the video mode database stored by
-	  default as /etc/fb.modes, which can be used to set frame buffer
-	  device to pre-defined video modes.
-
-config FDFLUSH
-	bool "fdflush"
-	default y
-	select PLATFORM_LINUX
-	help
-	  fdflush is only needed when changing media on slightly-broken
-	  removable media drives. It is used to make Linux believe that a
-	  hardware disk-change switch has been actuated, which causes Linux to
-	  forget anything it has cached from the previous media. If you have
-	  such a slightly-broken drive, you will need to run fdflush every time
-	  you change a disk. Most people have working hardware and can safely
-	  leave this disabled.
-
-config FDFORMAT
-	bool "fdformat"
-	default y
-	select PLATFORM_LINUX
-	help
-	  fdformat is used to low-level format a floppy disk.
-
-config FDISK
-	bool "fdisk"
-	default y
-	select PLATFORM_LINUX
-	help
-	  The fdisk utility is used to divide hard disks into one or more
-	  logical disks, which are generally called partitions. This utility
-	  can be used to list and edit the set of partitions or BSD style
-	  'disk slices' that are defined on a hard drive.
-
-config FDISK_SUPPORT_LARGE_DISKS
-	bool "Support over 4GB disks"
-	default y
-	depends on FDISK
-	depends on !LFS   # with LFS no special code is needed
-	help
-	  Enable this option to support large disks > 4GB.
-
-config FEATURE_FDISK_WRITABLE
-	bool "Write support"
-	default y
-	depends on FDISK
-	help
-	  Enabling this option allows you to create or change a partition table
-	  and write those changes out to disk. If you leave this option
-	  disabled, you will only be able to view the partition table.
-
-config FEATURE_AIX_LABEL
-	bool "Support AIX disklabels"
-	default n
-	depends on FDISK && FEATURE_FDISK_WRITABLE
-	help
-	  Enabling this option allows you to create or change AIX disklabels.
-	  Most people can safely leave this option disabled.
-
-config FEATURE_SGI_LABEL
-	bool "Support SGI disklabels"
-	default n
-	depends on FDISK && FEATURE_FDISK_WRITABLE
-	help
-	  Enabling this option allows you to create or change SGI disklabels.
-	  Most people can safely leave this option disabled.
-
-config FEATURE_SUN_LABEL
-	bool "Support SUN disklabels"
-	default n
-	depends on FDISK && FEATURE_FDISK_WRITABLE
-	help
-	  Enabling this option allows you to create or change SUN disklabels.
-	  Most people can safely leave this option disabled.
-
-config FEATURE_OSF_LABEL
-	bool "Support BSD disklabels"
-	default n
-	depends on FDISK && FEATURE_FDISK_WRITABLE
-	help
-	  Enabling this option allows you to create or change BSD disklabels
-	  and define and edit BSD disk slices.
-
-config FEATURE_GPT_LABEL
-	bool "Support GPT disklabels"
-	default n
-	depends on FDISK && FEATURE_FDISK_WRITABLE
-	help
-	  Enabling this option allows you to view GUID Partition Table
-	  disklabels.
-
-config FEATURE_FDISK_ADVANCED
-	bool "Support expert mode"
-	default y
-	depends on FDISK && FEATURE_FDISK_WRITABLE
-	help
-	  Enabling this option allows you to do terribly unsafe things like
-	  define arbitrary drive geometry, move the beginning of data in a
-	  partition, and similarly evil things. Unless you have a very good
-	  reason you would be wise to leave this disabled.
-
-config FINDFS
-	bool "findfs"
-	default y
-	select PLATFORM_LINUX
-	select VOLUMEID
-	help
-	  Prints the name of a filesystem with given label or UUID.
-	  WARNING:
-	  With all submodules selected, it will add ~8k to busybox.
-
-config FLOCK
-	bool "flock"
-	default y
-	help
-	  Manage locks from shell scripts
-
-config FREERAMDISK
-	bool "freeramdisk"
-	default y
-	select PLATFORM_LINUX
-	help
-	  Linux allows you to create ramdisks. This utility allows you to
-	  delete them and completely free all memory that was used for the
-	  ramdisk. For example, if you boot Linux into a ramdisk and later
-	  pivot_root, you may want to free the memory that is allocated to the
-	  ramdisk. If you have no use for freeing memory from a ramdisk, leave
-	  this disabled.
-
-config FSCK_MINIX
-	bool "fsck_minix"
-	default y
-	help
-	  The minix filesystem is a nice, small, compact, read-write filesystem
-	  with little overhead. It is not a journaling filesystem however and
-	  can experience corruption if it is not properly unmounted or if the
-	  power goes off in the middle of a write. This utility allows you to
-	  check for and attempt to repair any corruption that occurs to a minix
-	  filesystem.
-
-config MKFS_EXT2
-	bool "mkfs_ext2"
-	default y
-	select PLATFORM_LINUX
-	help
-	  Utility to create EXT2 filesystems.
-
-config MKFS_MINIX
-	bool "mkfs_minix"
-	default y
-	select PLATFORM_LINUX
-	help
-	  The minix filesystem is a nice, small, compact, read-write filesystem
-	  with little overhead. If you wish to be able to create minix
-	  filesystems this utility will do the job for you.
-
-config FEATURE_MINIX2
-	bool "Support Minix fs v2 (fsck_minix/mkfs_minix)"
-	default y
-	depends on FSCK_MINIX || MKFS_MINIX
-	help
-	  If you wish to be able to create version 2 minix filesystems, enable
-	  this. If you enabled 'mkfs_minix' then you almost certainly want to
-	  be using the version 2 filesystem support.
-
-config MKFS_REISER
-	bool "mkfs_reiser"
-	default n
-	select PLATFORM_LINUX
-	help
-	  Utility to create ReiserFS filesystems.
-	  Note: this applet needs a lot of testing and polishing.
-
-config MKFS_VFAT
-	bool "mkfs_vfat"
-	default y
-	select PLATFORM_LINUX
-	help
-	  Utility to create FAT32 filesystems.
-
-config GETOPT
-	bool "getopt"
-	default y
-	help
-	  The getopt utility is used to break up (parse) options in command
-	  lines to make it easy to write complex shell scripts that also check
-	  for legal (and illegal) options. If you want to write horribly
-	  complex shell scripts, or use some horribly complex shell script
-	  written by others, this utility may be for you. Most people will
-	  wisely leave this disabled.
-
-config FEATURE_GETOPT_LONG
-	bool "Support option -l"
-	default y if LONG_OPTS
-	depends on GETOPT
-	help
-	  Enable support for long options (option -l).
-
-config HEXDUMP
-	bool "hexdump"
-	default y
-	help
-	  The hexdump utility is used to display binary data in a readable
-	  way that is comparable to the output from most hex editors.
-
-config FEATURE_HEXDUMP_REVERSE
-	bool "Support -R, reverse of 'hexdump -Cv'"
-	default y
-	depends on HEXDUMP
-	help
-	  The hexdump utility is used to display binary data in an ascii
-	  readable way. This option creates binary data from an ascii input.
-	  NB: this option is non-standard. It's unwise to use it in scripts
-	  aimed to be portable.
-
-config HD
-	bool "hd"
-	default y
-	depends on HEXDUMP
-	help
-	  hd is an alias to hexdump -C.
-
-config HWCLOCK
-	bool "hwclock"
-	default y
-	select PLATFORM_LINUX
-	help
-	  The hwclock utility is used to read and set the hardware clock
-	  on a system. This is primarily used to set the current time on
-	  shutdown in the hardware clock, so the hardware will keep the
-	  correct time when Linux is _not_ running.
-
-config FEATURE_HWCLOCK_LONG_OPTIONS
-	bool "Support long options (--hctosys,...)"
-	default y
-	depends on HWCLOCK && LONG_OPTS
-	help
-	  By default, the hwclock utility only uses short options. If you
-	  are overly fond of its long options, such as --hctosys, --utc, etc)
-	  then enable this option.
-
-config FEATURE_HWCLOCK_ADJTIME_FHS
-	bool "Use FHS /var/lib/hwclock/adjtime"
-	default n  # util-linux-ng in Fedora 13 still uses /etc/adjtime
-	depends on HWCLOCK
-	help
-	  Starting with FHS 2.3, the adjtime state file is supposed to exist
-	  at /var/lib/hwclock/adjtime instead of /etc/adjtime. If you wish
-	  to use the FHS behavior, answer Y here, otherwise answer N for the
-	  classic /etc/adjtime path.
-
-	  pathname.com/fhs/pub/fhs-2.3.html#VARLIBHWCLOCKSTATEDIRECTORYFORHWCLO
-
-config IPCRM
-	bool "ipcrm"
-	default y
-	help
-	  The ipcrm utility allows the removal of System V interprocess
-	  communication (IPC) objects and the associated data structures
-	  from the system.
-
-config IPCS
-	bool "ipcs"
-	default y
-	select PLATFORM_LINUX
-	help
-	  The ipcs utility is used to provide information on the currently
-	  allocated System V interprocess (IPC) objects in the system.
-
-config LOSETUP
-	bool "losetup"
-	default y
-	select PLATFORM_LINUX
-	help
-	  losetup is used to associate or detach a loop device with a regular
-	  file or block device, and to query the status of a loop device. This
-	  version does not currently support enabling data encryption.
-
-config LSPCI
-	bool "lspci"
-	default y
-	#select PLATFORM_LINUX
-	help
-	  lspci is a utility for displaying information about PCI buses in the
-	  system and devices connected to them.
-
-	  This version uses sysfs (/sys/bus/pci/devices) only.
-
-config LSUSB
-	bool "lsusb"
-	default y
-	#select PLATFORM_LINUX
-	help
-	  lsusb is a utility for displaying information about USB buses in the
-	  system and devices connected to them.
-
-	  This version uses sysfs (/sys/bus/usb/devices) only.
-
-config MKSWAP
-	bool "mkswap"
-	default y
-	help
-	  The mkswap utility is used to configure a file or disk partition as
-	  Linux swap space. This allows Linux to use the entire file or
-	  partition as if it were additional RAM, which can greatly increase
-	  the capability of low-memory machines. This additional memory is
-	  much slower than real RAM, but can be very helpful at preventing your
-	  applications being killed by the Linux out of memory (OOM) killer.
-	  Once you have created swap space using 'mkswap' you need to enable
-	  the swap space using the 'swapon' utility.
-
-config FEATURE_MKSWAP_UUID
-	bool "UUID support"
-	default y
-	depends on MKSWAP
-	help
-	  Generate swap spaces with universally unique identifiers.
-
-config MORE
-	bool "more"
-	default y
-	help
-	  more is a simple utility which allows you to read text one screen
-	  sized page at a time. If you want to read text that is larger than
-	  the screen, and you are using anything faster than a 300 baud modem,
-	  you will probably find this utility very helpful. If you don't have
-	  any need to reading text files, you can leave this disabled.
-
-config MOUNT
-	bool "mount"
-	default y
-	select PLATFORM_LINUX
-	help
-	  All files and filesystems in Unix are arranged into one big directory
-	  tree. The 'mount' utility is used to graft a filesystem onto a
-	  particular part of the tree. A filesystem can either live on a block
-	  device, or it can be accessible over the network, as is the case with
-	  NFS filesystems. Most people using BusyBox will also want to enable
-	  the 'mount' utility.
-
-config FEATURE_MOUNT_FAKE
-	bool "Support option -f"
-	default y
-	depends on MOUNT
-	help
-	  Enable support for faking a file system mount.
-
-config FEATURE_MOUNT_VERBOSE
-	bool "Support option -v"
-	default y
-	depends on MOUNT
-	help
-	  Enable multi-level -v[vv...] verbose messages. Useful if you
-	  debug mount problems and want to see what is exactly passed
-	  to the kernel.
-
-config FEATURE_MOUNT_HELPERS
-	bool "Support mount helpers"
-	default n
-	depends on MOUNT
-	help
-	  Enable mounting of virtual file systems via external helpers.
-	  E.g. "mount obexfs#-b00.11.22.33.44.55 /mnt" will in effect call
-	  "obexfs -b00.11.22.33.44.55 /mnt"
-	  Also "mount -t sometype [-o opts] fs /mnt" will try
-	  "sometype [-o opts] fs /mnt" if simple mount syscall fails.
-	  The idea is to use such virtual filesystems in /etc/fstab.
-
-config FEATURE_MOUNT_LABEL
-	bool "Support specifying devices by label or UUID"
-	default y
-	depends on MOUNT
-	select VOLUMEID
-	help
-	  This allows for specifying a device by label or uuid, rather than by
-	  name. This feature utilizes the same functionality as blkid/findfs.
-	  This also enables label or uuid support for swapon.
-
-config FEATURE_MOUNT_NFS
-	bool "Support mounting NFS file systems on Linux < 2.6.23"
-	default n
-	depends on MOUNT
-	select FEATURE_HAVE_RPC
-	select FEATURE_SYSLOG
-	help
-	  Enable mounting of NFS file systems on Linux kernels prior
-	  to version 2.6.23. Note that in this case mounting of NFS
-	  over IPv6 will not be possible.
-
-	  Note that this option links in RPC support from libc,
-	  which is rather large (~10 kbytes on uclibc).
-
-config FEATURE_MOUNT_CIFS
-	bool "Support mounting CIFS/SMB file systems"
-	default y
-	depends on MOUNT
-	help
-	  Enable support for samba mounts.
-
-config FEATURE_MOUNT_FLAGS
-	depends on MOUNT
-	bool "Support lots of -o flags in mount"
-	default y
-	help
-	  Without this, mount only supports ro/rw/remount. With this, it
-	  supports nosuid, suid, dev, nodev, exec, noexec, sync, async, atime,
-	  noatime, diratime, nodiratime, loud, bind, move, shared, slave,
-	  private, unbindable, rshared, rslave, rprivate, and runbindable.
-
-config FEATURE_MOUNT_FSTAB
-	depends on MOUNT
-	bool "Support /etc/fstab and -a"
-	default y
-	help
-	  Support mount all and looking for files in /etc/fstab.
-
-config PIVOT_ROOT
-	bool "pivot_root"
-	default y
-	select PLATFORM_LINUX
-	help
-	  The pivot_root utility swaps the mount points for the root filesystem
-	  with some other mounted filesystem. This allows you to do all sorts
-	  of wild and crazy things with your Linux system and is far more
-	  powerful than 'chroot'.
-
-	  Note: This is for initrd in linux 2.4. Under initramfs (introduced
-	  in linux 2.6) use switch_root instead.
-
-config RDATE
-	bool "rdate"
-	default y
-	help
-	  The rdate utility allows you to synchronize the date and time of your
-	  system clock with the date and time of a remote networked system using
-	  the RFC868 protocol, which is built into the inetd daemon on most
-	  systems.
-
-config RDEV
-	bool "rdev"
-	default y
-	help
-	  Print the device node associated with the filesystem mounted at '/'.
-
-config READPROFILE
-	bool "readprofile"
-	default y
-	#select PLATFORM_LINUX
-	help
-	  This allows you to parse /proc/profile for basic profiling.
-
-config RTCWAKE
-	bool "rtcwake"
-	default y
-	select PLATFORM_LINUX
-	help
-	  Enter a system sleep state until specified wakeup time.
-
-config SCRIPT
-	bool "script"
-	default y
-	help
-	  The script makes typescript of terminal session.
-
-config SCRIPTREPLAY
-	bool "scriptreplay"
-	default y
-	help
-	  This program replays a typescript, using timing information
-	  given by script -t.
-
-config SETARCH
-	bool "setarch"
-	default y
-	select PLATFORM_LINUX
-	help
-	  The linux32 utility is used to create a 32bit environment for the
-	  specified program (usually a shell). It only makes sense to have
-	  this util on a system that supports both 64bit and 32bit userland
-	  (like amd64/x86, ppc64/ppc, sparc64/sparc, etc...).
-
-config SWAPONOFF
-	bool "swaponoff"
-	default y
-	select PLATFORM_LINUX
-	help
-	  This option enables both the 'swapon' and the 'swapoff' utilities.
-	  Once you have created some swap space using 'mkswap', you also need
-	  to enable your swap space with the 'swapon' utility. The 'swapoff'
-	  utility is used, typically at system shutdown, to disable any swap
-	  space. If you are not using any swap space, you can leave this
-	  option disabled.
-
-config FEATURE_SWAPON_DISCARD
-	bool "Support discard option -d"
-	default y
-	depends on SWAPONOFF
-	help
-	  Enable support for discarding swap area blocks at swapon and/or as
-	  the kernel frees them. This option enables both the -d option on
-	  'swapon' and the 'discard' option for swap entries in /etc/fstab.
-
-config FEATURE_SWAPON_PRI
-	bool "Support priority option -p"
-	default y
-	depends on SWAPONOFF
-	help
-	  Enable support for setting swap device priority in swapon.
-
-config SWITCH_ROOT
-	bool "switch_root"
-	default y
-	select PLATFORM_LINUX
-	help
-	  The switch_root utility is used from initramfs to select a new
-	  root device. Under initramfs, you have to use this instead of
-	  pivot_root. (Stop reading here if you don't care why.)
-
-	  Booting with initramfs extracts a gzipped cpio archive into rootfs
-	  (which is a variant of ramfs/tmpfs). Because rootfs can't be moved
-	  or unmounted*, pivot_root will not work from initramfs. Instead,
-	  switch_root deletes everything out of rootfs (including itself),
-	  does a mount --move that overmounts rootfs with the new root, and
-	  then execs the specified init program.
-
-	  * Because the Linux kernel uses rootfs internally as the starting
-	  and ending point for searching through the kernel's doubly linked
-	  list of active mount points. That's why.
-
-config UMOUNT
-	bool "umount"
-	default y
-	select PLATFORM_LINUX
-	help
-	  When you want to remove a mounted filesystem from its current mount
-	  point, for example when you are shutting down the system, the
-	  'umount' utility is the tool to use. If you enabled the 'mount'
-	  utility, you almost certainly also want to enable 'umount'.
-
-config FEATURE_UMOUNT_ALL
-	bool "Support option -a"
-	default y
-	depends on UMOUNT
-	help
-	  Support -a option to unmount all currently mounted filesystems.
-
-comment "Common options for mount/umount"
-	depends on MOUNT || UMOUNT
-
-config FEATURE_MOUNT_LOOP
-	bool "Support loopback mounts"
-	default y
-	depends on MOUNT || UMOUNT
-	help
-	  Enabling this feature allows automatic mounting of files (containing
-	  filesystem images) via the linux kernel's loopback devices.
-	  The mount command will detect you are trying to mount a file instead
-	  of a block device, and transparently associate the file with a
-	  loopback device. The umount command will also free that loopback
-	  device.
-
-	  You can still use the 'losetup' utility (to manually associate files
-	  with loop devices) if you need to do something advanced, such as
-	  specify an offset or cryptographic options to the loopback device.
-	  (If you don't want umount to free the loop device, use "umount -D".)
-
-config FEATURE_MOUNT_LOOP_CREATE
-	bool "Create new loopback devices if needed"
-	default y
-	depends on FEATURE_MOUNT_LOOP
-	help
-	  Linux kernels >= 2.6.24 support unlimited loopback devices. They are
-	  allocated for use when trying to use a loop device. The loop device
-	  must however exist.
-
-	  This feature lets mount to try to create next /dev/loopN device
-	  if it does not find a free one.
-
-config FEATURE_MTAB_SUPPORT
-	bool "Support for the old /etc/mtab file"
-	default n
-	depends on MOUNT || UMOUNT
-	select FEATURE_MOUNT_FAKE
-	help
-	  Historically, Unix systems kept track of the currently mounted
-	  partitions in the file "/etc/mtab". These days, the kernel exports
-	  the list of currently mounted partitions in "/proc/mounts", rendering
-	  the old mtab file obsolete. (In modern systems, /etc/mtab should be
-	  a symlink to /proc/mounts.)
-
-	  The only reason to have mount maintain an /etc/mtab file itself is if
-	  your stripped-down embedded system does not have a /proc directory.
-	  If you must use this, keep in mind it's inherently brittle (for
-	  example a mount under chroot won't update it), can't handle modern
-	  features like separate per-process filesystem namespaces, requires
-	  that your /etc directory be writable, tends to get easily confused
-	  by --bind or --move mounts, won't update if you rename a directory
-	  that contains a mount point, and so on. (In brief: avoid.)
-
-	  About the only reason to use this is if you've removed /proc from
-	  your kernel.
-
-source util-linux/volume_id/Config.in
-
-endmenu
diff -Nurp busybox.old/util-linux/Config.src busybox/util-linux/Config.src
--- busybox.old/util-linux/Config.src	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/Config.src	2015-05-29 07:00:58.245925812 +0800
@@ -434,94 +434,6 @@ config MORE
 	  you will probably find this utility very helpful. If you don't have
 	  any need to reading text files, you can leave this disabled.
 
-config MOUNT
-	bool "mount"
-	default y
-	select PLATFORM_LINUX
-	help
-	  All files and filesystems in Unix are arranged into one big directory
-	  tree. The 'mount' utility is used to graft a filesystem onto a
-	  particular part of the tree. A filesystem can either live on a block
-	  device, or it can be accessible over the network, as is the case with
-	  NFS filesystems. Most people using BusyBox will also want to enable
-	  the 'mount' utility.
-
-config FEATURE_MOUNT_FAKE
-	bool "Support option -f"
-	default y
-	depends on MOUNT
-	help
-	  Enable support for faking a file system mount.
-
-config FEATURE_MOUNT_VERBOSE
-	bool "Support option -v"
-	default y
-	depends on MOUNT
-	help
-	  Enable multi-level -v[vv...] verbose messages. Useful if you
-	  debug mount problems and want to see what is exactly passed
-	  to the kernel.
-
-config FEATURE_MOUNT_HELPERS
-	bool "Support mount helpers"
-	default n
-	depends on MOUNT
-	help
-	  Enable mounting of virtual file systems via external helpers.
-	  E.g. "mount obexfs#-b00.11.22.33.44.55 /mnt" will in effect call
-	  "obexfs -b00.11.22.33.44.55 /mnt"
-	  Also "mount -t sometype [-o opts] fs /mnt" will try
-	  "sometype [-o opts] fs /mnt" if simple mount syscall fails.
-	  The idea is to use such virtual filesystems in /etc/fstab.
-
-config FEATURE_MOUNT_LABEL
-	bool "Support specifying devices by label or UUID"
-	default y
-	depends on MOUNT
-	select VOLUMEID
-	help
-	  This allows for specifying a device by label or uuid, rather than by
-	  name. This feature utilizes the same functionality as blkid/findfs.
-	  This also enables label or uuid support for swapon.
-
-config FEATURE_MOUNT_NFS
-	bool "Support mounting NFS file systems on Linux < 2.6.23"
-	default n
-	depends on MOUNT
-	select FEATURE_HAVE_RPC
-	select FEATURE_SYSLOG
-	help
-	  Enable mounting of NFS file systems on Linux kernels prior
-	  to version 2.6.23. Note that in this case mounting of NFS
-	  over IPv6 will not be possible.
-
-	  Note that this option links in RPC support from libc,
-	  which is rather large (~10 kbytes on uclibc).
-
-config FEATURE_MOUNT_CIFS
-	bool "Support mounting CIFS/SMB file systems"
-	default y
-	depends on MOUNT
-	help
-	  Enable support for samba mounts.
-
-config FEATURE_MOUNT_FLAGS
-	depends on MOUNT
-	bool "Support lots of -o flags in mount"
-	default y
-	help
-	  Without this, mount only supports ro/rw/remount. With this, it
-	  supports nosuid, suid, dev, nodev, exec, noexec, sync, async, atime,
-	  noatime, diratime, nodiratime, loud, bind, move, shared, slave,
-	  private, unbindable, rshared, rslave, rprivate, and runbindable.
-
-config FEATURE_MOUNT_FSTAB
-	depends on MOUNT
-	bool "Support /etc/fstab and -a"
-	default y
-	help
-	  Support mount all and looking for files in /etc/fstab.
-
 config PIVOT_ROOT
 	bool "pivot_root"
 	default y
Binary files busybox.old/util-linux/dmesg.o and busybox/util-linux/dmesg.o differ
diff -Nurp busybox.old/util-linux/.dmesg.o.cmd busybox/util-linux/.dmesg.o.cmd
--- busybox.old/util-linux/.dmesg.o.cmd	2015-05-29 06:55:25.000000000 +0800
+++ busybox/util-linux/.dmesg.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,196 +0,0 @@
-cmd_util-linux/dmesg.o := mips-openwrt-linux-uclibc-gcc -Wp,-MD,util-linux/.dmesg.o.d   -std=gnu99 -Iinclude -Ilibbb  -include include/autoconf.h -D_GNU_SOURCE -DNDEBUG -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -D"BB_VER=KBUILD_STR(1.23.2)" -DBB_BT=AUTOCONF_TIMESTAMP  -Wall -Wshadow -Wwrite-strings -Wundef -Wstrict-prototypes -Wunused -Wunused-parameter -Wunused-function -Wunused-value -Wmissing-prototypes -Wmissing-declarations -Wno-format-security -Wdeclaration-after-statement -Wold-style-definition -fno-builtin-strlen -finline-limit=0 -fomit-frame-pointer -ffunction-sections -fdata-sections -fno-guess-branch-probability -funsigned-char -falign-functions=1 -falign-jumps=1 -falign-labels=1 -falign-loops=1 -fno-unwind-tables -fno-asynchronous-unwind-tables -Os  -Os -pipe -mno-branch-likely -mips32r2 -mtune=74kc -fno-caller-saves -fhonour-copts -Wno-error=unused-but-set-variable -msoft-float -mips16 -minterlink-mips16   -D"KBUILD_STR(s)=\#s" -D"KBUILD_BASENAME=KBUILD_STR(dmesg)"  -D"KBUILD_MODNAME=KBUILD_STR(dmesg)" -c -o util-linux/dmesg.o util-linux/dmesg.c
-
-deps_util-linux/dmesg.o := \
-  util-linux/dmesg.c \
-    $(wildcard include/config/feature/dmesg/pretty.h) \
-    $(wildcard include/config/feature/clean/up.h) \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/klog.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/features.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_config.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/cdefs.h \
-  include/libbb.h \
-    $(wildcard include/config/feature/shadowpasswds.h) \
-    $(wildcard include/config/use/bb/shadow.h) \
-    $(wildcard include/config/selinux.h) \
-    $(wildcard include/config/feature/utmp.h) \
-    $(wildcard include/config/locale/support.h) \
-    $(wildcard include/config/use/bb/pwd/grp.h) \
-    $(wildcard include/config/lfs.h) \
-    $(wildcard include/config/feature/buffers/go/on/stack.h) \
-    $(wildcard include/config/feature/buffers/go/in/bss.h) \
-    $(wildcard include/config/feature/verbose.h) \
-    $(wildcard include/config/feature/ipv6.h) \
-    $(wildcard include/config/feature/seamless/xz.h) \
-    $(wildcard include/config/feature/seamless/lzma.h) \
-    $(wildcard include/config/feature/seamless/bz2.h) \
-    $(wildcard include/config/feature/seamless/gz.h) \
-    $(wildcard include/config/feature/seamless/z.h) \
-    $(wildcard include/config/feature/check/names.h) \
-    $(wildcard include/config/feature/prefer/applets.h) \
-    $(wildcard include/config/long/opts.h) \
-    $(wildcard include/config/feature/getopt/long.h) \
-    $(wildcard include/config/feature/pidfile.h) \
-    $(wildcard include/config/feature/syslog.h) \
-    $(wildcard include/config/feature/individual.h) \
-    $(wildcard include/config/echo.h) \
-    $(wildcard include/config/printf.h) \
-    $(wildcard include/config/test.h) \
-    $(wildcard include/config/kill.h) \
-    $(wildcard include/config/chown.h) \
-    $(wildcard include/config/ls.h) \
-    $(wildcard include/config/xxx.h) \
-    $(wildcard include/config/route.h) \
-    $(wildcard include/config/feature/hwib.h) \
-    $(wildcard include/config/desktop.h) \
-    $(wildcard include/config/feature/crond/d.h) \
-    $(wildcard include/config/use/bb/crypt.h) \
-    $(wildcard include/config/feature/adduser/to/group.h) \
-    $(wildcard include/config/feature/del/user/from/group.h) \
-    $(wildcard include/config/ioctl/hex2str/error.h) \
-    $(wildcard include/config/feature/editing.h) \
-    $(wildcard include/config/feature/editing/history.h) \
-    $(wildcard include/config/feature/editing/savehistory.h) \
-    $(wildcard include/config/feature/tab/completion.h) \
-    $(wildcard include/config/feature/username/completion.h) \
-    $(wildcard include/config/feature/editing/vi.h) \
-    $(wildcard include/config/feature/editing/save/on/exit.h) \
-    $(wildcard include/config/pmap.h) \
-    $(wildcard include/config/feature/show/threads.h) \
-    $(wildcard include/config/feature/ps/additional/columns.h) \
-    $(wildcard include/config/feature/topmem.h) \
-    $(wildcard include/config/feature/top/smp/process.h) \
-    $(wildcard include/config/killall.h) \
-    $(wildcard include/config/pgrep.h) \
-    $(wildcard include/config/pkill.h) \
-    $(wildcard include/config/pidof.h) \
-    $(wildcard include/config/sestatus.h) \
-    $(wildcard include/config/unicode/support.h) \
-    $(wildcard include/config/feature/mtab/support.h) \
-    $(wildcard include/config/feature/devfs.h) \
-  include/platform.h \
-    $(wildcard include/config/werror.h) \
-    $(wildcard include/config/big/endian.h) \
-    $(wildcard include/config/little/endian.h) \
-    $(wildcard include/config/nommu.h) \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/syslimits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix1_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix2_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/xopen_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stdio_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap-common.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wordsize.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdbool.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/unistd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/environments.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/typesizes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stddef.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/confname.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/getopt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/ctype.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_touplow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/errno-base.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/syscall.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sysnum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sgidefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigset.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/sysmacros.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/pthreadtypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/inttypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netinet/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket_type.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sockaddr.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/sockios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/siginfo.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/signal.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/signum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigaction.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigcontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigstack.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ucontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigthread.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdarg.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdlib.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitflags.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitstatus.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/alloca.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/string.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/libgen.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctl-types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ttydefaults.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/wait.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_clk_tck.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/pwd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/grp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/shadow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/paths.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/mntent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/arpa/inet.h \
-  include/xatonum.h \
-
-util-linux/dmesg.o: $(deps_util-linux/dmesg.o)
-
-$(deps_util-linux/dmesg.o):
diff -Nurp busybox.old/util-linux/fdisk.c busybox/util-linux/fdisk.c
--- busybox.old/util-linux/fdisk.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/fdisk.c	2015-05-29 07:00:58.245925812 +0800
@@ -2781,14 +2781,14 @@ is_ide_cdrom_or_tape(const char *device)
 	   the process hangs on the attempt to read a music CD.
 	   So try to be careful. This only works since 2.1.73. */
 
-	if (strncmp("/dev/hd", device, 7))
+	if (!is_prefixed_with(device, "/dev/hd"))
 		return 0;
 
 	snprintf(buf, sizeof(buf), "/proc/ide/%s/media", device+5);
 	procf = fopen_for_read(buf);
 	if (procf != NULL && fgets(buf, sizeof(buf), procf))
-		is_ide = (!strncmp(buf, "cdrom", 5) ||
-			  !strncmp(buf, "tape", 4));
+		is_ide = (is_prefixed_with(buf, "cdrom") ||
+			  is_prefixed_with(buf, "tape"));
 	else
 		/* Now when this proc file does not exist, skip the
 		   device when it is read-only. */
diff -Nurp busybox.old/util-linux/fdisk_osf.c busybox/util-linux/fdisk_osf.c
--- busybox.old/util-linux/fdisk_osf.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/fdisk_osf.c	2015-05-29 07:00:58.245925812 +0800
@@ -854,7 +854,7 @@ xbsd_initlabel(struct partition *p)
 
 	d->d_magic = BSD_DISKMAGIC;
 
-	if (strncmp(disk_device, "/dev/sd", 7) == 0)
+	if (is_prefixed_with(disk_device, "/dev/sd"))
 		d->d_type = BSD_DTYPE_SCSI;
 	else
 		d->d_type = BSD_DTYPE_ST506;
diff -Nurp busybox.old/util-linux/fdisk_sgi.c busybox/util-linux/fdisk_sgi.c
--- busybox.old/util-linux/fdisk_sgi.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/fdisk_sgi.c	2015-05-29 07:00:58.245925812 +0800
@@ -440,7 +440,7 @@ sgi_write_table(void)
 		(unsigned int*)sgilabel, sizeof(*sgilabel)) == 0);
 
 	write_sector(0, sgilabel);
-	if (!strncmp((char*)sgilabel->directory[0].vol_file_name, "sgilabel", 8)) {
+	if (is_prefixed_with((char*)sgilabel->directory[0].vol_file_name, "sgilabel")) {
 		/*
 		 * keep this habit of first writing the "sgilabel".
 		 * I never tested whether it works without (AN 981002).
diff -Nurp busybox.old/util-linux/findfs.c busybox/util-linux/findfs.c
--- busybox.old/util-linux/findfs.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/findfs.c	2015-05-29 07:00:58.249259146 +0800
@@ -27,7 +27,7 @@ int findfs_main(int argc UNUSED_PARAM, c
 	if (!dev)
 		bb_show_usage();
 
-	if (strncmp(dev, "/dev/", 5) == 0) {
+	if (is_prefixed_with(dev, "/dev/")) {
 		/* Just pass any /dev/xxx name right through.
 		 * This might aid in some scripts being able
 		 * to call this unconditionally */
diff -Nurp busybox.old/util-linux/fstrim.c busybox/util-linux/fstrim.c
--- busybox.old/util-linux/fstrim.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/fstrim.c	2015-05-29 07:00:58.249259146 +0800
@@ -32,7 +32,7 @@
 //usage:       "	-o OFFSET	Offset in bytes to discard from"
 //usage:     "\n	-l LEN		Bytes to discard"
 //usage:     "\n	-m MIN		Minimum extent length"
-//usage:     "\n	-v,		Print number of discarded bytes"
+//usage:     "\n	-v		Print number of discarded bytes"
 //usage:	)
 
 #include "libbb.h"
Binary files busybox.old/util-linux/hexdump.o and busybox/util-linux/hexdump.o differ
diff -Nurp busybox.old/util-linux/.hexdump.o.cmd busybox/util-linux/.hexdump.o.cmd
--- busybox.old/util-linux/.hexdump.o.cmd	2015-05-29 06:55:25.000000000 +0800
+++ busybox/util-linux/.hexdump.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,197 +0,0 @@
-cmd_util-linux/hexdump.o := mips-openwrt-linux-uclibc-gcc -Wp,-MD,util-linux/.hexdump.o.d   -std=gnu99 -Iinclude -Ilibbb  -include include/autoconf.h -D_GNU_SOURCE -DNDEBUG -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -D"BB_VER=KBUILD_STR(1.23.2)" -DBB_BT=AUTOCONF_TIMESTAMP  -Wall -Wshadow -Wwrite-strings -Wundef -Wstrict-prototypes -Wunused -Wunused-parameter -Wunused-function -Wunused-value -Wmissing-prototypes -Wmissing-declarations -Wno-format-security -Wdeclaration-after-statement -Wold-style-definition -fno-builtin-strlen -finline-limit=0 -fomit-frame-pointer -ffunction-sections -fdata-sections -fno-guess-branch-probability -funsigned-char -falign-functions=1 -falign-jumps=1 -falign-labels=1 -falign-loops=1 -fno-unwind-tables -fno-asynchronous-unwind-tables -Os  -Os -pipe -mno-branch-likely -mips32r2 -mtune=74kc -fno-caller-saves -fhonour-copts -Wno-error=unused-but-set-variable -msoft-float -mips16 -minterlink-mips16   -D"KBUILD_STR(s)=\#s" -D"KBUILD_BASENAME=KBUILD_STR(hexdump)"  -D"KBUILD_MODNAME=KBUILD_STR(hexdump)" -c -o util-linux/hexdump.o util-linux/hexdump.c
-
-deps_util-linux/hexdump.o := \
-  util-linux/hexdump.c \
-    $(wildcard include/config/feature/hexdump/reverse.h) \
-    $(wildcard include/config/hd.h) \
-  include/libbb.h \
-    $(wildcard include/config/feature/shadowpasswds.h) \
-    $(wildcard include/config/use/bb/shadow.h) \
-    $(wildcard include/config/selinux.h) \
-    $(wildcard include/config/feature/utmp.h) \
-    $(wildcard include/config/locale/support.h) \
-    $(wildcard include/config/use/bb/pwd/grp.h) \
-    $(wildcard include/config/lfs.h) \
-    $(wildcard include/config/feature/buffers/go/on/stack.h) \
-    $(wildcard include/config/feature/buffers/go/in/bss.h) \
-    $(wildcard include/config/feature/verbose.h) \
-    $(wildcard include/config/feature/ipv6.h) \
-    $(wildcard include/config/feature/seamless/xz.h) \
-    $(wildcard include/config/feature/seamless/lzma.h) \
-    $(wildcard include/config/feature/seamless/bz2.h) \
-    $(wildcard include/config/feature/seamless/gz.h) \
-    $(wildcard include/config/feature/seamless/z.h) \
-    $(wildcard include/config/feature/check/names.h) \
-    $(wildcard include/config/feature/prefer/applets.h) \
-    $(wildcard include/config/long/opts.h) \
-    $(wildcard include/config/feature/getopt/long.h) \
-    $(wildcard include/config/feature/pidfile.h) \
-    $(wildcard include/config/feature/syslog.h) \
-    $(wildcard include/config/feature/individual.h) \
-    $(wildcard include/config/echo.h) \
-    $(wildcard include/config/printf.h) \
-    $(wildcard include/config/test.h) \
-    $(wildcard include/config/kill.h) \
-    $(wildcard include/config/chown.h) \
-    $(wildcard include/config/ls.h) \
-    $(wildcard include/config/xxx.h) \
-    $(wildcard include/config/route.h) \
-    $(wildcard include/config/feature/hwib.h) \
-    $(wildcard include/config/desktop.h) \
-    $(wildcard include/config/feature/crond/d.h) \
-    $(wildcard include/config/use/bb/crypt.h) \
-    $(wildcard include/config/feature/adduser/to/group.h) \
-    $(wildcard include/config/feature/del/user/from/group.h) \
-    $(wildcard include/config/ioctl/hex2str/error.h) \
-    $(wildcard include/config/feature/editing.h) \
-    $(wildcard include/config/feature/editing/history.h) \
-    $(wildcard include/config/feature/editing/savehistory.h) \
-    $(wildcard include/config/feature/tab/completion.h) \
-    $(wildcard include/config/feature/username/completion.h) \
-    $(wildcard include/config/feature/editing/vi.h) \
-    $(wildcard include/config/feature/editing/save/on/exit.h) \
-    $(wildcard include/config/pmap.h) \
-    $(wildcard include/config/feature/show/threads.h) \
-    $(wildcard include/config/feature/ps/additional/columns.h) \
-    $(wildcard include/config/feature/topmem.h) \
-    $(wildcard include/config/feature/top/smp/process.h) \
-    $(wildcard include/config/killall.h) \
-    $(wildcard include/config/pgrep.h) \
-    $(wildcard include/config/pkill.h) \
-    $(wildcard include/config/pidof.h) \
-    $(wildcard include/config/sestatus.h) \
-    $(wildcard include/config/unicode/support.h) \
-    $(wildcard include/config/feature/mtab/support.h) \
-    $(wildcard include/config/feature/clean/up.h) \
-    $(wildcard include/config/feature/devfs.h) \
-  include/platform.h \
-    $(wildcard include/config/werror.h) \
-    $(wildcard include/config/big/endian.h) \
-    $(wildcard include/config/little/endian.h) \
-    $(wildcard include/config/nommu.h) \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/syslimits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/features.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_config.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/cdefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix1_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix2_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/xopen_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stdio_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap-common.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wordsize.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdbool.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/unistd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/environments.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/typesizes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stddef.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/confname.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/getopt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/ctype.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_touplow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/errno-base.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/syscall.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sysnum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sgidefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigset.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/sysmacros.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/pthreadtypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/inttypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netinet/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket_type.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sockaddr.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/sockios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/siginfo.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/signal.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/signum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigaction.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigcontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigstack.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ucontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigthread.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdarg.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdlib.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitflags.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitstatus.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/alloca.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/string.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/libgen.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctl-types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ttydefaults.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/wait.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_clk_tck.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/pwd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/grp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/shadow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/paths.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/mntent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/arpa/inet.h \
-  include/xatonum.h \
-  include/dump.h \
-
-util-linux/hexdump.o: $(deps_util-linux/hexdump.o)
-
-$(deps_util-linux/hexdump.o):
diff -Nurp busybox.old/util-linux/hwclock.c busybox/util-linux/hwclock.c
--- busybox.old/util-linux/hwclock.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/hwclock.c	2015-05-29 07:00:58.249259146 +0800
@@ -69,7 +69,7 @@ static void show_clock(const char **pp_r
 	strftime(cp, sizeof(cp), "%c", ptm);
 #else
 	char *cp = ctime(&t);
-	strchrnul(cp, '\n')[0] = '\0';
+	chomp(cp);
 #endif
 
 #if !SHOW_HWCLOCK_DIFF
Binary files busybox.old/util-linux/hwclock.o and busybox/util-linux/hwclock.o differ
diff -Nurp busybox.old/util-linux/.hwclock.o.cmd busybox/util-linux/.hwclock.o.cmd
--- busybox.old/util-linux/.hwclock.o.cmd	2015-05-29 06:55:25.000000000 +0800
+++ busybox/util-linux/.hwclock.o.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1,199 +0,0 @@
-cmd_util-linux/hwclock.o := mips-openwrt-linux-uclibc-gcc -Wp,-MD,util-linux/.hwclock.o.d   -std=gnu99 -Iinclude -Ilibbb  -include include/autoconf.h -D_GNU_SOURCE -DNDEBUG -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -D"BB_VER=KBUILD_STR(1.23.2)" -DBB_BT=AUTOCONF_TIMESTAMP  -Wall -Wshadow -Wwrite-strings -Wundef -Wstrict-prototypes -Wunused -Wunused-parameter -Wunused-function -Wunused-value -Wmissing-prototypes -Wmissing-declarations -Wno-format-security -Wdeclaration-after-statement -Wold-style-definition -fno-builtin-strlen -finline-limit=0 -fomit-frame-pointer -ffunction-sections -fdata-sections -fno-guess-branch-probability -funsigned-char -falign-functions=1 -falign-jumps=1 -falign-labels=1 -falign-loops=1 -fno-unwind-tables -fno-asynchronous-unwind-tables -Os  -Os -pipe -mno-branch-likely -mips32r2 -mtune=74kc -fno-caller-saves -fhonour-copts -Wno-error=unused-but-set-variable -msoft-float -mips16 -minterlink-mips16   -D"KBUILD_STR(s)=\#s" -D"KBUILD_BASENAME=KBUILD_STR(hwclock)"  -D"KBUILD_MODNAME=KBUILD_STR(hwclock)" -c -o util-linux/hwclock.o util-linux/hwclock.c
-
-deps_util-linux/hwclock.o := \
-  util-linux/hwclock.c \
-    $(wildcard include/config/feature/clean/up.h) \
-    $(wildcard include/config/locale/support.h) \
-    $(wildcard include/config/feature/hwclock/long/options.h) \
-  include/libbb.h \
-    $(wildcard include/config/feature/shadowpasswds.h) \
-    $(wildcard include/config/use/bb/shadow.h) \
-    $(wildcard include/config/selinux.h) \
-    $(wildcard include/config/feature/utmp.h) \
-    $(wildcard include/config/use/bb/pwd/grp.h) \
-    $(wildcard include/config/lfs.h) \
-    $(wildcard include/config/feature/buffers/go/on/stack.h) \
-    $(wildcard include/config/feature/buffers/go/in/bss.h) \
-    $(wildcard include/config/feature/verbose.h) \
-    $(wildcard include/config/feature/ipv6.h) \
-    $(wildcard include/config/feature/seamless/xz.h) \
-    $(wildcard include/config/feature/seamless/lzma.h) \
-    $(wildcard include/config/feature/seamless/bz2.h) \
-    $(wildcard include/config/feature/seamless/gz.h) \
-    $(wildcard include/config/feature/seamless/z.h) \
-    $(wildcard include/config/feature/check/names.h) \
-    $(wildcard include/config/feature/prefer/applets.h) \
-    $(wildcard include/config/long/opts.h) \
-    $(wildcard include/config/feature/getopt/long.h) \
-    $(wildcard include/config/feature/pidfile.h) \
-    $(wildcard include/config/feature/syslog.h) \
-    $(wildcard include/config/feature/individual.h) \
-    $(wildcard include/config/echo.h) \
-    $(wildcard include/config/printf.h) \
-    $(wildcard include/config/test.h) \
-    $(wildcard include/config/kill.h) \
-    $(wildcard include/config/chown.h) \
-    $(wildcard include/config/ls.h) \
-    $(wildcard include/config/xxx.h) \
-    $(wildcard include/config/route.h) \
-    $(wildcard include/config/feature/hwib.h) \
-    $(wildcard include/config/desktop.h) \
-    $(wildcard include/config/feature/crond/d.h) \
-    $(wildcard include/config/use/bb/crypt.h) \
-    $(wildcard include/config/feature/adduser/to/group.h) \
-    $(wildcard include/config/feature/del/user/from/group.h) \
-    $(wildcard include/config/ioctl/hex2str/error.h) \
-    $(wildcard include/config/feature/editing.h) \
-    $(wildcard include/config/feature/editing/history.h) \
-    $(wildcard include/config/feature/editing/savehistory.h) \
-    $(wildcard include/config/feature/tab/completion.h) \
-    $(wildcard include/config/feature/username/completion.h) \
-    $(wildcard include/config/feature/editing/vi.h) \
-    $(wildcard include/config/feature/editing/save/on/exit.h) \
-    $(wildcard include/config/pmap.h) \
-    $(wildcard include/config/feature/show/threads.h) \
-    $(wildcard include/config/feature/ps/additional/columns.h) \
-    $(wildcard include/config/feature/topmem.h) \
-    $(wildcard include/config/feature/top/smp/process.h) \
-    $(wildcard include/config/killall.h) \
-    $(wildcard include/config/pgrep.h) \
-    $(wildcard include/config/pkill.h) \
-    $(wildcard include/config/pidof.h) \
-    $(wildcard include/config/sestatus.h) \
-    $(wildcard include/config/unicode/support.h) \
-    $(wildcard include/config/feature/mtab/support.h) \
-    $(wildcard include/config/feature/devfs.h) \
-  include/platform.h \
-    $(wildcard include/config/werror.h) \
-    $(wildcard include/config/big/endian.h) \
-    $(wildcard include/config/little/endian.h) \
-    $(wildcard include/config/nommu.h) \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include-fixed/syslimits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/features.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_config.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/cdefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix1_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/limits.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_local_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix2_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/xopen_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stdio_lim.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/byteswap-common.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/endian.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdint.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/wordsize.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdbool.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/unistd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_posix_opt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/environments.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/typesizes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stddef.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/confname.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/getopt.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/ctype.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_touplow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/dirent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/errno.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/errno-base.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/syscall.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sysnum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/fcntl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sgidefs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/select.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigset.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/sysmacros.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/pthreadtypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/stat.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/inttypes.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/netinet/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/uio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/socket_type.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sockaddr.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/socket.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/sockios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/in.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/siginfo.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/netdb.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/setjmp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/signal.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/signum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigaction.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigcontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigstack.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ucontext.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/sigthread.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_stdio.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/wchar.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/lib/gcc/mips-openwrt-linux-uclibc/4.9.3/include/stdarg.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/stdlib.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitflags.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/waitstatus.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/alloca.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/string.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/libgen.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/poll.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ioctl.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/ioctls.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/ioctl-types.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/ttydefaults.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/mman.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/resource.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/time.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/wait.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/termios.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/uClibc_clk_tck.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/linux/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/asm-generic/param.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/pwd.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/grp.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/shadow.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/paths.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/mntent.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/statfs.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/arpa/inet.h \
-  include/xatonum.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/sys/utsname.h \
-  /home/wong/github/openwrt-1/staging_dir/toolchain-mips_74kc_gcc-4.9-linaro-1_uClibc-snapshot/include/bits/utsname.h \
-  include/rtc_.h \
-  include/libbb.h \
-
-util-linux/hwclock.o: $(deps_util-linux/hwclock.o)
-
-$(deps_util-linux/hwclock.o):
diff -Nurp busybox.old/util-linux/Kbuild busybox/util-linux/Kbuild
--- busybox.old/util-linux/Kbuild	2015-05-29 06:55:00.000000000 +0800
+++ busybox/util-linux/Kbuild	1970-01-01 08:00:00.000000000 +0800
@@ -1,51 +0,0 @@
-# DO NOT EDIT. This file is generated from Kbuild.src
-# Makefile for busybox
-#
-# Copyright (C) 1999-2005 by Erik Andersen <andersen@codepoet.org>
-#
-# Licensed under GPLv2, see file LICENSE in this source tree.
-
-lib-y:=
-
-lib-$(CONFIG_BLOCKDEV) += blockdev.o
-lib-$(CONFIG_FATATTR) += fatattr.o
-lib-$(CONFIG_FSTRIM) += fstrim.o
-lib-$(CONFIG_MDEV) += mdev.o
-lib-$(CONFIG_REV) += rev.o
-lib-$(CONFIG_ACPID)             += acpid.o
-lib-$(CONFIG_BLKID)             += blkid.o
-lib-$(CONFIG_DMESG)             += dmesg.o
-lib-$(CONFIG_FBSET)             += fbset.o
-lib-$(CONFIG_FDFLUSH)           += freeramdisk.o
-lib-$(CONFIG_FDFORMAT)          += fdformat.o
-lib-$(CONFIG_FDISK)             += fdisk.o
-lib-$(CONFIG_FINDFS)            += findfs.o
-lib-$(CONFIG_FLOCK)             += flock.o
-lib-$(CONFIG_FREERAMDISK)       += freeramdisk.o
-lib-$(CONFIG_FSCK_MINIX)        += fsck_minix.o
-lib-$(CONFIG_GETOPT)            += getopt.o
-lib-$(CONFIG_HEXDUMP)           += hexdump.o
-lib-$(CONFIG_HWCLOCK)           += hwclock.o
-lib-$(CONFIG_IPCRM)             += ipcrm.o
-lib-$(CONFIG_IPCS)              += ipcs.o
-lib-$(CONFIG_LOSETUP)           += losetup.o
-lib-$(CONFIG_LSPCI)             += lspci.o
-lib-$(CONFIG_LSUSB)             += lsusb.o
-lib-$(CONFIG_MKFS_EXT2)         += mkfs_ext2.o
-lib-$(CONFIG_MKFS_MINIX)        += mkfs_minix.o
-lib-$(CONFIG_MKFS_REISER)       += mkfs_reiser.o
-lib-$(CONFIG_MKFS_VFAT)         += mkfs_vfat.o
-lib-$(CONFIG_MKSWAP)            += mkswap.o
-lib-$(CONFIG_MORE)              += more.o
-lib-$(CONFIG_MOUNT)             += mount.o
-lib-$(CONFIG_PIVOT_ROOT)        += pivot_root.o
-lib-$(CONFIG_RDATE)             += rdate.o
-lib-$(CONFIG_RDEV)              += rdev.o
-lib-$(CONFIG_READPROFILE)       += readprofile.o
-lib-$(CONFIG_RTCWAKE)           += rtcwake.o
-lib-$(CONFIG_SCRIPT)            += script.o
-lib-$(CONFIG_SCRIPTREPLAY)      += scriptreplay.o
-lib-$(CONFIG_SETARCH)           += setarch.o
-lib-$(CONFIG_SWAPONOFF)         += swaponoff.o
-lib-$(CONFIG_SWITCH_ROOT)       += switch_root.o
-lib-$(CONFIG_UMOUNT)            += umount.o
Binary files busybox.old/util-linux/lib.a and busybox/util-linux/lib.a differ
diff -Nurp busybox.old/util-linux/.lib.a.cmd busybox/util-linux/.lib.a.cmd
--- busybox.old/util-linux/.lib.a.cmd	2015-05-29 06:55:25.000000000 +0800
+++ busybox/util-linux/.lib.a.cmd	1970-01-01 08:00:00.000000000 +0800
@@ -1 +0,0 @@
-cmd_util-linux/lib.a := rm -f util-linux/lib.a; mips-openwrt-linux-uclibc-ar  rcs util-linux/lib.a util-linux/dmesg.o util-linux/hexdump.o util-linux/hwclock.o util-linux/mkswap.o util-linux/mount.o util-linux/pivot_root.o util-linux/switch_root.o util-linux/umount.o
diff -Nurp busybox.old/util-linux/mdev.c busybox/util-linux/mdev.c
--- busybox.old/util-linux/mdev.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/mdev.c	2015-05-29 07:00:58.249259146 +0800
@@ -283,7 +283,7 @@ struct globals {
 	unsigned rule_idx;
 #endif
 	struct rule cur_rule;
-	char timestr[sizeof("60.123456")];
+	char timestr[sizeof("HH:MM:SS.123456")];
 } FIX_ALIASING;
 #define G (*(struct globals*)&bb_common_bufsiz1)
 #define INIT_G() do { \
@@ -610,7 +610,7 @@ static void make_device(char *device_nam
 	 * We use strstr("/block/") to forestall future surprises.
 	 */
 	type = S_IFCHR;
-	if (strstr(path, "/block/") || (G.subsystem && strncmp(G.subsystem, "block", 5) == 0))
+	if (strstr(path, "/block/") || (G.subsystem && is_prefixed_with(G.subsystem, "block")))
 		type = S_IFBLK;
 
 #if ENABLE_FEATURE_MDEV_CONF
@@ -923,7 +923,11 @@ static char *curtime(void)
 {
 	struct timeval tv;
 	gettimeofday(&tv, NULL);
-	sprintf(G.timestr, "%u.%06u", (unsigned)tv.tv_sec % 60, (unsigned)tv.tv_usec);
+	sprintf(
+		strftime_HHMMSS(G.timestr, sizeof(G.timestr), &tv.tv_sec),
+		".%06u",
+		(unsigned)tv.tv_usec
+	);
 	return G.timestr;
 }
 
@@ -943,7 +947,7 @@ static void open_mdev_log(const char *se
  * Active mdev pokes us with SIGCHLD to check the new file.
  */
 static int
-wait_for_seqfile(const char *seq)
+wait_for_seqfile(unsigned expected_seq)
 {
 	/* We time out after 2 sec */
 	static const struct timespec ts = { 0, 32*1000*1000 };
@@ -958,12 +962,14 @@ wait_for_seqfile(const char *seq)
 
 	for (;;) {
 		int seqlen;
-		char seqbuf[sizeof(int)*3 + 2];
+		char seqbuf[sizeof(long)*3 + 2];
+		unsigned seqbufnum;
 
 		if (seq_fd < 0) {
 			seq_fd = open("mdev.seq", O_RDWR);
 			if (seq_fd < 0)
 				break;
+			close_on_exec_on(seq_fd);
 		}
 		seqlen = pread(seq_fd, seqbuf, sizeof(seqbuf) - 1, 0);
 		if (seqlen < 0) {
@@ -974,17 +980,25 @@ wait_for_seqfile(const char *seq)
 		seqbuf[seqlen] = '\0';
 		if (seqbuf[0] == '\n' || seqbuf[0] == '\0') {
 			/* seed file: write out seq ASAP */
-			xwrite_str(seq_fd, seq);
+			xwrite_str(seq_fd, utoa(expected_seq));
 			xlseek(seq_fd, 0, SEEK_SET);
 			dbg2("first seq written");
 			break;
 		}
-		if (strcmp(seq, seqbuf) == 0) {
+		seqbufnum = atoll(seqbuf);
+		if (seqbufnum == expected_seq) {
 			/* correct idx */
 			break;
 		}
+		if (seqbufnum > expected_seq) {
+			/* a later mdev runs already (this was seen by users to happen) */
+			/* do not overwrite seqfile on exit */
+			close(seq_fd);
+			seq_fd = -1;
+			break;
+		}
 		if (do_once) {
-			dbg2("%s waiting for '%s'", curtime(), seqbuf);
+			dbg2("%s mdev.seq='%s', need '%u'", curtime(), seqbuf, expected_seq);
 			do_once = 0;
 		}
 		if (sigtimedwait(&set_CHLD, NULL, &ts) >= 0) {
@@ -992,7 +1006,7 @@ wait_for_seqfile(const char *seq)
 			continue; /* don't decrement timeout! */
 		}
 		if (--timeout == 0) {
-			dbg1("%s waiting for '%s'", "timed out", seqbuf);
+			dbg1("%s mdev.seq='%s'", "timed out", seqbuf);
 			break;
 		}
 	}
@@ -1075,6 +1089,7 @@ int mdev_main(int argc UNUSED_PARAM, cha
 		char *env_devname;
 		char *env_devpath;
 		unsigned my_pid;
+		unsigned seqnum = seqnum; /* for compiler */
 		int seq_fd;
 		smalluint op;
 
@@ -1096,7 +1111,11 @@ int mdev_main(int argc UNUSED_PARAM, cha
 		my_pid = getpid();
 		open_mdev_log(seq, my_pid);
 
-		seq_fd = seq ? wait_for_seqfile(seq) : -1;
+		seq_fd = -1;
+		if (seq) {
+			seqnum = atoll(seq);
+			seq_fd = wait_for_seqfile(seqnum);
+		}
 
 		dbg1("%s "
 			"ACTION:%s SUBSYSTEM:%s DEVNAME:%s DEVPATH:%s"
@@ -1124,7 +1143,7 @@ int mdev_main(int argc UNUSED_PARAM, cha
 
 		dbg1("%s exiting", curtime());
 		if (seq_fd >= 0) {
-			xwrite_str(seq_fd, utoa(xatou(seq) + 1));
+			xwrite_str(seq_fd, utoa(seqnum + 1));
 			signal_mdevs(my_pid);
 		}
 	}
diff -Nurp busybox.old/util-linux/mkfs_reiser.c busybox/util-linux/mkfs_reiser.c
--- busybox.old/util-linux/mkfs_reiser.c	2015-03-23 11:06:55.000000000 +0800
+++ busybox/util-linux/mkfs_reiser.c	2015-05-29 07:00:58.249259146 +0800
@@ -66,7 +66,7 @@ struct reiserfs_super_block {
 
 	char s_magic[10];               /* 52 "ReIsErFs" or "ReIsEr2Fs" or "ReIsEr3Fs" */
 	uint16_t sb_fs_state;           /* 62 it is set to used by fsck to mark which phase of rebuilding is done (used for fsck debugging) */
-	uint32_t sb_hash_function_code; /* 64 code of fuction which was/is/will be used to sort names in a directory. See codes in above */
+	uint32_t sb_hash_function_code; /* 64 code of function which was/is/will be used to sort names in a directory. See codes in above */
 	uint16_t sb_tree_height;        /* 68 height of filesytem tree. Tree consisting of only one root block has 2 here */
 	uint16_t sb_bmap_nr;            /* 70 amount of bitmap blocks needed to address each block of file system */
 	uint16_t sb_version;            /* 72 this field is only reliable on filesystem with non-standard journal */
diff -Nurp busybox.old/util-linux/mount.c busybox/util-linux/mount.c
--- busybox.old/util-linux/mount.c	2015-05-29 06:54:59.000000000 +0800
+++ busybox/util-linux/mount.c	2015-05-29 07:00:58.249259146 +0800
@@ -17,8 +17,103 @@
 // mount_it_now() does the actual mount.
 //
 
+//config:config MOUNT
+//config:	bool "mount"
+//config:	default y
+//config:	select PLATFORM_LINUX
+//config:	help
+//config:	  All files and filesystems in Unix are arranged into one big directory
+//config:	  tree. The 'mount' utility is used to graft a filesystem onto a
+//config:	  particular part of the tree. A filesystem can either live on a block
+//config:	  device, or it can be accessible over the network, as is the case with
+//config:	  NFS filesystems. Most people using BusyBox will also want to enable
+//config:	  the 'mount' utility.
+//config:
+//config:config FEATURE_MOUNT_FAKE
+//config:	bool "Support option -f"
+//config:	default y
+//config:	depends on MOUNT
+//config:	help
+//config:	  Enable support for faking a file system mount.
+//config:
+//config:config FEATURE_MOUNT_VERBOSE
+//config:	bool "Support option -v"
+//config:	default y
+//config:	depends on MOUNT
+//config:	help
+//config:	  Enable multi-level -v[vv...] verbose messages. Useful if you
+//config:	  debug mount problems and want to see what is exactly passed
+//config:	  to the kernel.
+//config:
+//config:config FEATURE_MOUNT_HELPERS
+//config:	bool "Support mount helpers"
+//config:	default n
+//config:	depends on MOUNT
+//config:	help
+//config:	  Enable mounting of virtual file systems via external helpers.
+//config:	  E.g. "mount obexfs#-b00.11.22.33.44.55 /mnt" will in effect call
+//config:	  "obexfs -b00.11.22.33.44.55 /mnt"
+//config:	  Also "mount -t sometype [-o opts] fs /mnt" will try
+//config:	  "sometype [-o opts] fs /mnt" if simple mount syscall fails.
+//config:	  The idea is to use such virtual filesystems in /etc/fstab.
+//config:
+//config:config FEATURE_MOUNT_LABEL
+//config:	bool "Support specifying devices by label or UUID"
+//config:	default y
+//config:	depends on MOUNT
+//config:	select VOLUMEID
+//config:	help
+//config:	  This allows for specifying a device by label or uuid, rather than by
+//config:	  name. This feature utilizes the same functionality as blkid/findfs.
+//config:	  This also enables label or uuid support for swapon.
+//config:
+//config:config FEATURE_MOUNT_NFS
+//config:	bool "Support mounting NFS file systems on Linux < 2.6.23"
+//config:	default n
+//config:	depends on MOUNT
+//config:	select FEATURE_HAVE_RPC
+//config:	select FEATURE_SYSLOG
+//config:	help
+//config:	  Enable mounting of NFS file systems on Linux kernels prior
+//config:	  to version 2.6.23. Note that in this case mounting of NFS
+//config:	  over IPv6 will not be possible.
+//config:
+//config:	  Note that this option links in RPC support from libc,
+//config:	  which is rather large (~10 kbytes on uclibc).
+//config:
+//config:config FEATURE_MOUNT_CIFS
+//config:	bool "Support mounting CIFS/SMB file systems"
+//config:	default y
+//config:	depends on MOUNT
+//config:	help
+//config:	  Enable support for samba mounts.
+//config:
+//config:config FEATURE_MOUNT_FLAGS
+//config:	depends on MOUNT
+//config:	bool "Support lots of -o flags in mount"
+//config:	default y
+//config:	help
+//config:	  Without this, mount only supports ro/rw/remount. With this, it
+//config:	  supports nosuid, suid, dev, nodev, exec, noexec, sync, async, atime,
+//config:	  noatime, diratime, nodiratime, loud, bind, move, shared, slave,
+//config:	  private, unbindable, rshared, rslave, rprivate, and runbindable.
+//config:
+//config:config FEATURE_MOUNT_FSTAB
+//config:	depends on MOUNT
+//config:	bool "Support /etc/fstab and -a"
+//config:	default y
+//config:	help
+//config:	  Support mount all and looking for files in /etc/fstab.
+//config:
+//config:config FEATURE_MOUNT_OTHERTAB
+//config:	depends on FEATURE_MOUNT_FSTAB
+//config:	bool "Support -T <alt_fstab>"
+//config:	default y
+//config:	help
+//config:	  Support mount -T (specifying an alternate fstab)
+
 //usage:#define mount_trivial_usage
-//usage:       "[OPTIONS] [-o OPTS] DEVICE NODE"
+//usage:       "[OPTIONS] [-o OPT] DEVICE NODE"
 //usage:#define mount_full_usage "\n\n"
 //usage:       "Mount a filesystem. Filesystem autodetection requires /proc.\n"
 //usage:     "\n	-a		Mount all filesystems in fstab"
@@ -41,8 +136,11 @@
 //usage:	)
 ////usage:   "\n	-s		Sloppy (ignored)"
 //usage:     "\n	-r		Read-only mount"
-//usage:     "\n	-w		Read-write mount (default)"
+////usage:     "\n	-w		Read-write mount (default)"
 //usage:     "\n	-t FSTYPE[,...]	Filesystem type(s)"
+//usage:	IF_FEATURE_MOUNT_OTHERTAB(
+//usage:     "\n	-T FILE		Read FILE instead of /etc/fstab"
+//usage:	)
 //usage:     "\n	-O OPT		Mount only filesystems with option OPT (-a only)"
 //usage:     "\n-o OPT:"
 //usage:	IF_FEATURE_MOUNT_LOOP(
@@ -64,7 +162,7 @@
 //usage:     "\n	move		Relocate an existing mount point"
 //usage:	)
 //usage:     "\n	remount		Remount a mounted filesystem, changing flags"
-//usage:     "\n	ro/rw		Same as -r/-w"
+//usage:     "\n	ro		Same as -r"
 //usage:     "\n"
 //usage:     "\nThere are filesystem-specific -o flags."
 //usage:
@@ -138,6 +236,9 @@
 #if ENABLE_FEATURE_MOUNT_NFS
 /* This is just a warning of a common mistake.  Possibly this should be a
  * uclibc faq entry rather than in busybox... */
+# if defined(__UCLIBC__) && ! defined(__UCLIBC_HAS_RPC__)
+#  error "You need to build uClibc with UCLIBC_HAS_RPC for NFS support"
+# endif
 # include <rpc/rpc.h>
 # include <rpc/pmap_prot.h>
 # include <rpc/pmap_clnt.h>
@@ -164,7 +265,7 @@ enum {
 };
 
 
-#define OPTION_STR "o:t:rwanfvsiO:"
+#define OPTION_STR "o:t:rwanfvsiO:" IF_FEATURE_MOUNT_OTHERTAB("T:")
 enum {
 	OPT_o = (1 << 0),
 	OPT_t = (1 << 1),
@@ -177,6 +278,7 @@ enum {
 	OPT_s = (1 << 8),
 	OPT_i = (1 << 9),
 	OPT_O = (1 << 10),
+	OPT_T = (1 << 11),
 };
 
 #if ENABLE_FEATURE_MTAB_SUPPORT
@@ -539,7 +641,7 @@ static llist_t *get_block_backed_filesys
 		if (!f) continue;
 
 		while ((buf = xmalloc_fgetline(f)) != NULL) {
-			if (strncmp(buf, "nodev", 5) == 0 && isspace(buf[5]))
+			if (is_prefixed_with(buf, "nodev") && isspace(buf[5]))
 				goto next;
 			fs = skip_whitespace(buf);
 			if (*fs == '#' || *fs == '*' || !*fs)
@@ -1262,9 +1364,9 @@ static NOINLINE int nfsmount(struct mnte
 						strcspn(opteq, " \t\n\r,"));
 				continue;
 			case 18: // "proto"
-				if (!strncmp(opteq, "tcp", 3))
+				if (is_prefixed_with(opteq, "tcp"))
 					tcp = 1;
-				else if (!strncmp(opteq, "udp", 3))
+				else if (is_prefixed_with(opteq, "udp"))
 					tcp = 0;
 				else
 					bb_error_msg("warning: unrecognized proto= option");
@@ -1357,7 +1459,7 @@ static NOINLINE int nfsmount(struct mnte
 				"rdirplus\0"
 				"acl\0";
 			int val = 1;
-			if (!strncmp(opt, "no", 2)) {
+			if (is_prefixed_with(opt, "no")) {
 				val = 0;
 				opt += 2;
 			}
@@ -1877,7 +1979,7 @@ static int singlemount(struct mntent *mp
 	}
 
 	// Might this be an NFS filesystem?
-	if ((!mp->mnt_type || strncmp(mp->mnt_type, "nfs", 3) == 0)
+	if ((!mp->mnt_type || is_prefixed_with(mp->mnt_type, "nfs"))
 	 && strchr(mp->mnt_fsname, ':') != NULL
 	) {
 		if (!mp->mnt_type)
@@ -2031,7 +2133,7 @@ int mount_main(int argc UNUSED_PARAM, ch
 	char *O_optmatch = NULL;
 	char *storage_path;
 	llist_t *lst_o = NULL;
-	const char *fstabname;
+	const char *fstabname = "/etc/fstab";
 	FILE *fstab;
 	int i, j;
 	int rc = EXIT_SUCCESS;
@@ -2058,6 +2160,7 @@ int mount_main(int argc UNUSED_PARAM, ch
 	// Max 2 params; -o is a list, -v is a counter
 	opt_complementary = "?2o::" IF_FEATURE_MOUNT_VERBOSE("vv");
 	opt = getopt32(argv, OPTION_STR, &lst_o, &fstype, &O_optmatch
+			IF_FEATURE_MOUNT_OTHERTAB(, &fstabname)
 			IF_FEATURE_MOUNT_VERBOSE(, &verbose));
 	while (lst_o) append_mount_options(&cmdopts, llist_pop(&lst_o)); // -o
 	if (opt & OPT_r) append_mount_options(&cmdopts, "ro"); // -r
@@ -2125,8 +2228,10 @@ int mount_main(int argc UNUSED_PARAM, ch
 		return rc;
 	}
 
+	// A malicious user could overmount /usr without this.
+	if (ENABLE_FEATURE_MOUNT_OTHERTAB && nonroot)
+		fstabname = "/etc/fstab";
 	// Open either fstab or mtab
-	fstabname = "/etc/fstab";
 	if (cmdopt_flags & MS_REMOUNT) {
 		// WARNING. I am not sure this matches util-linux's
 		// behavior. It's possible util-linux does not
diff -Nurp busybox.old/util-linux/rdate.c busybox/util-linux/rdate.c
--- busybox.old/util-linux/rdate.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/rdate.c	2015-05-29 07:00:58.249259146 +0800
@@ -11,9 +11,9 @@
 //usage:#define rdate_trivial_usage
 //usage:       "[-sp] HOST"
 //usage:#define rdate_full_usage "\n\n"
-//usage:       "Get and possibly set the system date/time from a remote HOST\n"
-//usage:     "\n	-s	Set the system date/time (default)"
-//usage:     "\n	-p	Print the date/time"
+//usage:       "Get and possibly set system time from a remote HOST\n"
+//usage:     "\n	-s	Set system time (default)"
+//usage:     "\n	-p	Print time"
 
 #include "libbb.h"
 
@@ -36,7 +36,7 @@ static time_t askremotedate(const char *
 	fd = create_and_connect_stream_or_die(host, bb_lookup_port("time", "tcp", 37));
 
 	if (safe_read(fd, &nett, 4) != 4)    /* read time from server */
-		bb_error_msg_and_die("%s did not send the complete time", host);
+		bb_error_msg_and_die("%s: %s", host, "short read");
 	if (ENABLE_FEATURE_CLEAN_UP)
 		close(fd);
 
diff -Nurp busybox.old/util-linux/rtcwake.c busybox/util-linux/rtcwake.c
--- busybox.old/util-linux/rtcwake.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/rtcwake.c	2015-05-29 07:00:58.249259146 +0800
@@ -32,18 +32,18 @@
 //usage:     "\n	-l,--local	Clock is set to local time"
 //usage:     "\n	-u,--utc	Clock is set to UTC time"
 //usage:     "\n	-d,--device=DEV	Specify the RTC device"
-//usage:     "\n	-m,--mode=MODE	Set the sleep state (default: standby)"
-//usage:     "\n	-s,--seconds=SEC Set the timeout in SEC seconds from now"
-//usage:     "\n	-t,--time=TIME	Set the timeout to TIME seconds from epoch"
+//usage:     "\n	-m,--mode=MODE	Set sleep state (default: standby)"
+//usage:     "\n	-s,--seconds=SEC Set timeout in SEC seconds from now"
+//usage:     "\n	-t,--time=TIME	Set timeout to TIME seconds from epoch"
 //usage:	)
 //usage:	IF_NOT_LONG_OPTS(
 //usage:     "\n	-a	Read clock mode from adjtime"
 //usage:     "\n	-l	Clock is set to local time"
 //usage:     "\n	-u	Clock is set to UTC time"
 //usage:     "\n	-d DEV	Specify the RTC device"
-//usage:     "\n	-m MODE	Set the sleep state (default: standby)"
-//usage:     "\n	-s SEC	Set the timeout in SEC seconds from now"
-//usage:     "\n	-t TIME	Set the timeout to TIME seconds from epoch"
+//usage:     "\n	-m MODE	Set sleep state (default: standby)"
+//usage:     "\n	-s SEC	Set timeout in SEC seconds from now"
+//usage:     "\n	-t TIME	Set timeout to TIME seconds from epoch"
 //usage:	)
 
 #include "libbb.h"
@@ -66,7 +66,7 @@ static NOINLINE bool may_wakeup(const ch
 		return false;
 
 	/* wakeup events could be disabled or not supported */
-	return strncmp(buf, "enabled\n", 8) == 0;
+	return is_prefixed_with(buf, "enabled\n") != NULL;
 }
 
 static NOINLINE void setup_alarm(int fd, time_t *wakeup, time_t rtc_time)
diff -Nurp busybox.old/util-linux/swaponoff.c busybox/util-linux/swaponoff.c
--- busybox.old/util-linux/swaponoff.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/swaponoff.c	2015-05-29 07:00:58.252592479 +0800
@@ -8,7 +8,7 @@
  */
 
 //usage:#define swapon_trivial_usage
-//usage:       "[-a]" IF_FEATURE_SWAPON_DISCARD(" [-d[POL]]") IF_FEATURE_SWAPON_PRI(" [-p PRI]") " [DEVICE]"
+//usage:       "[-a] [-e]" IF_FEATURE_SWAPON_DISCARD(" [-d[POL]]") IF_FEATURE_SWAPON_PRI(" [-p PRI]") " [DEVICE]"
 //usage:#define swapon_full_usage "\n\n"
 //usage:       "Start swapping on DEVICE\n"
 //usage:     "\n	-a	Start swapping on all swap devices"
@@ -16,15 +16,17 @@
 //usage:     "\n	-d[POL]	Discard blocks at swapon (POL=once),"
 //usage:     "\n		as freed (POL=pages), or both (POL omitted)"
 //usage:	)
+//usage:     "\n	-e	Silently skip devices that do not exist"
 //usage:	IF_FEATURE_SWAPON_PRI(
 //usage:     "\n	-p PRI	Set swap device priority"
 //usage:	)
 //usage:
 //usage:#define swapoff_trivial_usage
-//usage:       "[-a] [DEVICE]"
+//usage:       "[-a] [-e] [DEVICE]"
 //usage:#define swapoff_full_usage "\n\n"
 //usage:       "Stop swapping on DEVICE\n"
 //usage:     "\n	-a	Stop swapping on all swap devices"
+//usage:     "\n	-e	Silently skip devices that do not exist"
 
 #include "libbb.h"
 #include <mntent.h>
@@ -77,15 +79,18 @@ struct globals {
 /* Command line options */
 enum {
 	OPTBIT_a,                              /* -a all      */
+	OPTBIT_e,                              /* -e ifexists */
 	IF_FEATURE_SWAPON_DISCARD( OPTBIT_d ,) /* -d discard  */
 	IF_FEATURE_SWAPON_PRI    ( OPTBIT_p ,) /* -p priority */
 	OPT_a = 1 << OPTBIT_a,
+	OPT_e = 1 << OPTBIT_e,
 	OPT_d = IF_FEATURE_SWAPON_DISCARD((1 << OPTBIT_d)) + 0,
 	OPT_p = IF_FEATURE_SWAPON_PRI    ((1 << OPTBIT_p)) + 0,
 };
 
 #define OPT_ALL      (option_mask32 & OPT_a)
 #define OPT_DISCARD  (option_mask32 & OPT_d)
+#define OPT_IFEXISTS (option_mask32 & OPT_e)
 #define OPT_PRIO     (option_mask32 & OPT_p)
 
 static int swap_enable_disable(char *device)
@@ -95,6 +100,8 @@ static int swap_enable_disable(char *dev
 	struct stat st;
 
 	resolve_mount_spec(&device);
+	if (!OPT_IFEXISTS)
+		xstat(device, &st);
 
 	if (do_swapoff) {
 		err = swapoff(device);
@@ -112,7 +119,8 @@ static int swap_enable_disable(char *dev
 			}
 			err = swapon(device, g_flags);
 			/* Don't complain on swapon -a if device is already in use */
-			quiet = (OPT_ALL && errno == EBUSY);
+			/* Don't complain if file does not exist with -e option */
+			quiet = (OPT_ALL && errno == EBUSY) || (OPT_IFEXISTS && errno == ENOENT);
 		}
 	}
 
@@ -229,7 +237,7 @@ static int do_all_in_proc_swaps(void)
 	return err;
 }
 
-#define OPTSTR_SWAPON "a" \
+#define OPTSTR_SWAPON "ae" \
 	IF_FEATURE_SWAPON_DISCARD("d::") \
 	IF_FEATURE_SWAPON_PRI("p:")
 
@@ -242,7 +250,7 @@ int swap_on_off_main(int argc UNUSED_PAR
 
 	INIT_G();
 
-	getopt32(argv, do_swapoff ? "a" : OPTSTR_SWAPON
+	getopt32(argv, do_swapoff ? "ae" : OPTSTR_SWAPON
 			IF_FEATURE_SWAPON_DISCARD(, &discard)
 			IF_FEATURE_SWAPON_PRI(, &prio)
 	);
diff -Nurp busybox.old/util-linux/uevent.c busybox/util-linux/uevent.c
--- busybox.old/util-linux/uevent.c	1970-01-01 08:00:00.000000000 +0800
+++ busybox/util-linux/uevent.c	2015-05-29 07:00:58.252592479 +0800
@@ -0,0 +1,127 @@
+/*
+ * Copyright 2015 Denys Vlasenko
+ *
+ * Licensed under GPLv2, see file LICENSE in this source tree.
+ */
+
+//config:config UEVENT
+//config:	bool "uevent"
+//config:	default y
+//config:	select PLATFORM_LINUX
+//config:	help
+//config:	  uevent is a netlink listener for kernel uevent notifications
+//config:	  sent via netlink. It is usually used for dynamic device creation.
+
+//applet:IF_UEVENT(APPLET(uevent, BB_DIR_SBIN, BB_SUID_DROP))
+
+//kbuild:lib-$(CONFIG_UEVENT) += uevent.o
+
+//usage:#define uevent_trivial_usage
+//usage:       "[PROG [ARGS]]"
+//usage:#define uevent_full_usage "\n\n"
+//usage:       "uevent runs PROG for every netlink notification."
+//usage:   "\n""PROG's environment contains data passed from the kernel."
+//usage:   "\n""Typical usage (daemon for dynamic device node creation):"
+//usage:   "\n""	# uevent mdev & mdev -s"
+
+#include "libbb.h"
+#include <linux/netlink.h>
+
+#define BUFFER_SIZE 16*1024
+
+#define env ((char **)&bb_common_bufsiz1)
+enum {
+	MAX_ENV = COMMON_BUFSIZE / sizeof(env[0]) - 1,
+};
+
+#ifndef SO_RCVBUFFORCE
+#define SO_RCVBUFFORCE 33
+#endif
+static const int RCVBUF = 2 * 1024 * 1024;
+
+int uevent_main(int argc, char **argv) MAIN_EXTERNALLY_VISIBLE;
+int uevent_main(int argc UNUSED_PARAM, char **argv)
+{
+	struct sockaddr_nl sa;
+	int fd;
+
+	argv++;
+
+	// Subscribe for UEVENT kernel messages
+	sa.nl_family = AF_NETLINK;
+	sa.nl_pad = 0;
+	sa.nl_pid = getpid();
+	sa.nl_groups = 1 << 0;
+	fd = xsocket(AF_NETLINK, SOCK_DGRAM, NETLINK_KOBJECT_UEVENT);
+	xbind(fd, (struct sockaddr *) &sa, sizeof(sa));
+	close_on_exec_on(fd);
+
+	// Without a sufficiently big RCVBUF, a ton of simultaneous events
+	// can trigger ENOBUFS on read, which is unrecoverable.
+	// Reproducer:
+	//	uevent mdev &
+	// 	find /sys -name uevent -exec sh -c 'echo add >"{}"' ';'
+	//
+	// SO_RCVBUFFORCE (root only) can go above net.core.rmem_max sysctl
+	setsockopt(fd, SOL_SOCKET, SO_RCVBUF,      &RCVBUF, sizeof(RCVBUF));
+	setsockopt(fd, SOL_SOCKET, SO_RCVBUFFORCE, &RCVBUF, sizeof(RCVBUF));
+	if (0) {
+		int z;
+		socklen_t zl = sizeof(z);
+		getsockopt(fd, SOL_SOCKET, SO_RCVBUF, &z, &zl);
+		bb_error_msg("SO_RCVBUF:%d", z);
+	}
+
+	for (;;) {
+		char *netbuf;
+		char *s, *end;
+		ssize_t len;
+		int idx;
+
+		// In many cases, a system sits for *days* waiting
+		// for a new uevent notification to come in.
+		// We use a fresh mmap so that buffer is not allocated
+		// until kernel actually starts filling it.
+		netbuf = mmap(NULL, BUFFER_SIZE,
+					PROT_READ | PROT_WRITE,
+					MAP_PRIVATE | MAP_ANON,
+					/* ignored: */ -1, 0);
+		if (netbuf == MAP_FAILED)
+			bb_perror_msg_and_die("mmap");
+
+		// Here we block, possibly for a very long time
+		len = safe_read(fd, netbuf, BUFFER_SIZE - 1);
+		if (len < 0)
+			bb_perror_msg_and_die("read");
+		end = netbuf + len;
+		*end = '\0';
+
+		// Each netlink message starts with "ACTION@/path"
+		// (which we currently ignore),
+		// followed by environment variables.
+		if (!argv[0])
+			putchar('\n');
+		idx = 0;
+		s = netbuf;
+		while (s < end) {
+			if (!argv[0])
+				puts(s);
+			if (strchr(s, '=') && idx < MAX_ENV)
+				env[idx++] = s;
+			s += strlen(s) + 1;
+		}
+		env[idx] = NULL;
+
+		idx = 0;
+		while (env[idx])
+			putenv(env[idx++]);
+		if (argv[0])
+			spawn_and_wait(argv);
+		idx = 0;
+		while (env[idx])
+			bb_unsetenv(env[idx++]);
+		munmap(netbuf, BUFFER_SIZE);
+	}
+
+	return 0; // not reached
+}
diff -Nurp busybox.old/util-linux/volume_id/get_devname.c busybox/util-linux/volume_id/get_devname.c
--- busybox.old/util-linux/volume_id/get_devname.c	2015-03-23 11:07:19.000000000 +0800
+++ busybox/util-linux/volume_id/get_devname.c	2015-05-29 07:00:58.252592479 +0800
@@ -302,9 +302,9 @@ int resolve_mount_spec(char **fsname)
 {
 	char *tmp = *fsname;
 
-	if (strncmp(*fsname, "UUID=", 5) == 0)
+	if (is_prefixed_with(*fsname, "UUID="))
 		tmp = get_devname_from_uuid(*fsname + 5);
-	else if (strncmp(*fsname, "LABEL=", 6) == 0)
+	else if (is_prefixed_with(*fsname, "LABEL="))
 		tmp = get_devname_from_label(*fsname + 6);
 
 	if (tmp == *fsname)
